<!DOCTYPE html>
<html>
<head>
<title>Tue Aug 31, 2021 : #flightworthy (chtc)</title>
</head>
<body>
<h3>Tue Aug 31, 2021 : #flightworthy (chtc)</h3>
<span style="color: #684b6c"><span style="font-size: small">(09:46:10)</span> <b>bbockelman:</b></span> @tlmiller -&gt; if you're in today, I'd enjoy your $0.02 on this ticket: <a href="https://opensciencegrid.atlassian.net/browse/HTCONDOR-692">https://opensciencegrid.atlassian.net/browse/HTCONDOR-692</a><br/><br/>We've hit a subtle (but disruptive) issue in that the FQDN != canonical name.<br/>
<span style="color: #684b6c"><span style="font-size: small">(09:46:55)</span> <b>bbockelman:</b></span> (and googling around there's no "one shot" fix to get a FQDN)<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:16:29)</span> <b>tlmiller:</b></span> I could use a few more details in the description.  Is <tt>host_alias</tt> a query attribute?  When it says "In the lookup of the FQDN, we set this to the canonical name of the hostname." is that intended to mean "When we look up the FQDN, we set <tt>host_alias</tt> to the canonical name of the hostname."?  If <tt>host_alias</tt> is a query attribute, how does that cause SSL/GSI issues?<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:16:36)</span> <b>tlmiller:</b></span> (Do we still care about GSI issues?)<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:17:32)</span> <b>tlmiller:</b></span> If <tt>host_alias</tt> is a query attribute, isn't it what to expect that HTCondor sent along in the (machine) ad?<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:21:14)</span> <b>tlmiller:</b></span> Further, my impression was that we use the Sinful string's <tt>alias</tt> field for cases where the reverse DNS of an IP address does not match its certificate name(s).<br/>
<span style="color: #684b6c"><span style="font-size: small">(11:18:13)</span> <b>bbockelman:</b></span> <tt>host_alias</tt> is used by both SSL and GSI -- so the ticket isn't immediately obsolete.<br/>
<span style="color: #bb86b7"><span style="font-size: small">(13:50:10)</span> <b>tim:</b></span> The master branch is now at 9.1.5.<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:08:01)</span> <b>bbockelman:</b></span> &gt;  If <tt>host_alias</tt> is a query attribute, how does that cause SSL/GSI issues?<br/><tt>host_alias</tt> is used for the comparison against the certificate.  So if the user specifies <tt>condor_status -pool foo</tt>, the sinful becomes <tt>&lt;123.456.7.8?host_alias=foo&gt;</tt> and later on in the SSL/GSI code it compares the CN + SANs on the host certificate to <tt>foo</tt>.<br/><br/>The problem is, with using the CNAME instead of what the user provided, <tt>-pool foo</tt> becomes <tt>&lt;123.456.7.8?host_alias=bar&gt;</tt> and thus fails when the CN is <tt><a href="http://foo.example.com">foo.example.com</a></tt>, for example (which fails when compared to <tt>bar</tt>).<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:13:02)</span> <b>tlmiller:</b></span> Details: there is no <tt>host_alias</tt> in the HTCondor source tree.  <tt>HOST_ALIAS</tt> if a config knob.  <tt>alias</tt> is a part of a Sinful.  Are you using <tt>condor_status</tt> a confusing example?  That is, the initial connection to the collector is failing?<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:14:06)</span> <b>tlmiller:</b></span> (I didn't think we _ever_ used Sinfuls for the initial connection to the collector, actually.)<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:20:51)</span> <b>tlmiller:</b></span> I also haven't been able to reproduce this problem.  (Although the error messages I have encountered doing so strongly suggest that we do actually use sinfuls to contact the collector, so I guess I learned something today.)<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:23:35)</span> <b>tlmiller:</b></span> <tt>condor_status -pool cname</tt> on a machine where <tt>cname.domain.tld</tt> is a CNAME to <tt>domain.tld</tt> attempts to connect to the Sinful <tt>&lt;ip:9618?alias=cname&gt;</tt>, just like it does when the argument to <tt>-pool</tt> is anything else (and in any other DNS set-up I've tried); AFAICT, we just shovel the command-line argument in as the alias (which is arguably wrong, too, but at least more-predictably so).<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:28:51)</span> <b>bbockelman:</b></span> Oh, did I copy/paste from the ticket incorrectly?  Yes, you're right.  The knob is called <tt>host_alias</tt> but the Sinful portion is called <tt>alias</tt>.<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:29:11)</span> <b>tlmiller:</b></span> Looks like the ticket has it wrong too.<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:29:57)</span> <b>bbockelman:</b></span> Diego had to change the example he reported to workaround the condor issue.  John Thiltges was able to find another case:<br/><pre>env _condor_TOOL.SEC_CLIENT_ENCRYPTION=REQUIRED  _condor_TOOL.SEC_CLIENT_AUTHENTICATION_METHODS=GSI _condor_TOOL_DEBUG=D_FULLDEBUG,D_SECURITY condor_status -debug -pool <a href="http://collector1.opensciencegrid.org:9619">collector1.opensciencegrid.org:9619</a></pre><br/><br/>
<span style="color: #684b6c"><span style="font-size: small">(14:30:08)</span> <b>bbockelman:</b></span> (that should trigger the issue on <a href="http://submit2.chtc.wisc.edu">submit2.chtc.wisc.edu</a>)<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:30:15)</span> <b>tlmiller:</b></span> HOST_ALIAS also shouldn't affect outgoing connections to the collector, since we're not looking up an address.<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:30:51)</span> <b>bbockelman:</b></span> (editing the ticket to clean it up)<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:32:58)</span> <b>bbockelman:</b></span> ticket description and name cleaned up to reflect the above.  Also copy/pasted in the example.<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:34:37)</span> <b>tlmiller:</b></span> Interesting!  Did this change recently?  The behavior (even in the non-GSI case) is very different on that machine / version of HTCondor than what I was trying.<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:36:56)</span> <b>bbockelman:</b></span> Diego was trying a few different condor versions.  He claims 8.8.10 and before work (have not verified).<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:37:22)</span> <b>tlmiller:</b></span> I tried 9.1.1, IIRC, but I'll go check that again quickly.<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:37:30)</span> <b>tlmiller:</b></span> What really blows my mind is the following line from a D_HOSTNAME log:<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:37:48)</span> <b>tlmiller:</b></span> <pre>08/31/21 14:36:53 (D_HOSTNAME) Daemon client (collector) address determined: name: "<a href="http://collector1.opensciencegrid.org:9619">collector1.opensciencegrid.org:9619</a>", pool: "<a href="http://collector1.opensciencegrid.org:9619">collector1.opensciencegrid.org:9619</a>", alias: "<a href="http://collector1.opensciencegrid.org">collector1.opensciencegrid.org</a>", addr: "&lt;129.93.175.54:9619?alias=hcc-osg-collector.unl.edu&gt;"</pre><br/>Somebody went out of their way to screw the Sinful up.<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:41:57)</span> <b>bbockelman:</b></span> Yes - I had found the function involved yesterday when I filed the ticket (in a rush on my way out the door)<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:42:53)</span> <b>tlmiller:</b></span> ... and apparently I had screwed up some of the testing earlier.<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:43:24)</span> <b>tlmiller:</b></span> Do you remember the function?<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:44:23)</span> <b>bbockelman:</b></span> My theory yesterday was <tt>get_fqdn_and_ip_from_hostname</tt><br/>
<span style="color: #9e3997"><span style="font-size: small">(14:44:49)</span> <b>tlmiller:</b></span> Also -- I didn't think HTCondor ever actually did its own DNS queries.  Is it actually looking at the CNAME, or is it just doing its usual reverse-DNS look up, and for some reason shoving that rather than the command-line argument into the <tt>alias</tt> field?<br/>
<span style="color: #2b6836"><span style="font-size: small">(15:16:28)</span> <b>jcpatton:</b></span> @tim I vaguely remember the conversation about blahp versions from yesterday, how do I get around this?<br/><pre>Error: Package: condor-9.1.3-1.el7.x86_64 (htcondor)<br/>           Requires: blahp &gt;= 2.1.1<br/>           Available: blahp-2.0.2-1.el7.x86_64 (htcondor)<br/>               blahp = 2.0.2-1.el7</pre><br/>
<span style="color: #bb86b7"><span style="font-size: small">(15:17:32)</span> <b>tim:</b></span> So, the blahp 2.1.1 should be alongside the condor 9.1.3. What repository are you using?<br/>
<span style="color: #2b6836"><span style="font-size: small">(15:17:56)</span> <b>jcpatton:</b></span> <tt><a href="https://research.cs.wisc.edu/htcondor/repo/9.1/el7/release">https://research.cs.wisc.edu/htcondor/repo/9.1/el7/release</a></tt><br/>
<span style="color: #bb86b7"><span style="font-size: small">(15:21:41)</span> <b>tim:</b></span> Well, it's in the repo. What command did you issue?<br/>
<span style="color: #2b6836"><span style="font-size: small">(15:22:02)</span> <b>jcpatton:</b></span> <tt>yum install condor-credmon-oauth</tt> (so I get only what’s needed for it)<br/>
<span style="color: #2b6836"><span style="font-size: small">(15:22:51)</span> <b>jcpatton:</b></span> <pre>[jcpatton@scitokens-dev ~]$ sudo yum list blahp<br/>Loaded plugins: fastestmirror, priorities, versionlock<br/>Loading mirror speeds from cached hostfile<br/> * epel: <a href="http://mirror.steadfastnet.com">mirror.steadfastnet.com</a><br/> * osg: <a href="http://repo.opensciencegrid.org">repo.opensciencegrid.org</a><br/>453 packages excluded due to repository priority protections<br/>Excluding 7 updates due to versionlock (use "yum versionlock status" to show them)<br/>Available Packages<br/>blahp.x86_64                                  2.0.2-1.el7                                  htcondor</pre><br/>
<span style="color: #bb86b7"><span style="font-size: small">(15:24:13)</span> <b>tim:</b></span> Looks like like blahp is version locked. You'll have to pester your sysadmin to remove the version lock on blahp.<br/>
<span style="color: #2b6836"><span style="font-size: small">(15:24:23)</span> <b>jcpatton:</b></span> ahhhhh yep that’s it<br/>
<span style="color: #2b6836"><span style="font-size: small">(15:27:26)</span> <b>jcpatton:</b></span> thanks, my bad on not checking the versionlocks<br/>
</body>
</html>
