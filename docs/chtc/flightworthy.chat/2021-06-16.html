<!DOCTYPE html>
<html>
<head>
<title>Wed Jun 16, 2021 : #flightworthy (chtc)</title>
</head>
<body>
<h3>Wed Jun 16, 2021 : #flightworthy (chtc)</h3>
<span style="color: #d58247"><span style="font-size: small">(08:08:37)</span> <b>gthain:</b></span> IHEP has an interesting problem:<br/>
<span style="color: #d58247"><span style="font-size: small">(08:09:12)</span> <b>gthain:</b></span> <pre>Now we are developing the submission function for LHAASO users with python bindings. Unfortunately, it's stopped by formatting the output file name. The problem is like:<br/><br/>If a job's procid is 0, the output file will be DAT000001.log; procid is 100, the output file will be DAT000101.log. With the condor_submit command, we can do like this:<br/>	Arguments = $INT(RunID_Mapped)<br/>	RunID_Formatted=$INT(RunID_Mapped,%06d)<br/>	transfer_output_files = /dg_hpc/CNG/shijy/lhaaso/20210505/result/g4wcda_step1/Gamma/1.e11_1.e12/DAT$(RunID_Formatted)_step1.root<br/><br/>But with python bindings, I didn't find a way to format procid to the output file. </pre><br/>
<span style="color: #9e3997"><span style="font-size: small">(08:38:45)</span> <b>tlmiller:</b></span> The Python bindings don't do macro expansion?<br/>
<span style="color: #d58247"><span style="font-size: small">(08:49:40)</span> <b>gthain:</b></span> My understanding is they don't speak the submit language<br/>
<span style="color: #9e3997"><span style="font-size: small">(08:54:35)</span> <b>tlmiller:</b></span> ... hrm.  For some reason I thought macro expansion != the submit language, but maybe I'm wrong.  At any rate, they can certainly strcat() their way around that problem.<br/>
<span style="color: #d58247"><span style="font-size: small">(09:04:15)</span> <b>gthain:</b></span> huddle will be quick today -- neither Todd will be there, I'm out, TimT's out<br/>
<span style="color: #4cc091"><span style="font-size: small">(09:16:29)</span> <b>blin:</b></span> yeah, i don't think python bindings do macro expansion or submit language niceties: you just construct the job ad directly<br/>
<span style="color: #d58247"><span style="font-size: small">(09:18:08)</span> <b>gthain:</b></span> It is a bit of a headache in this case because they don't necessarily know the procid at submit time<br/>
<span style="color: #99a949"><span style="font-size: small">(09:24:47)</span> <b>matyas:</b></span> you can still use <tt>$(ClusterId)</tt> and <tt>$(ProcId)</tt> no? I did it in some of my dask stuff.<br/>
<span style="color: #99a949"><span style="font-size: small">(09:25:17)</span> <b>matyas:</b></span> <pre>JOB_TEMPLATE = \<br/>    { 'Executable':           '/usr/bin/dask-worker'<br/>    , 'Universe':             'vanilla'<br/>    # $F(MY.JobId) strips the quotes from MY.JobId<br/>    , 'Output':               '$(LogDir)/worker-$F(MY.JobId).out'<br/>    ## Don't transfer stderr -- we're redirecting it to stdout<br/>    #, 'Error':                '$(LogDir)/worker-$F(MY.JobId).err'<br/>    , 'Log':                  '$(LogDir)/worker-$(ClusterId).log'<br/>    # We kill all the workers to stop them so we need to stream their<br/>    # stdout if we ever want to see anything<br/>    , 'Stream_Output':        'True'<br/>    #, 'Stream_Error':         'True'<br/><br/>    # using MY.Arguments instead of Arguments lets the value be a classad<br/>    # expression instead of a string. Thanks TJ!<br/>    , 'MY.Arguments':<br/>        'strcat( MY.DaskSchedulerAddress'<br/>        # can't name a worker if we have more than one proc, in which case<br/>        # we don't need a nanny<br/>        '      , " --nprocs=1"'<br/>        '      , " --no-nanny"'<br/>        '      , " --nthreads=", MY.DaskNThreads'<br/>        '      , " --no-bokeh"'<br/>        # default memory limit is 75% of memory;<br/>        # use 75% of RequestMemory instead<br/>        '      , " --memory-limit="'<br/>        '      , floor(RequestMemory * 1048576 * 0.75)'<br/>        '      , " --name=", MY.DaskWorkerName'<br/>        '      )'<br/><br/>    , 'MY.DaskWorkerName':    '"htcondor-$F(MY.JobId)"'<br/><br/>    , 'RequestCpus':          'MY.DaskNThreads'<br/><br/>    , 'Periodic_Hold':<br/>        '((time() - EnteredCurrentStatus) &gt; MY.DaskWorkerTimeout) &amp;&amp;'<br/>        ' (JobStatus == 2)'<br/>    , 'Periodic_Hold_Reason': 'strcat("dask-worker exceeded max lifetime of ",'<br/>                              '       interval(MY.DaskWorkerTimeout))'<br/>    , 'Transfer_Input_Files': ''<br/>    , 'MY.JobId':             '"$(ClusterId).$(ProcId)"'<br/>    }</pre><br/>(pardon the weird formatting)<br/>
<span style="color: #684b6c"><span style="font-size: small">(09:25:45)</span> <b>bbockelman:</b></span> The old interface is pure classads.  The new interface is the same library as condor_submit.<br/>
<span style="color: #684b6c"><span style="font-size: small">(09:25:55)</span> <b>bbockelman:</b></span> I would be surprised if macro substitution doesn't work for the new interface.<br/>
<span style="color: #4cc091"><span style="font-size: small">(09:55:20)</span> <b>blin:</b></span> oh, i stand corrected! so that's an 8.9/9.0 change?<br/>
<span style="color: #99a949"><span style="font-size: small">(09:55:36)</span> <b>matyas:</b></span> I think I did that in 8.7<br/>
<span style="color: #99a949"><span style="font-size: small">(09:56:05)</span> <b>matyas:</b></span> (that code's four years old)<br/>
<span style="color: #d58247"><span style="font-size: small">(09:56:40)</span> <b>gthain:</b></span> Also HTCondor -- this year we can now use C++11 features!<br/>
<span style="color: #16569E"><span style="font-size: small">(09:57:20)</span> <b>edquist:</b></span> which also means that traditional C uses of the <tt>auto</tt> keyword are now syntax errors!<br/>
<span style="color: #16569E"><span style="font-size: small">(09:57:30)</span> <b>edquist:</b></span> lol<br/>
<span style="color: #16569E"><span style="font-size: small">(09:57:44)</span> <b>edquist:</b></span> good riddens though<br/>
<span style="color: #d58247"><span style="font-size: small">(09:58:08)</span> <b>gthain:</b></span> Pretty sure we've still got some uses of <tt>register</tt><br/>
<span style="color: #2b6836"><span style="font-size: small">(10:00:51)</span> <b>jcpatton:</b></span> the dedicated scheduler sadness continues<br/>
<span style="color: #235e5b"><span style="font-size: small">(10:07:07)</span> <b>johnkn:</b></span> if you use the python bindings submit object, then you are using the submit language and $() expansions work.<br/>
<span style="color: #235e5b"><span style="font-size: small">(10:08:13)</span> <b>johnkn:</b></span> Rrior to 9.0 the old schedd.submit() method would take a job classad as input, and which is post-submit language,  but as of 9.0 the first argument to that method can be a submit object *or* a raw job classad.<br/>
<span style="color: #99a949"><span style="font-size: small">(10:09:31)</span> <b>matyas:</b></span> I used<br/><pre>with schedd.transaction() as txn:<br/>    job.queue(txn, ...)</pre><br/>to submit<br/>
<span style="color: #235e5b"><span style="font-size: small">(10:10:06)</span> <b>johnkn:</b></span> That interface only accepts the submit object which is submit language<br/>
<span style="color: #235e5b"><span style="font-size: small">(10:10:49)</span> <b>johnkn:</b></span> But it is now deprecated because it's impossible for us to make <tt>with transaction</tt> thread safe.<br/>
<span style="color: #235e5b"><span style="font-size: small">(10:11:33)</span> <b>johnkn:</b></span> you should now use<br/><pre>schedd.submit(job, ...)</pre><br/>where job is the same object you use above.<br/>
<span style="color: #235e5b"><span style="font-size: small">(10:18:11)</span> <b>johnkn:</b></span> To be clear, if job is of class <tt>htcondor.Submit</tt>, then this is just like using <tt>condor_submit</tt>.  you can use $() substitution<br/><pre>job = htcondor.Submit({"executable":"/bin/echo", "arguments":"$(ProcId)"})</pre><br/>If job is a classad,  then you cannot use $() substitution,  but you can still use $$() substitution<br/>
<span style="color: #235e5b"><span style="font-size: small">(10:20:14)</span> <b>johnkn:</b></span> Tell IHEP we need to see their code,  because what they want to do is supported, they are probably just doing it wrong...<br/>
<span style="color: #235e5b"><span style="font-size: small">(10:39:55)</span> <b>johnkn:</b></span> Are we meeting?<br/>
<span style="color: #9b3b45"><span style="font-size: small">(10:40:44)</span> <b>jfrey:</b></span> We just adjourned.<br/>
<span style="color: #9b3b45"><span style="font-size: small">(10:41:06)</span> <b>jfrey:</b></span> Mark, Jason, and I were the only ones there.<br/>
<span style="color: #235e5b"><span style="font-size: small">(10:41:57)</span> <b>johnkn:</b></span> ah,  ok.<br/>
<span style="color: #99a949"><span style="font-size: small">(16:04:36)</span> <b>matyas:</b></span> @jfrey we've got an issue with a CE where the BLAHP thinks the remote job ID is always "2"<br/><a href="http://pages.cs.wisc.edu/~matyas/frontera-condor-ce-log/">http://pages.cs.wisc.edu/~matyas/frontera-condor-ce-log/</a><br/>do you have any ideas?<br/>
<span style="color: #99a949"><span style="font-size: small">(16:07:50)</span> <b>matyas:</b></span> nvm<br/>
<span style="color: #99a949"><span style="font-size: small">(16:08:21)</span> <b>matyas:</b></span> figured it out<br/>
<span style="color: #99a949"><span style="font-size: small">(16:08:53)</span> <b>matyas:</b></span> (we have an old version of slurm_submit.sh)<br/>
<span style="color: #9b3b45"><span style="font-size: small">(16:13:30)</span> <b>jfrey:</b></span> Good to hear. I was just about to pepper you with questions.<br/>
<span style="color: #99a949"><span style="font-size: small">(16:42:38)</span> <b>matyas:</b></span> do you know if the blahp skips passing <tt>-m</tt> to slurm_submit.sh if I unset RequestMemory in the routed job? (looking at <a href="https://github.com/htcondor/BLAH/blob/devel/src/server.c#L1323">https://github.com/htcondor/BLAH/blob/devel/src/server.c#L1323</a>).<br/>TACC forbids <tt>--mem</tt> in the submit file but to actually omit it, <tt>$bls_opt_req_mem</tt> must be blank<br/>
<span style="color: #9b3b45"><span style="font-size: small">(16:45:36)</span> <b>jfrey:</b></span> Yes, if RequestMemory isn’t in the condor grid universe job ad, then the blahp won’t pass -m to slurm_submit.sh<br/>
<span style="color: #9b3b45"><span style="font-size: small">(16:46:33)</span> <b>jfrey:</b></span> And slurm_submit.sh won’t pass --mem to sbatch.<br/>
<span style="color: #99a949"><span style="font-size: small">(16:47:07)</span> <b>matyas:</b></span> cool, thanks<br/>
<span style="color: #d58247"><span style="font-size: small">(20:56:34)</span> <b>gthain:</b></span> The condor test strike force continues our work, but we're seeing an intermittent problem with shutting down the master of a personal condor<br/>
<span style="color: #d58247"><span style="font-size: small">(20:56:39)</span> <b>gthain:</b></span> What happens is<br/>
<span style="color: #d58247"><span style="font-size: small">(20:56:48)</span> <b>gthain:</b></span> 1. master gets fast shutdown<br/>2. master sends SIGQUIT to all child processes<br/>3. master waits for reapers to fire for all of above<br/>4. when last reaper fires, master exits<br/>
<span style="color: #d58247"><span style="font-size: small">(20:58:36)</span> <b>gthain:</b></span> Problems are happening when some other daemon core callback fires after #2 but before #4, especially if that callback requires communication with the collector we killed<br/>
<span style="color: #d58247"><span style="font-size: small">(20:59:03)</span> <b>gthain:</b></span> The test suite waits up to 120 seconds for the master to exit, and if it doesn't, declares the test failed<br/>
<span style="color: #d58247"><span style="font-size: small">(20:59:39)</span> <b>gthain:</b></span> Possible solutions off the top of my head:<br/>
<span style="color: #d58247"><span style="font-size: small">(21:01:14)</span> <b>gthain:</b></span> 1. have the master SIGQUIT everyone then immediately exit.  Hope that init reaps the zombies<br/>2. If the master has a COLLECTOR, don't SIGQUIT it until after all the other reapers have fired<br/>3. When we get SIGQUIT, close our daemon core command socket (LA LA LA I'm not listening to you) (still have problems with timers)<br/>4. Have the test suite declare an undead master as not an error<br/>5. Have the test suite SIGQUIT the master, then SIGKILL the master five seconds later<br/><br/>
<span style="color: #9e3997"><span style="font-size: small">(21:32:41)</span> <b>tlmiller:</b></span> 6.  When we get SIGQUIT, close the daemon core command socket, unregister all timers and delete all callbacks (except for the signal handlers necessary to do clean shutdowns)?<br/>
<span style="color: #9e3997"><span style="font-size: small">(21:33:47)</span> <b>tlmiller:</b></span> (Problem with 1: what if SIGQUIT fails to kill a process?)<br/>
<span style="color: #9e3997"><span style="font-size: small">(21:36:48)</span> <b>tlmiller:</b></span> (I'd suspect 4 of potentially hiding real problems, but I don't know if there's a real reason for that.  Ditto for 5, with the additional sadness of making the HTCondor-under-test even less like a HTCondor-in-production.  I think 2 is insufficiently ordered, because nothing can talk to the collector after the shared port daemon is dead.)<br/>
<span style="color: #9e3997"><span style="font-size: small">(21:37:45)</span> <b>tlmiller:</b></span> (Now, if <tt>condor_off -fast-and-silent</tt> were a thing implementing 5...)<br/>
<span style="color: #9e3997"><span style="font-size: small">(21:38:04)</span> <b>tlmiller:</b></span> (I guess it should kill the master's whole group, etc...)<br/>
<span style="color: #d58247"><span style="font-size: small">(21:38:40)</span> <b>gthain:</b></span> A quick implementation of 6 would be "When master gets SIGQUIT, send SIGQUIT to all kids.  Don't return to daemon core.  In that same function, go into a loop, waiting for, uh, 20 seconds to reap all kids.  After 20 seconds, kill -9 all kids then exit<br/>
<span style="color: #d58247"><span style="font-size: small">(21:38:50)</span> <b>gthain:</b></span> <tt>condor_off --quick-and-the-dead</tt><br/>
<span style="color: #9e3997"><span style="font-size: small">(21:39:49)</span> <b>tlmiller:</b></span> I kind of like that quick-and-dirty hack for 6.  Seems like something we could implement really quickly and see how well it worked.<br/>
<span style="color: #9e3997"><span style="font-size: small">(21:41:26)</span> <b>tlmiller:</b></span> (Determining "all kids" may be tricky, unless you mean "only immediate children," or maybe cache the result from the procd after SIGQUIT'ing all direct kids (but before SIGKILLing (QUITing?) the procd. -- Assuming the master doesn't have to go through the event loop for the procd.)<br/>
<span style="color: #d58247"><span style="font-size: small">(21:42:44)</span> <b>gthain:</b></span> I think procapi has a "kill all descendants" method<br/>
<span style="color: #9e3997"><span style="font-size: small">(21:43:41)</span> <b>tlmiller:</b></span> It probably does, which I guess means just being careful about not killing the procd until all the kids have been reaped or 20 seconds have passed.  But that shouldn't be too hard.<br/>
<span style="color: #9e3997"><span style="font-size: small">(21:43:42)</span> <b>tlmiller:</b></span> Anyway, gotta go.  Will probably see y'all tomorrow.<br/>
<span style="color: #d58247"><span style="font-size: small">(21:43:57)</span> <b>gthain:</b></span> Not if I see my shadow<br/>
</body>
</html>
