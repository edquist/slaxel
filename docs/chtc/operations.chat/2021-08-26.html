<!DOCTYPE html>
<html>
<head>
<title>Thu Aug 26, 2021 : #operations (chtc)</title>
</head>
<body>
<h3>Thu Aug 26, 2021 : #operations (chtc)</h3>
<span style="color: #e7392d"><span style="font-size: small">(12:33:01)</span> <b>ckoch5:</b></span> I’m reenabling <tt>hguo84</tt><br/>
<span style="color: #99a949"><span style="font-size: small">(13:29:18)</span> <b>matyas:</b></span> fyi, updated condor on osg-sw-submit (it was versionlocked at 9.1.0)<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:13:52)</span> <b>bbockelman:</b></span> @wiscmoate - speaking of which, probably time to remove my Duo exemption!  :tada:<br/>
<span style="color: #e7392d"><span style="font-size: small">(14:14:29)</span> <b>ckoch5:</b></span> Miron is right - we should follow up w/ offline to make sure that expired accounts are truly deactivated.<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:16:40)</span> <b>bbockelman:</b></span> Yes - I don't think they are TBH.<br/>
<span style="color: #e7392d"><span style="font-size: small">(14:18:03)</span> <b>ckoch5:</b></span> yeah, I said that and then was like…I don’t know what happens to the account after they “expire”…<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:25:50)</span> <b>bbockelman:</b></span> (for example, the chtc pubkey will still work...)<br/>
<span style="color: #e7392d"><span style="font-size: small">(14:26:22)</span> <b>ckoch5:</b></span> will it though, through the firewall?<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:27:06)</span> <b>bbockelman:</b></span> :wink: if you can't find a way through the tens of thousands of IPs allowed, you're a lazy hacker.<br/>
<span style="color: #e7392d"><span style="font-size: small">(14:27:24)</span> <b>ckoch5:</b></span> i mean, without any extra effort<br/>
<span style="color: #3c989f"><span style="font-size: small">(14:41:18)</span> <b>wiscmoate:</b></span> @bbockelman how about other Morgridge employees?<br/>
<span style="color: #3c989f"><span style="font-size: small">(14:41:24)</span> <b>wiscmoate:</b></span> (re: DUO-MFA)<br/>
<span style="color: #3c989f"><span style="font-size: small">(14:41:32)</span> <b>wiscmoate:</b></span> Remove exemption?<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:57:50)</span> <b>bbockelman:</b></span> Who else do we have?  But yes, one-by-one...<br/>
<span style="color: #684b6c"><span style="font-size: small">(14:58:07)</span> <b>bbockelman:</b></span> (Christina might need to add them to the external-users manifest)<br/>
<span style="color: #3c989f"><span style="font-size: small">(15:03:50)</span> <b>wiscmoate:</b></span> @bbockelman :<br/>• <tt>baydemir</tt><br/>• <tt>bbockelm</tt><br/>• <tt>jnpeterson</tt><br/>• <tt>kramer</tt><br/>• <tt>tura</tt><br/>
<span style="color: #99a949"><span style="font-size: small">(15:10:00)</span> <b>matyas:</b></span> Cannon?<br/>
<span style="color: #3c989f"><span style="font-size: small">(15:14:48)</span> <b>wiscmoate:</b></span> Never put him on the list<br/>
<span style="color: #3c989f"><span style="font-size: small">(15:15:06)</span> <b>wiscmoate:</b></span> I'm not sure he SSHes (verb) into CHTC hosts very often<br/>
<span style="color: #235e5b"><span style="font-size: small">(16:29:53)</span> <b>johnkn:</b></span> This is bad...<br/><pre>[johnkn@gpulab2004 ~]$ /usr/libexec/condor/condor_gpu_discovery -extra -diag<br/>diag: using nvcuda for gpu discovery<br/>Error: cuInit returned 3<br/>Segmentation fault</pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(16:31:34)</span> <b>johnkn:</b></span> error 3 is : cudaErrorInitializationError - CUDA driver and runtime could not be initialized<br/>
<span style="color: #235e5b"><span style="font-size: small">(16:33:31)</span> <b>johnkn:</b></span> the segfault is a bug in gpu discovery when it detects 0 devices,  I have a patch for it already, but error 3 indicates that there is a problem other than just something in gpu discovery<br/>
<span style="color: #235e5b"><span style="font-size: small">(16:37:32)</span> <b>johnkn:</b></span> <pre>[johnkn@gpulab2004 ~]$ nvidia-smi<br/>Thu Aug 26 16:35:49 2021<br/>+-----------------------------------------------------------------------------+<br/>| NVIDIA-SMI 460.32.03    Driver Version: 460.32.03    CUDA Version: 11.2     |<br/>|-------------------------------+----------------------+----------------------+<br/>| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |<br/>| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |<br/>|                               |                      |               MIG M. |<br/>|===============================+======================+======================|<br/>|   0  A100-SXM4-40GB      Off  | 00000000:01:00.0 Off |                   On |<br/>| N/A   24C    P0    40W / 400W |      0MiB / 40536MiB |     N/A      Default |<br/>|                               |                      |              Enabled |<br/>+-------------------------------+----------------------+----------------------+<br/>|   1  A100-SXM4-40GB      Off  | 00000000:41:00.0 Off |                   On |<br/>| N/A   25C    P0    41W / 400W |      0MiB / 40536MiB |     N/A      Default |<br/>|                               |                      |              Enabled |<br/>+-------------------------------+----------------------+----------------------+<br/>|   2  A100-SXM4-40GB      Off  | 00000000:81:00.0 Off |                   On |<br/>| N/A   23C    P0    40W / 400W |      0MiB / 40536MiB |     N/A      Default |<br/>|                               |                      |              Enabled |<br/>+-------------------------------+----------------------+----------------------+<br/>|   3  A100-SXM4-40GB      Off  | 00000000:C1:00.0 Off |                   On |<br/>| N/A   23C    P0    41W / 400W |      0MiB / 40536MiB |     N/A      Default |<br/>|                               |                      |              Enabled |<br/>+-------------------------------+----------------------+----------------------+<br/><br/>+-----------------------------------------------------------------------------+<br/>| MIG devices:                                                                |<br/>+------------------+----------------------+-----------+-----------------------+<br/>| GPU  GI  CI  MIG |         Memory-Usage |        Vol|         Shared        |<br/>|      ID  ID  Dev |           BAR1-Usage | SM     Unc| CE  ENC  DEC  OFA  JPG|<br/>|                  |                      |        ECC|                       |<br/>|==================+======================+===========+=======================|<br/>|  No MIG devices found                                                       |<br/>+-----------------------------------------------------------------------------+<br/><br/>+-----------------------------------------------------------------------------+<br/>| Processes:                                                                  |<br/>|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |<br/>|        ID   ID                                                   Usage      |<br/>|=============================================================================|<br/>|  No running processes found                                                 |<br/>+-----------------------------------------------------------------------------+</pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(16:38:21)</span> <b>johnkn:</b></span> so perhaps that the problem is that you put *all* of the GPUs into MIG mode, but did not create any MIG devices<br/>
<span style="color: #235e5b"><span style="font-size: small">(16:39:27)</span> <b>johnkn:</b></span> I suggest two things.  put only *one* of the A100's into MIG mode for now, use the last device,  and split that one up into 2 MIG partitions<br/>
<span style="color: #3c989f"><span style="font-size: small">(16:46:34)</span> <b>wiscmoate:</b></span> @eturatsinze :arrow_up: please<br/>
<span style="color: #235e5b"><span style="font-size: small">(16:57:44)</span> <b>johnkn:</b></span> btw.  the nvidia user guide has this to day about MIG partitions.<br/><pre>Without creating GPU instances (and corresponding compute instances), CUDA workloads cannot be run on the GPU. In other words, simply enabling MIG mode on the GPU is not sufficient. Also note that, the created MIG devices are not persistent across system reboots. Thus, the user or system administrator needs to recreate the desired MIG configurations if the GPU or system is reset. For automated tooling support for this purpose, refer to the NVIDIA MIG Partition Editor (or mig-parted) tool.</pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(16:57:47)</span> <b>johnkn:</b></span> &lt;sigh&gt;<br/>
<span style="color: #c386df"><span style="font-size: small">(17:08:30)</span> <b>eturatsinze:</b></span> Looks like the mig-parted systemd implementation <a href="https://github.com/NVIDIA/mig-parted/tree/master/deployments/systemd">https://github.com/NVIDIA/mig-parted/tree/master/deployments/systemd</a> addresses persistence across reboots.Definitely something to further look into<br/>
<span style="color: #235e5b"><span style="font-size: small">(17:08:57)</span> <b>johnkn:</b></span> that's good.<br/>
<span style="color: #c386df"><span style="font-size: small">(17:12:25)</span> <b>eturatsinze:</b></span> I have the changes requested above in place - Using the last A100 and split into 2 MIG part<br/>
<span style="color: #235e5b"><span style="font-size: small">(17:12:51)</span> <b>johnkn:</b></span> yep, I see that via nvida-smi now<br/>
<span style="color: #235e5b"><span style="font-size: small">(17:15:00)</span> <b>johnkn:</b></span> gpu discovery is unhappy.<br/><pre>[johnkn@gpulab2004 ~]$ /usr/libexec/condor/condor_gpu_discovery -extra<br/>Failed to enumerate MIG devices (6: Not Found), aborting.</pre><br/>but my patched version is working<br/><pre>[johnkn@gpulab2004 ~]$ ./condor_gpu_discovery -extra<br/>DetectedGPUs="MIG-GPU-20e62ffc-155e-49ad-04e1-ffacfc109ce3/1/0, MIG-GPU-20e62ffc-155e-49ad-04e1-ffacfc109ce3/2/0, GPU-124d06a7, GPU-c6cfdc9c, GPU-8f9c2d75"<br/>CUDADriverVersion=11.20<br/>CUDAMaxSupportedVersion=11020<br/>GPU_124d06a7Capability=8.0<br/>GPU_124d06a7ClockMhz=1410.00<br/>GPU_124d06a7CoresPerCU=64<br/>GPU_124d06a7DeviceName="A100-SXM4-40GB"<br/>GPU_124d06a7DevicePciBusId="0000:01:00.0"<br/>GPU_124d06a7DeviceUuid="GPU-124d06a7-6642-3962-9afa-c86c31b9a7e6"<br/>GPU_124d06a7ECCEnabled=true<br/>GPU_124d06a7GlobalMemoryMb=40536<br/>GPU_8f9c2d75Capability=8.0<br/>GPU_8f9c2d75ClockMhz=1410.00<br/>GPU_8f9c2d75CoresPerCU=64<br/>GPU_8f9c2d75DeviceName="A100-SXM4-40GB"<br/>GPU_8f9c2d75DevicePciBusId="0000:81:00.0"<br/>GPU_8f9c2d75DeviceUuid="GPU-8f9c2d75-1b7d-5026-b177-283d13ddbb90"<br/>GPU_8f9c2d75ECCEnabled=true<br/>GPU_8f9c2d75GlobalMemoryMb=40536<br/>GPU_c6cfdc9cCapability=8.0<br/>GPU_c6cfdc9cClockMhz=1410.00<br/>GPU_c6cfdc9cCoresPerCU=64<br/>GPU_c6cfdc9cDeviceName="A100-SXM4-40GB"<br/>GPU_c6cfdc9cDevicePciBusId="0000:41:00.0"<br/>GPU_c6cfdc9cDeviceUuid="GPU-c6cfdc9c-63df-c5b3-3605-7bc4b2545434"<br/>GPU_c6cfdc9cECCEnabled=true<br/>GPU_c6cfdc9cGlobalMemoryMb=40536<br/>MIG_GPU_20e62ffc_155e_49ad_04e1_ffacfc109ce3_1_0ComputeUnits=42<br/>MIG_GPU_20e62ffc_155e_49ad_04e1_ffacfc109ce3_1_0DeviceUuid="MIG-GPU-20e62ffc-155e-49ad-04e1-ffacfc109ce3/1/0"<br/>MIG_GPU_20e62ffc_155e_49ad_04e1_ffacfc109ce3_1_0GlobalMemoryMb=20087<br/>MIG_GPU_20e62ffc_155e_49ad_04e1_ffacfc109ce3_2_0ComputeUnits=42<br/>MIG_GPU_20e62ffc_155e_49ad_04e1_ffacfc109ce3_2_0DeviceUuid="MIG-GPU-20e62ffc-155e-49ad-04e1-ffacfc109ce3/2/0"<br/>MIG_GPU_20e62ffc_155e_49ad_04e1_ffacfc109ce3_2_0GlobalMemoryMb=20090</pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(17:23:53)</span> <b>johnkn:</b></span> <pre>[johnkn@gpulab2004 ~]$ tail -f <tt>condor_config_val master_log</tt><br/>08/26/21 17:06:30 (D_ALWAYS) restarting /usr/sbin/condor_startd in 265 seconds<br/>08/26/21 17:10:55 (D_ALWAYS) Started DaemonCore process "/usr/sbin/condor_startd", pid and pgroup = 10650<br/>08/26/21 17:10:58 (D_ALWAYS) DefaultReaper unexpectedly called on pid 10650, status 134.<br/>08/26/21 17:10:58 (D_ALWAYS|D_FAILURE) The STARTD (pid 10650) died due to signal 6 (Aborted)<br/>08/26/21 17:10:58 (D_ALWAYS) restarting /usr/sbin/condor_startd in 521 seconds</pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(17:24:15)</span> <b>johnkn:</b></span> I think we should dump my patched condor_gpu_discovery into libexec<br/>
<span style="color: #c386df"><span style="font-size: small">(17:26:34)</span> <b>eturatsinze:</b></span> I've disabled puppet on the machine for now, you can go ahead and dump it in there. I'll puppet it later<br/>
<span style="color: #235e5b"><span style="font-size: small">(17:26:43)</span> <b>johnkn:</b></span> ok<br/>
<span style="color: #235e5b"><span style="font-size: small">(17:28:51)</span> <b>johnkn:</b></span> done and I restarted the startd<br/>
<span style="color: #235e5b"><span style="font-size: small">(17:29:40)</span> <b>johnkn:</b></span> <pre>[johnkn@gpulab2004 ~]$ condor_status gpulab2004 -const PartitionableSlot -af name AssignedGPUs<br/><a href="mailto:slot1@gpulab2004.chtc.wisc.edu">slot1@gpulab2004.chtc.wisc.edu</a> MIG-GPU-20e62ffc-155e-49ad-04e1-ffacfc109ce3/1/0,MIG-GPU-20e62ffc-155e-49ad-04e1-ffacfc109ce3/2/0,GPU-124d06a7,GPU-c6cfdc9c</pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(17:32:47)</span> <b>johnkn:</b></span> oh, interesting.   the config is only assigning 4 GPUs so now that one of the GPUs is 2 MIGs, the last A100 is not being assigned.<br/>
<span style="color: #235e5b"><span style="font-size: small">(17:38:08)</span> <b>johnkn:</b></span> yep.  the config has a hard-coded number of resources.<br/><pre>[johnkn@gpulab2004 ~]$ condor_config_val -v _detected_gpus<br/>_DETECTED_GPUS = 4<br/> # at: /etc/condor/hosts/gpulab2004.chtc.wisc.edu.local, line 5<br/> # raw: _DETECTED_GPUS = 4<br/><br/>[johnkn@gpulab2004 ~]$  /usr/libexec/condor/condor_gpu_discovery -config<br/>DetectedGPUs=MIG-GPU-20e62ffc-155e-49ad-04e1-ffacfc109ce3/1/0, MIG-GPU-20e62ffc-155e-49ad-04e1-ffacfc109ce3/2/0, GPU-124d06a7, GPU-c6cfdc9c, GPU-8f9c2d75<br/>NUM_DETECTED_GPUs=5</pre><br/>but discovery sees 1 more.  and it also floats the 2 MIG devices to the start of the list, which is somewhat unfortunate.<br/>
<span style="color: #235e5b"><span style="font-size: small">(17:40:27)</span> <b>johnkn:</b></span> Always more work.  But I'm conditionally happy with where we are now.  Thanks for the quick turnaround Emile!<br/>
</body>
</html>
