<!DOCTYPE html>
<html>
<head>
<title>Fri Feb 5, 2021 : #icecube-condor (osg)</title>
</head>
<body>
<h3>Fri Feb 5, 2021 : #icecube-condor (osg)</h3>
<span style="color: #827327"><span style="font-size: small">(11:43:34)</span> <b>jamie.rajewski:</b></span> Okay, I added those options for the respective <tt>condor_config.local</tt> and I also added <tt>IDTOKENS</tt> to the auth lists rather than replacing anything. I'm going to start up the CM first now and run the <tt>condor_token_request_auto_approve...</tt> command<br/>
<span style="color: #827327"><span style="font-size: small">(11:46:35)</span> <b>jamie.rajewski:</b></span> I got the following on the CM:<br/><pre>ubuntu@test-condor-cm-v2:~$ condor_token_request_auto_approve -netblock 192.168.0.0/24 -lifetime 3600<br/>Successfully installed auto-approval rule for netblock 192.168.0.0/24 with lifetime of 1.00 hours<br/>Failed to list remaining token requests: DAEMON:1:Failed to start command for listing token requests with remote daemon at '&lt;192.168.254.17:9618&gt;'.|AUTHENTICATE:1003:Failed to authenticate with any method|AUTHENTICATE:1004:Failed to authenticate using PASSWORD</pre><br/>for reference, my security config looks like<br/><pre>SEC_PASSWORD_FILE = /etc/condor/passwords.d/POOL<br/>SEC_DAEMON_AUTHENTICATION = REQUIRED<br/>SEC_DAEMON_INTEGRITY = REQUIRED<br/>SEC_DAEMON_AUTHENTICATION_METHODS = IDTOKENS, PASSWORD<br/>SEC_NEGOTIATOR_AUTHENTICATION = REQUIRED<br/>SEC_NEGOTIATOR_INTEGRITY = REQUIRED<br/>SEC_NEGOTIATOR_AUTHENTICATION_METHODS = IDTOKENS, PASSWORD<br/>SEC_CLIENT_AUTHENTICATION_METHODS = FS, IDTOKENS, PASSWORD, KERBEROS, GSI<br/>ALLOW_DAEMON = condor_pool@*/*, condor@*/$(IP_ADDRESS)<br/>ALLOW_NEGOTIATOR = condor_pool@*/condor-cm.example.com</pre><br/><br/>
<span style="color: #c386df"><span style="font-size: small">(11:47:34)</span> <b>matyas:</b></span> so this is before you started up any of the other hosts?<br/>
<span style="color: #827327"><span style="font-size: small">(11:47:46)</span> <b>jamie.rajewski:</b></span> yep<br/>
<span style="color: #827327"><span style="font-size: small">(11:47:58)</span> <b>jamie.rajewski:</b></span> I installed the configs and got them set up but have not start them yet<br/>
<span style="color: #c386df"><span style="font-size: small">(11:47:59)</span> <b>matyas:</b></span> so nothing's even trying to talk to it yet?<br/>
<span style="color: #827327"><span style="font-size: small">(11:48:03)</span> <b>jamie.rajewski:</b></span> No<br/>
<span style="color: #827327"><span style="font-size: small">(11:48:29)</span> <b>jamie.rajewski:</b></span> This remote daemon thing is referencing the central manager itself<br/>
<span style="color: #c386df"><span style="font-size: small">(11:48:51)</span> <b>matyas:</b></span> can you prepend FS to the auth methods?<br/>
<span style="color: #827327"><span style="font-size: small">(11:49:31)</span> <b>jamie.rajewski:</b></span> sure<br/>
<span style="color: #c386df"><span style="font-size: small">(11:49:39)</span> <b>matyas:</b></span> daemons should use FS to talk to each other on the same host; simpler that way<br/>
<span style="color: #827327"><span style="font-size: small">(11:49:59)</span> <b>jamie.rajewski:</b></span> Yea that makes sense<br/>
<span style="color: #827327"><span style="font-size: small">(11:51:08)</span> <b>jamie.rajewski:</b></span> alright, after adding FS to the auth methods, I get<br/><pre>ubuntu@test-condor-cm-v2:~$ condor_token_request_auto_approve -netblock 192.168.0.0/24 -lifetime 3600<br/>Successfully installed auto-approval rule for netblock 192.168.0.0/24 with lifetime of 1.00 hours<br/>Remote daemon reports no un-approved requests pending.</pre><br/>so that looks good so far<br/>
<span style="color: #827327"><span style="font-size: small">(11:52:08)</span> <b>jamie.rajewski:</b></span> I'll start up the schedd now and see what happens<br/>
<span style="color: #827327"><span style="font-size: small">(11:54:07)</span> <b>jamie.rajewski:</b></span> I started the schedd<br/><pre>ubuntu@test-condor-sub-v2:~$ sudo systemctl enable condor<br/>Created symlink /etc/systemd/system/multi-user.target.wants/condor.service → /lib/systemd/system/condor.service.<br/>ubuntu@test-condor-sub-v2:~$ sudo systemctl start condor</pre><br/>I'll check the logs and see if it connected<br/>
<span style="color: #827327"><span style="font-size: small">(11:56:58)</span> <b>jamie.rajewski:</b></span> The <tt>MasterLog</tt> on the schedd says<br/><pre>02/05/21 17:53:00 ERROR: AUTHENTICATE:1003:Failed to authenticate with any method|AUTHENTICATE:1004:Failed to authenticate using PASSWORD|AUTHENTICATE:1004:Failed to authenticate using FS<br/>02/05/21 17:53:00 Collector update failed; will try to get a token request for trust domain 192.168.254.17, identity (default).<br/>02/05/21 17:53:00 Failed to start non-blocking update to &lt;192.168.254.17:9618&gt;.<br/>02/05/21 17:53:00 read_password_from_filename(): read_secure_file(/etc/condor/passwords.d/POOL) failed!<br/>02/05/21 17:53:00 read_password_from_filename(): read_secure_file(/etc/condor/passwords.d/POOL) failed!<br/>02/05/21 17:53:00 SECMAN: required authentication with collector 192.168.254.17 failed, so aborting command DC_START_TOKEN_REQUEST.<br/>02/05/21 17:53:00 Failed to request a new token: DAEMON:1:failed to start command for token request with remote daemon at '&lt;192.168.254.17:9618&gt;'.|AUTHENTICATE:1003:Failed to authenticate with any method|AUTHENTICATE:1004:Failed to authenticate using PASSWORD|AUTHENTICATE:1004:Failed to authenticate using FS</pre><br/>I had added FS to the start of the security config just to keep them all the same, but it seems to have failed due to that. If it has a list, isn't it supposed to try the next method (which here would be IDTOKENS)?<br/>
<span style="color: #43761b"><span style="font-size: small">(11:58:45)</span> <b>blin:</b></span> depends where the failure is: if it's in the authentication layer, it should move onto the next item in the list<br/>
<span style="color: #43761b"><span style="font-size: small">(11:58:55)</span> <b>blin:</b></span> however, if it fails in the authorization layer, then it'll be a terminal failure<br/>
<span style="color: #43761b"><span style="font-size: small">(12:00:26)</span> <b>blin:</b></span> it looks like it's trying multiple authentication types, though because it fails PASSWORD as well as FS<br/>
<span style="color: #827327"><span style="font-size: small">(12:01:22)</span> <b>jamie.rajewski:</b></span> Yea, which is strange because it should've tried tokens before password<br/><pre>SEC_PASSWORD_FILE = /etc/condor/passwords.d/POOL<br/>SEC_DAEMON_AUTHENTICATION = REQUIRED<br/>SEC_DAEMON_INTEGRITY = REQUIRED<br/>SEC_DAEMON_AUTHENTICATION_METHODS = FS, IDTOKENS, PASSWORD<br/>SEC_NEGOTIATOR_AUTHENTICATION = REQUIRED<br/>SEC_NEGOTIATOR_INTEGRITY = REQUIRED<br/>SEC_NEGOTIATOR_AUTHENTICATION_METHODS = FS, IDTOKENS, PASSWORD<br/>SEC_CLIENT_AUTHENTICATION_METHODS = FS, IDTOKENS, PASSWORD, KERBEROS, GSI<br/>ALLOW_DAEMON = condor_pool@*/*, condor@*/$(IP_ADDRESS)<br/>ALLOW_NEGOTIATOR = condor_pool@*/condor-cm.example.com</pre><br/>In all of the auth types its that way<br/>
<span style="color: #43761b"><span style="font-size: small">(12:01:44)</span> <b>blin:</b></span> which host is that config for?<br/>
<span style="color: #827327"><span style="font-size: small">(12:02:09)</span> <b>jamie.rajewski:</b></span> Both, it was the CM but I copied it to the Schedd<br/>
<span style="color: #827327"><span style="font-size: small">(12:02:18)</span> <b>jamie.rajewski:</b></span> I imagine I can remove the FS from the schedd though<br/>
<span style="color: #827327"><span style="font-size: small">(12:06:54)</span> <b>jamie.rajewski:</b></span> I cut password out, and it looks like it is still just skipping tokens:<br/><pre>02/05/21 18:05:53 SECMAN: required authentication with collector 192.168.254.17 failed, so aborting command UPDATE_MASTER_AD.<br/>02/05/21 18:05:53 ERROR: AUTHENTICATE:1003:Failed to authenticate with any method|AUTHENTICATE:1004:Failed to authenticate using FS<br/>02/05/21 18:05:54 Collector update failed; will try to get a token request for trust domain 192.168.254.17, identity (default).<br/>02/05/21 18:05:54 Failed to start non-blocking update to &lt;192.168.254.17:9618&gt;.<br/>02/05/21 18:05:54 SECMAN: required authentication with collector 192.168.254.17 failed, so aborting command DC_START_TOKEN_REQUEST.<br/>02/05/21 18:05:54 Failed to request a new token: DAEMON:1:failed to start command for token request with remote daemon at '&lt;192.168.254.17:9618&gt;'.|AUTHENTICATE:1003:Failed to authenticate with any method|AUTHENTICATE:1004:Failed to authenticate using FS</pre><br/><br/>
<span style="color: #827327"><span style="font-size: small">(12:06:59)</span> <b>jamie.rajewski:</b></span> this is very strange<br/>
<span style="color: #827327"><span style="font-size: small">(12:08:53)</span> <b>jamie.rajewski:</b></span> If I only leave IDTOKENS as the authentication method for each, I get the following:<br/><pre>2/05/21 18:07:50 Adding SHARED_PORT to DAEMON_LIST, because USE_SHARED_PORT=true (to disable this, set AUTO_INCLUDE_SHARED_PORT_IN_DAEMON_LIST=False)<br/>02/05/21 18:07:50 Master restart (GRACEFUL) is watching /usr/sbin/condor_master (mtime:1609204587)<br/>02/05/21 18:07:50 Cannot remove wait-for-startup file /var/lock/condor/shared_port_ad<br/>02/05/21 18:07:50 Starting shared port with port: 9618<br/>02/05/21 18:07:50 SECMAN: failed to create non-negotiated security session d347ba0e40200bfac422dda216c275e63a9a390064e9d33a becauseReconcileSecurityPolicyAds() failed.<br/>02/05/21 18:07:50 ERROR: Create_Process failed to create security session for child daemon.<br/>02/05/21 18:07:50 ERROR: Create_Process failed trying to start /usr/lib/condor/libexec/condor_shared_port<br/>02/05/21 18:07:50 restarting /usr/lib/condor/libexec/condor_shared_port in 10 seconds<br/>02/05/21 18:07:50 SECMAN: failed to create non-negotiated security session 866dd4e0b5bea7e94938bdd28df51395e0bcd26b4ccb48ef becauseReconcileSecurityPolicyAds() failed.<br/>02/05/21 18:07:50 ERROR: Create_Process failed to create security session for child daemon.<br/>02/05/21 18:07:50 ERROR: Create_Process failed trying to start /usr/sbin/condor_schedd<br/>02/05/21 18:07:50 restarting /usr/sbin/condor_schedd in 10 seconds<br/>02/05/21 18:07:50 Daemons::StartAllDaemons all daemons were started<br/>02/05/21 18:07:50 SECMAN: no classad from server, failing<br/>02/05/21 18:07:50 ERROR: SECMAN:2007:Failed to end classad message.<br/>02/05/21 18:07:50 Failed to start non-blocking update to &lt;192.168.254.17:9618&gt;.<br/>02/05/21 18:07:55 SECMAN: no classad from server, failing<br/>02/05/21 18:07:55 ERROR: SECMAN:2007:Failed to end classad message.<br/>02/05/21 18:07:55 Failed to start non-blocking update to &lt;192.168.254.17:9618&gt;.<br/>02/05/21 18:08:00 Cannot remove wait-for-startup file /var/lock/condor/shared_port_ad<br/>02/05/21 18:08:00 Starting shared port with port: 9618<br/>02/05/21 18:08:00 SECMAN: failed to create non-negotiated security session 6fa232ae57cc1f8a53fd5a699aa97ed92f81f2e4c37caf8d becauseReconcileSecurityPolicyAds() failed.<br/>02/05/21 18:08:00 ERROR: Create_Process failed to create security session for child daemon.<br/>02/05/21 18:08:00 ERROR: Create_Process failed trying to start /usr/lib/condor/libexec/condor_shared_port<br/>02/05/21 18:08:00 restarting /usr/lib/condor/libexec/condor_shared_port in 11 seconds<br/>02/05/21 18:08:00 SECMAN: failed to create non-negotiated security session 9fd307b3e927950cab9d172b2b983fb846a2e8181c5a9341 becauseReconcileSecurityPolicyAds() failed</pre><br/>
<span style="color: #827327"><span style="font-size: small">(12:10:06)</span> <b>jamie.rajewski:</b></span> I imagine some of that is due to not being able to authenticate to the master on that node through FS, but I have no idea why IDTOKENS wouldn't show up here or in the previous log and it is seemingly skipped over<br/>
<span style="color: #c386df"><span style="font-size: small">(12:11:57)</span> <b>matyas:</b></span> well I'm not surprised that it's not trying to use an IDTOKEN when it's trying to acquire an IDTOKEN for the first time<br/>
<span style="color: #827327"><span style="font-size: small">(12:14:13)</span> <b>jamie.rajewski:</b></span> ah fair enough<br/>
<span style="color: #827327"><span style="font-size: small">(12:15:21)</span> <b>jamie.rajewski:</b></span> I assumed that meant "try token if you have one/ask for one if not". Still, according to the security quick start I shouldnt have had to make any changes to the security config for new condor instances to auto-authorize so I'm not sure how to proceed<br/>
<span style="color: #827327"><span style="font-size: small">(12:23:11)</span> <b>jamie.rajewski:</b></span> Perhaps this <tt>token_request_auto_approve</tt> is a new feature that may have some issues? I wonder if a condor dev has more insight into how to correctly use it<br/>
<span style="color: #43761b"><span style="font-size: small">(12:24:19)</span> <b>blin:</b></span> @zmiller would probably have a better idea of how this is all supposed to work<br/>
<span style="color: #43761b"><span style="font-size: small">(12:24:36)</span> <b>blin:</b></span> or @bbockelm<br/>
<span style="color: #902d59"><span style="font-size: small">(12:36:54)</span> <b>zmiller:</b></span> token_request_auto_approve is in fact a new feature and does in fact have some issues.<br/>
<span style="color: #902d59"><span style="font-size: small">(12:37:49)</span> <b>zmiller:</b></span> It mostly works but has some kind of gnarly config you need to add to make it useful. This is something we've been working on this week, to make it work "out of the box".<br/>
<span style="color: #827327"><span style="font-size: small">(12:39:57)</span> <b>jamie.rajewski:</b></span> oh, interesting! I figured that might be the case since this is of course the development release, but the docs made it seem like it was all ready to rock. I'm pretty excited for it as it will make deploying infrastructure incredibly easy<br/>
<span style="color: #902d59"><span style="font-size: small">(12:42:35)</span> <b>zmiller:</b></span> It's close.  To avoid frustration, I would manually create tokens for now with condor_token_create.  Or if want to go on an adventure, you could try adding the config pieces from here: <a href="https://htcondor-wiki.cs.wisc.edu/index.cgi/wiki?p=HowToUseIdtokens">https://htcondor-wiki.cs.wisc.edu/index.cgi/wiki?p=HowToUseIdtokens</a><br/><br/>But as the disclaimer says at the top of that page "not fully verified yet".<br/>
<span style="color: #902d59"><span style="font-size: small">(12:44:09)</span> <b>zmiller:</b></span> Plus the page may be updated yet.  And unfortunately I don't have much spare bandwidth today to work through any issues.  Monday I could though.<br/>
<span style="color: #827327"><span style="font-size: small">(12:44:54)</span> <b>jamie.rajewski:</b></span> Sure, I will do some testing. The alternative I tried before this was passwords by mounting a pool password into terraform and trying to fill it in similar to the quick start guide, but instead of <tt>sudo condor_store_cred add -c</tt> which wouldnt work in an automated terraform deployment, I opted for <tt>sudo condor_store_cred add -p [password file]</tt> but that resulted in a weird and different issue<br/>
<span style="color: #827327"><span style="font-size: small">(12:45:28)</span> <b>jamie.rajewski:</b></span> (which I can try to replicate, but I figured it wasnt worth the effort since tokens seem like the way to go for something like this)<br/>
<span style="color: #902d59"><span style="font-size: small">(12:46:09)</span> <b>zmiller:</b></span> maybe it was a typo but you still want the -c flag even if you use -p.<br/>
<span style="color: #902d59"><span style="font-size: small">(12:46:23)</span> <b>zmiller:</b></span> (for <tt>condor_store_cred</tt> )<br/>
<span style="color: #827327"><span style="font-size: small">(12:46:44)</span> <b>jamie.rajewski:</b></span> ah, perhaps that was it. I think I just missed that<br/>
<span style="color: #827327"><span style="font-size: small">(12:46:56)</span> <b>jamie.rajewski:</b></span> I see now it says "manage the pool password"<br/>
<span style="color: #902d59"><span style="font-size: small">(12:47:45)</span> <b>zmiller:</b></span> also, you can literally just write the password file yourself, you don't need to use condor_store_cred (on linux anyway).  As long as the contents of /etc/condor/passwords.d/POOL match on two machines, they should be able to authenticate using PASSWORD.<br/>
<span style="color: #902d59"><span style="font-size: small">(12:48:17)</span> <b>zmiller:</b></span> (and IDTOKENS for that matter... it falls back on using the pool password to create and sign a brand-new token on the fly)<br/>
<span style="color: #902d59"><span style="font-size: small">(12:49:12)</span> <b>zmiller:</b></span> (edited passwords.d  -- i had written it in the singular)<br/>
<span style="color: #827327"><span style="font-size: small">(12:55:31)</span> <b>jamie.rajewski:</b></span> Ah okay that makes sense, I only tried a few times before giving up on passwords as I was more keen on trying to get tokens to work but I might do that in the mean time if your above fixes don't do the trick just yet<br/>
<span style="color: #827327"><span style="font-size: small">(13:20:54)</span> <b>jamie.rajewski:</b></span> Quick update - I tried those configs, and it seems to work! I set each of the configs on their appropriate machines, started up the CM first and ran <tt>condor_token_request_auto_approve...</tt>  then started up the schedd and exec, and I can see the exec's slots from <tt>condor_status</tt> on the schedd. I will test a bit more to make sure everything we need is working, but this seems good for now. I will keep an eye out for changes to the configs as well in the event they change as you mentioned they might. Thanks!<br/>
<span style="color: #902d59"><span style="font-size: small">(13:35:59)</span> <b>zmiller:</b></span> Well, that's great feedback.  We just created that wiki page this week and are still working out some of the kinks.<br/>
<span style="color: #902d59"><span style="font-size: small">(13:37:43)</span> <b>zmiller:</b></span> I think one issue still is that the token that the SchedD got during the auto-approve period has insufficient permissions to do all the things a SchedD is supposed to do.  (It fails to send reschedules to the negotiator for example.)  Things might still work though.  We're pretty fault-tolerent, even of our own code. : )<br/>
<span style="color: #827327"><span style="font-size: small">(13:39:18)</span> <b>jamie.rajewski:</b></span> Good to know, I was just gonna ask if there was anything else I should be aware of! I will implement these configs and try out a larger deployment and actually run some jobs etc and let you know. This cluster doesn't do anything too fancy so it might be okay<br/>
<span style="color: #827327"><span style="font-size: small">(18:29:40)</span> <b>jamie.rajewski:</b></span> @zmiller Sorry for the delay, I spent some time setting up storage mounts while I was messing around with my configs. I finally deployed it, and two noteworthy points:<br/>• I had to put a <tt>sleep</tt> of a couple seconds after <tt>sudo systemctl start condor</tt> on the CM before running the <tt>condor_token_request_auto_approve</tt> , otherwise it error'd since the daemons hadn't all started yet. Normally not really an issue, but for automated deployments in terraform it does<br/>• The CM configured correctly, but the schedd and workers all show the same error:<br/><pre>02/06/21 00:19:38 ERROR: SECMAN:2010:Received "DENIED" from server for user CONDOR_ANONYMOUS_USER using method ANONYMOUS.<br/>02/06/21 00:19:38 Collector update failed; will try to get a token request for trust domain 192.168.254.30, identity (default).<br/>02/06/21 00:19:38 Failed to start non-blocking update to &lt;192.168.254.30:9618&gt;.<br/>02/06/21 00:19:38 Failed to request a new token: DAEMON:1:PASSWD:1:Failed to derive key for JWT signature<br/>02/06/21 00:24:38 SECMAN: FAILED: Received "DENIED" from server for user CONDOR_ANONYMOUS_USER using method ANONYMOUS.<br/>02/06/21 00:24:38 ERROR: SECMAN:2010:Received "DENIED" from server for user CONDOR_ANONYMOUS_USER using method ANONYMOUS.<br/>02/06/21 00:24:38 Collector update failed; will try to get a token request for trust domain 192.168.254.30, identity (default).<br/>02/06/21 00:24:38 Failed to start non-blocking update to &lt;192.168.254.30:9618&gt;.<br/>02/06/21 00:24:38 Failed to request a new token: DAEMON:1:PASSWD:1:Failed to derive key for JWT signature</pre><br/>Not sure where that came from as I used the exact same configs that I used when testing manually. I'll tinker a bit more, but it could be related to the unfinished state of things as you mentioned<br/>
</body>
</html>
