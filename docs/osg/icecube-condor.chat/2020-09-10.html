<!DOCTYPE html>
<html>
<head>
<title>Thu Sep 10, 2020 : #icecube-condor (osg)</title>
</head>
<body>
<h3>Thu Sep 10, 2020 : #icecube-condor (osg)</h3>
<span style="color: #827327"><span style="font-size: small">(14:16:00)</span> <b>jamie.rajewski:</b></span> Alright I have the containers launched again, following from the most recent version of the repository. So I believe we left off with the submitter not being detected by the central manager:<br/><pre>[submituser@pop-os ~]$ condor_status -any -debug<br/>09/10/20 19:15:02 Can't open directory "/etc/condor/passwords.d" as PRIV_UNKNOWN, errno: 13 (Permission denied)<br/>MyType             TargetType         Name                                     <br/><br/>DaemonMaster       None               9bb1baa5fb97                             <br/>Negotiator         None               9bb1baa5fb97                             <br/>Collector          None               My Pool - 9bb1baa5fb97@9bb1baa5fb97      <br/>Accounting         none               &lt;none&gt; </pre><br/>not to mention the permission denied issue at the top<br/>
<span style="color: #827327"><span style="font-size: small">(14:19:19)</span> <b>jamie.rajewski:</b></span> You had mentioned above to run <tt>condor_config_val -verbose ALLOW_ADVERTISE_SCHEDD</tt> in the submit container, the output is:<br/><pre>[root@pop-os /]# condor_config_val -verbose ALLOW_ADVERTISE_SCHEDD<br/>ALLOW_ADVERTISE_SCHEDD =  submituser@jamie  <a href="mailto:dockerworker@example.net">dockerworker@example.net</a> submituser@jamie  <a href="mailto:dockersubmit@example.net">dockersubmit@example.net</a><br/> # at: /etc/condor/config.d/01-security.conf, line 42<br/> # raw: ALLOW_ADVERTISE_SCHEDD = $(ALLOW_ADVERTISE_STARTD) $(ALLOW_WRITE_COLLECTOR) <a href="mailto:dockersubmit@example.net">dockersubmit@example.net</a></pre><br/><br/>
<span style="color: #827327"><span style="font-size: small">(14:19:58)</span> <b>jamie.rajewski:</b></span> (which I see now I already ran above ha)<br/>
<span style="color: #c386df"><span style="font-size: small">(14:46:29)</span> <b>matyas:</b></span> yep, taking another look at your logs<br/>
<span style="color: #c386df"><span style="font-size: small">(16:09:18)</span> <b>matyas:</b></span> So I think I replicated your setup on a local VM and got similar results. I still can't get the shared port daemon in the submit container to run, but I also noticed that <tt>/etc/condor/tokens.d/</tt> is empty on that container.<br/>
<span style="color: #c386df"><span style="font-size: small">(16:10:17)</span> <b>matyas:</b></span> You'll need a token in there for the scheduler to authenticate to the central manager.<br/>
<span style="color: #827327"><span style="font-size: small">(16:12:09)</span> <b>jamie.rajewski:</b></span> Hmm in the launch script, I mount the token there though<br/>
<span style="color: #827327"><span style="font-size: small">(16:12:16)</span> <b>jamie.rajewski:</b></span> oh wait<br/>
<span style="color: #827327"><span style="font-size: small">(16:12:26)</span> <b>jamie.rajewski:</b></span> no that is to the users' .condor location<br/>
<span style="color: #c386df"><span style="font-size: small">(16:12:44)</span> <b>matyas:</b></span> yep<br/>
<span style="color: #827327"><span style="font-size: small">(16:12:51)</span> <b>jamie.rajewski:</b></span> so should I also mount the token to <tt>/etc/condor/tokens.d/</tt> ?<br/>
<span style="color: #c386df"><span style="font-size: small">(16:18:14)</span> <b>matyas:</b></span> so 2 things:<br/>
<span style="color: #c386df"><span style="font-size: small">(16:18:28)</span> <b>matyas:</b></span> you don't want to use the same token for <tt>submituser</tt> that you use for the schedd<br/>
<span style="color: #c386df"><span style="font-size: small">(16:18:56)</span> <b>matyas:</b></span> because one of those is a user and one of those is a daemon, and they should have separate identities<br/>
<span style="color: #c386df"><span style="font-size: small">(16:19:29)</span> <b>matyas:</b></span> Second, if you bind-mount directly, the permissions might be wrong.<br/>
<span style="color: #c386df"><span style="font-size: small">(16:20:29)</span> <b>matyas:</b></span> If you bind-mount the token for the daemon to <tt>/root/secrets/token</tt> , then the entrypoint will copy it to the right place with the right permissions<br/>
<span style="color: #c386df"><span style="font-size: small">(16:21:36)</span> <b>matyas:</b></span> or run <tt>/update-secrets</tt> to do the same, in case the submit container is running. (You might need to follow up <tt>update-secrets</tt> with <tt>condor_reconfig</tt> so it finds the new token...)<br/>
<span style="color: #827327"><span style="font-size: small">(16:23:06)</span> <b>jamie.rajewski:</b></span> Ah okay, we had gone through this once before with the cm token too. Sorry about that. So I will add the schedd token creating to the token creation script then; what arguments should it have?<br/>
<span style="color: #827327"><span style="font-size: small">(16:23:50)</span> <b>jamie.rajewski:</b></span> for reference, the others look like:<br/><pre># # Create the execute token                                                                                                                <br/># condor_token_create -authz ADVERTISE_MASTER \                                                                                             <br/>#          -authz ADVERTISE_STARTD -authz READ -identity dockerworker@jamie \                                                               <br/>#          &gt; /root/secrets/token                                                                                                            <br/>                                                                                                                                            <br/># Create the submituser token (stored only on the submit node)                                                                              <br/>condor_token_create -identity submituser@jamie \                                                                                            <br/>                    &gt; /root/submitsecrets/token</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(16:29:58)</span> <b>matyas:</b></span> Yep, so <tt>condor_token_create  -authz ADVERTISE_MASTER  -authz ADVERTISE_SCHEDD  -authz READ  -identity dockersubmit@jamie</tt> and then make sure it's mounted as <tt>/root/secrets/token</tt>  on the submit container (and only the submit container). (You may need to make a new directory for this...)<br/>
<span style="color: #827327"><span style="font-size: small">(16:36:30)</span> <b>jamie.rajewski:</b></span> Awesome, I shall give it a shot<br/>
<span style="color: #827327"><span style="font-size: small">(16:42:06)</span> <b>jamie.rajewski:</b></span> Alright, the schedd token is saved in a new directory, which I bind mounted to <tt>/root/secrets/token</tt> as you pointed out, and it now shows up:<br/><pre>[root@pop-os /]# cd /etc/condor/tokens.d/<br/>[root@pop-os tokens.d]# ls<br/>token</pre><br/>now to test<br/>
<span style="color: #827327"><span style="font-size: small">(16:43:07)</span> <b>jamie.rajewski:</b></span> <pre>[root@pop-os ~]# condor_status -any<br/>MyType             TargetType         Name                                     <br/><br/>Collector          None               My Pool - d91dc910a884@d91dc910a884      <br/>DaemonMaster       None               d91dc910a884                             <br/>Negotiator         None               d91dc910a884                             <br/>DaemonMaster       None               pop-os.localdomain                       <br/>Accounting         none               &lt;none&gt; </pre><br/>it added a second DaemonMaster, is that correct? Or should it show up as something else?<br/>
<span style="color: #c386df"><span style="font-size: small">(16:43:30)</span> <b>matyas:</b></span> Yes, that's fine<br/>
<span style="color: #c386df"><span style="font-size: small">(16:43:44)</span> <b>matyas:</b></span> But there should also be a Scheduler.<br/>
<span style="color: #827327"><span style="font-size: small">(16:44:00)</span> <b>jamie.rajewski:</b></span> Hmm, I'll get the logs<br/>
<span style="color: #827327"><span style="font-size: small">(16:47:45)</span> <b>jamie.rajewski:</b></span> <br/>
<span style="color: #827327"><span style="font-size: small">(16:50:25)</span> <b>jamie.rajewski:</b></span> <br/>
<span style="color: #c386df"><span style="font-size: small">(17:25:40)</span> <b>matyas:</b></span> So you authenticated just fine, but there's some problem with the ad the scheduler's sending:<br/><pre>09/10/20 21:46:10 ScheddAd Error: Neither 'MyAddress' nor 'ScheddIpAddr' found in ad<br/>09/10/20 21:46:10 Could not make hashkey --- ignoring ad<br/>09/10/20 21:46:10 Received malformed ad from command (1). Ignoring.</pre><br/><br/>
<span style="color: #c386df"><span style="font-size: small">(17:25:57)</span> <b>matyas:</b></span> (that's the CollectorLog)<br/>
<span style="color: #827327"><span style="font-size: small">(17:30:17)</span> <b>jamie.rajewski:</b></span> how would I check what ads its sending?<br/>
<span style="color: #c386df"><span style="font-size: small">(17:31:14)</span> <b>matyas:</b></span> That's in the SchedLog. Here's what the Collector's receiving:<br/><pre>AuthMethods = "IDTOKENS"<br/>AuthMethodsList = "FS,TOKEN"<br/>Authentication = "YES"<br/>CryptoMethods = "BLOWFISH,3DES"<br/>Enact = "YES"<br/>Encryption = "NO"<br/>Integrity = "YES"<br/>IssuerKeys = "POOL"<br/>LimitAuthorization = "ADVERTISE_MASTER,ADVERTISE_SCHEDD,READ,"<br/>ParentUniqueID = "pop-os:24:1599774364"<br/>RemoteVersion = "$CondorVersion: 8.9.7 May 19 2020 BuildID: 504263 PackageID: 8.9.7-1 $"<br/>ServerPid = 26<br/>SessionDuration = "86400"<br/>SessionLease = 3600<br/>Sid = "6706cb7856ac:37:1599774370:3"<br/>Subsystem = "SCHEDD"<br/>TriedAuthentication = true<br/>TrustDomain = "localhost:9618"<br/>User = "dockersubmit@jamie"<br/>ValidCommands = "60028,67,14,18,1,11"</pre><br/><br/>
<span style="color: #c386df"><span style="font-size: small">(17:32:18)</span> <b>matyas:</b></span> looks well-formed to me, except for the missing MyAddress. So the question is what would cause the schedd to not have (or not send) a MyAddress or ScheddIpAddr?<br/>
<span style="color: #827327"><span style="font-size: small">(17:32:52)</span> <b>jamie.rajewski:</b></span> that I do not know<br/>
<span style="color: #c386df"><span style="font-size: small">(17:33:22)</span> <b>matyas:</b></span> Yep. I will ask the developers.<br/>
<span style="color: #827327"><span style="font-size: small">(17:33:29)</span> <b>jamie.rajewski:</b></span> Sounds good, thank you!<br/>
<span style="color: #c386df"><span style="font-size: small">(17:37:28)</span> <b>matyas:</b></span> Is <tt>condor_shared_port</tt> running in the submit container? I recall having issues with that...<br/>
<span style="color: #827327"><span style="font-size: small">(17:38:35)</span> <b>jamie.rajewski:</b></span> I recall that as well, how do I check that again?<br/>
<span style="color: #827327"><span style="font-size: small">(17:39:07)</span> <b>jamie.rajewski:</b></span> oh is that the <tt>SHARED_PORT_PORT</tt> in the config?<br/>
<span style="color: #c386df"><span style="font-size: small">(17:39:09)</span> <b>matyas:</b></span> just run <tt>ps</tt> in the container<br/>
<span style="color: #827327"><span style="font-size: small">(17:39:34)</span> <b>jamie.rajewski:</b></span> <pre>USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br/>root           1  0.1  0.1 118088 18052 ?        Ss   22:37   0:00 /usr/bin/python /usr/bin/supervisord -c /etc<br/>condor        23  0.0  0.0  71788 12300 ?        S    22:37   0:00 /usr/sbin/condor_master -f<br/>root          24  0.5  0.0  22872  3876 ?        S    22:37   0:00 condor_procd -A /var/run/condor/procd_pipe -<br/>condor        25  0.5  0.0  48512 11716 ?        Ss   22:37   0:00 condor_schedd<br/>root          28  0.0  0.0  15272  3440 pts/0    Ss   22:38   0:00 bash<br/>root          45  0.0  0.0  55200  3952 pts/0    R+   22:39   0:00 ps -aux</pre><br/>doesn't look like it<br/>
<span style="color: #c386df"><span style="font-size: small">(17:39:46)</span> <b>matyas:</b></span> is there a SharedPortLog?<br/>
<span style="color: #827327"><span style="font-size: small">(17:40:36)</span> <b>jamie.rajewski:</b></span> No, only these<br/><pre>MasterLog  ProcLog  ScheddRestartReport  SchedLog</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(17:40:46)</span> <b>matyas:</b></span> What's in MasterLog?<br/>
<span style="color: #827327"><span style="font-size: small">(17:41:53)</span> <b>jamie.rajewski:</b></span> <br/>
<span style="color: #827327"><span style="font-size: small">(17:43:36)</span> <b>jamie.rajewski:</b></span> for reference, the most up to date submit condor config:<br/><pre>ALLOW_WRITE = submituser@jamie<br/>SEC_USE_FAMILY_SESSION = False<br/>SHARED_PORT_PORT = 9621<br/># Workaround to force it to use shared port<br/>MASTER.COLLECTOR_LIST = $(IP_ADDRESS):$(SHARED_PORT_PORT) $(COLLECTOR_HOST)<br/>SCHEDD_DEBUG=D_SECURITY:2 D_NETWORK:2</pre><br/><br/>
<span style="color: #c386df"><span style="font-size: small">(18:24:21)</span> <b>matyas:</b></span> I don't understand why the workaround doesn't work, but I've asked the devs to create Docker images based on condor 8.9.8 which fixed the bug.<br/>
<span style="color: #c386df"><span style="font-size: small">(18:52:56)</span> <b>matyas:</b></span> Could you try using 8.9.8-el7 images instead of 8.9.7-el7 ?<br/>
</body>
</html>
