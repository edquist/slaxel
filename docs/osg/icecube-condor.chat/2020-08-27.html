<!DOCTYPE html>
<html>
<head>
<title>Thu Aug 27, 2020 : #icecube-condor (osg)</title>
</head>
<body>
<h3>Thu Aug 27, 2020 : #icecube-condor (osg)</h3>
<span style="color: #827327"><span style="font-size: small">(13:13:59)</span> <b>jamie.rajewski:</b></span> Alright, the repo is here: <a href="https://github.com/jamierajewski/condor-deployment">https://github.com/jamierajewski/condor-deployment</a><br/>I will try your suggestion now, thanks @matyas!<br/>
<span style="color: #827327"><span style="font-size: small">(13:31:22)</span> <b>jamie.rajewski:</b></span> The log with that option enabled is the following:<br/>
<span style="color: #827327"><span style="font-size: small">(13:32:51)</span> <b>jamie.rajewski:</b></span> at the bottom of the log, there are a number of these errors but I'm not entirely sure what it means<br/>
<span style="color: #827327"><span style="font-size: small">(13:33:02)</span> <b>jamie.rajewski:</b></span> <pre>08/27/20 18:30:13 DC_AUTHENTICATE: attempt to open invalid session family:e311c1dcd6d2e8c374700aa332b7fc49f3a4eaa736852979, failing; this session was requested by &lt;172.17.0.1:38342&gt; with return address (none)<br/>08/27/20 18:30:13   The remote daemon thinks that we are in the same family of Condor daemon processes as it, but I don't recognize its family security session.<br/>08/27/20 18:30:13   If we are in the same family of processes, you may need to change how the configuration parameter SEC_USE_FAMILY_SESSION is set.</pre><br/>
<span style="color: #827327"><span style="font-size: small">(13:45:22)</span> <b>jamie.rajewski:</b></span> Ah, looks like that was the error. I see that it is a new feature as of 8.9.x (we're still running 8.8.9 on our main cluster so I hadn't seen this). I set <tt>SEC_USE_FAMILY_SESSION</tt> to false in each of the configs and it works now; condor_status shows my single node. Should leaving it set to false be fine for a testing environment?<br/>
<span style="color: #c386df"><span style="font-size: small">(13:47:18)</span> <b>matyas:</b></span> Leaving it false is fine. Like you saw SEC_USE_FAMILY_SESSION is new, and it's essentially a performance enhancement.<br/>
<span style="color: #c386df"><span style="font-size: small">(13:47:51)</span> <b>matyas:</b></span> (What it does is that it allows condor daemons that were started by the same condor_master to talk to each other without additional authentication.)<br/>
<span style="color: #827327"><span style="font-size: small">(14:26:28)</span> <b>jamie.rajewski:</b></span> ah okay that makes sense<br/>
<span style="color: #827327"><span style="font-size: small">(14:43:29)</span> <b>jamie.rajewski:</b></span> At the very end of the example, it says to become the <tt>submituser</tt> to submit jobs, but when I do that, the authentication fails again (probably because the token is mounted to /root/secrets?). Should I mount the token additonally to the submituser's space, or is there a better way around this?<br/>
<span style="color: #c386df"><span style="font-size: small">(14:51:53)</span> <b>matyas:</b></span> If you are submitting a job (as submituser) from within the submit node container, then condor uses FS authentication to authenticate the user to the daemons.<br/>
<span style="color: #c386df"><span style="font-size: small">(14:54:02)</span> <b>matyas:</b></span> If you're submitting a job from elsewhere, you will need some other way to authenticate the user doing the submission -- such as a token.<br/>However, you should _not_ reuse the tokens you generated for the daemons (e.g. dockerworker@jamie) -- you're submitting as a user, not a daemon.<br/>
<span style="color: #c386df"><span style="font-size: small">(14:56:57)</span> <b>matyas:</b></span> so create a separate token for the submit user, with WRITE authz and an identity like submituser@jamie<br/>
<span style="color: #c386df"><span style="font-size: small">(14:57:20)</span> <b>matyas:</b></span> and make sure that submituser@jaime has ALLOW_WRITE in the config for the submit host<br/>
<blockquote>
<span style="color: #43761b"><span style="font-size: small">(15:16:16)</span> <b>blin:</b></span> are these condor id principles? i'm not sure i understand how the <tt>submituser@&lt;user&gt;</tt>  is supposed to work<br/>
<span style="color: #c386df"><span style="font-size: small">(15:17:12)</span> <b>matyas:</b></span> When you use a token to authenticate, you get whatever ID you put into the token when you created it.<br/>
<span style="color: #c386df"><span style="font-size: small">(15:18:16)</span> <b>matyas:</b></span> (Also Jamie was calling his _host_ "jamie" - it's not a user)<br/>
<span style="color: #43761b"><span style="font-size: small">(15:18:40)</span> <b>blin:</b></span> ah, i see<br/>
<span style="color: #43761b"><span style="font-size: small">(15:19:19)</span> <b>blin:</b></span> that explains it<br/>
<span style="color: #827327"><span style="font-size: small">(15:35:59)</span> <b>jamie.rajewski:</b></span> sorry for the confusion, that was to try and simply differentiate from the example<br/>
<span style="color: #c386df"><span style="font-size: small">(15:36:15)</span> <b>matyas:</b></span> no prob :slightly_smiling_face:<br/>
</blockquote>
<span style="color: #827327"><span style="font-size: small">(15:12:11)</span> <b>jamie.rajewski:</b></span> Alright great, I shall give that a try, thank you!<br/>
<span style="color: #827327"><span style="font-size: small">(15:19:51)</span> <b>jamie.rajewski:</b></span> where should the submituser token be stored?<br/>
<span style="color: #c386df"><span style="font-size: small">(15:21:19)</span> <b>matyas:</b></span> <tt>$HOME/.condor/tokens.d/token</tt><br/>
<span style="color: #827327"><span style="font-size: small">(15:21:58)</span> <b>jamie.rajewski:</b></span> Okay, I was reading about that in the docs but wasn't sure if that was meant just for the daemons<br/>
<span style="color: #c386df"><span style="font-size: small">(15:22:53)</span> <b>matyas:</b></span> it doesn't have to be named "token" btw; it can be named anything, it just has to be in $HOME/.condor/tokens.d<br/>
<span style="color: #c386df"><span style="font-size: small">(15:23:23)</span> <b>matyas:</b></span> if you submit to multiple clusters, you might have multiple tokens in there, for example<br/>
<span style="color: #827327"><span style="font-size: small">(15:23:40)</span> <b>jamie.rajewski:</b></span> that makes sense<br/>
<span style="color: #c386df"><span style="font-size: small">(15:29:54)</span> <b>matyas:</b></span> One thing to watch out for is that condor tries all the tokens in that directory and uses the first one that works. This means if you have a token for user1@jamie and a token for user2@jamie (both from the same submit host), you don't know which one of those you will be authenticated as.<br/>
<span style="color: #c386df"><span style="font-size: small">(15:31:31)</span> <b>matyas:</b></span> Same if you have tokens for the same identity but with different permissions.<br/>
<span style="color: #827327"><span style="font-size: small">(15:38:36)</span> <b>jamie.rajewski:</b></span> just to clarify your above instructions, can I use the token authentication with my newly created submituser token when submitting as that user on the submit node? A quick test resulted in:<br/><pre>[submituser@pop-os ~]$ condor_status<br/>Error: communication error<br/>SECMAN:2010:Received "DENIED" from server for user submituser@jamie using method IDTOKENS.<br/>AUTHENTICATE:1004:Failed to authenticate using FS</pre><br/>which could be a result from how I mounted this token, as you described previously although it appears to be trying to use the correct one<br/>
<span style="color: #c386df"><span style="font-size: small">(15:40:53)</span> <b>matyas:</b></span> Hmm. What does /var/log/condor/SchedLog on the submit node say? You might have to add <tt>SCHEDD_DEBUG=D_SECURITY:2</tt> to its config.<br/>
<span style="color: #827327"><span style="font-size: small">(15:43:34)</span> <b>jamie.rajewski:</b></span> at the bottom after running <tt>condor_status</tt> it shows this:<br/><pre>08/27/20 20:42:06 Authorizing server 'condor_pool@50f194aa3f4a/127.0.0.1'.<br/>08/27/20 20:42:06 Failed to request a new token: DAEMON:1:Failed to recieve response from remote daemon at at '&lt;127.0.0.1:9618?alias=localhost&gt;'|AUTHENTICATE:1004:Failed to authenticate using FS</pre><br/>
<span style="color: #827327"><span style="font-size: small">(15:48:44)</span> <b>jamie.rajewski:</b></span> The steps I added were to generate the new submituser token in the same script that I generate the daemon token:<br/><pre># Create the daemon token<br/>condor_token_create -authz ADVERTISE_MASTER \<br/>         -authz ADVERTISE_STARTD -authz READ -identity dockerworker@jamie \<br/>         &gt;&gt; /root/secrets/token<br/><br/># Create the submituser token (stored only on the submit node)<br/>condor_token_create -authz WRITE -identity submituser@jamie \<br/>                    &gt;&gt; /root/submitsecrets/token</pre><br/>This gets run after the cm is launched but before the others are launched. I then mount the directory where I had stored that new token (submitsecrets) to <tt>/home/submituser/.condor/tokens.d</tt> and it shows up fine:<br/><pre>[submituser@pop-os ~]$ ls .condor/tokens.d/<br/>token</pre><br/>I also added to the submit condor config this line:<br/><pre>ALLOW_WRITE = submituser@jamie                                                                                     </pre><br/>so the submit config now looks like:<br/><pre>ALLOW_WRITE = submituser@jamie                                                                                     <br/>SEC_USE_FAMILY_SESSION = False                                                                                     <br/>SCHEDD_DEBUG=D_SECURITY:2</pre><br/><br/>
<span style="color: #c386df"><span style="font-size: small">(15:50:15)</span> <b>matyas:</b></span> Is there more stuff in the SchedLog?<br/>
<span style="color: #827327"><span style="font-size: small">(15:52:22)</span> <b>jamie.rajewski:</b></span> <br/>
<span style="color: #827327"><span style="font-size: small">(15:58:07)</span> <b>jamie.rajewski:</b></span> well I noticed one thing: it was showing:<br/><pre>08/27/20 20:51:41 allow ADVERTISE_STARTD:  submituser@jamie/* <a href="mailto:dockerworker@example.net">dockerworker@example.net</a>/*</pre><br/><br/>
<span style="color: #827327"><span style="font-size: small">(15:58:29)</span> <b>jamie.rajewski:</b></span> so I checked and my tokens were being appended to, not overwritten (a simple &gt;&gt; instead of &gt; :face_with_rolling_eyes: )<br/>
<span style="color: #c386df"><span style="font-size: small">(15:59:02)</span> <b>matyas:</b></span> yeah that would change things<br/>
<span style="color: #827327"><span style="font-size: small">(15:59:16)</span> <b>jamie.rajewski:</b></span> but now it is showing me the auth error again:<br/><pre>[submituser@pop-os ~]$ condor_status<br/>Error: communication error<br/>AUTHENTICATE:1003:Failed to authenticate with any method<br/>AUTHENTICATE:1004:Failed to authenticate using IDTOKENS<br/>AUTHENTICATE:1004:Failed to authenticate using FS</pre><br/>let me check the sched log again now<br/>
<span style="color: #c386df"><span style="font-size: small">(15:59:57)</span> <b>matyas:</b></span> wait a sec. You're doing a condor_status?<br/>
<span style="color: #827327"><span style="font-size: small">(16:00:12)</span> <b>jamie.rajewski:</b></span> yea<br/>
<span style="color: #c386df"><span style="font-size: small">(16:00:17)</span> <b>matyas:</b></span> condor_status talks to the collector. If you want to talk to the schedd, you want condor_q<br/>
<span style="color: #827327"><span style="font-size: small">(16:00:17)</span> <b>jamie.rajewski:</b></span> oh would that require read permissions?<br/>
<span style="color: #827327"><span style="font-size: small">(16:00:30)</span> <b>jamie.rajewski:</b></span> ahhh<br/>
<span style="color: #827327"><span style="font-size: small">(16:00:57)</span> <b>jamie.rajewski:</b></span> well condor_q shows:<br/><pre>[submituser@pop-os ~]$ condor_q<br/><br/>-- Failed to fetch ads from: &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt; : pop-os.localdomain<br/>CEDAR:6001:Failed to connect to &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt;</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(16:04:34)</span> <b>matyas:</b></span> Can you do <tt>netstat -nlp --tcp</tt> as root on your host to see what's listening on what port?<br/>
<span style="color: #c386df"><span style="font-size: small">(16:04:41)</span> <b>matyas:</b></span> er, on the outside host<br/>
<span style="color: #827327"><span style="font-size: small">(16:05:56)</span> <b>jamie.rajewski:</b></span> <pre>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    <br/>tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      113180/cupsd        <br/>tcp        0      0 127.0.0.1:29754         0.0.0.0:*               LISTEN      968/vpnagentd       <br/>tcp        0      0 0.0.0.0:44155           0.0.0.0:*               LISTEN      136725/condor_sched <br/>tcp        0      0 0.0.0.0:44627           0.0.0.0:*               LISTEN      136725/condor_sched <br/>tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      64997/systemd-resol <br/>tcp6       0      0 ::1:631                 :::*                    LISTEN      113180/cupsd        <br/>tcp6       0      0 :::9618                 :::*                    LISTEN      136457/docker-proxy </pre><br/>
<span style="color: #827327"><span style="font-size: small">(16:08:47)</span> <b>jamie.rajewski:</b></span> Here is the log with my tokens fixed, although the entries look mostly the same:<br/>
<span style="color: #827327"><span style="font-size: small">(16:10:37)</span> <b>jamie.rajewski:</b></span> for example, this still shows up:<br/><pre>08/27/20 20:51:41 allow ADVERTISE_STARTD:  submituser@jamie/* <a href="mailto:dockerworker@example.net">dockerworker@example.net</a>/*</pre><br/>isn't that supposed to be <tt>dockerworker@jamie</tt> since the condor_config on the cm has this in there? Or is this a default entry on all nodes and because this is the schedd, it doesn't see that?<br/>
<span style="color: #c386df"><span style="font-size: small">(16:10:38)</span> <b>matyas:</b></span> The shared port daemon for the submit host isn't starting up... probably because something else (the collector) is already using port 9618<br/>
<span style="color: #c386df"><span style="font-size: small">(16:10:51)</span> <b>matyas:</b></span> er, the shared port daemon for the collector<br/>
<span style="color: #c386df"><span style="font-size: small">(16:11:14)</span> <b>matyas:</b></span> you need to change the config for the submit host so that it listens on a different port.<br/>
<span style="color: #c386df"><span style="font-size: small">(16:11:51)</span> <b>matyas:</b></span> same for the execute host, since it looks like you're using host networking for both<br/>
<span style="color: #827327"><span style="font-size: small">(16:14:04)</span> <b>jamie.rajewski:</b></span> does that go in the docker config or condor config? If it's host networking, could I just map a different external port to 9618 internally or is it recommended to switch it within condor?<br/>
<span style="color: #c386df"><span style="font-size: small">(16:15:31)</span> <b>matyas:</b></span> Containers that use host networking don't do any port mapping: 9618 inside the container is 9618 outside the container.<br/>
<span style="color: #c386df"><span style="font-size: small">(16:16:08)</span> <b>matyas:</b></span> So you should change the port in the condor config.<br/>
<span style="color: #827327"><span style="font-size: small">(16:16:53)</span> <b>jamie.rajewski:</b></span> Ah so dumb question then. Sorry about that, I'm not very proficient at networking/systems I'm more of a standard software developer but I'm trying to change that<br/>
<span style="color: #c386df"><span style="font-size: small">(16:17:04)</span> <b>matyas:</b></span> Try doing <tt>NETWORK_INTERFACE = 0.0.0.0:9621</tt> in the submit host config and <tt>NETWORK_INTERFACE = 0.0.0.0:9622</tt> in the execute host config<br/>
<span style="color: #c386df"><span style="font-size: small">(16:17:21)</span> <b>matyas:</b></span> No worries, I'm coming from the same place :slightly_smiling_face:<br/>
<span style="color: #c386df"><span style="font-size: small">(16:17:33)</span> <b>matyas:</b></span> Container networking is a confusing bundle of lies<br/>
<span style="color: #827327"><span style="font-size: small">(16:17:45)</span> <b>jamie.rajewski:</b></span> hahaha<br/>
<span style="color: #827327"><span style="font-size: small">(16:19:13)</span> <b>jamie.rajewski:</b></span> alright, here's what shows up now:<br/><pre>[submituser@pop-os ~]$ condor_q<br/>init_network_interfaces:2:Failed to determine my IP address using NETWORK_INTERFACE=0.0.0.0:9621<br/>Error: <br/><br/>Extra Info: You probably saw this error because the condor_schedd is not <br/>running on the machine you are trying to query. If the condor_schedd is not <br/>running, the Condor system will not be able to find an address and port to <br/>connect to and satisfy this request. Please make sure the Condor daemons are <br/>running and try again.<br/> <br/>Extra Info: If the condor_schedd is running on the machine you are trying to <br/>query and you still see the error, the most likely cause is that you have <br/>setup a personal Condor, you have not defined SCHEDD_NAME in your <br/>condor_config file, and something is wrong with your SCHEDD_ADDRESS_FILE <br/>setting. You must define either or both of those settings in your config <br/>file, or you must use the -name option to condor_q. Please see the Condor <br/>manual for details on SCHEDD_NAME and SCHEDD_ADDRESS_FILE.</pre><br/>
<span style="color: #827327"><span style="font-size: small">(16:21:14)</span> <b>jamie.rajewski:</b></span> I'm checking the manual<br/>
<span style="color: #c386df"><span style="font-size: small">(16:22:41)</span> <b>matyas:</b></span> Try <tt>NETWORK_INTERFACE=$(IP_ADDRESS):9621</tt> ?<br/>
<span style="color: #c386df"><span style="font-size: small">(16:23:15)</span> <b>matyas:</b></span> .... otherwise use the IP address of the host instead of <tt>$(IP_ADDRESS)</tt><br/>
<span style="color: #827327"><span style="font-size: small">(16:25:10)</span> <b>jamie.rajewski:</b></span> I got the same error, but it did substitute an IP in:<br/><pre>[submituser@pop-os ~]$ condor_q<br/>init_network_interfaces:2:Failed to determine my IP address using NETWORK_INTERFACE=192.168.187.192:9621<br/>...</pre><br/><br/>
<span style="color: #827327"><span style="font-size: small">(16:27:32)</span> <b>jamie.rajewski:</b></span> do I need to do anything that it says in the extra info of the error?:<br/><pre>Extra Info: If the condor_schedd is running on the machine you are trying to <br/>query and you still see the error, the most likely cause is that you have <br/>setup a personal Condor, you have not defined SCHEDD_NAME in your <br/>condor_config file, and something is wrong with your SCHEDD_ADDRESS_FILE <br/>setting. You must define either or both of those settings in your config <br/>file, or you must use the -name option to condor_q. Please see the Condor <br/>manual for details on SCHEDD_NAME and SCHEDD_ADDRESS_FILE.</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(16:28:38)</span> <b>matyas:</b></span> I asked the devs. Don't set NETWORK_INTERFACE, set <tt>SHARED_PORT_PORT=9621</tt><br/>
<span style="color: #c386df"><span style="font-size: small">(16:42:50)</span> <b>matyas:</b></span> ... and you'll also need the workaround from this: <a href="https://htcondor-wiki.cs.wisc.edu/index.cgi/tktview?tn=7697">https://htcondor-wiki.cs.wisc.edu/index.cgi/tktview?tn=7697</a><br/>
<span style="color: #c386df"><span style="font-size: small">(16:43:26)</span> <b>matyas:</b></span> (in the submit host config)<br/><pre># The first entry in the list is what defines the local shared port port<br/>MASTER.COLLECTOR_LIST = $(IP_ADDRESS):$(SHARED_PORT_PORT) $(COLLECTOR_HOST)</pre><br/>
<span style="color: #827327"><span style="font-size: small">(18:11:06)</span> <b>jamie.rajewski:</b></span> Alright, I changed the submit config as indicated:<br/><pre>ALLOW_WRITE = submituser@jamie                                                                                     <br/>SEC_USE_FAMILY_SESSION = False                                                                                     <br/>SHARED_PORT_PORT = 9621                                                                                            <br/># Workaround to force it to use shared port                                                                        <br/>MASTER.COLLECTOR_LIST = $(IP_ADDRESS):$(SHARED_PORT_PORT) $(COLLECTOR_HOST)                                        <br/>SCHEDD_DEBUG=D_SECURITY:2</pre><br/>but the issue persists:<br/><pre>[root@pop-os /]# su - submituser<br/>[submituser@pop-os ~]$ condor_q<br/><br/>-- Failed to fetch ads from: &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt; : pop-os.localdomain<br/>CEDAR:6001:Failed to connect to &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt;</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(18:13:53)</span> <b>matyas:</b></span> What do you get when you run <tt>condor_status -any</tt>?<br/>
<span style="color: #c386df"><span style="font-size: small">(18:29:26)</span> <b>matyas:</b></span> That talks to the collector to get what other daemons it knows about. The output looks kinda like<br/><pre>MyType             TargetType         Name                                     <br/><br/>Collector          None               My Pool - <a href="mailto:127.0.0.1@siren.cs.wisc.edu">127.0.0.1@siren.cs.wisc.edu</a>    <br/>Scheduler          None               <a href="http://siren.cs.wisc.edu">siren.cs.wisc.edu</a>                        <br/>DaemonMaster       None               <a href="http://siren.cs.wisc.edu">siren.cs.wisc.edu</a>                        <br/>Negotiator         None               <a href="http://siren.cs.wisc.edu">siren.cs.wisc.edu</a>                        <br/>Machine            Job                <a href="mailto:slot1@siren.cs.wisc.edu">slot1@siren.cs.wisc.edu</a>                  <br/>Accounting         none               &lt;none&gt;</pre><br/>(with some differences since I ran this on an RPM install, not a container)<br/>
<span style="color: #c386df"><span style="font-size: small">(18:34:54)</span> <b>matyas:</b></span> If you can't get any output from that, you most likely can't talk to the collector - examine /var/log/condor/CollectorLog on the cm to find out what's going on on that end of the connection.<br/>If you don't see Scheduler in there, then the submit host can't talk to the collector - examine /var/log/condor/SchedLog to find out what's going on on the submit end of the connection.<br/>If you want to know what's going on on the client end of the connection, set <tt>_CONDOR_TOOL_DEBUG=D_SECURITY:2</tt> in the environment, and add <tt>-debug</tt> to the condor_status call.<br/>
<span style="color: #c386df"><span style="font-size: small">(18:36:54)</span> <b>matyas:</b></span> You might also try adding <tt>D_NETWORK:2</tt> to any of those debug options (they're space separated) to debug what's going on in networking.<br/>
<span style="color: #c386df"><span style="font-size: small">(18:37:21)</span> <b>matyas:</b></span> I gotta go for tonight, but we can keep working on this tomorrow.<br/>
</body>
</html>
