<!DOCTYPE html>
<html>
<head>
<title>Mon Feb 8, 2021 : #icecube-condor (osg)</title>
</head>
<body>
<h3>Mon Feb 8, 2021 : #icecube-condor (osg)</h3>
<span style="color: #827327"><span style="font-size: small">(12:39:07)</span> <b>jamie.rajewski:</b></span> I found that the above issue came from a typo in the auto-approval rule for the IP range which I have since resolved. It works now, but I have one final issue which may or may not be a condor issue (seems more like a Terraform one but I'm not sure). I took the steps that worked and simply put them in my post-provision scripts to run on the appropriate nodes to set them up but the auto-approval rule doesn't seem to run correctly when applied through terraform. On the central manager, I have the following:<br/><pre>      # Add condor CM IP to config and start, with token auto approval<br/>      "sudo sed -i 's/condor_host_ip/${self.network[0].fixed_ip_v4}/' /etc/condor/condor_config.local",<br/>      "sudo systemctl enable condor",<br/>      "sudo systemctl start condor",<br/>      # Add sleep to allow condor to start properly before setting the rule<br/>      "sleep 10",<br/>      "sudo condor_token_request_auto_approve -netblock 192.168.0.0/24 -lifetime 3600",</pre><br/>which works, as seen in the output of terraform:<br/><pre>openstack_compute_instance_v2.illume-control-v2: Still creating... [1m50s elapsed]<br/>openstack_compute_instance_v2.illume-control-v2 (remote-exec): Successfully installed auto-approval rule for netblock 192.168.0.0/24 with lifetime of 1.00 hours<br/>openstack_compute_instance_v2.illume-control-v2 (remote-exec): Remote daemon reports no un-approved requests pending.</pre><br/>It then moves on to create the worker nodes, which I have set with the central manager as a dependency to ensure they dont start building until after it is complete. They complete just fine, but when I log in to the schedd or the workers, the logs show that it is still waiting to be approved as if though the auto-approval rule isnt running. If I then stop condor on each of the schedd and workers, reapply the rule manually, and restart condor, it works fine. Any thoughts from anyone?<br/>
<span style="color: #827327"><span style="font-size: small">(12:45:00)</span> <b>jamie.rajewski:</b></span> I suppose the shell exiting at the end of the provisioner may also cause the auto-approval rule to be cancelled and exit as well<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:56:38)</span> <b>bbockelm:</b></span> Hi @jamie.rajewski - <tt>condor_token_request_auto_approve</tt> doesn't cancel the rule on the way out.<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:56:54)</span> <b>bbockelm:</b></span> _However_, <tt>condor_reconfig</tt> on the collector bounces any rules.  Is it possible something triggered that?<br/>
<span style="color: #827327"><span style="font-size: small">(14:57:50)</span> <b>jamie.rajewski:</b></span> Hmm, I don't think so as that was the last entry in my post-provision script. Following that, the provisioning of that node is complete, and it moves on to the others so I don't see any place that could have happened<br/>
<span style="color: #827327"><span style="font-size: small">(14:59:12)</span> <b>jamie.rajewski:</b></span> I'm going to try a few other things to see if I can figure it out, but it looks like the htcondor/wisc domains are down at the moment so I can't rebuild<br/>
<span style="color: #9e3997"><span style="font-size: small">(15:02:06)</span> <b>bbockelm:</b></span> @jamie.rajewski do you see the requests listed with the collector?  That is, theyâ€™re sitting there but waiting for approval?<br/>
<span style="color: #827327"><span style="font-size: small">(15:02:50)</span> <b>jamie.rajewski:</b></span> When I ran the command to manually approve requests, they all showed up yea<br/>
<span style="color: #9e3997"><span style="font-size: small">(15:04:59)</span> <b>bbockelm:</b></span> Hm.  Yeah, the two best guesses was something cleared out the approval rule or some subtle issue with the auto-approve (IPv6 vs IPv4 possibly?)<br/>
<span style="color: #827327"><span style="font-size: small">(15:05:54)</span> <b>jamie.rajewski:</b></span> I would guess it would be the former, as running the auto approval command myself manually seems to work in the same environment but hard to say<br/>
<span style="color: #9e3997"><span style="font-size: small">(15:06:51)</span> <b>bbockelm:</b></span> A reconfig would be logged, could find it in the <tt>CollectorLog</tt>.  Let me see if it has a clear message about rules.<br/>
<span style="color: #9e3997"><span style="font-size: small">(15:08:39)</span> <b>bbockelm:</b></span> The plot thickens... it appears that a reconfig _also_ clears out the pending token requests.<br/>
<span style="color: #827327"><span style="font-size: small">(15:08:52)</span> <b>jamie.rajewski:</b></span> interesting<br/>
<span style="color: #9e3997"><span style="font-size: small">(15:08:56)</span> <b>bbockelm:</b></span> So I don't have a theory as to why requests would be pending but the auto-approval rule is cleared.<br/>
<span style="color: #827327"><span style="font-size: small">(15:10:30)</span> <b>jamie.rajewski:</b></span> I had a slightly hacky idea to try to get around it - I was going to try and put the auto-approval command in a script, and create a service in systemd for it (with dependence on the condor service) and then finally starting the service in my provisioner. Perhaps running it like that will get around any possible issues related to the shell/environment?<br/>
<span style="color: #827327"><span style="font-size: small">(15:11:21)</span> <b>jamie.rajewski:</b></span> I dont think I would need to <tt>enable</tt> the service either since I just need to run it manually this one time (although I'm a bit new to creating my own services so that could be incorrect)<br/>
<span style="color: #9e3997"><span style="font-size: small">(15:15:02)</span> <b>bbockelm:</b></span> Looking at the source code, I don't see anything that would cancel rules in <tt>condor_token_request_auto_approve</tt>.<br/>
<span style="color: #827327"><span style="font-size: small">(15:15:55)</span> <b>jamie.rajewski:</b></span> okay, once I get this alternate solution tested I will go back to what I had before and get the logs for you to see if we can spot what's happening<br/>
<span style="color: #9e3997"><span style="font-size: small">(15:18:33)</span> <b>bbockelm:</b></span> Yeah - unfortunately, I don't see that many helpful "by default" log lines.  <tt>D_SECURITY,D_FULLDEBUG</tt> might be helpful in figuring it out.<br/>
<span style="color: #827327"><span style="font-size: small">(16:54:35)</span> <b>jamie.rajewski:</b></span> Sorry for the delay, this new idea didnt work either. I had a peak at the CollectorLog and found the following:<br/><pre>02/08/21 21:57:22 PERMISSION DENIED to CONDOR_ANONYMOUS_USER from host 192.168.254.17 for command 2 (UPDATE_MASTER_AD), access level ADVERTISE_MASTER: reason: ADVERTISE_MASTER authorization policy denies IP address 192.168.254.17<br/>02/08/21 21:57:22 DC_AUTHENTICATE: Command not authorized, done!<br/>02/08/21 21:59:17 PERMISSION DENIED to CONDOR_ANONYMOUS_USER from host 192.168.254.25 for command 1 (UPDATE_SCHEDD_AD), access level ADVERTISE_SCHEDD: reason: ADVERTISE_SCHEDD authorization policy denies IP address 192.168.254.25<br/>02/08/21 21:59:17 DC_AUTHENTICATE: Command not authorized, done!<br/>02/08/21 21:59:22 PERMISSION DENIED to CONDOR_ANONYMOUS_USER from host 192.168.254.25 for command 2 (UPDATE_MASTER_AD), access level ADVERTISE_MASTER: reason: ADVERTISE_MASTER authorization policy denies IP address 192.168.254.25<br/>02/08/21 21:59:22 DC_AUTHENTICATE: Command not authorized, done!</pre><br/><br/>
<span style="color: #9e3997"><span style="font-size: small">(16:55:24)</span> <b>bbockelm:</b></span> that's not what you're looking for - that's just the failure which should trigger the automatic request.<br/>
<span style="color: #9e3997"><span style="font-size: small">(16:55:43)</span> <b>bbockelm:</b></span> the schedd / master is supposed to notice the failure to advertise and decide to request a token.<br/>
<span style="color: #827327"><span style="font-size: small">(16:55:54)</span> <b>jamie.rajewski:</b></span> ah okay, let me keep looking<br/>
<span style="color: #9e3997"><span style="font-size: small">(16:56:57)</span> <b>bbockelm:</b></span> (given we don't have useful debug messages and it's my fault, I'll happily look at things with <tt>D_SECURITY,D_FULLDEBUG</tt>.  Would appreciate the master log and the collector log at that level if you have 'em)<br/>
<span style="color: #827327"><span style="font-size: small">(16:57:19)</span> <b>jamie.rajewski:</b></span> sure, let me throw those in there and I'll retry it and grab the logs<br/>
<span style="color: #827327"><span style="font-size: small">(17:26:09)</span> <b>jamie.rajewski:</b></span> there we go, I wanted to have a fresh deployment and also undo my service idea, so this is the result of starting condor, waiting a few seconds, then initiating the rule in the provisioner in Terraform<br/>
<span style="color: #827327"><span style="font-size: small">(17:29:23)</span> <b>jamie.rajewski:</b></span> And for reference, here is the message in the <tt>StartLog</tt> on one of the workers<br/><pre>02/08/21 23:28:50 Token requested not yet approved; please ask collector 192.168.254.36 admin to approve request ID 4760694.</pre><br/>
</body>
</html>
