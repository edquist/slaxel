<!DOCTYPE html>
<html>
<head>
<title>Fri Aug 28, 2020 : #icecube-condor (osg)</title>
</head>
<body>
<h3>Fri Aug 28, 2020 : #icecube-condor (osg)</h3>
<span style="color: #827327"><span style="font-size: small">(12:14:03)</span> <b>jamie.rajewski:</b></span> Hi again, I just tried some of this. So <tt>condor_status -any</tt> works fine as the root user on the submit node, and returns a result similar to what you showed. However, when I tried as the submituser it failed. I added the debug information as you specified, and this is what came up:<br/><pre>[submituser@pop-os ~]$ condor_status -any -debug<br/>08/28/20 17:13:32 Can't open directory "/etc/condor/passwords.d" as PRIV_UNKNOWN, errno: 13 (Permission denied)<br/>08/28/20 17:13:32 SECMAN: required authentication with collector at &lt;127.0.0.1:9618&gt; failed, so aborting command QUERY_ANY_ADS.<br/>Error: communication error<br/>AUTHENTICATE:1003:Failed to authenticate with any method<br/>AUTHENTICATE:1004:Failed to authenticate using IDTOKENS<br/>AUTHENTICATE:1004:Failed to authenticate using FS</pre><br/>
<span style="color: #827327"><span style="font-size: small">(12:14:53)</span> <b>jamie.rajewski:</b></span> I'll check the logs as well<br/>
<span style="color: #c386df"><span style="font-size: small">(12:16:06)</span> <b>matyas:</b></span> Which container did you create the token for the submit user on?<br/>
<span style="color: #827327"><span style="font-size: small">(12:16:16)</span> <b>jamie.rajewski:</b></span> the cm<br/>
<span style="color: #827327"><span style="font-size: small">(12:16:51)</span> <b>jamie.rajewski:</b></span> is that the correct place to generate it?<br/>
<span style="color: #c386df"><span style="font-size: small">(12:17:23)</span> <b>matyas:</b></span> yes... can you run "condor_token_list" as submituser?<br/>
<span style="color: #827327"><span style="font-size: small">(12:17:46)</span> <b>jamie.rajewski:</b></span> <pre>[submituser@pop-os ~]$ condor_token_list<br/>Header: {"alg":"HS256","kid":"POOL"} Payload: {"iat":1598634601,"iss":"8ca8ab236729","jti":"1ba17edb6bacc365abd2b7da54ab508a","scope":"condor:\/WRITE","sub":"submituser@jamie"} File: /home/submituser/.condor/tokens.d/token</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(12:19:09)</span> <b>matyas:</b></span> what are the permissions on that file?<br/>
<span style="color: #827327"><span style="font-size: small">(12:19:41)</span> <b>jamie.rajewski:</b></span> <pre>-rw-r--r-- 1 root root 258 Aug 28 17:10 .condor/tokens.d/token</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(12:19:57)</span> <b>matyas:</b></span> change it to submituser 0600<br/>
<span style="color: #827327"><span style="font-size: small">(12:21:31)</span> <b>jamie.rajewski:</b></span> submituser cant change the permissions on it, should I just change it as root then?<br/>
<span style="color: #827327"><span style="font-size: small">(12:22:24)</span> <b>jamie.rajewski:</b></span> or do you mean <tt>chown</tt> it to submituser, then change the permissions?<br/>
<span style="color: #c386df"><span style="font-size: small">(12:24:05)</span> <b>matyas:</b></span> Either way.<br/>
<span style="color: #827327"><span style="font-size: small">(12:24:49)</span> <b>jamie.rajewski:</b></span> Alright I did it, still the same result for condor_status<br/>
<span style="color: #c386df"><span style="font-size: small">(12:25:44)</span> <b>matyas:</b></span> Hmm. Let's look at the CollectorLog again.<br/>
<span style="color: #827327"><span style="font-size: small">(12:26:53)</span> <b>jamie.rajewski:</b></span> <br/>
<span style="color: #827327"><span style="font-size: small">(12:29:16)</span> <b>jamie.rajewski:</b></span> out of curiosity, what is the difference between these two:<br/><pre>AuthMethods = "FS"<br/>AuthMethodsList = "FS,TOKEN"</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(12:46:56)</span> <b>matyas:</b></span> I don't know and unfortunately our security person is out today. I'm looking at this:<br/><pre>08/28/20 17:24:26 Authentication was a Success.<br/>08/28/20 17:24:26 ZKM: setting default map to submituser@jamie<br/>08/28/20 17:24:26 ZKM: post-map: current user is 'submituser'<br/>...<br/>08/28/20 17:24:26 DC_AUTHENTICATE: authentication of &lt;172.17.0.1:41286&gt; was successful but resulted in a limited authorization which did not include this command (48 QUERY_ANY_ADS), so aborting.</pre><br/><br/>
<span style="color: #827327"><span style="font-size: small">(12:47:21)</span> <b>jamie.rajewski:</b></span> ah interesting<br/>
<span style="color: #c386df"><span style="font-size: small">(12:48:25)</span> <b>matyas:</b></span> I'm a little confused. WRITE ought to imply READ, but maybe that's not working for tokens.<br/>Can you try making a new token for submituser, without specifying any <tt>-authz</tt> arguments? (That makes the token have all the permissions that user would normally be granted.)<br/>
<span style="color: #c386df"><span style="font-size: small">(12:50:17)</span> <b>matyas:</b></span> Be sure to remove the old token from <tt>~/.condor/tokens.d</tt><br/>
<span style="color: #827327"><span style="font-size: small">(12:57:34)</span> <b>jamie.rajewski:</b></span> Sure let me give it a try<br/>
<span style="color: #827327"><span style="font-size: small">(13:00:24)</span> <b>jamie.rajewski:</b></span> it worked! :<br/><pre>[root@pop-os /]# condor_status -any<br/>MyType             TargetType         Name                                     <br/><br/>Collector          None               My Pool - cb6672e28115@cb6672e28115      <br/>DaemonMaster       None               cb6672e28115                             <br/>Negotiator         None               cb6672e28115                             <br/>DaemonMaster       None               pop-os.localdomain                       <br/>Accounting         none               &lt;none&gt;                                   <br/>[root@pop-os /]# su - submituser<br/>[submituser@pop-os ~]$ condor_status -any<br/>MyType             TargetType         Name                                     <br/><br/>Collector          None               My Pool - cb6672e28115@cb6672e28115      <br/>DaemonMaster       None               cb6672e28115                             <br/>Negotiator         None               cb6672e28115                             <br/>DaemonMaster       None               pop-os.localdomain                       <br/>Accounting         none               &lt;none&gt;</pre><br/><br/>
<span style="color: #827327"><span style="font-size: small">(13:00:38)</span> <b>jamie.rajewski:</b></span> I tried it as root first to compare and it is the same<br/>
<span style="color: #c386df"><span style="font-size: small">(13:00:54)</span> <b>matyas:</b></span> Great!<br/>
<span style="color: #c386df"><span style="font-size: small">(13:01:04)</span> <b>matyas:</b></span> except it looks like the schedd is not talking to the collector<br/>
<span style="color: #827327"><span style="font-size: small">(13:01:18)</span> <b>jamie.rajewski:</b></span> ah dang<br/>
<span style="color: #827327"><span style="font-size: small">(13:01:33)</span> <b>jamie.rajewski:</b></span> yep:<br/><pre>[submituser@pop-os ~]$ condor_q<br/><br/>-- Failed to fetch ads from: &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt; : pop-os.localdomain<br/>CEDAR:6001:Failed to connect to &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt;</pre><br/>
<span style="color: #827327"><span style="font-size: small">(13:02:03)</span> <b>jamie.rajewski:</b></span> with debug:<br/><pre>[submituser@pop-os ~]$ condor_q -debug<br/>08/28/20 18:01:49 Can't find address in classad for schedd pop-os.localdomain<br/>08/28/20 18:01:49 SharedPortServer: failed to connect to schedd_29_7856 as requested by &lt;192.168.187.192:42265&gt;: No such file or directory (err=2)<br/><br/>-- Failed to fetch ads from: &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt; : pop-os.localdomain<br/>CEDAR:6001:Failed to connect to &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt;</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(13:02:37)</span> <b>matyas:</b></span> Can you shut down the worker node for now? It might be interfering...<br/>
<span style="color: #c386df"><span style="font-size: small">(13:02:59)</span> <b>matyas:</b></span> and then restart the submit node<br/>
<span style="color: #827327"><span style="font-size: small">(13:03:58)</span> <b>jamie.rajewski:</b></span> Sure<br/>
<span style="color: #827327"><span style="font-size: small">(13:05:40)</span> <b>jamie.rajewski:</b></span> <pre>[root@pop-os /]# condor_q<br/><br/>-- Schedd: pop-os.localdomain : &lt;192.168.187.192:46831?... @ 08/28/20 18:04:37<br/>OWNER BATCH_NAME      SUBMITTED   DONE   RUN    IDLE   HOLD  TOTAL JOB_IDS<br/><br/>Total for query: 0 jobs; 0 completed, 0 removed, 0 idle, 0 running, 0 held, 0 suspended <br/>Total for all users: 0 jobs; 0 completed, 0 removed, 0 idle, 0 running, 0 held, 0 suspended<br/><br/>[root@pop-os /]# condor_status -any<br/>MyType             TargetType         Name                                     <br/><br/>DaemonMaster       None               4dd0d8551f1f                             <br/>Negotiator         None               4dd0d8551f1f                             <br/>Collector          None               My Pool - 4dd0d8551f1f@4dd0d8551f1f      <br/>DaemonMaster       None               pop-os.localdomain                       <br/>Accounting         none               &lt;none&gt;                                   <br/>[root@pop-os /]# su - submituser<br/>[submituser@pop-os ~]$ condor_q<br/><br/>-- Failed to fetch ads from: &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt; : pop-os.localdomain<br/>CEDAR:6001:Failed to connect to &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt;<br/>[submituser@pop-os ~]$ condor_q -debug<br/>08/28/20 18:05:01 Can't find address in classad for schedd pop-os.localdomain<br/>08/28/20 18:05:01 SharedPortServer: failed to connect to schedd_29_7856 as requested by &lt;192.168.187.192:33573&gt;: No such file or directory (err=2)<br/><br/>-- Failed to fetch ads from: &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt; : pop-os.localdomain<br/>CEDAR:6001:Failed to connect to &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt;</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(13:06:42)</span> <b>matyas:</b></span> Can you check <tt>ps</tt> for a <tt>condor_schedd</tt> process?<br/>
<span style="color: #827327"><span style="font-size: small">(13:07:41)</span> <b>jamie.rajewski:</b></span> <pre>systemd+  157582  0.2  0.0  48504 11916 ?        Ss   12:04   0:00 condor_schedd</pre><br/>
<span style="color: #827327"><span style="font-size: small">(13:08:12)</span> <b>jamie.rajewski:</b></span> so the schedd daemon is supposed to show up in that list when you run condor_status -any?<br/>
<span style="color: #c386df"><span style="font-size: small">(13:09:13)</span> <b>matyas:</b></span> Yep, you're supposed to see a line like<br/><pre>Scheduler          None               <a href="http://siren.cs.wisc.edu">siren.cs.wisc.edu</a></pre><br/><br/>
<span style="color: #c386df"><span style="font-size: small">(13:09:50)</span> <b>matyas:</b></span> So it looks like the scheduler's not successfully advertising to the collector.<br/>
<span style="color: #c386df"><span style="font-size: small">(13:10:07)</span> <b>matyas:</b></span> Can you run <tt>condor_token_list</tt> as root in the submit container?<br/>
<span style="color: #827327"><span style="font-size: small">(13:14:36)</span> <b>jamie.rajewski:</b></span> <pre>[root@pop-os /]# condor_token_list<br/>Header: {"alg":"HS256","kid":"POOL"} Payload: {"iat":1598637869,"iss":"localhost:9618","jti":"29f7c41a5bc029cf73308dee0a973e20","scope":"condor:\/ADVERTISE_MASTER condor:\/ADVERTISE_SCHEDD condor:\/READ","sub":"<a href="mailto:dockersubmit@example.net">dockersubmit@example.net</a>"} File: /etc/condor/tokens.d/dockersubmit<br/>Header: {"alg":"HS256","kid":"POOL"} Payload: {"iat":1598637869,"iss":"4dd0d8551f1f","jti":"4de8f09cad0cd3222a2b9cd4b3f70ab3","scope":"condor:\/ADVERTISE_MASTER condor:\/ADVERTISE_STARTD condor:\/READ","sub":"dockerworker@jamie"} File: /etc/condor/tokens.d/token</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(13:17:00)</span> <b>matyas:</b></span> I don't see anything trying to authenticate as dockersubmit in your CollectorLog. I think you need to remove the token for dockerworker@jamie (/etc/condor/tokens.d/token) from the submit container.<br/>
<span style="color: #c386df"><span style="font-size: small">(13:17:27)</span> <b>matyas:</b></span> Remember, condor tries all the tokens in that directory and goes with the first one that works<br/>
<span style="color: #c386df"><span style="font-size: small">(13:17:54)</span> <b>matyas:</b></span> and your submit host is getting authenticated as an execute host instead, which doesn't have ADVERTISE_SCHEDD permissions<br/>
<span style="color: #827327"><span style="font-size: small">(13:19:52)</span> <b>jamie.rajewski:</b></span> ah okay, I forgot that that first token had the dockerworker identity; let me remove it<br/>
<span style="color: #827327"><span style="font-size: small">(13:21:17)</span> <b>jamie.rajewski:</b></span> Alright, the create token script will now just generate the submit one, and I deleted all tokens to start fresh:<br/><pre># # Create the execute token                                                                                       <br/># condor_token_create -authz ADVERTISE_MASTER \                                                                    <br/>#          -authz ADVERTISE_STARTD -authz READ -identity dockerworker@jamie \                                      <br/>#          &gt; /root/secrets/token                                                                                   <br/>                                                                                                                   <br/># Create the submituser token (stored only on the submit node)                                                     <br/>condor_token_create -identity submituser@jamie \                                                                   <br/>                    &gt; /root/submitsecrets/token</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(13:22:04)</span> <b>matyas:</b></span> Looks good.<br/>
<span style="color: #827327"><span style="font-size: small">(13:22:17)</span> <b>jamie.rajewski:</b></span> <pre>[root@pop-os /]# condor_status -any -debug<br/>08/28/20 18:21:43 TOKEN: No token found.<br/>08/28/20 18:21:43 SECMAN: required authentication with collector at &lt;127.0.0.1:9618&gt; failed, so aborting command QUERY_ANY_ADS.<br/>Error: communication error<br/>AUTHENTICATE:1003:Failed to authenticate with any method<br/>AUTHENTICATE:1004:Failed to authenticate using IDTOKENS<br/>AUTHENTICATE:1004:Failed to authenticate using FS<br/>[root@pop-os /]# condor_token_list<br/>Header: {"alg":"HS256","kid":"POOL"} Payload: {"iat":1598638881,"iss":"localhost:9618","jti":"1f385150e2ae3c38e171ac3290d17b4a","scope":"condor:\/ADVERTISE_MASTER condor:\/ADVERTISE_SCHEDD condor:\/READ","sub":"<a href="mailto:dockersubmit@example.net">dockersubmit@example.net</a>"} File: /etc/condor/tokens.d/dockersubmit</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(13:24:21)</span> <b>matyas:</b></span> You're root right now. Can you try that as submituser?<br/>
<span style="color: #827327"><span style="font-size: small">(13:25:25)</span> <b>jamie.rajewski:</b></span> sorry, I was simulateneously trying to deal with an issue on our cluster. Here it is:<br/><pre>[submituser@pop-os ~]$ condor_token_list<br/>Header: {"alg":"HS256","kid":"POOL"} Payload: {"iat":1598638881,"iss":"345e08295a22","jti":"0562647b59bb1ea331a45ac5f719adbd","sub":"submituser@jamie"} File: /home/submituser/.condor/tokens.d/token<br/>[submituser@pop-os ~]$ condor_status -any -debug<br/>08/28/20 18:24:51 Can't open directory "/etc/condor/passwords.d" as PRIV_UNKNOWN, errno: 13 (Permission denied)<br/>MyType             TargetType         Name                                     <br/><br/>DaemonMaster       None               345e08295a22                             <br/>Negotiator         None               345e08295a22                             <br/>Collector          None               My Pool - 345e08295a22@345e08295a22      <br/>Accounting         none               &lt;none&gt;</pre><br/>
<span style="color: #827327"><span style="font-size: small">(13:25:34)</span> <b>jamie.rajewski:</b></span> so it still isnt showing up in the list<br/>
<span style="color: #c386df"><span style="font-size: small">(13:26:08)</span> <b>matyas:</b></span> OK, let's check the CollectorLog and SchedLog again<br/>
<span style="color: #827327"><span style="font-size: small">(13:27:34)</span> <b>jamie.rajewski:</b></span> <br/>
<span style="color: #827327"><span style="font-size: small">(13:28:09)</span> <b>jamie.rajewski:</b></span> <br/>
<span style="color: #c386df"><span style="font-size: small">(13:35:53)</span> <b>matyas:</b></span> This is interesting:<br/><pre>08/28/20 18:21:29 TOKEN: Will use tokens found in /etc/condor/tokens.d/dockersubmit.<br/>08/28/20 18:21:29 JWT object was signed with server key POOL (out of 1 possible keys)<br/>08/28/20 18:21:29 TOKEN: No token found.<br/>08/28/20 18:21:29 PW: Failed to fetch a login name<br/>08/28/20 18:21:29 PW: Generating ra.<br/>08/28/20 18:21:29 PW: Client sending.<br/>08/28/20 18:21:29 Client error: NULL in send?<br/>08/28/20 18:21:29 Client sending: -1, 0(), 0<br/>08/28/20 18:21:29 condor_write(fd=14 collector localhost:9618,,size=31,timeout=20,flags=0,non_blocking=0)<br/>08/28/20 18:21:29 PW: Client receiving.<br/>08/28/20 18:21:29 condor_read(fd=14 collector localhost:9618,,size=5,timeout=20,flags=0,non_blocking=0)<br/>08/28/20 18:21:29 condor_read(): fd=14<br/>08/28/20 18:21:29 condor_read(): select returned 1<br/>08/28/20 18:21:29 condor_read(fd=14 collector localhost:9618,,size=50,timeout=20,flags=0,non_blocking=0)<br/>08/28/20 18:21:29 condor_read(): fd=14<br/>08/28/20 18:21:29 condor_read(): select returned 1<br/>08/28/20 18:21:29 Server sent status indicating not OK.<br/>08/28/20 18:21:29 PW: Client received ERROR from server, propagating<br/>08/28/20 18:21:29 PW: CLient sending two.<br/>08/28/20 18:21:29 In client_send_two.<br/>08/28/20 18:21:29 Client error: don't know my own name?<br/>08/28/20 18:21:29 Can't send null for random string.<br/>08/28/20 18:21:29 Client error: I have no name?<br/>08/28/20 18:21:29 Client sending: 0() 0 0</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(13:36:14)</span> <b>matyas:</b></span> I'll ask the condor devs if they have any suggestions.<br/>
<span style="color: #827327"><span style="font-size: small">(13:36:27)</span> <b>jamie.rajewski:</b></span> sure, that is strange<br/>
<span style="color: #c386df"><span style="font-size: small">(13:50:54)</span> <b>matyas:</b></span> Just to double-check, can you run condor_token_list as root from inside the submit container? From your prompt <tt>[root@pop-os /]</tt> it looked like you were running it from outside.<br/>
<span style="color: #827327"><span style="font-size: small">(13:52:35)</span> <b>jamie.rajewski:</b></span> Yea for sure, I'm not sure why inside the container it shows the host as my actual host whereas in other containers it shows a hash or something. Proof:<br/><pre>jamie@pop-os:~/Documents/IceCube/task6-pyglidein-rewrite/testing/condor-deployment$ docker exec -ti submit bash<br/>[root@pop-os /]# condor_token_list<br/>Header: {"alg":"HS256","kid":"POOL"} Payload: {"iat":1598640685,"iss":"localhost:9618","jti":"58148a50dfe1a8e833d6f41c02085bdb","scope":"condor:\/ADVERTISE_MASTER condor:\/ADVERTISE_SCHEDD condor:\/READ","sub":"<a href="mailto:dockersubmit@example.net">dockersubmit@example.net</a>"} File: /etc/condor/tokens.d/dockersubmit<br/>[root@pop-os /]#</pre><br/><br/>
<span style="color: #c386df"><span style="font-size: small">(14:12:05)</span> <b>matyas:</b></span> can you run <tt>condor_config_val TRUST_DOMAIN</tt> in the cm container?<br/>
<span style="color: #827327"><span style="font-size: small">(14:12:32)</span> <b>jamie.rajewski:</b></span> <pre>[root@ac04b4de6a6b /]# condor_config_val TRUST_DOMAIN<br/>ac04b4de6a6b<br/>[root@ac04b4de6a6b /]# </pre><br/>
<span style="color: #c386df"><span style="font-size: small">(14:29:11)</span> <b>matyas:</b></span> Can you set TRUST_DOMAIN=localhost:9618 in the cm? Apparently it has to match the "iss" (issuer) in the token in order for the token to work. Also, after doing that, can you use condor_token_create on the cm and create a new token for submituser with the right iss?<br/>
<span style="color: #827327"><span style="font-size: small">(14:31:09)</span> <b>jamie.rajewski:</b></span> Sure, I will add it to the condor config for the cm, then the rest should stay the same once I wipe the old tokens<br/>
<span style="color: #827327"><span style="font-size: small">(14:32:35)</span> <b>jamie.rajewski:</b></span> Alright, the trusted domain changed successfully:<br/><pre>[root@5a0b6e094a67 /]# condor_config_val TRUST_DOMAIN<br/>localhost:9618<br/>[root@5a0b6e094a67 /]#</pre><br/>which means the token should have also been created with this<br/>
<span style="color: #827327"><span style="font-size: small">(14:34:00)</span> <b>jamie.rajewski:</b></span> still no dice on the submituser though:<br/><pre>[submituser@pop-os ~]$ condor_status -any<br/>MyType             TargetType         Name                                     <br/><br/>DaemonMaster       None               5a0b6e094a67                             <br/>Negotiator         None               5a0b6e094a67                             <br/>Collector          None               My Pool - 5a0b6e094a67@5a0b6e094a67      <br/>Accounting         none               &lt;none&gt;                                   <br/>[submituser@pop-os ~]$ condor_q<br/><br/>-- Failed to fetch ads from: &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt; : pop-os.localdomain<br/>CEDAR:6001:Failed to connect to &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=schedd_29_7856&gt;<br/>[submituser@pop-os ~]$ condor_token_list<br/>Header: {"alg":"HS256","kid":"POOL"} Payload: {"iat":1598643102,"iss":"localhost:9618","jti":"6968b9beae184839ce12a42e9e093b87","sub":"submituser@jamie"} File: /home/submituser/.condor/tokens.d/token<br/>[submituser@pop-os ~]$ </pre><br/>
<span style="color: #c386df"><span style="font-size: small">(14:34:32)</span> <b>matyas:</b></span> or the scheduler it looks like<br/>
<span style="color: #c386df"><span style="font-size: small">(15:57:20)</span> <b>matyas:</b></span> anything new in the logs?<br/>
<span style="color: #827327"><span style="font-size: small">(16:00:38)</span> <b>jamie.rajewski:</b></span> <br/>
<span style="color: #827327"><span style="font-size: small">(16:04:17)</span> <b>jamie.rajewski:</b></span> <br/>
<span style="color: #c386df"><span style="font-size: small">(16:06:43)</span> <b>matyas:</b></span> SchedLog shows that it's successfully _sending_ the data<br/>
<span style="color: #c386df"><span style="font-size: small">(16:10:39)</span> <b>matyas:</b></span> ... but the collector is not accepting it:<br/><pre>08/28/20 21:03:32 ZKM: setting default map to <a href="mailto:dockersubmit@example.net">dockersubmit@example.net</a><br/>08/28/20 21:03:32 ZKM: post-map: current user is 'dockersubmit'<br/>08/28/20 21:03:32 ZKM: post-map: current domain is '<a href="http://example.net">example.net</a>'<br/>08/28/20 21:03:32 ZKM: post-map: current FQU is '<a href="mailto:dockersubmit@example.net">dockersubmit@example.net</a>'<br/>08/28/20 21:03:32 AUTHENTICATE: Exchanging keys with remote side.<br/>08/28/20 21:03:32 condor_write(fd=15 &lt;172.17.0.1:45010&gt;,,size=13,timeout=20,flags=0,non_blocking=0)<br/>08/28/20 21:03:32 In Condor_Auth_Passwd::wrap.<br/>08/28/20 21:03:32 condor_write(fd=15 &lt;172.17.0.1:45010&gt;,,size=61,timeout=20,flags=0,non_blocking=0)<br/>08/28/20 21:03:32 AUTHENTICATE: Result of end of authenticate is 1.<br/>08/28/20 21:03:32 DC_AUTHENTICATE: authentication of 172.17.0.1 complete.<br/>08/28/20 21:03:32 DC_AUTHENTICATE: message authenticator enabled with key id be5832b79af9:36:1598648612:12.<br/>08/28/20 21:03:32 DC_AUTHENTICATE: Success.<br/>08/28/20 21:03:32 PERMISSION DENIED to <a href="mailto:dockersubmit@example.net">dockersubmit@example.net</a> from host 172.17.0.1 for command 2 (UPDATE_MASTER_AD), access level ADVERTISE_MASTER: reason: cached result for ADVERTISE_MASTER; see first case for the full reason</pre><br/><br/>
<span style="color: #827327"><span style="font-size: small">(16:11:13)</span> <b>jamie.rajewski:</b></span> why does it show <tt>@example.net</tt> though?<br/>
<span style="color: #827327"><span style="font-size: small">(16:11:58)</span> <b>jamie.rajewski:</b></span> the phony test host should be <tt>@jamie</tt><br/>
<span style="color: #c386df"><span style="font-size: small">(16:16:01)</span> <b>matyas:</b></span> Not sure. Check if there are any other token files (or files with multiple tokens?) in /etc/condor/tokens.d on the submit container<br/>
<span style="color: #c386df"><span style="font-size: small">(16:16:51)</span> <b>matyas:</b></span> Also, I just looked at your cm config and noticed you don't have any allow lines for dockersubmit: <a href="https://github.com/jamierajewski/condor-deployment/blob/master/cm/condor_config.local">https://github.com/jamierajewski/condor-deployment/blob/master/cm/condor_config.local</a><br/>
<span style="color: #c386df"><span style="font-size: small">(16:17:53)</span> <b>matyas:</b></span> you probably want to add <tt>dockersubmit@jamie</tt> to <tt>ALLOW_ADVERTISE_MASTER</tt> and also add<br/><pre>ALLOW_ADVERTISE_SCHEDD = $(ALLOW_ADVERTISE_SCHEDD) dockersubmit@jamie</pre><br/><br/>
<span style="color: #827327"><span style="font-size: small">(16:41:03)</span> <b>jamie.rajewski:</b></span> In the submit node at <tt>/etc/condor/tokens.d</tt> there is indeed a token, <tt>dockersubmit</tt> which I didnt create. That must be from the image but I'm not sure how or why if I have to create my own token<br/>
<span style="color: #827327"><span style="font-size: small">(16:41:11)</span> <b>jamie.rajewski:</b></span> and I shall add that to my config<br/>
<span style="color: #827327"><span style="font-size: small">(16:43:49)</span> <b>jamie.rajewski:</b></span> Alright my updated cm config:<br/><pre>ALLOW_ADVERTISE_MASTER = \                                                                                         <br/>    $(ALLOW_ADVERTISE_MASTER) \                                                                                    <br/>    $(ALLOW_WRITE_COLLECTOR) \                                                                                     <br/>    dockerworker@jamie dockersubmit@jamie                                                                          <br/>                                                                                                                   <br/>ALLOW_ADVERTISE_STARTD = \                                                                                         <br/>    $(ALLOW_ADVERTISE_STARTD) \                                                                                    <br/>    $(ALLOW_WRITE_COLLECTOR) \                                                                                     <br/>    dockerworker@jamie                                                                                             <br/>                                                                                                                   <br/>ALLOW_ADVERTISE_SCHEDD = \                                                                                         <br/>    $(ALLOW_ADVERTISE_SCHEDD) \                                                                                    <br/>    dockersubmit@jamie                                                                                             <br/>                                                                                                                   <br/>SEC_USE_FAMILY_SESSION = False                                                                                     <br/>COLLECTOR_DEBUG=D_SECURITY:2 D_NETWORK:2                                                                           <br/>TRUST_DOMAIN=localhost:9618</pre><br/><br/>
<span style="color: #c386df"><span style="font-size: small">(16:44:44)</span> <b>matyas:</b></span> Looks like if you put a pool password into <tt>/root/secrets/pool_password</tt> , then it will automatically create <tt>dockersubmit</tt> and <tt>dockerworker</tt> tokens from that password.<br/>
<span style="color: #c386df"><span style="font-size: small">(16:45:51)</span> <b>matyas:</b></span> <a href="https://github.com/htcondor/htcondor/blob/master/build/docker/services/base/update-secrets#L12-L26">https://github.com/htcondor/htcondor/blob/master/build/docker/services/base/update-secrets#L12-L26</a><br/>
<span style="color: #827327"><span style="font-size: small">(16:46:27)</span> <b>jamie.rajewski:</b></span> huh okay, so should I be using those then and change the cm config to reflect that?<br/>
<span style="color: #c386df"><span style="font-size: small">(16:47:45)</span> <b>matyas:</b></span> No, instead you shouldn't put the pool password in as a secret for the submit container and execute container. That should only be on the cm<br/>
<span style="color: #c386df"><span style="font-size: small">(16:48:19)</span> <b>matyas:</b></span> (I should change that code to only run on the cm)<br/>
<span style="color: #827327"><span style="font-size: small">(16:49:59)</span> <b>jamie.rajewski:</b></span> Oh okay. I removed the mount for it in my submit code so I will try now<br/>
<span style="color: #827327"><span style="font-size: small">(16:53:51)</span> <b>jamie.rajewski:</b></span> <pre>[submituser@pop-os ~]$ condor_status -any -debug<br/>08/28/20 21:51:31 Can't open directory "/etc/condor/passwords.d" as PRIV_UNKNOWN, errno: 13 (Permission denied)</pre><br/>It gave the auth error as before with this line. For reference, my code to launch it looks like this now:<br/><pre># Submit:                                                                                                          <br/>docker run --detach --network host --name=submit \                                                                 <br/>       -e CONDOR_HOST='localhost:9618' \                                                                           <br/>       -v $(pwd -P)/submit/condor_config.local:/etc/condor/condor_config.local \                                   <br/>       -v $(pwd -P)/submitsecrets:/home/submituser/.condor/tokens.d \                                              <br/>       htcondor/submit:8.9.7-el7</pre><br/>so no more mounting the secrets dir where the pool_password lives<br/>
<span style="color: #827327"><span style="font-size: small">(16:54:05)</span> <b>jamie.rajewski:</b></span> I'll fetch the logs<br/>
<span style="color: #827327"><span style="font-size: small">(16:54:40)</span> <b>jamie.rajewski:</b></span> and for reference, that dockersubmit token is indeed gone<br/>
<span style="color: #827327"><span style="font-size: small">(16:56:03)</span> <b>jamie.rajewski:</b></span> <br/>
<span style="color: #827327"><span style="font-size: small">(16:56:12)</span> <b>jamie.rajewski:</b></span> <br/>
<span style="color: #c386df"><span style="font-size: small">(17:25:05)</span> <b>matyas:</b></span> is /etc/condor/passwords.d/POOL still there on the cm?<br/>
<span style="color: #827327"><span style="font-size: small">(18:13:55)</span> <b>jamie.rajewski:</b></span> Yea it is<br/>
<span style="color: #c386df"><span style="font-size: small">(18:24:14)</span> <b>matyas:</b></span> Is the config in your repo here up to date? <a href="https://github.com/jamierajewski/condor-deployment">https://github.com/jamierajewski/condor-deployment</a><br/>I'm seeing some odd lines in the SchedLog:<br/><pre>08/28/20 21:50:20 IPVERIFY: Subsystem SCHEDD<br/>08/28/20 21:50:20 IPVERIFY: Permission ADVERTISE_STARTD<br/>08/28/20 21:50:20 IPVERIFY: allow ADVERTISE_STARTD:  submituser@jamie  <a href="mailto:dockerworker@example.net">dockerworker@example.net</a> (from config value ALLOW_ADVERTISE_STARTD)<br/>08/28/20 21:50:20 IPVERIFY: Subsystem SCHEDD<br/>08/28/20 21:50:20 IPVERIFY: Permission ADVERTISE_SCHEDD<br/>08/28/20 21:50:20 IPVERIFY: allow ADVERTISE_SCHEDD:  submituser@jamie  <a href="mailto:dockerworker@example.net">dockerworker@example.net</a> submituser@jamie  <a href="mailto:dockersubmit@example.net">dockersubmit@example.net</a> (from config value ALLOW_ADVERTISE_SCHEDD)<br/>08/28/20 21:50:20 IPVERIFY: Subsystem SCHEDD<br/>08/28/20 21:50:20 IPVERIFY: Permission ADVERTISE_MASTER<br/>08/28/20 21:50:20 IPVERIFY: allow ADVERTISE_MASTER:  submituser@jamie  <a href="mailto:dockerworker@example.net">dockerworker@example.net</a> (from config value ALLOW_ADVERTISE_MASTER)</pre><br/>ADVERTISE_STARTD, ADVERTISE_SCHEDD, ADVERTISE_MASTER should be part of the cm config, not the submit config.<br/>
<span style="color: #c386df"><span style="font-size: small">(18:25:29)</span> <b>matyas:</b></span> from inside the submit container, can you run <tt>condor_config_val -verbose ALLOW_ADVERTISE_SCHEDD</tt>?<br/>
<span style="color: #827327"><span style="font-size: small">(18:39:36)</span> <b>jamie.rajewski:</b></span> The repo hasn't been updated as of today so I will get the most recent changes put in. I will have to go soon, but I will also run that command first too. The configuration for the submit node does not have that stuff, here is the current version of it:<br/><pre>ALLOW_WRITE = submituser@jamie                                                                                                                          <br/>SEC_USE_FAMILY_SESSION = False                                                                                                                          <br/>SHARED_PORT_PORT = 9621                                                                                                                                 <br/># Workaround to force it to use shared port                                                                                                             <br/>MASTER.COLLECTOR_LIST = $(IP_ADDRESS):$(SHARED_PORT_PORT) $(COLLECTOR_HOST)                                                                             <br/>SCHEDD_DEBUG=D_SECURITY:2 D_NETWORK:2 </pre><br/><br/>
<span style="color: #827327"><span style="font-size: small">(18:47:44)</span> <b>jamie.rajewski:</b></span> alright the repo is updated with the latest on everything<br/>
<span style="color: #827327"><span style="font-size: small">(18:48:38)</span> <b>jamie.rajewski:</b></span> one thing I just noticed is that in the launch script, I only set the permissions for the cm secrets directory, not the submitsecrets dir. I imagine those would also have to be set to 0700?<br/>
<span style="color: #827327"><span style="font-size: small">(18:51:25)</span> <b>jamie.rajewski:</b></span> Also, from inside the submit container as submituser, I ran that bit:<br/><pre>[submituser@pop-os ~]$ condor_config_val -verbose ALLOW_ADVERTISE_SCHEDD<br/>ALLOW_ADVERTISE_SCHEDD =  submituser@jamie  <a href="mailto:dockerworker@example.net">dockerworker@example.net</a> submituser@jamie  <a href="mailto:dockersubmit@example.net">dockersubmit@example.net</a><br/> # at: /etc/condor/config.d/01-security.conf, line 42<br/> # raw: ALLOW_ADVERTISE_SCHEDD = $(ALLOW_ADVERTISE_STARTD) $(ALLOW_WRITE_COLLECTOR) <a href="mailto:dockersubmit@example.net">dockersubmit@example.net</a></pre><br/>
<span style="color: #c386df"><span style="font-size: small">(18:51:27)</span> <b>matyas:</b></span> Doesn't really matter; the secrets directories are bind-mounted under /root, which is already 0700, and the password file and tokens are copied out of there with the right permissions.<br/>
<span style="color: #827327"><span style="font-size: small">(18:51:42)</span> <b>jamie.rajewski:</b></span> ah okay cool<br/>
<span style="color: #827327"><span style="font-size: small">(18:52:33)</span> <b>jamie.rajewski:</b></span> I have to go now, but the repo is updated so feel free to have a look around. We can pick this up on monday or whenever you have time next and I really appreciate all of your help thus far; this has been more complicated than I anticipated haha<br/>
<span style="color: #c386df"><span style="font-size: small">(18:53:35)</span> <b>matyas:</b></span> sure<br/>
<span style="color: #c386df"><span style="font-size: small">(18:53:51)</span> <b>matyas:</b></span> have a good weekend!<br/>
<span style="color: #827327"><span style="font-size: small">(18:54:10)</span> <b>jamie.rajewski:</b></span> You too!<br/>
</body>
</html>
