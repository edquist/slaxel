<!DOCTYPE html>
<html>
<head>
<title>Thu Feb 4, 2021 : #icecube-condor (osg)</title>
</head>
<body>
<h3>Thu Feb 4, 2021 : #icecube-condor (osg)</h3>
<span style="color: #827327"><span style="font-size: small">(15:33:12)</span> <b>jamie.rajewski:</b></span> Hi everyone, I have a (hopefully) simple question about setting up Condor fresh on a cluster. I'm at the stage in the architecture of a new cluster where I need to install the scheduler, so I decided to base it on the latest dev release of Condor and to use the <tt>token</tt> authentication. However, the <a href="https://htcondor.readthedocs.io/en/v8_9_11/admin-manual/quick-start-condor-pool.html#quick-start-setting-up-an-htcondor-pool">quick start guide</a> seems based on <tt>password</tt> auth so I'm not sure what changes to make to it for token auth. I then found <a href="https://htcondor.readthedocs.io/en/v8_9_11/admin-manual/security.html#quick-configuration-of-security">this quick setup for token based auth</a>  which sounds perfectly applicable to our situation, but when I try to use the <tt>condor_token_request_auto_approve</tt> command, I get<br/><pre>Failed to create new auto-approval rule: DAEMON:1:Failed to connect to remote daemon at '&lt;192.168.254.17:9618&gt;'</pre><br/>(which is the local IP of that node) so I'm not sure what I'm missing. This quick security guide mentions that if you use the "default" installation, then you just need to use this command and it will work, but I'm not sure what "default" means in this scenario (just a fresh install of the package? Following the actual quick start install guide in the docs?). The steps I've tried are as follows:<br/>1. Install the package from the repo for Ubuntu 20.04 (and pinning the current latest version)<br/><pre>wget -qO - <a href="https://research.cs.wisc.edu/htcondor/ubuntu/HTCondor-Release.gpg.key">https://research.cs.wisc.edu/htcondor/ubuntu/HTCondor-Release.gpg.key</a> | sudo apt-key add -<br/>echo "deb <a href="http://research.cs.wisc.edu/htcondor/ubuntu/8.9/focal">http://research.cs.wisc.edu/htcondor/ubuntu/8.9/focal</a> focal contrib" | sudo tee -a /etc/apt/sources.list &gt; /dev/null<br/>echo "deb-src <a href="http://research.cs.wisc.edu/htcondor/ubuntu/8.9/focal">http://research.cs.wisc.edu/htcondor/ubuntu/8.9/focal</a> focal contrib" | sudo tee -a /etc/apt/sources.list &gt; /dev/null<br/><br/>sudo apt-get update<br/>sudo apt-get install -y htcondor=8.9.11-1.2</pre><br/>2. Set each node to have the appropriate role as outlined in the quickstart guide<br/><pre># On Submit<br/>echo "use ROLE: Submit" | sudo tee -a /etc/condor/config.d/51-role-submit<br/><br/># On Execute<br/>echo "use ROLE: Execute" | sudo tee -a /etc/condor/config.d/51-role-exec<br/><br/># On CM<br/>echo "use ROLE: CentralManager" | sudo tee -a /etc/condor/config.d/51-role-cm<br/>## (Not sure if this line is necessary, since I want the nodes to auto-join with token auth)<br/>echo "ALLOW_WRITE_COLLECTOR=\$(ALLOW_WRITE) <a href="http://condor-execute.example.com">condor-execute.example.com</a> <a href="http://condor-submit.example.com">condor-submit.example.com</a>" | sudo tee -a /etc/condor/config.d/51-role-cm</pre><br/>3. After that, I tried following the remainder of the quickstart to install the default security config that they have on each node (with the password options switched to <tt>IDTOKENS</tt> ) - I have tried leaving this config as it was in the guide along with making the following changes with no success. Not sure if this was the correct way to use tokens in place of passwords but from reading, it sounded like it:<br/><pre>echo '<br/>SEC_PASSWORD_FILE = /etc/condor/passwords.d/POOL<br/>SEC_DAEMON_AUTHENTICATION = REQUIRED<br/>SEC_DAEMON_INTEGRITY = REQUIRED<br/>SEC_DAEMON_AUTHENTICATION_METHODS = IDTOKENS<br/>SEC_NEGOTIATOR_AUTHENTICATION = REQUIRED<br/>SEC_NEGOTIATOR_INTEGRITY = REQUIRED<br/>SEC_NEGOTIATOR_AUTHENTICATION_METHODS = IDTOKENS<br/>SEC_CLIENT_AUTHENTICATION_METHODS = IDTOKENS<br/>ALLOW_DAEMON = condor_pool@*/*, condor@*/$(IP_ADDRESS)<br/>ALLOW_NEGOTIATOR = condor_pool@*/condor-cm.example.com<br/>' | sudo tee /etc/condor/config.d/50-security &gt; /dev/null</pre><br/>4. Start up the CM with<br/><pre>sudo systemctl enable condor<br/>sudo systemctl start condor</pre><br/>and run<br/><pre>sudo condor_token_request_auto_approve -netblock 192.168.0.0/24 -lifetime 3600</pre><br/>which then results in the above error. Hopefully this is enough info, but let me know if you need anything else.<br/><br/>One other point to mention is I am doing this in Terraform (although I also tested on some test instances), so I ensure that the CM is deployed and configured first with the above settings along with correct firewall rules (only allowing internal traffic on any port which does indeed work). Thank you!<br/>
<span style="color: #c386df"><span style="font-size: small">(17:21:48)</span> <b>matyas:</b></span> can you try it out with just password auth to see if they can talk to each other in the first place?<br/>
<span style="color: #827327"><span style="font-size: small">(17:28:51)</span> <b>jamie.rajewski:</b></span> Sure, let me rebuild the instances and reinstall with password auth<br/>
<span style="color: #827327"><span style="font-size: small">(17:41:20)</span> <b>jamie.rajewski:</b></span> Ok, I ran the quick install guide for password auth and it works. Each of the instances are connected, and the worker shows up in <tt>condor_status</tt><br/>
<span style="color: #827327"><span style="font-size: small">(17:42:55)</span> <b>jamie.rajewski:</b></span> So from here, how would I properly redo the setup using auto authenticated tokens?<br/>
<span style="color: #c386df"><span style="font-size: small">(17:45:06)</span> <b>matyas:</b></span> Are you running condor_token_request_auto_approve on the central manager?<br/>
<span style="color: #c386df"><span style="font-size: small">(17:45:22)</span> <b>matyas:</b></span> (or were you I should say)<br/>
<span style="color: #827327"><span style="font-size: small">(17:45:33)</span> <b>jamie.rajewski:</b></span> Yes<br/>
<span style="color: #c386df"><span style="font-size: small">(17:46:05)</span> <b>matyas:</b></span> and condor_token_request_auto_approve itself was exiting with the error?<br/>
<span style="color: #827327"><span style="font-size: small">(17:46:59)</span> <b>jamie.rajewski:</b></span> Yes, it said something like "policy started, no pending requests"<br/>
<span style="color: #827327"><span style="font-size: small">(17:48:24)</span> <b>jamie.rajewski:</b></span> I can retry it and then send you the output of the logs from the schedd or exec to see what's happening. Before that though, what adjustments should I make to the security config? Is changing PASSWORD to IDTOKENS sufficient for this purpose?<br/>
<span style="color: #c386df"><span style="font-size: small">(17:56:39)</span> <b>matyas:</b></span> not sure; try adding it to the auth list (put it before PASSWORD) instead of replacing PASSWORD. Also, can you set <tt>COLLECTOR_DEBUG = D_NETWORK D_SECURITY</tt> on the central manager and <tt>SCHEDD_DEBUG = D_NETWORK D_SECURITY</tt> on the schedd?<br/>
<span style="color: #43761b"><span style="font-size: small">(17:57:05)</span> <b>blin:</b></span> also <tt>D_ALWAYS:2 D_CAT</tt> to both<br/>
<span style="color: #827327"><span style="font-size: small">(18:05:05)</span> <b>jamie.rajewski:</b></span> I'm just finishing for the day but I'll try first thing tomorrow with these suggestions and update you guys, thank you!<br/>
<span style="color: #c386df"><span style="font-size: small">(18:08:12)</span> <b>matyas:</b></span> sure no prob<br/>
</body>
</html>
