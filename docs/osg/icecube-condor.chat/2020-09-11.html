<!DOCTYPE html>
<html>
<head>
<title>Fri Sep 11, 2020 : #icecube-condor (osg)</title>
</head>
<body>
<h3>Fri Sep 11, 2020 : #icecube-condor (osg)</h3>
<span style="color: #827327"><span style="font-size: small">(11:49:24)</span> <b>jamie.rajewski:</b></span> I tried the new images and it did indeed solve that issue!<br/><pre>[root@pop-os /]# condor_status -any<br/>MyType             TargetType         Name                                     <br/><br/>Collector          None               My Pool - b2f07cea9d74@b2f07cea9d74      <br/>DaemonMaster       None               b2f07cea9d74                             <br/>Negotiator         None               b2f07cea9d74                             <br/>Scheduler          None               pop-os.localdomain                       <br/>DaemonMaster       None               pop-os.localdomain                       <br/>Accounting         none               &lt;none&gt;</pre><br/>The scheduler now shows up, and condor_q works. Now just to get the execute image working and that should be it<br/>
<span style="color: #c386df"><span style="font-size: small">(11:57:37)</span> <b>matyas:</b></span> Great! You'll have to use a different port for the shared port in the execute image too.<br/>
<span style="color: #827327"><span style="font-size: small">(11:59:52)</span> <b>jamie.rajewski:</b></span> So if my submit config currently looks like<br/><pre>ALLOW_WRITE = submituser@jamie<br/>SEC_USE_FAMILY_SESSION = False<br/>SHARED_PORT_PORT = 9621</pre><br/>(after removing the workaround) then will the execute one look like<br/><pre>SEC_USE_FAMILY_SESSION = False<br/>SHARED_PORT_PORT = 9622</pre><br/>? I'll give it a go<br/>
<span style="color: #c386df"><span style="font-size: small">(12:00:50)</span> <b>matyas:</b></span> Yep, that should be good.<br/>
<span style="color: #827327"><span style="font-size: small">(12:04:51)</span> <b>jamie.rajewski:</b></span> I commented back in the execute token creation and container launch, along with making that the config, but it doesn't appear in <tt>condor_status -any</tt> and it shows this on the execute node:<br/><pre>[root@pop-os /]# condor_status -any<br/>Error: communication error<br/>AUTHENTICATE:1003:Failed to authenticate with any method<br/>AUTHENTICATE:1004:Failed to authenticate using FS</pre><br/>that probably means it is token related then, I imagine<br/>
<span style="color: #827327"><span style="font-size: small">(12:06:04)</span> <b>jamie.rajewski:</b></span> The MasterLog on the execute is<br/><br/>
<span style="color: #827327"><span style="font-size: small">(12:06:05)</span> <b>jamie.rajewski:</b></span> <pre>09/11/20 17:02:46 ******************************************************<br/>09/11/20 17:02:46 ** condor_master (CONDOR_MASTER) STARTING UP<br/>09/11/20 17:02:46 ** /usr/sbin/condor_master<br/>09/11/20 17:02:46 ** SubsystemInfo: name=MASTER type=MASTER(2) class=DAEMON(1)<br/>09/11/20 17:02:46 ** Configuration: subsystem:MASTER local:&lt;NONE&gt; class:DAEMON<br/>09/11/20 17:02:46 ** $CondorVersion: 8.9.8 Aug 05 2020 BuildID: 513887 PackageID: 8.9.8-1 $<br/>09/11/20 17:02:46 ** $CondorPlatform: x86_64_CentOS7 $<br/>09/11/20 17:02:46 ** PID = 21<br/>09/11/20 17:02:46 ** Log last touched time unavailable (No such file or directory)<br/>09/11/20 17:02:46 ******************************************************<br/>09/11/20 17:02:46 Using config source: /etc/condor/condor_config<br/>09/11/20 17:02:46 Using local config sources: <br/>09/11/20 17:02:46    /etc/condor/config.d/01-ccb.conf<br/>09/11/20 17:02:46    /etc/condor/config.d/01-env.conf<br/>09/11/20 17:02:46    /etc/condor/config.d/01-misc.conf<br/>09/11/20 17:02:46    /etc/condor/config.d/01-pslots.conf<br/>09/11/20 17:02:46    /etc/condor/config.d/01-role.conf<br/>09/11/20 17:02:46    /etc/condor/config.d/01-security.conf<br/>09/11/20 17:02:46    /etc/condor/config.d/01-slotusers.conf<br/>09/11/20 17:02:46    /etc/condor/condor_config.local<br/>09/11/20 17:02:46 config Macros = 148, Sorted = 148, StringBytes = 3774, TablesBytes = 5432<br/>09/11/20 17:02:46 CLASSAD_CACHING is OFF<br/>09/11/20 17:02:46 Daemon Log is logging: D_ALWAYS D_ERROR<br/>09/11/20 17:02:46 SharedPortEndpoint: waiting for connections to named socket master_21_fb94<br/>09/11/20 17:02:46 SharedPortEndpoint: failed to open /var/lock/condor/shared_port_ad: No such file or directory<br/>09/11/20 17:02:46 SharedPortEndpoint: did not successfully find SharedPortServer address. Will retry in 60s.<br/>09/11/20 17:02:46 DaemonCore: private command socket at &lt;192.168.187.192:0?alias=pop-os.localdomain&amp;sock=master_21_fb94&gt;<br/>09/11/20 17:02:46 WARNING: Not attempting to resolve 'localhost:9618' from the security list: it looks like a Sinful string.  A Sinful string specifies how to contact a daemon, but not which address it uses when contacting others.  Use the bare hostname of the trusted machine, or an IP address (if known and unique).<br/>09/11/20 17:02:46 WARNING: Not attempting to resolve 'localhost:9618' from the security list: it looks like a Sinful string.  A Sinful string specifies how to contact a daemon, but not which address it uses when contacting others.  Use the bare hostname of the trusted machine, or an IP address (if known and unique).<br/>09/11/20 17:02:46 Permission denied error during DISCARD_SESSION_KEYRING_ON_STARTUP, continuing anyway<br/>09/11/20 17:02:46 Adding SHARED_PORT to DAEMON_LIST, because USE_SHARED_PORT=true (to disable this, set AUTO_INCLUDE_SHARED_PORT_IN_DAEMON_LIST=False)<br/>09/11/20 17:02:46 Master restart (GRACEFUL) is watching /usr/sbin/condor_master (mtime:1596689493)<br/>09/11/20 17:02:46 Cannot remove wait-for-startup file /var/lock/condor/shared_port_ad<br/>09/11/20 17:02:46 Starting shared port with port: 9622<br/>09/11/20 17:02:47 Started DaemonCore process "/usr/libexec/condor/condor_shared_port", pid and pgroup = 23<br/>09/11/20 17:02:47 Waiting for /var/lock/condor/shared_port_ad to appear.<br/>09/11/20 17:02:48 Found /var/lock/condor/shared_port_ad.<br/>09/11/20 17:02:49 Started DaemonCore process "/usr/sbin/condor_startd", pid and pgroup = 24<br/>09/11/20 17:02:49 Daemons::StartAllDaemons all daemons were started<br/>09/11/20 17:02:52 SECMAN: required authentication with collector localhost:9618 failed, so aborting command UPDATE_MASTER_AD.<br/>09/11/20 17:02:52 ERROR: AUTHENTICATE:1003:Failed to authenticate with any method|AUTHENTICATE:1004:Failed to authenticate using FS<br/>09/11/20 17:02:52 Collector update failed; will try to get a token request for trust domain localhost:9618, identity (default).<br/>09/11/20 17:02:52 Failed to start non-blocking update to &lt;127.0.0.1:9618&gt;.<br/>09/11/20 17:02:52 SECMAN: required authentication with collector localhost:9618 failed, so aborting command DC_START_TOKEN_REQUEST.<br/>09/11/20 17:02:52 Failed to request a new token: DAEMON:1:failed to start command for token request with remote daemon at '&lt;127.0.0.1:9618?alias=localhost&gt;'.|AUTHENTICATE:1003:Failed to authenticate with any method|AUTHENTICATE:1004:Failed to authenticate using FS<br/>09/11/20 17:02:57 Setting ready state 'Ready' for STARTD</pre><br/>
<span style="color: #827327"><span style="font-size: small">(12:08:09)</span> <b>jamie.rajewski:</b></span> I don't think there is a token mount in the script... Let me fix that (and then I will make sure it ends up at <tt>/etc/condor/tokens.d</tt> )<br/>
<span style="color: #827327"><span style="font-size: small">(12:11:45)</span> <b>jamie.rajewski:</b></span> Yep that seems to have resolved it:<br/><pre>[root@pop-os /]# condor_status -any<br/>MyType             TargetType         Name                                     <br/><br/>Collector          None               My Pool - d9d724196f5c@d9d724196f5c      <br/>DaemonMaster       None               d9d724196f5c                             <br/>Negotiator         None               d9d724196f5c                             <br/>Scheduler          None               pop-os.localdomain                       <br/>DaemonMaster       None               pop-os.localdomain                       <br/>Machine            Job                slot1@pop-os.localdomain                 <br/>Accounting         none               &lt;none&gt;</pre><br/>there is the slot!<br/>
<span style="color: #827327"><span style="font-size: small">(12:11:55)</span> <b>jamie.rajewski:</b></span> I guess the final test is to actually submit some test jobs?<br/>
<span style="color: #c386df"><span style="font-size: small">(13:25:23)</span> <b>matyas:</b></span> yep!<br/>
<span style="color: #827327"><span style="font-size: small">(13:28:36)</span> <b>jamie.rajewski:</b></span> I had made a small sub script to test with an executable that just echos; the script looks like<br/><pre>executable = example.sh<br/><br/>error   = err.$(Process)<br/>output  = out.$(Process)<br/><br/>request_memory =  512<br/>request_cpus = 1<br/>request_disk = 128<br/><br/>queue 1</pre><br/>but my job gets held with the following:<br/><pre>[submituser@pop-os scripts]$ condor_q -hold -af HoldReason<br/>Error from slot1_1@pop-os.localdomain: Failed to open '/home/submituser/scripts/out.0' as standard output: No such file or directory (errno 2)</pre><br/><br/>
<span style="color: #827327"><span style="font-size: small">(13:28:54)</span> <b>jamie.rajewski:</b></span> so it seems it cant write to that directory I guess?<br/>
<span style="color: #c386df"><span style="font-size: small">(13:30:03)</span> <b>matyas:</b></span> Are you submitting from outside of the container?<br/>
<span style="color: #827327"><span style="font-size: small">(13:30:24)</span> <b>jamie.rajewski:</b></span> No I am on the submit container, switched to the <tt>submituser</tt><br/>
<span style="color: #827327"><span style="font-size: small">(13:30:39)</span> <b>jamie.rajewski:</b></span> I made the scripts directory and mounted it though<br/>
<span style="color: #827327"><span style="font-size: small">(13:31:17)</span> <b>jamie.rajewski:</b></span> The directory is writable though as I changed one of the scripts and saved it fine<br/>
<span style="color: #c386df"><span style="font-size: small">(13:33:01)</span> <b>matyas:</b></span> Can you try adding <tt>universe=local</tt> to the job and seeing what happens? That causes the job to be run on the submit host.<br/>
<span style="color: #827327"><span style="font-size: small">(13:34:39)</span> <b>jamie.rajewski:</b></span> it instantly got held but the script itself didnt have permissions set, so let me fix that...<br/>
<span style="color: #827327"><span style="font-size: small">(13:35:26)</span> <b>jamie.rajewski:</b></span> yea that worked, let me try launching it again on the exec node<br/>
<span style="color: #827327"><span style="font-size: small">(13:36:25)</span> <b>jamie.rajewski:</b></span> Nope I got the same error<br/>
<span style="color: #827327"><span style="font-size: small">(13:36:28)</span> <b>jamie.rajewski:</b></span> strange<br/>
<span style="color: #827327"><span style="font-size: small">(13:36:54)</span> <b>jamie.rajewski:</b></span> I assume the execute node requires write permissions to write on the submit node?<br/>
<span style="color: #c386df"><span style="font-size: small">(13:38:12)</span> <b>matyas:</b></span> No, a process on the submit node (condor_shadow) writes these.<br/>
<span style="color: #827327"><span style="font-size: small">(13:38:24)</span> <b>jamie.rajewski:</b></span> Ah okay<br/>
<span style="color: #c386df"><span style="font-size: small">(13:39:06)</span> <b>matyas:</b></span> Can you try submitting from /tmp instead?<br/>
<span style="color: #827327"><span style="font-size: small">(13:39:47)</span> <b>jamie.rajewski:</b></span> sure<br/>
<span style="color: #827327"><span style="font-size: small">(13:42:26)</span> <b>jamie.rajewski:</b></span> this is strange:<br/><pre>[submituser@pop-os tmp]$ condor_q -hold -af HoldReason<br/>Error from slot1_1@pop-os.localdomain: Failed to execute '/tmp/example.sh': (errno=2: 'No such file or directory')<br/>[submituser@pop-os tmp]$ ls<br/>condor_master-stderr---supervisor-5hBNYH.log  example.sh        submission.sub<br/>condor_master-stdout---supervisor-J2SeuJ.log  ks-script-V_wEqJ  yum.log</pre><br/>so I moved the script and submission to <tt>/tmp</tt> and submitted, but it got held because it says the example.sh doesnt exist (it clearly does).<br/>
<span style="color: #827327"><span style="font-size: small">(13:43:24)</span> <b>jamie.rajewski:</b></span> I don't have the line <tt>should_transfer_files = yes</tt> in my submission as I had never previously used it, but could that be it?<br/>
<span style="color: #827327"><span style="font-size: small">(13:43:38)</span> <b>jamie.rajewski:</b></span> I'm not sure if new condor requires it but I will try<br/>
<span style="color: #827327"><span style="font-size: small">(13:45:04)</span> <b>jamie.rajewski:</b></span> yea that was it<br/>
<span style="color: #827327"><span style="font-size: small">(13:45:28)</span> <b>jamie.rajewski:</b></span> Perhaps I am misremembering not having it before as it seems like it is vital here but it is now running<br/>
<span style="color: #827327"><span style="font-size: small">(13:46:38)</span> <b>jamie.rajewski:</b></span> I don't actually use condor much myself so that doesn't help the situation either<br/>
<span style="color: #73769d"><span style="font-size: small">(13:47:01)</span> <b>tim.theisen:</b></span> Condor jobs mount tmp as scratch, so submitting something from /tmp will never work.<br/>
<span style="color: #827327"><span style="font-size: small">(13:47:52)</span> <b>jamie.rajewski:</b></span> it worked here it seems:<br/><pre>[submituser@pop-os scripts]$ ls /tmp/<br/>condor_master-stderr---supervisor-5hBNYH.log  err.0       ks-script-V_wEqJ  submission.sub<br/>condor_master-stdout---supervisor-J2SeuJ.log  example.sh  out.0             yum.log</pre><br/><br/>
<span style="color: #827327"><span style="font-size: small">(13:48:03)</span> <b>jamie.rajewski:</b></span> unless that isn't what you meant<br/>
<span style="color: #c386df"><span style="font-size: small">(13:49:58)</span> <b>matyas:</b></span> Tim, that doesn't apply here -- /tmp is scratch on the execute node; we're talking about submitting from /tmp on the submit node, which isn't affected.<br/>
<span style="color: #827327"><span style="font-size: small">(13:50:45)</span> <b>jamie.rajewski:</b></span> I re-ran from my own mounted directory residing in home and it worked as well<br/>
<span style="color: #827327"><span style="font-size: small">(13:50:53)</span> <b>jamie.rajewski:</b></span> so it was just that line missing from the submission script<br/>
<span style="color: #73769d"><span style="font-size: small">(13:51:24)</span> <b>tim.theisen:</b></span> Condor tries to determine if the execute node and submit node are in the same domain. If so, it won't copy the files. So, should_transfer_files will cause the files to be copied.<br/>
<span style="color: #c386df"><span style="font-size: small">(13:53:27)</span> <b>matyas:</b></span> Hmm. What do <tt>hostname -f</tt> on the submit node and <tt>hostname -f</tt> on the execute node say?<br/>
<span style="color: #827327"><span style="font-size: small">(13:54:07)</span> <b>jamie.rajewski:</b></span> They both say <tt>pop-os.localdomain</tt><br/>
<span style="color: #827327"><span style="font-size: small">(13:54:31)</span> <b>jamie.rajewski:</b></span> <pre>[submituser@pop-os scripts]$ hostname -f<br/>pop-os.localdomain<br/>[submituser@pop-os scripts]$ exit<br/>logout<br/>[root@pop-os /]# hostname -f<br/>pop-os.localdomain</pre><br/>and execute:<br/><pre>[root@pop-os /]# hostname -f<br/>pop-os.localdomain</pre><br/><br/>
<span style="color: #827327"><span style="font-size: small">(13:54:51)</span> <b>jamie.rajewski:</b></span> so that is strange that it didnt work then<br/>
<span style="color: #c386df"><span style="font-size: small">(13:55:31)</span> <b>matyas:</b></span> no, that explains why it didn't work<br/>
<span style="color: #c386df"><span style="font-size: small">(13:56:02)</span> <b>matyas:</b></span> By default, FILESYSTEM_DOMAIN = $(FULL_HOSTNAME), meaning if the hostname is the same, condor thinks they share a filesystem.<br/>
<span style="color: #827327"><span style="font-size: small">(13:56:18)</span> <b>jamie.rajewski:</b></span> oh okay, I misinterpreted what Tim said above<br/>
<span style="color: #827327"><span style="font-size: small">(13:56:24)</span> <b>jamie.rajewski:</b></span> that makes complete sense now<br/>
<span style="color: #827327"><span style="font-size: small">(14:03:22)</span> <b>jamie.rajewski:</b></span> I think that mostly wraps it up then as this seems to work great. I will commit the rest of my working code to the repo for reference as well. Did you want me to update the <a href="https://github.com/htcondor/htcondor/blob/master/build/docker/services/README.md#example">example in the docs</a> with some of this information, or even upload my working example from my repo to the github? (I will change all of the <tt>jamie</tt> references prior)<br/>
<span style="color: #827327"><span style="font-size: small">(14:08:01)</span> <b>jamie.rajewski:</b></span> I also had a few questions about Condor in general:<br/>1. If I wanted a second submit node, is there anything in particular that I have to do different from what I had done for the first one? This is more for an actual condor setup and not a local test one (perhaps there is documentation on this matter?)<br/>2. Is it possible to separate the job queue from the submit node such that if I need to update or provision the submit node, it won't wipe the queue? This has been a problem in the past on our cluster and was wondering if it is possible currently, or something to put in as a feature request<br/>
<span style="color: #c386df"><span style="font-size: small">(14:08:08)</span> <b>matyas:</b></span> I would like to see what you ended up with. I should definitely update the example, but you have a fairly unique setup where your submit and execute nodes use host networking and your cm does not, and I don't think that's the setup people should use.<br/>
<span style="color: #c386df"><span style="font-size: small">(14:10:15)</span> <b>matyas:</b></span> Ironically we used host networking to save us the trouble of dealing with Docker networking, but it might have ended up being more trouble overall... I'll have to think about that.<br/>
<span style="color: #c386df"><span style="font-size: small">(14:12:27)</span> <b>matyas:</b></span> So I guess I'm not sure about the answer to your first question. Your second question is easier:<br/>
<span style="color: #827327"><span style="font-size: small">(14:13:24)</span> <b>jamie.rajewski:</b></span> Sure, @dschultz might know more since it is fairly common for clusters to have multiple submit nodes and I'm trying to think about how we would add another<br/>
<span style="color: #c386df"><span style="font-size: small">(14:14:52)</span> <b>matyas:</b></span> The job queue is in /var/lib/condor/spool so if you preserve that directory, your queue will still be good even after you replace the container.<br/>
<span style="color: #827327"><span style="font-size: small">(14:17:09)</span> <b>jamie.rajewski:</b></span> If condor is run within a container and I would have to delete/redeploy the container, would that imply that the best way to preserve that directory would be to copy it out to permanent storage and then copy it back after it is redeployed?<br/>
<span style="color: #c386df"><span style="font-size: small">(14:17:23)</span> <b>matyas:</b></span> Bind-mount it from outside<br/>
<span style="color: #827327"><span style="font-size: small">(14:17:38)</span> <b>jamie.rajewski:</b></span> I was just gonna say<br/>
<span style="color: #827327"><span style="font-size: small">(14:17:41)</span> <b>jamie.rajewski:</b></span> That is better haha<br/>
<span style="color: #827327"><span style="font-size: small">(14:17:58)</span> <b>jamie.rajewski:</b></span> That is much easier than I thought it would be though, thanks for that<br/>
<span style="color: #827327"><span style="font-size: small">(14:18:39)</span> <b>jamie.rajewski:</b></span> and thanks for all of your help through this process. It was not as direct as probably either of us thought it would be, but now I just have to get the icecube pyglidein stuff working with it and the development environment will be complete<br/>
<span style="color: #c386df"><span style="font-size: small">(14:23:26)</span> <b>matyas:</b></span> oh totally<br/>
<span style="color: #c386df"><span style="font-size: small">(14:23:35)</span> <b>matyas:</b></span> and thanks for your patience! I know I was a little slow at times...<br/>
<span style="color: #827327"><span style="font-size: small">(14:24:44)</span> <b>jamie.rajewski:</b></span> The repo has been updated and cleaned so feel free to check it over now. And no worries, you have nothing to be sorry about! Thank YOU for your patience haha I know some of my questions were not as informed as they could have been but I definitely understand condor far better because of this<br/>
</body>
</html>
