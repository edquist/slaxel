<!DOCTYPE html>
<html>
<head>
<title>Tue Apr 23, 2019 : #xcache (osg)</title>
</head>
<body>
<h3>Tue Apr 23, 2019 : #xcache (osg)</h3>
<span style="color: #a63024"><span style="font-size: small">(12:20:28)</span> <b>efajardo:</b></span> I was checking the statshcache<br/>
<span style="color: #a63024"><span style="font-size: small">(12:20:30)</span> <b>efajardo:</b></span> image<br/>
<span style="color: #a63024"><span style="font-size: small">(12:20:36)</span> <b>efajardo:</b></span> and the default configuration<br/>
<span style="color: #a63024"><span style="font-size: small">(12:20:59)</span> <b>efajardo:</b></span> <pre>at 50-stash-cache-authz.cfg<br/>#<br/># Configure authorization for the StashCache cache server.<br/>#<br/># **********************************************************************<br/># * WARNING: DO NOT EDIT THIS FILE.  IT WILL BE OVERWRITTEN ON UPGRADE *<br/># **********************************************************************<br/>#<br/># This file is part of the StashCache Daemon<br/># <a href="https://opensciencegrid.org/docs/data/stashcache/overview/">https://opensciencegrid.org/docs/data/stashcache/overview/</a><br/><br/># Enable the authorization module, even if we have an unauthenticated instance.<br/>ofs.authorize 1<br/># Log both successes and failures in authorization.<br/>acc.audit deny grant<br/><br/># Allow connections from all hosts; sec.protocol is overwritten later.<br/>xrd.allow host *<br/>sec.protocol host<br/><br/><br/># Apply the auto-generated cache authorizations only in the case<br/># where we are one of the two StashCache templates.<br/>if named stash-cache-auth<br/><br/>   xrootd.seclib /usr/lib64/libXrdSec.so<br/><br/>   # Set libXrdLcmaps to be used only to invoke Globus and libvoms<br/>   # to verify the proxy; authorizations will be handled internally.<br/>   sec.protocol /usr/lib64 gsi \<br/>     -certdir:/etc/grid-security/certificates \<br/>     -cert:/etc/grid-security/xrd/xrdcert.pem \<br/>     -key:/etc/grid-security/xrd/xrdkey.pem \<br/>     -crl:1 \<br/>     -authzfun:libXrdLcmaps.so \<br/>     -authzfunparms:--lcmapscfg,/etc/xrootd/lcmaps.cfg,--no-authz \<br/>     -gmapopt:0 \<br/>     -authzto:3600<br/>   sec.protbind * gsi<br/><br/>else if named stash-cache<br/><br/>   sec.protbind * none<br/>fi<br/></pre><br/>
<span style="color: #a63024"><span style="font-size: small">(12:21:15)</span> <b>efajardo:</b></span> and the default shipped<br/>
<span style="color: #a63024"><span style="font-size: small">(12:21:16)</span> <b>efajardo:</b></span> <tt>/etc/xrootd/lcmaps.cfg</tt><br/>
<span style="color: #a63024"><span style="font-size: small">(12:21:19)</span> <b>efajardo:</b></span> seems wrong<br/>
<span style="color: #a63024"><span style="font-size: small">(12:21:33)</span> <b>efajardo:</b></span> <pre>cat /etc/xrootd/lcmaps.cfg<br/>#path = /usr/lib64/lcmaps<br/><br/>good = "lcmaps_dummy_good.mod"<br/>bad  = "lcmaps_dummy_bad.mod"<br/><br/>scasclient = "lcmaps_scas_client.mod"<br/>             "-resourcetype wn"<br/>             "-actiontype execute-now"<br/>             "-capath /etc/grid-security/certificates"<br/>             "-cert   /etc/grid-security/xrd/xrdcert.pem"<br/>             "-key    /etc/grid-security/xrd/xrdkey.pem"<br/>             "--endpoint <a href="https://red-auth.unl.edu:8443/gums/services/GUMSXACMLAuthorizationServicePort">https://red-auth.unl.edu:8443/gums/services/GUMSXACMLAuthorizationServicePort</a>"<br/><br/>verifyproxy = "lcmaps_verify_proxy.mod"<br/>          "--allow-limited-proxy"<br/>          " -certdir /etc/grid-security/certificates"<br/>          "--discard_private_key_absence"<br/><br/></pre><br/>
<span style="color: #a63024"><span style="font-size: small">(12:21:39)</span> <b>efajardo:</b></span> Why is not grid map ifle for LIGO<br/>
<span style="color: #a63024"><span style="font-size: small">(12:21:50)</span> <b>efajardo:</b></span> and why are all caches pointing to UNL GUMS?<br/>
<span style="color: #43761b"><span style="font-size: small">(12:27:23)</span> <b>blin:</b></span> @efajardo i don't think it's actually using <tt>/etc/xrootd/lcmaps.cfg</tt>: <a href="https://github.com/opensciencegrid/xcache/blob/master/configs/stash-cache/config.d/50-stash-cache-authz.cfg#L23-L43">https://github.com/opensciencegrid/xcache/blob/master/configs/stash-cache/config.d/50-stash-cache-authz.cfg#L23-L43</a><br/>
<span style="color: #a63024"><span style="font-size: small">(12:28:15)</span> <b>efajardo:</b></span> What do you mean<br/>
<span style="color: #a63024"><span style="font-size: small">(12:28:19)</span> <b>efajardo:</b></span> It is very clear here<br/>
<span style="color: #a63024"><span style="font-size: small">(12:28:20)</span> <b>efajardo:</b></span> <a href="https://github.com/opensciencegrid/xcache/blob/master/configs/stash-cache/config.d/50-stash-cache-authz.cfg#L35">https://github.com/opensciencegrid/xcache/blob/master/configs/stash-cache/config.d/50-stash-cache-authz.cfg#L35</a><br/>
<span style="color: #a63024"><span style="font-size: small">(12:29:23)</span> <b>efajardo:</b></span> This is what is running @blin<br/>
<span style="color: #a63024"><span style="font-size: small">(12:29:26)</span> <b>efajardo:</b></span> <pre>9 xrootd -c /etc/xrootd/xrootd-stash-cache-auth.cfg -k fifo -n stash-cache-auth -k 10 -s /var/run/xrootd/xrootd-stash-cache-auth.pid -l /var/log/xrootd/xrootd.log</pre><br/>
<span style="color: #43761b"><span style="font-size: small">(12:29:58)</span> <b>blin:</b></span> ah, you're right<br/>
<span style="color: #43761b"><span style="font-size: small">(12:34:17)</span> <b>blin:</b></span> ok, it looks like that's just the default lcmaps.cfg from <tt>xrootd-lcmaps</tt><br/>
<span style="color: #43761b"><span style="font-size: small">(12:35:03)</span> <b>blin:</b></span> i believe that the ligo stuff is managed by the generated authfile, i.e. <tt>/run/stash-cache-auth/Authfile</tt><br/>
<span style="color: #43761b"><span style="font-size: small">(12:35:13)</span> <b>blin:</b></span> but @matyas would know those details<br/>
<span style="color: #a63024"><span style="font-size: small">(12:36:32)</span> <b>efajardo:</b></span> The authfile is once a user has already been authenticated<br/>
<span style="color: #a63024"><span style="font-size: small">(12:36:42)</span> <b>efajardo:</b></span> which paths it can access<br/>
<span style="color: #a63024"><span style="font-size: small">(12:36:53)</span> <b>efajardo:</b></span> but I cannot believe the default is all authentications go through UNL Gums<br/>
<span style="color: #43761b"><span style="font-size: small">(12:37:05)</span> <b>blin:</b></span> <pre><br/># Set libXrdLcmaps to be used only to invoke Globus and libvoms<br/># to verify the proxy; authorizations will be handled internally.<br/></pre><br/>
<span style="color: #43761b"><span style="font-size: small">(12:37:10)</span> <b>blin:</b></span> from the authz config file<br/>
<span style="color: #235e5b"><span style="font-size: small">(12:37:58)</span> <b>dweitzel:</b></span> UNL GUMS does not exist.  It was even deleted from DNS.<br/>
<span style="color: #235e5b"><span style="font-size: small">(12:38:06)</span> <b>dweitzel:</b></span> it certainly is not "using" that.<br/>
<span style="color: #43761b"><span style="font-size: small">(12:42:43)</span> <b>blin:</b></span> yeah @efajardo, this looks fine and how it's intended to work. <tt>/run/stash-cache-auth/Authfile</tt> should have these contents: <a href="https://topology.opensciencegrid.org/stashcache/authfile?cache_fqdn=stashcache.t2.ucsd.edu">https://topology.opensciencegrid.org/stashcache/authfile?cache_fqdn=stashcache.t2.ucsd.edu</a><br/>
<span style="color: #a63024"><span style="font-size: small">(12:43:11)</span> <b>efajardo:</b></span> ahh ok<br/>
<span style="color: #a63024"><span style="font-size: small">(12:43:13)</span> <b>efajardo:</b></span> Now I see<br/>
<span style="color: #a63024"><span style="font-size: small">(12:43:20)</span> <b>efajardo:</b></span> where is the cod that generates taht file?<br/>
<span style="color: #43761b"><span style="font-size: small">(12:43:23)</span> <b>blin:</b></span> which is used here: <a href="https://github.com/opensciencegrid/xcache/blob/master/configs/stash-cache/config.d/50-stash-cache-authz.cfg#L50-L51">https://github.com/opensciencegrid/xcache/blob/master/configs/stash-cache/config.d/50-stash-cache-authz.cfg#L50-L51</a><br/>
<span style="color: #a63024"><span style="font-size: small">(12:43:31)</span> <b>efajardo:</b></span> It is not running on the caches right?<br/>
<span style="color: #43761b"><span style="font-size: small">(12:43:42)</span> <b>blin:</b></span> well there's a service that queries that URL<br/>
<span style="color: #a63024"><span style="font-size: small">(12:43:51)</span> <b>efajardo:</b></span> But the code  that generates that URL<br/>
<span style="color: #43761b"><span style="font-size: small">(12:43:59)</span> <b>blin:</b></span> <a href="https://github.com/opensciencegrid/xcache/blob/master/src/authfile-update">https://github.com/opensciencegrid/xcache/blob/master/src/authfile-update</a><br/>
<span style="color: #43761b"><span style="font-size: small">(12:44:09)</span> <b>blin:</b></span> yes, that runs on the caches<br/>
<span style="color: #a63024"><span style="font-size: small">(12:44:25)</span> <b>efajardo:</b></span> no not the code that downloads it in the cache<br/>
<span style="color: #a63024"><span style="font-size: small">(12:44:33)</span> <b>efajardo:</b></span> the code that generates that topology file<br/>
<span style="color: #43761b"><span style="font-size: small">(12:45:10)</span> <b>blin:</b></span> ah, i forget if we use this <a href="https://github.com/opensciencegrid/topology/blob/master/bin/osg-authfile">https://github.com/opensciencegrid/topology/blob/master/bin/osg-authfile</a><br/>
<span style="color: #43761b"><span style="font-size: small">(12:45:18)</span> <b>blin:</b></span> or if topology calls the stashcache lib directly<br/>
<span style="color: #43761b"><span style="font-size: small">(12:45:27)</span> <b>blin:</b></span> but the script will give you an idea of how things are generated<br/>
<span style="color: #a63024"><span style="font-size: small">(12:46:53)</span> <b>efajardo:</b></span> So basically in one moment<br/>
<span style="color: #a63024"><span style="font-size: small">(12:47:08)</span> <b>efajardo:</b></span> the scripts that generates that URL must talk to the ligo ldap server<br/>
<span style="color: #a63024"><span style="font-size: small">(12:47:16)</span> <b>efajardo:</b></span> and I am tryng to see which query it is using<br/>
<span style="color: #a63024"><span style="font-size: small">(12:47:22)</span> <b>efajardo:</b></span> to see what needs to be added<br/>
<span style="color: #235e5b"><span style="font-size: small">(12:47:33)</span> <b>dweitzel:</b></span> <a href="https://github.com/opensciencegrid/topology/blob/master/src/stashcache.py#L38">https://github.com/opensciencegrid/topology/blob/master/src/stashcache.py#L38</a><br/>
<span style="color: #235e5b"><span style="font-size: small">(12:47:43)</span> <b>dweitzel:</b></span> ^ Ligo ldap query.<br/>
<span style="color: #a63024"><span style="font-size: small">(12:49:15)</span> <b>efajardo:</b></span> thanks @dweitzel<br/>
</body>
</html>
