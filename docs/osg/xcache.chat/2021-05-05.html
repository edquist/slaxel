<!DOCTYPE html>
<html>
<head>
<title>Wed May 5, 2021 : #xcache (osg)</title>
</head>
<body>
<h3>Wed May 5, 2021 : #xcache (osg)</h3>
<span style="color: #235e5b"><span style="font-size: small">(12:59:03)</span> <b>dweitzel:</b></span> @justas.balcas @gattebury new xrootd-multiuser build is in koji.  It's in 3.6 development, or 3.5 upcoming-development.<br/>
<span style="color: #235e5b"><span style="font-size: small">(12:59:35)</span> <b>dweitzel:</b></span> You need XRootD 5.0+ for the normal FS wrapping.  If you want checksum "wrapping", you need 5.2-rc1<br/>
<span style="color: #de5f24"><span style="font-size: small">(13:00:26)</span> <b>justas.balcas:</b></span> 5.2 is also in 3.5-upcoming?<br/>
<span style="color: #235e5b"><span style="font-size: small">(13:00:48)</span> <b>dweitzel:</b></span> I think it's in upcoming-development as well, yes<br/>
<span style="color: #c386df"><span style="font-size: small">(13:00:52)</span> <b>matyas:</b></span> yep<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:03:00)</span> <b>justas.balcas:</b></span> <br/>
<span style="color: #de5f24"><span style="font-size: small">(15:03:15)</span> <b>justas.balcas:</b></span> @dweitzel @didavila what’s wrong?<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:04:05)</span> <b>dweitzel:</b></span> It looks like it's switching users:<br/><pre>multiuser_UserSentry: Switching FS uid for user jbalcas</pre><br/>
<span style="color: #de5f24"><span style="font-size: small">(15:04:18)</span> <b>justas.balcas:</b></span> but at the end:<br/><pre>210505 13:01:15 2006092 multiuser_UserSentry: Anonymous client; no user set, cannot change FS UIDs</pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(15:05:27)</span> <b>dweitzel:</b></span> That's normal.  The multiuser plugin will get the "disconnect" event, but it won't have any security information passed along with it.  But it doesn't really need security information for just a disconnect.<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:05:52)</span> <b>justas.balcas:</b></span> and here is from client:<br/><pre>-bash-4.2$ gfal-copy 1GB_File <a href="davs://transfer-10.ultralight.org:1094/storage/cms/store/user/jbalcas/1GB_File-1">davs://transfer-10.ultralight.org:1094/storage/cms/store/user/jbalcas/1GB_File-1</a><br/>Copying file:///storage/user/jbalcas/1GB_File   [FAILED]  after 0s<br/>gfal-copy error: 13 (Permission denied) - TRANSFER  ERROR: Copy failed with mode streamed, with error: Authentication error, reached maximum number of attempts</pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(15:08:02)</span> <b>dweitzel:</b></span> It looks like XRootD is sending a 404, when really it can't find the file?<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:08:24)</span> <b>dweitzel:</b></span> or, it can't find the file because it can't access it as the user jbalcas ?<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:08:54)</span> <b>justas.balcas:</b></span> 404 is ok - I think. I transfer file to xrootd server (using davs) - so this file does not exist on storage<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:09:14)</span> <b>dweitzel:</b></span> oh, ok, then so far so good?<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:09:30)</span> <b>justas.balcas:</b></span> till that stage yes - but transfer fails<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:10:51)</span> <b>justas.balcas:</b></span> transfer from xrootd server using davs - is ok; transfer to xrootd server using davs - fails<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:10:54)</span> <b>justas.balcas:</b></span> <pre>-bash-4.2$ gfal-copy <a href="davs://transfer-10.ultralight.org:1094/storage/cms/store/user/jbalcas/1GB_File">davs://transfer-10.ultralight.org:1094/storage/cms/store/user/jbalcas/1GB_File</a> /tmp/<br/>Copying <a href="davs://transfer-10.ultralight.org:1094/storage/cms/store/user/jbalcas/1GB_File">davs://transfer-10.ultralight.org:1094/storage/cms/store/user/jbalcas/1GB_File</a>   [DONE]  after 9s<br/>-bash-4.2$ gfal-copy 1GB_File <a href="davs://transfer-10.ultralight.org:1094/storage/cms/store/user/jbalcas/1GB_File-1">davs://transfer-10.ultralight.org:1094/storage/cms/store/user/jbalcas/1GB_File-1</a><br/>Copying file:///storage/user/jbalcas/1GB_File   [FAILED]  after 0s<br/>gfal-copy error: 13 (Permission denied) - TRANSFER  ERROR: Copy failed with mode streamed, with error: Authentication error, reached maximum number of attempts</pre><br/>
<span style="color: #de5f24"><span style="font-size: small">(15:11:56)</span> <b>justas.balcas:</b></span> I even made dir 777, same issue:<br/><pre>[root@transfer-10 config.d]# stat /storage/cms/store/user/jbalcas/<br/>  File: '/storage/cms/store/user/jbalcas/'<br/>  Size: 6         	Blocks: 0          IO Block: 65536  directory<br/>Device: 2ch/44d	Inode: 1099511711139  Links: 5<br/>Access: (0777/drwxrwxrwx)  Uid: ( 3000/ jbalcas)   Gid: ( 3000/ jbalcas)<br/>Access: 2021-05-05 12:58:04.173563844 -0700<br/>Modify: 2021-05-04 10:13:56.881689929 -0700<br/>Change: 2021-05-05 13:11:22.443626469 -0700<br/> Birth: -</pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(15:12:58)</span> <b>dweitzel:</b></span> What's the underlying storage?  CEPH or Hadoop?<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:13:03)</span> <b>justas.balcas:</b></span> Ceph<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:13:16)</span> <b>dweitzel:</b></span> using posix interface?<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:13:22)</span> <b>justas.balcas:</b></span> yep<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:13:46)</span> <b>dweitzel:</b></span> Huh, because that is the exact test I did.  HTTP with a scitoken, but should be a similar thing.<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:14:26)</span> <b>justas.balcas:</b></span> unless I miss something in xrootd config<br/><pre>[root@transfer-10 config.d]# cat *<br/># Configure LCMAPS authentication for XRootD installations<br/>#<br/># *************************************************************<br/># * Changes made to this file will be preserved upon upgrade. *<br/># *************************************************************<br/>#<br/># This file is part of the xrootd-lcmaps package.<br/>#<br/><br/># To use the default XRootD LCMAPS configuration, uncomment the<br/># following line:<br/># set EnableLcmaps = 1<br/># Configure LCMAPS authentication for XRootD installations<br/>#<br/># **********************************************************************<br/># * WARNING: DO NOT EDIT THIS FILE.  IT WILL BE OVERWRITTEN ON UPGRADE *<br/># **********************************************************************<br/>#<br/># This file is part of the xrootd-lcmaps package<br/>#<br/># Instead of editing this file:<br/># - Modify /etc/xrootd/config.d/10-xrootd-lcmaps.cfg to enable the default<br/>#   configuration<br/># - Override OSG-provided defaults by dropping a site-specific configuration<br/>#   file in <tt>/etc/xrootd/config.d</tt> and prefixing it with "90-" or higher.<br/>#<br/><br/>if defined ?EnableLcmaps<br/>   xrootd.seclib libXrdSec.so<br/>   sec.protocol /usr/lib64 gsi -certdir:/etc/grid-security/certificates \<br/>                       -cert:/etc/grid-security/xrd/xrdcert.pem \<br/>                       -key:/etc/grid-security/xrd/xrdkey.pem \<br/>                       -crl:1 \<br/>                       -&lt;authzfun:libXrdLcmaps.so&gt; \<br/>                       -authzfunparms:lcmapscfg=/etc/lcmaps.db,loglevel=0,policy=authorize_only \<br/>                       -gmapopt:10 -gmapto:0<br/><br/>   acc.authdb /etc/xrootd/auth_file<br/>   ofs.authorize 1<br/>fi<br/># Enable multiuser plugin. This makes XRootD to write the files with the<br/># ownership of the user that authenticated to the server and not as the<br/># 'xrootd' user<br/>ofs.osslib ++ libXrdMultiuser.so<br/><br/><br/># Enable the checksum wrapper<br/>ofs.ckslib ++ libXrdMultiuser.so<br/># ===================================================================<br/># WARNING! THIS FILE WAS AUTOMATICALLY PREPARED BY PUPPET<br/># ANY MODIFICATIONS TO THIS FILE WILL BE OVERWRITTEN ON PUPPET RUN<br/># IN CASE YOU WANT TO DO MODIFICATIONS, MAKE SURE YOU DISABLE PUPPET!<br/># ===================================================================<br/>#<br/># IPC files should be placed<br/>#<br/>all.adminpath /var/spool/xrootd<br/>all.pidpath /var/run/xrootd<br/><br/># XrootD Security<br/># ---------------------------------------<br/>xrootd.seclib /usr/lib64/libXrdSec.so<br/>sec.protocol /usr/lib64 gsi -certdir:/etc/grid-security/certificates -cert:/etc/grid-security/xrootd/xrootdcert.pem -key:/etc/grid-security/xrootd/xrootdkey.pem -crl:3 -&lt;authzfun:libXrdLcmaps.so&gt; -authzto:900 -authzfunparms:lcmapscfg=/etc/xrootd/lcmaps.cfg -gmapopt:10 -gmapto:0<br/>acc.authdb /etc/xrootd/auth_file<br/>ofs.authorize 1<br/>macaroons.secretkey /etc/xrootd/macaroon-secret<br/>ofs.authlib ++ libXrdMacaroons.so<br/>ofs.authlib ++ libXrdAccSciTokens.so<br/># --------------------------------------<br/># XrootD Monitoring<br/># --------------------------------------<br/># Monitoring for AAA Dashboard :<br/>xrd.report 169.228.130.91:9931 every 30s all sync<br/>xrootd.monitor all auth flush 30s window 5s fstat 60 lfn ops xfr 5 dest files io info user 169.228.130.91:9930 dest fstat info user <a href="http://xrd-mon.osgstorage.org:9930">xrd-mon.osgstorage.org:9930</a><br/>all.sitename T2_US_Caltech<br/># -------------------------------------<br/># Configure redirector<br/># -------------------------------------<br/>all.role server<br/>all.manager <a href="http://xrootd-redir.ultralight.org:1213">xrootd-redir.ultralight.org:1213</a><br/>all.manager meta <a href="http://xrootd-redir.ultralight.org:1213">xrootd-redir.ultralight.org:1213</a><br/># -------------------------------------<br/># Port, allow only specific path, checksum config<br/># -------------------------------------<br/># Allow any path to be exported; this is further refined in the authfile.<br/>all.export /storage<br/><br/># Hosts allowed to use this xrootd cluster<br/>cms.allow host *<br/><br/>xrd.port 1094<br/><br/>xrootd.chksum max 10 adler32<br/><br/># -------------------------------------<br/># Configure davs/https for TPC<br/># -------------------------------------<br/># Enable https over XrootD<br/>if exec xrootd<br/>  xrd.protocol http:1094 /usr/lib64/libXrdHttp.so<br/>  http.cadir /etc/grid-security/certificates<br/>  http.cert /etc/grid-security/xrootd/xrootdcert.pem<br/>  http.key /etc/grid-security/xrootd/xrootdkey.pem<br/>  http.secxtractor /usr/lib64/libXrdLcmaps.so<br/>  http.secretkey pYrySWhj4BftwJkSbMyAk8ha3p5YXsAt7g3mFzX7Vkg<br/>  # Enable third-party-copy<br/>  http.exthandler xrdtpc libXrdHttpTPC.so<br/>  # Pass the bearer token to the Xrootd authorization framework.<br/>  http.header2cgi Authorization authz<br/>  http.listingdeny yes<br/>  http.desthttps yes<br/>  http.selfhttps2http no<br/>  http.staticpreload <a href="http://static/robots.txt">http://static/robots.txt</a> /etc/xrootd/robots.txt<br/>  http.exthandler xrdmacaroons libXrdMacaroons.so<br/>fi</pre><br/>
<span style="color: #de5f24"><span style="font-size: small">(15:14:53)</span> <b>justas.balcas:</b></span> authfile - these enough:<br/><pre>g /cms /storage/cms/user a /storage/cms/temp/ a readcmsdata<br/>u jbalcas /storage/cms/user/jbalcas a</pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(15:15:36)</span> <b>dweitzel:</b></span> I would think so.  Authfiles are not my speciality.<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:16:41)</span> <b>dweitzel:</b></span> Could you do a strace -p on the xrootd process while you do just the write?  I want to make sure the order of operations is:<br/>1. Change user to jbalcas<br/>2. Perform the open on the 1GB_File<br/>3. Change user back<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:17:14)</span> <b>dweitzel:</b></span> That's what I did while I was debugging my code.<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:20:44)</span> <b>dweitzel:</b></span> @justas.balcas thanks for helping debug these things.<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:21:14)</span> <b>justas.balcas:</b></span> ha, Was changing auth_file from / to /storage… and so on. Seems I have misconfig<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:21:16)</span> <b>justas.balcas:</b></span> fixing<br/>
<span style="color: #e06b56"><span style="font-size: small">(15:21:17)</span> <b>jthiltges:</b></span> If writing fails, try swapping those two lines in the authfile. I vaguely recall the first match is the one it picks. (but could be wrong)<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:21:48)</span> <b>dweitzel:</b></span> no worries.<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:24:57)</span> <b>justas.balcas:</b></span> auth_file fixed. looking checksum now<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:25:44)</span> <b>dweitzel:</b></span> writing works now?<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:26:04)</span> <b>justas.balcas:</b></span> <pre>-bash-4.2$ gfal-copy 1GB_File <a href="davs://transfer-10.ultralight.org:1094/storage/cms/store/user/jbalcas/1GB_File-cksum">davs://transfer-10.ultralight.org:1094/storage/cms/store/user/jbalcas/1GB_File-cksum</a> -K ADLER32<br/>Copying file:///storage/user/jbalcas/1GB_File   [FAILED]  after 21s<br/>gfal-copy error: 112 (Host is down) - DESTINATION CHECKSUM (Neon): Could not read status line: Secure connection truncated</pre><br/>
<span style="color: #de5f24"><span style="font-size: small">(15:26:12)</span> <b>justas.balcas:</b></span> yes write works without checksum<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:26:26)</span> <b>dweitzel:</b></span> host is down?<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:26:30)</span> <b>dweitzel:</b></span> odd error.<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:26:38)</span> <b>dweitzel:</b></span> what does XRootD logs say?<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:26:55)</span> <b>justas.balcas:</b></span> I enabled full debug mode, so it has a lot of these:<br/><pre>210505 13:25:05 2017719 cryptossl_ASN1toUTC:  UTC: 1213226057  isdst: 1<br/>210505 13:25:05 2017719 cryptossl_ASN1toUTC:  UTC: 1226001393  isdst: 0<br/>210505 13:25:05 2017719 cryptossl_ASN1toUTC:  UTC: 1224272299  isdst: 1<br/>210505 13:25:05 2017719 cryptossl_ASN1toUTC:  UTC: 1219698543  isdst: 1<br/>210505 13:25:05 2017719 cryptossl_ASN1toUTC:  UTC: 1258751383  isdst: 0<br/>210505 13:25:05 2017719 cryptossl_ASN1toUTC:  UTC: 1258751384  isdst: 0<br/>210505 13:25:05 2017719 cryptossl_ASN1toUTC:  UTC: 1258751385  isdst: 0<br/>210505 13:25:05 2017719 cryptossl_ASN1toUTC:  UTC: 1258751384  isdst: 0</pre><br/>
<span style="color: #de5f24"><span style="font-size: small">(15:27:00)</span> <b>justas.balcas:</b></span> trying to get the exact error<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:27:05)</span> <b>dweitzel:</b></span> kk<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:27:44)</span> <b>dweitzel:</b></span> This checksum part is BRAND NEW, so it may have bugs we have to report to upstream devs.  But... likely the bug is in my code...<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:28:31)</span> <b>justas.balcas:</b></span> <pre>May  5 13:28:07 transfer-10 kernel: traps: xrootd[2019090] trap divide error ip:7f4b009f2a05 sp:7f4af84c4cf0 error:0 in libXrdMultiuser-5.so[7f4b009e7000+10000]<br/>May  5 13:28:07 transfer-10 systemd[1]: xrootd-privileged@clustered.service: main process exited, code=killed, status=8/FPE<br/>May  5 13:28:07 transfer-10 systemd[1]: Unit xrootd-privileged@clustered.service entered failed state.<br/>May  5 13:28:07 transfer-10 systemd[1]: xrootd-privileged@clustered.service failed.<br/>May  5 13:28:07 transfer-10 systemd[1]: xrootd-privileged@clustered.service has no holdoff time, scheduling restart.<br/>May  5 13:28:07 transfer-10 systemd[1]: Stopped XRootD xrootd deamon instance clustered.</pre><br/>
<span style="color: #de5f24"><span style="font-size: small">(15:28:34)</span> <b>justas.balcas:</b></span> it crashed<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:29:05)</span> <b>dweitzel:</b></span> :slightly_smiling_face: my code!<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:29:31)</span> <b>dweitzel:</b></span> How good is your GDB-foo?  Otherwise, I can probably debug.<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:29:50)</span> <b>justas.balcas:</b></span> I am looking for core dump - but is not here<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:29:55)</span> <b>justas.balcas:</b></span> strange<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:30:16)</span> <b>dweitzel:</b></span> that is strange.  Maybe the mutiuser cgroup startup disables coredumps?<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:30:30)</span> <b>dweitzel:</b></span> @jthiltges what's the magic systemd command to generate coredumps?  Is that in systemd?<br/>
<span style="color: #e06b56"><span style="font-size: small">(15:32:07)</span> <b>jthiltges:</b></span> We set <tt>DAEMON_COREFILE_LIMIT="unlimited"</tt> in <tt>/etc/sysconfig/xrootd</tt> and they end up in <tt>/var/spool/xrootd/clustered</tt>. If that doesn't do it, I can look for other knobs.<br/>
<span style="color: #235e5b"><span style="font-size: small">(15:33:16)</span> <b>dweitzel:</b></span> Since the service name is xrootd-privileged, does that matter?<br/>
<span style="color: #e06b56"><span style="font-size: small">(15:34:44)</span> <b>jthiltges:</b></span> Ah, I'd overlooked that. Perhaps! Should hopefully be somewhere similar. (the cwd of the process)<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:38:44)</span> <b>justas.balcas:</b></span> I add DAEMON_COREFILE_LIMIT to sysconfig file, restarted xrootd, made it crash. No core dump<br/>
<span style="color: #de5f24"><span style="font-size: small">(15:43:42)</span> <b>justas.balcas:</b></span> it writes to /tmp - something else to follow up. Let me share it with you (will be faster than me debugging it) :slightly_smiling_face:<br/>
<span style="color: #235e5b"><span style="font-size: small">(16:14:59)</span> <b>dweitzel:</b></span> Ok, I found the issue, it's a mis-understanding of the logic flow.  I need to contact Andy for help understanding.  I should have another iteration ready tomorrow, since Andy usually responds to my emails at ~midnight my time.<br/>
<span style="color: #de5f24"><span style="font-size: small">(16:17:15)</span> <b>justas.balcas:</b></span> thanks<br/>
</body>
</html>
