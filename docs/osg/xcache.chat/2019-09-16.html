<!DOCTYPE html>
<html>
<head>
<title>Mon Sep 16, 2019 : #xcache (osg)</title>
</head>
<body>
<h3>Mon Sep 16, 2019 : #xcache (osg)</h3>
<span style="color: #a63024"><span style="font-size: small">(10:06:18)</span> <b>efajardo:</b></span> Good morning <b>@here</b> Xcache experts<br/>
<span style="color: #a63024"><span style="font-size: small">(10:06:29)</span> <b>efajardo:</b></span> What was the trick to obtain the hash out of a DN<br/>
<span style="color: #a63024"><span style="font-size: small">(10:06:31)</span> <b>efajardo:</b></span> <pre>INFO in AuthzFun: Lookup with key /DC=org/DC=incommon/C=US/ST=CA/L=La Jolla/O=University of California, San Diego/OU=UCSD/CN=<a href="http://osg-ligo-1.t2.ucsd.edu::osg:/osg/ligo">osg-ligo-1.t2.ucsd.edu::osg:/osg/ligo</a>,::<br/>ERROR in AuthzFun: LCMAPS failed or denied mapping</pre><br/>
<span style="color: #99a949"><span style="font-size: small">(10:09:01)</span> <b>dwd:</b></span> You can’t go from a DN to a hash.  You need a cert of some kind<br/>
<span style="color: #a63024"><span style="font-size: small">(10:10:51)</span> <b>efajardo:</b></span> I have the cert<br/>
<span style="color: #a63024"><span style="font-size: small">(10:10:53)</span> <b>efajardo:</b></span> or the proxy<br/>
<span style="color: #a63024"><span style="font-size: small">(10:11:02)</span> <b>efajardo:</b></span> if you know the command to get the hash @dwd<br/>
<span style="color: #43761b"><span style="font-size: small">(10:17:02)</span> <b>blin:</b></span> <tt>openssl x509 -in &lt;proxy/cert&gt; -noout -subject_hash</tt> maybe?<br/>
<span style="color: #99a949"><span style="font-size: small">(10:21:12)</span> <b>dwd:</b></span> Yeah it depends on which hash you’re talking about.  There’s also -fingerprint<br/>
<span style="color: #99a949"><span style="font-size: small">(10:21:45)</span> <b>dwd:</b></span> and -issuer_hash<br/>
<span style="color: #a63024"><span style="font-size: small">(11:04:50)</span> <b>efajardo:</b></span> thanks @dwd<br/>
<span style="color: #a63024"><span style="font-size: small">(11:05:00)</span> <b>efajardo:</b></span> I am looking at one site authfile<br/>
<span style="color: #99a949"><span style="font-size: small">(11:05:56)</span> <b>dwd:</b></span> An authfile for what?<br/>
<span style="color: #c386df"><span style="font-size: small">(11:07:43)</span> <b>matyas:</b></span> @efajardo if you're looking at the CNAF xcache, they might not be running the generated authfile... you'll need to check their xcache config<br/>
<span style="color: #a63024"><span style="font-size: small">(11:30:46)</span> <b>efajardo:</b></span> well<br/>
<span style="color: #a63024"><span style="font-size: small">(11:30:49)</span> <b>efajardo:</b></span> I see this in their config<br/>
<span style="color: #a63024"><span style="font-size: small">(11:31:19)</span> <b>efajardo:</b></span> <pre># xrootd config does not do nested "unqualified" ifs<br/>if defined ?StashCacheAuthfile &amp;&amp; named stash-cache-auth<br/>   acc.authdb $StashCacheAuthfile<br/># nor negations ("!")<br/>else if named stash-cache-auth<br/>   # This authfile is automatically generated by stash-cache-authfile.service<br/>   acc.authdb /run/stash-cache-auth/Authfile<br/>fi<br/><br/>if defined ?StashCachePublicAuthfile &amp;&amp; named stash-cache<br/>   acc.authdb $StashCachePublicAuthfile<br/>else if named stash-cache<br/>   # The unauthenticated instance uses a separate auth file from the<br/>   # authenticated instance; file is generated by stash-cache-authfile.service<br/>   acc.authdb /run/stash-cache/Authfile<br/>fi<br/></pre><br/>
<span style="color: #c386df"><span style="font-size: small">(11:39:25)</span> <b>matyas:</b></span> hm. also, you said it was an LCMAPS fail? In that case, it wouldn't have gotten as far as the xrootd authfile<br/>
<span style="color: #a63024"><span style="font-size: small">(11:40:33)</span> <b>efajardo:</b></span> Isn’t this an LCMAPS<br/>
<span style="color: #a63024"><span style="font-size: small">(11:40:34)</span> <b>efajardo:</b></span> fail<br/>
<span style="color: #a63024"><span style="font-size: small">(11:40:37)</span> <b>efajardo:</b></span> <pre>190916 16:52:47 31200 XrootdXeq: ?:25@hcc-mon.unl.edu disc 0:00:01<br/>INFO in AuthzFun: Lookup with key /DC=org/DC=incommon/C=US/ST=CA/L=La Jolla/O=University of California, San Diego/OU=UCSD/CN=<a href="http://osg-ligo-1.t2.ucsd.edu::osg:/osg/ligo">osg-ligo-1.t2.ucsd.edu::osg:/osg/ligo</a>,::<br/>ERROR in AuthzFun: LCMAPS failed or denied mapping<br/>190916 16:52:53 30850 XrootdBridge: unknown.1:28@osg-ligo-1.t2.ucsd.edu login as nobody<br/>190916 16:52:53 30850 acc_Audit: http deny  *@[::ffff:169.228.130.104] stat /user/ligo/frames/O3/V1Online/V-V1Online-12484/V-V1Online-1248444000-2000.gwf</pre><br/>
<span style="color: #99a949"><span style="font-size: small">(11:51:13)</span> <b>dwd:</b></span> That looks like the DN is unrecognized, but maybe a higher LCMAPS debug level would give more details<br/>
<span style="color: #43761b"><span style="font-size: small">(11:58:54)</span> <b>blin:</b></span> i think you'll want to look in <tt>/var/log/messages</tt> or <tt>journalctl</tt> for the specific LCMAPS error<br/>
<span style="color: #a63024"><span style="font-size: small">(12:18:47)</span> <b>efajardo:</b></span> In other news<br/>
<span style="color: #a63024"><span style="font-size: small">(12:18:51)</span> <b>efajardo:</b></span> the stashcache fresh images<br/>
<span style="color: #a63024"><span style="font-size: small">(12:18:52)</span> <b>efajardo:</b></span> fails<br/>
<span style="color: #a63024"><span style="font-size: small">(12:18:59)</span> <b>efajardo:</b></span> <pre>=====&gt; http.staticpreload <a href="http://static/robots.txt">http://static/robots.txt</a> /etc/xrootd/xcache-robots.txt<br/>Config continuing with file /etc/xrootd/config.d/40-stash-cache-plugin.cfg ...<br/>Config continuing with file /etc/xrootd/config.d/40-xrootd-lcmaps.cfg ...<br/>Config continuing with file /etc/xrootd/config.d/50-osg-http.cfg ...<br/>=====&gt; http.cadir /etc/grid-security/certificates<br/>=====&gt; http.cert /etc/grid-security/xrd/xrdcert.pem<br/>=====&gt; http.key /etc/grid-security/xrd/xrdkey.pem<br/>=====&gt; http.secxtractor /usr/lib64/libXrdLcmaps.so<br/>=====&gt; http.listingdeny yes<br/>=====&gt; http.staticpreload <a href="http://static/robots.txt">http://static/robots.txt</a> /etc/xrootd/ban-robots.txt<br/>Config continuing with file /etc/xrootd/config.d/50-osg-monitoring.cfg ...<br/>Config continuing with file /etc/xrootd/config.d/50-osg-paths.cfg ...<br/>Config warning: ignoring unknown directive 'pidpath'.<br/>Config continuing with file /etc/xrootd/config.d/50-stash-cache-authz.cfg ...<br/>Config continuing with file /etc/xrootd/config.d/50-stash-cache-paths.cfg ...<br/>Config warning: ignoring unknown directive 'export'.<br/>Config continuing with file /etc/xrootd/config.d/90-stash-cache-disks.cfg ...<br/>Config continuing with file /etc/xrootd/config.d/90-xcache-logging.cfg ...<br/> Using TLS 1.2<br/>------ HTTP protocol initialization failed.<br/>190916 17:17:41 673 XrdProtocol: Protocol http could not be loaded<br/>------ xrootd <a href="mailto:stash-cache-auth@fiona-r-uva.vlan7.uvalight.net">stash-cache-auth@fiona-r-uva.vlan7.uvalight.net</a>:1095 initialization failed.<br/></pre><br/>
<span style="color: #a63024"><span style="font-size: small">(12:19:47)</span> <b>efajardo:</b></span> This is the image<br/>
<span style="color: #a63024"><span style="font-size: small">(12:19:49)</span> <b>efajardo:</b></span> <pre>Containers:<br/>  stashcache:<br/>    Container ID:   <a href="docker://c9cac5c7b319ba61486a15ac9f06554b01cc5b8d7d7bef50db3357fd19c07945">docker://c9cac5c7b319ba61486a15ac9f06554b01cc5b8d7d7bef50db3357fd19c07945</a><br/>    Image:          opensciencegrid/stash-cache:fresh<br/>    Image ID:       <a href="docker-pullable://opensciencegrid/stash-cache@sha256:54e46f7844de095dba4a94ebb478fd4c6e55b99813b87781be13d4efae9b5b4f">docker-pullable://opensciencegrid/stash-cache@sha256:54e46f7844de095dba4a94ebb478fd4c6e55b99813b87781be13d4efae9b5b4f</a><br/></pre><br/>
<span style="color: #43761b"><span style="font-size: small">(12:20:01)</span> <b>blin:</b></span> hrmm, what sort of config are you dropping on top of the image?<br/>
<span style="color: #a63024"><span style="font-size: small">(12:22:12)</span> <b>efajardo:</b></span> I am overriding<br/>
<span style="color: #a63024"><span style="font-size: small">(12:22:14)</span> <b>efajardo:</b></span> <tt>/etc/xrootd/config.d/40-osg-http.cfg</tt><br/>
<span style="color: #a63024"><span style="font-size: small">(12:22:24)</span> <b>efajardo:</b></span> with<br/>
<span style="color: #a63024"><span style="font-size: small">(12:22:27)</span> <b>efajardo:</b></span> <pre>#                                                                                                                                                                             <br/># Configure HTTPS for OSG deploys of XRootD.                                                                                                                                  <br/>#                                                                                                                                                                             <br/># **********************************************************************                                                                                                      <br/># * WARNING: DO NOT EDIT THIS FILE.  IT WILL BE OVERWRITTEN ON UPGRADE *                                                                                                      <br/># **********************************************************************                                                                                                      <br/>#                                                                                                                                                                             <br/># This file is part of the StashCache Daemon                                                                                                                                  <br/># <a href="https://opensciencegrid.org/docs/data/stashcache/overview/">https://opensciencegrid.org/docs/data/stashcache/overview/</a>                                                                                                                  <br/><br/>if named stash-cache-auth<br/><br/>   xrd.protocol http:8444 libXrdHttp.so<br/>   xrd.port 1095<br/>   http.cadir /etc/grid-security/certificates<br/>   http.cert /etc/grid-security/xrd/xrdcert.pem<br/>   http.key /etc/grid-security/xrd/xrdkey.pem<br/>   http.secxtractor /usr/lib64/libXrdLcmaps.so<br/><br/>else<br/>   xrd.protocol http:8000 libXrdHttp.so<br/>fi<br/><br/>http.listingdeny yes<br/>http.staticpreload <a href="http://static/robots.txt">http://static/robots.txt</a> /etc/xrootd/xcache-robots.txt<br/><br/></pre><br/>
<span style="color: #a63024"><span style="font-size: small">(12:22:45)</span> <b>efajardo:</b></span> apart from that<br/>
<span style="color: #a63024"><span style="font-size: small">(12:22:47)</span> <b>efajardo:</b></span> just disk stuff<br/>
<span style="color: #a63024"><span style="font-size: small">(12:22:49)</span> <b>efajardo:</b></span> <pre>if defined ?~DATA1<br/>set stashpath1 = $DATA1<br/><a href="http://oss.space">oss.space</a> public $stashpath1<br/>fi<br/><br/>if defined ?~DATA2<br/>set stashpath2 = $DATA2<br/><a href="http://oss.space">oss.space</a> public $stashpath2<br/>fi<br/><br/>if defined ?~DATA3<br/>set stashpath3 = $DATA3<br/><a href="http://oss.space">oss.space</a> public $stashpath3<br/>fi<br/><br/>if defined ?~DATA4<br/>set stashpath4 = $DATA4<br/><a href="http://oss.space">oss.space</a> public $stashpath4<br/>fi<br/><br/>if defined ?~DATA5<br/>set stashpath5 = $DATA5<br/><a href="http://oss.space">oss.space</a> public $stashpath5<br/>fi<br/><br/>if defined ?~DATA6<br/>set stashpath7 = $DATA6<br/><a href="http://oss.space">oss.space</a> public $stashpath6<br/>fi</pre><br/>
<span style="color: #43761b"><span style="font-size: small">(12:23:53)</span> <b>blin:</b></span> we moved <tt>40-osg-http.cfg</tt> to <tt>50-osg-http.cfg</tt> and it contains the following now:<br/><pre><br/>#<br/># Configure HTTP/S for OSG deploys of XRootD.<br/>#<br/># **********************************************************************<br/># * WARNING: DO NOT EDIT THIS FILE.  IT WILL BE OVERWRITTEN ON UPGRADE *<br/># **********************************************************************<br/>#<br/># This file is part of the OSG XRootD packaging<br/><br/>if defined ?~XRD_HTTP_PORT<br/>   set HttpPort=$XRD_HTTP_PORT<br/>else if defined ?HttpPort<br/>   # admin-specified HTTP/S port<br/>else<br/>   set HttpPort=1094<br/>fi<br/><br/># Only use HTTP for Stash Cache/Origin because the config necessary for<br/># HTTPS enables auth across all protocols<br/>if defined ?EnableHttp &amp;&amp; exec xrootd &amp;&amp; named stash-cache<br/>   xrd.protocol http:$(HttpPort) libXrdHttp.so<br/>else if defined ?EnableHttp &amp;&amp; exec xrootd &amp;&amp; named stash-origin<br/>   xrd.protocol http:$(HttpPort) libXrdHttp.so   <br/>else if defined ?EnableHttp &amp;&amp; exec xrootd<br/>   xrd.protocol http:$(HttpPort) libXrdHttp.so<br/><br/>   http.cadir /etc/grid-security/certificates<br/>   http.cert /etc/grid-security/xrd/xrdcert.pem<br/>   http.key /etc/grid-security/xrd/xrdkey.pem<br/><br/>   http.secxtractor /usr/lib64/libXrdLcmaps.so<br/>fi<br/><br/>if defined ?EnableHttp &amp;&amp; exec xrootd<br/>   http.listingdeny yes<br/>   http.staticpreload <a href="http://static/robots.txt">http://static/robots.txt</a> /etc/xrootd/ban-robots.txt<br/>fi<br/></pre><br/>
<span style="color: #43761b"><span style="font-size: small">(12:26:24)</span> <b>blin:</b></span> i think you can get rid of your http override config<br/>
<span style="color: #43761b"><span style="font-size: small">(12:26:41)</span> <b>blin:</b></span> because we have this in the default stash-cache config now:<br/><pre><br/># A few extra configuration settings that have no good other location.<br/>set EnableHttp=1<br/><br/>if named stash-cache-auth<br/>   set HttpPort=8443<br/>   xrd.port $(HttpPort)<br/>else<br/>   # non-authed stash-cache; the HTTP plugin will also listen on 8000<br/>   set HttpPort=8000<br/>   xrd.port 1094<br/>fi<br/><br/># Drop your site-specific configuration additions into this directory.<br/>continue /etc/xrootd/config.d<br/></pre><br/>
<span style="color: #43761b"><span style="font-size: small">(12:26:59)</span> <b>blin:</b></span> the only difference i can tell from the default config and yours is that xrootd for the auth origin listens on 8443<br/>
<span style="color: #a63024"><span style="font-size: small">(12:47:28)</span> <b>efajardo:</b></span> what is the differnece between stable and fresh?<br/>
<span style="color: #a63024"><span style="font-size: small">(12:50:29)</span> <b>efajardo:</b></span> ok<br/>
<span style="color: #a63024"><span style="font-size: small">(12:50:33)</span> <b>efajardo:</b></span> let me test that<br/>
<span style="color: #43761b"><span style="font-size: small">(12:52:05)</span> <b>blin:</b></span> stable has xcache 1.0<br/>
<span style="color: #43761b"><span style="font-size: small">(12:52:12)</span> <b>blin:</b></span> fresh has 1.1<br/>
<span style="color: #a63024"><span style="font-size: small">(12:52:24)</span> <b>efajardo:</b></span> ok<br/>
<span style="color: #a63024"><span style="font-size: small">(12:52:27)</span> <b>efajardo:</b></span> my problem is the port<br/>
<span style="color: #a63024"><span style="font-size: small">(12:52:32)</span> <b>efajardo:</b></span> so I will just have to change that<br/>
<span style="color: #a63024"><span style="font-size: small">(12:53:15)</span> <b>efajardo:</b></span> this should be enough to change port right<br/>
<span style="color: #a63024"><span style="font-size: small">(12:53:17)</span> <b>efajardo:</b></span> <pre>if named stash-cache-auth<br/>   xrd.protocol http:8444 libXrdHttp.so<br/>fi</pre><br/>
<span style="color: #a63024"><span style="font-size: small">(12:57:21)</span> <b>efajardo:</b></span> ok it works<br/>
<span style="color: #a63024"><span style="font-size: small">(12:57:24)</span> <b>efajardo:</b></span> after some cleaning up<br/>
<span style="color: #43761b"><span style="font-size: small">(12:59:59)</span> <b>blin:</b></span> we wanted to unify the auth/https ports<br/>
<span style="color: #43761b"><span style="font-size: small">(13:01:08)</span> <b>blin:</b></span> instead, i would do something like:<br/><pre><br/>if named stash-cache-auth<br/>   set HttpsPort=8444<br/>fi<br/></pre><br/>in a <tt>10-*.cfg</tt> file<br/>
<span style="color: #a63024"><span style="font-size: small">(14:00:21)</span> <b>efajardo:</b></span> ahh ok<br/>
<span style="color: #a63024"><span style="font-size: small">(14:00:24)</span> <b>efajardo:</b></span> what I did work too<br/>
<span style="color: #a63024"><span style="font-size: small">(14:00:39)</span> <b>efajardo:</b></span> I can try that too<br/>
<span style="color: #43761b"><span style="font-size: small">(14:09:28)</span> <b>blin:</b></span> yeah but if you're using the supported method, there's a better chance that we won't mess it on you down the road :slightly_smiling_face:<br/>
</body>
</html>
