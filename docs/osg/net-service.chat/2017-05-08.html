<!DOCTYPE html>
<html>
<head>
<title>Mon May 8, 2017 : #net-service (osg)</title>
</head>
<body>
<h3>Mon May 8, 2017 : #net-service (osg)</h3>
<span style="color: #4ec0d6"><span style="font-size: small">(14:33:09)</span> <b>smckee:</b></span> OK, working on this again.   I compressed the pg_logs on psds0 via gzip -9.   I then backed up the whole /usr/local/pgsql/data/* in a bzipped tarball on /net/nas01/Public/psds0/pg-backup-data.tar.bz2<br/>
<span style="color: #4ec0d6"><span style="font-size: small">(14:33:29)</span> <b>smckee:</b></span> Following this thread I found all referenced bad blocks from the log files:<br/>
<span style="color: #4ec0d6"><span style="font-size: small">(14:33:40)</span> <b>smckee:</b></span> [0] 19:26:40 UTC [root@psds0:/usr/local/pgsql/data]# grep "invalid page" pg_log/postgresql-2017-05-08_140028.log | awk '{print $6" "$7" "$8" "$9}' | sort -u -n<br/>30831 of relation base/16384/16776<br/>30893 of relation base/16384/16776<br/>31053 of relation base/16384/16776<br/>31253 of relation base/16384/16776<br/>32742 of relation base/16384/16776<br/>32820 of relation base/16384/16776<br/>33366 of relation base/16384/16776<br/>34069 of relation base/16384/16776<br/>34070 of relation base/16384/16776<br/>36327 of relation base/16384/16776<br/>36566 of relation base/16384/16776<br/>38966 of relation base/16384/16776<br/>39765 of relation base/16384/16776<br/>76918 of relation base/16384/16776<br/>104965 of relation base/16384/16776<br/>
<span style="color: #4ec0d6"><span style="font-size: small">(14:33:52)</span> <b>smckee:</b></span> [ Here is the thread <a href="https://www.postgresql.org/message-id/1184245756.24101.178.camel@coppola.muc.ecircle.de">https://www.postgresql.org/message-id/1184245756.24101.178.camel@coppola.muc.ecircle.de</a> ]<br/>
<span style="color: #4ec0d6"><span style="font-size: small">(14:34:05)</span> <b>smckee:</b></span> Dumping the one at 30831:<br/>
<span style="color: #4ec0d6"><span style="font-size: small">(14:34:29)</span> <b>smckee:</b></span> [0] 19:30:05 UTC [root@psds0:/usr/local/pgsql/data]# pg_filedump -if -R 31053 base/16384/16776<br/><br/>*******************************************************************<br/>* PostgreSQL File/Block Formatted Dump Utility - Version 8.4.0<br/>*<br/>* File: base/16384/16776<br/>* Options used: -if -R 31053<br/>*<br/>* Dump created on: Mon May  8 19:30:13 2017<br/>*******************************************************************<br/><br/>Block 31053 ********************************************************<br/>&lt;Header&gt; -----<br/> Block Offset: 0x0f29a000         Offsets: Lower    25600 (0x6400)<br/> Block: Size 17664  Version   72            Upper    17736 (0x4548)<br/> LSN:  logid 1162372104 recoff 0x454863f8      Special  25624 (0x6418)<br/> Items: 6394                      Free Space: 4294959432<br/> TLI: 0x6410  Prune XID: 0x45486408  Flags: 0x4548 ()<br/> Length (including item array): 8192<br/><br/> Error: Invalid header information.<br/><br/> Error: End of block encountered within the header. Bytes read: 8192.<br/><br/>  0000: 08644845 f8634845 10644845 00644845  .dHE.cHE.dHE.dHE<br/>  0010: 18644845 08644845 20644845 10644845  .dHE.dHE dHE.dHE<br/>  0020: 28644845 18644845 30644845 20644845  (dHE.dHE0dHE dHE<br/>  0030: 38644845 28644845 40644845 30644845  8dHE(dHE@dHE0dHE<br/>  0040: 48644845 38644845 50644845 40644845  HdHE8dHEPdHE@dHE<br/>  0050: 58644845 48644845 60644845 50644845  XdHEHdHE<tt>dHEPdHE<br/>  0060: 68644845 58644845 70644845 60644845  hdHEXdHEpdHE</tt>dHE<br/>  0070: 80644845 68644845 80644845 70644845  .dHEhdHE.dHEpdHE<br/>  0080: 88644845 70644845 98644845 80644845  .dHEpdHE.dHE.dHE<br/>  0090: 98644845 88644845 a8644845 88644845  .dHE.dHE.dHE.dHE<br/>  00a0: a8644845 98644845 b8644845 98644845  .dHE.dHE.dHE.dHE<br/>  00b0: b8644845 a8644845 c0644845 a8644845  .dHE.dHE.dHE.dHE<br/>  00c0: c8644845 b8644845 d0644845 c0644845  .dHE.dHE.dHE.dHE<br/>  00d0: e0644845 c8644845 e0644845 d0644845  .dHE.dHE.dHE.dHE<br/>  00e0: e8644845 d0644845 f0644845 e0644845  .dHE.dHE.dHE.dHE<br/>  00f0: f8644845 e8644845 00654845 f0644845  .dHE.dHE.eHE.dHE<br/>  0100: 08654845 f8644845 18654845 00654845  .eHE.dHE.eHE.eHE<br/>  0110: 18654845 08654845 20654845 08654845  .eHE.eHE eHE.eHE<br/>  0120: 28654845 18654845 30654845 20654845  (eHE.eHE0eHE eHE<br/>  0130: 38654845 28654845 40654845 30654845  8eHE(eHE@eHE0eHE<br/>  0140: 50654845 38654845 50654845 40654845  PeHE8eHEPeHE@eHE<br/>  0150: 58654845 40654845 60654845 50654845  XeHE@eHE<tt>eHEPeHE<br/>  0160: 68654845 58654845 70654845 60654845  heHEXeHEpeHE</tt>eHE<br/>  0170: 78654845 68654845 80654845 70654845  xeHEheHE.eHEpeHE<br/>  0180: 88654845 78654845 90654845 80654845  .eHExeHE.eHE.eHE<br/>  0190: 98654845 88654845 a0654845 90654845  .eHE.eHE.eHE.eHE<br/>  01a0: b0654845 98654845 b0654845 a0654845  .eHE.eHE.eHE.eHE<br/>  01b0: b8654845 a0654845 c0654845 b0654845  .eHE.eHE.eHE.eHE<br/>  01c0: c8654845 b8654845 d0654845 c0654845  .eHE.eHE.eHE.eHE<br/>  01d0: d8654845 c8654845 e0654845 d0654845  .eHE.eHE.eHE.eHE<br/>
<span style="color: #4ec0d6"><span style="font-size: small">(14:34:39)</span> <b>smckee:</b></span> Then I zero it out:<br/>
<span style="color: #4ec0d6"><span style="font-size: small">(14:35:03)</span> <b>smckee:</b></span> [0] 19:30:13 UTC [root@psds0:/usr/local/pgsql/data]# dd ibs=1024 obs=1024 if=/dev/zero of=base/16384/16776 count=8 seek=248424 conv=notrunc<br/>8+0 records in<br/>8+0 records out<br/>8192 bytes (8.2 kB) copied, 0.00183764 s, 4.5 MB/s<br/>[0] 19:30:41 UTC [root@psds0:/usr/local/pgsql/data]# pg_filedump -if -R 31053 base/16384/16776                   <br/>*******************************************************************<br/>* PostgreSQL File/Block Formatted Dump Utility - Version 8.4.0<br/>*<br/>* File: base/16384/16776<br/>* Options used: -if -R 31053<br/>*<br/>* Dump created on: Mon May  8 19:30:44 2017<br/>*******************************************************************<br/><br/>Block 31053 ********************************************************<br/>&lt;Header&gt; -----<br/> Block Offset: 0x0f29a000         Offsets: Lower       0 (0x0000)<br/> Block: Size    0  Version    0            Upper       0 (0x0000)<br/> LSN:  logid      0 recoff 0x00000000      Special     0 (0x0000)<br/> Items:    0                      Free Space:    0<br/> TLI: 0x0000  Prune XID: 0x00000000  Flags: 0x0000 ()<br/> Length (including item array): 24<br/><br/> Error: Invalid header information.<br/><br/>  0000: 00000000 00000000 00000000 00000000  ................<br/>  0010: 00000000 00000000                    ........<br/><br/>&lt;Data&gt; ------<br/> Empty block - no items listed<br/><br/>&lt;Special Section&gt; -----<br/> Error: Invalid special section encountered.<br/> Error: Special section points off page. Unable to dump contents.<br/><br/>*** End of Requested Range Encountered. Last Block Read: 31053 ***<br/>
<span style="color: #4ec0d6"><span style="font-size: small">(14:35:13)</span> <b>smckee:</b></span> Doing the complete list of bad blocks I found now...<br/>
<span style="color: #4ec0d6"><span style="font-size: small">(16:24:54)</span> <b>smckee:</b></span> Didn't work.  Lots of problems.  Currently unable to dump the DB (crashes on ps_event_types when running either 'pg_dumpall' or 'pg_dump')<br/>
</body>
</html>
