<!DOCTYPE html>
<html>
<head>
<title>Tue Jun 1, 2021 : #gracc (osg)</title>
</head>
<body>
<h3>Tue Jun 1, 2021 : #gracc (osg)</h3>
<span style="color: #c386df"><span style="font-size: small">(13:00:53)</span> <b>matyas:</b></span> Hi Mitchell, just hopping in. So you've been running the <tt>slurm_meter</tt> command by hand after running and rm'ing some jobs?<br/>
<span style="color: #c386df"><span style="font-size: small">(13:01:57)</span> <b>matyas:</b></span> can you try adding <tt>-v</tt> (<tt>--verbose</tt>) to your invocation? it might give us more info.<br/>
<span style="color: #a63024"><span style="font-size: small">(13:12:24)</span> <b>miwalls:</b></span> Here is the only thing that seems off as far as I can tell.<br/>2021-06-01 13:09:51 CDT Gratia: DEBUG: call readCertInfo(1434, slurm:<a href="http://cc-condor.hpc.siue.edu">cc-condor.hpc.siue.edu</a>)<br/>2021-06-01 13:09:51 CDT Gratia: findCertInfoFile: received (1434, slurm:<a href="http://cc-condor.hpc.siue.edu">cc-condor.hpc.siue.edu</a>)<br/>2021-06-01 13:09:51 CDT Gratia: findCertInfoFile: trimming 1434 to 1434<br/>2021-06-01 13:09:51 CDT Gratia: findCertInfoFile: continuing to process<br/>2021-06-01 13:09:51 CDT Gratia: findCertInfoFile: looking for /var/lib/gratia/data/gratia_certinfo_batch_1434<br/>2021-06-01 13:09:51 CDT Gratia: findCertInfoFile: looking for /var/lib/gratia/data/gratia_certinfo_condor_1434<br/>2021-06-01 13:09:51 CDT Gratia: findCertInfoFile: looking for /var/lib/gratia/data/gratia_certinfo_sge_1434<br/>2021-06-01 13:09:51 CDT Gratia: findCertInfoFile: looking for /var/lib/gratia/data/gratia_certinfo_slurm_1434<br/>2021-06-01 13:09:51 CDT Gratia: findCertInfoFile: looking for /var/lib/gratia/data/gratia_certinfo_pbs_1434<br/>2021-06-01 13:09:51 CDT Gratia: findCertInfoFile: looking for /var/lib/gratia/data/gratia_certinfo_lsf_1434<br/>2021-06-01 13:09:51 CDT Gratia: ERROR: unable to find valid certinfo file for job 1434<br/>2021-06-01 13:09:51 CDT Gratia: readCertInfoLog: received (1434)<br/>2021-06-01 13:09:51 CDT Gratia: DEBUG: call readCertInfo: OK<br/>2021-06-01 13:09:51 CDT Gratia: DEBUG: certInfo: None<br/>2021-06-01 13:09:51 CDT Gratia: DEBUG: Returning without processing certInfo<br/>2021-06-01 13:09:51 CDT Gratia: DEBUG: Calling verifyFromCertInfo: DONE<br/>
<span style="color: #a63024"><span style="font-size: small">(13:13:05)</span> <b>miwalls:</b></span> There are no such files in /var/lib/gratia/data<br/>
<span style="color: #c386df"><span style="font-size: small">(13:52:41)</span> <b>matyas:</b></span> does the directory exist?<br/>
<span style="color: #c386df"><span style="font-size: small">(14:07:44)</span> <b>matyas:</b></span> do you have any lines like "Converting ClassAd %s to certinfo file" (where %s is a filename)?<br/>
<span style="color: #a63024"><span style="font-size: small">(14:25:02)</span> <b>miwalls:</b></span> The directory does exist and I do not see any lines about converting ClassAd.<br/>
<span style="color: #c386df"><span style="font-size: small">(14:28:02)</span> <b>matyas:</b></span> do you see anything like "Ignoring history file %s as it does not match the regular expression" ?<br/>
<span style="color: #a63024"><span style="font-size: small">(14:57:43)</span> <b>miwalls:</b></span> I do not<br/>
<span style="color: #c386df"><span style="font-size: small">(15:00:57)</span> <b>matyas:</b></span> Do you see an "Initializing Gratia with" and then a config file name?<br/>
<span style="color: #a63024"><span style="font-size: small">(15:06:53)</span> <b>miwalls:</b></span> Looks like it.<br/>[root@cc-condor condor-ce]# cat /tmp/dump | grep -i ini<br/>2021-06-01 13:09:51 CDT Gratia: Initializing Gratia with /etc/gratia/slurm/ProbeConfig<br/>
<span style="color: #c386df"><span style="font-size: small">(15:23:06)</span> <b>matyas:</b></span> OK so presumably it's getting to <a href="https://github.com/opensciencegrid/gratia-probe/blob/master/common/gratia/common/condor_ce.py#L258">https://github.com/opensciencegrid/gratia-probe/blob/master/common/gratia/common/condor_ce.py#L258</a><br/>
<span style="color: #c386df"><span style="font-size: small">(15:23:39)</span> <b>matyas:</b></span> and not displaying either of these:<br/><a href="https://github.com/opensciencegrid/gratia-probe/blob/master/common/gratia/common/condor_ce.py#L266-L271">https://github.com/opensciencegrid/gratia-probe/blob/master/common/gratia/common/condor_ce.py#L266-L271</a><br/>
<span style="color: #c386df"><span style="font-size: small">(15:29:20)</span> <b>matyas:</b></span> You're not seeing <a href="https://github.com/opensciencegrid/gratia-probe/blob/0d9c42008df61d3192be95806402277be834ab46/common/gratia/common/condor_ce.py#L238">https://github.com/opensciencegrid/gratia-probe/blob/0d9c42008df61d3192be95806402277be834ab46/common/gratia/common/condor_ce.py#L238</a><br/>so you can't be getting to <a href="https://github.com/opensciencegrid/gratia-probe/blob/master/common/gratia/common/condor_ce.py#L279">https://github.com/opensciencegrid/gratia-probe/blob/master/common/gratia/common/condor_ce.py#L279</a><br/>but you're also not seeing <a href="https://github.com/opensciencegrid/gratia-probe/blob/master/common/gratia/common/condor_ce.py#L275-L276">https://github.com/opensciencegrid/gratia-probe/blob/master/common/gratia/common/condor_ce.py#L275-L276</a><br/>so you're not skipping any files.<br/><br/>Meaning <tt>glob.glob(os.path.join(history_dir, "history.*"))</tt>  must be empty somehow. Or logging is broken.<br/>
<span style="color: #c386df"><span style="font-size: small">(15:32:55)</span> <b>matyas:</b></span> can you edit <tt>/usr/lib/python3.6/site-packages/gratia/common</tt> and add something like<br/><pre>DebugPrint(3, "In processHistoryDir, history_dir=%s; history files=%s" % (history_dir, glob.glob(os.path.join(history_dir, "history.*"))))</pre><br/>before line 272 (<tt>for full_filename in glob.glob</tt>...)<br/>
<span style="color: #c386df"><span style="font-size: small">(15:34:37)</span> <b>matyas:</b></span> then rm a job, make sure /var/lib/gratia/condorce_data/ has history.* files, and run the slurm_meter probe as usual?<br/>
<span style="color: #c386df"><span style="font-size: small">(15:35:54)</span> <b>matyas:</b></span> er, as before? with <tt>-v</tt>.<br/>
<span style="color: #a63024"><span style="font-size: small">(15:36:21)</span> <b>miwalls:</b></span> doing it now<br/>
<span style="color: #a63024"><span style="font-size: small">(15:37:40)</span> <b>miwalls:</b></span> Here is what that outputted.<br/>2021-06-01 15:36:54 CDT Gratia: In processHistoryDir, history_dir=/var/lib/gratia/condorce_data; history files=['/var/lib/gratia/condorce_data/history.7655.0', '/var/lib/gratia/condorce_data/history.7656.0']<br/>
<span style="color: #c386df"><span style="font-size: small">(15:38:23)</span> <b>matyas:</b></span> and after that?<br/>
<span style="color: #a63024"><span style="font-size: small">(15:39:02)</span> <b>miwalls:</b></span> Whoops missed this thanks,<br/>2021-06-01 15:36:54 CDT Gratia: GridJobId was not parsed correctly: ''<br/>2021-06-01 15:36:54 CDT Gratia: GridJobId was not parsed correctly: 'undefined'<br/>
<span style="color: #c386df"><span style="font-size: small">(15:41:29)</span> <b>matyas:</b></span> this is where GridJobId shows up: <a href="https://github.com/opensciencegrid/gratia-probe/blob/master/common/gratia/common/condor_ce.py#L117">https://github.com/opensciencegrid/gratia-probe/blob/master/common/gratia/common/condor_ce.py#L117</a><br/>
<span style="color: #43761b"><span style="font-size: small">(15:42:26)</span> <b>blin:</b></span> Perhaps it'd be helpful to grab a copy of the history ad right before running <tt>slum_meter</tt>?<br/>
<span style="color: #c386df"><span style="font-size: small">(15:42:40)</span> <b>matyas:</b></span> ^^ :+1:<br/>
<span style="color: #a63024"><span style="font-size: small">(15:43:16)</span> <b>miwalls:</b></span> doing that now<br/>
<span style="color: #a63024"><span style="font-size: small">(15:45:17)</span> <b>miwalls:</b></span> <br/>
<span style="color: #c386df"><span style="font-size: small">(15:51:56)</span> <b>matyas:</b></span> yep I sure don't see a GridJobId. I'll ask the HTCondor devs what a GridJobId is...<br/>
<span style="color: #c386df"><span style="font-size: small">(15:57:40)</span> <b>matyas:</b></span> Mitchell, there were two history files; which one did you send us? Can you check the other one to see if it has a GridJobId?<br/>
<span style="color: #43761b"><span style="font-size: small">(15:58:55)</span> <b>blin:</b></span> The job with the <tt>GridJobId</tt> should correspond to the job where <tt>RoutedJob = True</tt><br/>
<span style="color: #c386df"><span style="font-size: small">(15:59:56)</span> <b>matyas:</b></span> does that mean it's normal for the pre-routed job to have no GridJobId?<br/>
<span style="color: #43761b"><span style="font-size: small">(16:00:48)</span> <b>blin:</b></span> Yeah, I think it's normal but Jaime would know for sure<br/>
<span style="color: #c386df"><span style="font-size: small">(16:01:41)</span> <b>matyas:</b></span> ok but so<br/>&gt; 2021-06-01 15:36:54 CDT Gratia: GridJobId was not parsed correctly: ''<br/>&gt; 2021-06-01 15:36:54 CDT Gratia: GridJobId was not parsed correctly: 'undefined'<br/>that suggests the routed job has a GridJobId of <tt>undefined</tt><br/>
<span style="color: #43761b"><span style="font-size: small">(16:02:49)</span> <b>blin:</b></span> Ah, does Gratia ignore GridJobId parsing for the original job?<br/>
<span style="color: #c386df"><span style="font-size: small">(16:03:24)</span> <b>matyas:</b></span> if it can't parse the GridJobId, it moves onto the next one<br/>
<span style="color: #c386df"><span style="font-size: small">(16:04:28)</span> <b>matyas:</b></span> hmm.<br/>
<span style="color: #c386df"><span style="font-size: small">(16:04:39)</span> <b>matyas:</b></span> &gt; # If we can't create an certinfo XML from it, it's not a routed job.<br/>
<span style="color: #c386df"><span style="font-size: small">(16:05:17)</span> <b>matyas:</b></span> at which point the file gets sent to quarantine.<br/>
<span style="color: #43761b"><span style="font-size: small">(16:07:51)</span> <b>blin:</b></span> The file = the history ad in this case?<br/>
<span style="color: #c386df"><span style="font-size: small">(16:07:57)</span> <b>matyas:</b></span> yep<br/>
<span style="color: #43761b"><span style="font-size: small">(16:10:22)</span> <b>blin:</b></span> Hrm, so it seems like it'd be helpful if @miwalls removed a few jobs and passed along a history file that has <tt>GridJobId</tt>, then ran <tt>slurm_meter</tt>, and gave us the full output<br/>
<span style="color: #43761b"><span style="font-size: small">(16:10:51)</span> <b>blin:</b></span> Also I'm curious about the contents of the quarantine dir at this point<br/>
<span style="color: #c386df"><span style="font-size: small">(16:14:34)</span> <b>matyas:</b></span> ok interestingly, I think in the routed job, GridJobId is the string "undefined", not the classad literal<br/>
<span style="color: #c386df"><span style="font-size: small">(16:19:11)</span> <b>matyas:</b></span> I might be wrong there... based on how Gratia parses the classad, there's no way it can distinguish between the two<br/>
<span style="color: #a63024"><span style="font-size: small">(16:43:54)</span> <b>miwalls:</b></span> Quarantine dir has 2278 line of this.<br/>data/quarantine/subdir.<a href="http://slurm_cc-condor.hpc.siue.edu">slurm_cc-condor.hpc.siue.edu</a>_<a href="http://gratia-osg-prod.opensciencegrid.org">gratia-osg-prod.opensciencegrid.org</a>_80/r.824241.gratia.xml__W7oMq3BcWs<br/>data/quarantine/subdir.<a href="http://slurm_cc-condor.hpc.siue.edu">slurm_cc-condor.hpc.siue.edu</a>_<a href="http://gratia-osg-prod.opensciencegrid.org">gratia-osg-prod.opensciencegrid.org</a>_80/r.824241.gratia.xml__wlKmOnd4iC<br/>data/quarantine/subdir.<a href="http://slurm_cc-condor.hpc.siue.edu">slurm_cc-condor.hpc.siue.edu</a>_<a href="http://gratia-osg-prod.opensciencegrid.org">gratia-osg-prod.opensciencegrid.org</a>_80/r.824241.gratia.xml__WlLJDIG1zz<br/>
<span style="color: #a63024"><span style="font-size: small">(16:46:19)</span> <b>miwalls:</b></span> Yeah it is returning as:<br/>[root@cc-condor condorce_data]# grep -r GridJobId<br/>history.7692.0:GridJobId = undefined<br/>history.7696.0:GridJobId = undefined<br/>
<span style="color: #a63024"><span style="font-size: small">(16:49:00)</span> <b>miwalls:</b></span> Here are the files dump is the slurm_meter output.<br/>
<span style="color: #c386df"><span style="font-size: small">(17:00:06)</span> <b>matyas:</b></span> what's the version of condor/htcondor-ce? (Run <tt>condor_ce_version</tt>)<br/>
<span style="color: #a63024"><span style="font-size: small">(17:04:22)</span> <b>miwalls:</b></span> $HTCondorCEVersion: 5.1.1 $<br/>$CondorVersion: 9.0.1 May 18 2021 PackageID: 9.0.1-1 $<br/>$CondorPlatform: X86_64-CentOS_7.9 $<br/>
<span style="color: #c386df"><span style="font-size: small">(17:57:42)</span> <b>matyas:</b></span> Can you add <tt>GRIDMANAGER_DEBUG = D_CAT D_FULLDEBUG</tt> to your condor-ce config, run <tt>condor_ce_reconfig</tt>, wait for some new jobs to arrive, then send us <tt>/var/log/condor-ce/GridManagerLog</tt> ?<br/>
<span style="color: #c386df"><span style="font-size: small">(17:59:47)</span> <b>matyas:</b></span> (you don't have to do that right now; it's getting late so we can pick back up in the morning)<br/>
</body>
</html>
