<!DOCTYPE html>
<html>
<head>
<title>Fri Feb 19, 2021 : #uscms (osg)</title>
</head>
<body>
<h3>Fri Feb 19, 2021 : #uscms (osg)</h3>
<span style="color: #7d414c"><span style="font-size: small">(07:09:18)</span> <b>bockjoo:</b></span> <pre>146(Conns) 32(Load) 30(Seconds) 2(UFConns)</pre><br/>When there are 146 :root connections, load is 32, and 2 local :root connections (stagein? could not check), a 2GB file gfal-sum takes longer than 30 sec (normally 5-6 sec).<br/>
<span style="color: #7d414c"><span style="font-size: small">(07:10:03)</span> <b>bockjoo:</b></span> So, this will lead to the load hike and xrootd becomes useless.<br/>
<span style="color: #7d414c"><span style="font-size: small">(07:10:44)</span> <b>bockjoo:</b></span> 2 local: root connections are very rate incidents, it seems.<br/>
<span style="color: #7d414c"><span style="font-size: small">(07:11:04)</span> <b>bockjoo:</b></span> So, I have to guess that's the source of the problem.<br/>
<span style="color: #a72f79"><span style="font-size: small">(09:10:15)</span> <b>andrew.melo:</b></span> Do you store checksums as extended attributes in lustre?<br/>
<span style="color: #7d414c"><span style="font-size: small">(09:10:53)</span> <b>bockjoo:</b></span> yes<br/>
<span style="color: #a72f79"><span style="font-size: small">(09:11:29)</span> <b>andrew.melo:</b></span> I'm curious about why gfal-sum takes a lot of time in that case, shouldn't it just read the attribute instead of calculating the checksum?<br/>
<span style="color: #7d414c"><span style="font-size: small">(09:12:09)</span> <b>bockjoo:</b></span> How long does it take for you?<br/>
<span style="color: #a72f79"><span style="font-size: small">(09:12:37)</span> <b>andrew.melo:</b></span> IT's instantaneous<br/>
<span style="color: #a72f79"><span style="font-size: small">(09:13:31)</span> <b>andrew.melo:</b></span> Any file that gets copied into lstore via gridftp/xrootd has the checksum calculated and stored w/the file on the way in, so any time someone asks for the checksum it just reads the attribute instead of re-calculating it<br/>
<span style="color: #7d414c"><span style="font-size: small">(09:14:06)</span> <b>bockjoo:</b></span> Yeah, that's a good question.<br/>
<span style="color: #7d414c"><span style="font-size: small">(09:15:33)</span> <b>bockjoo:</b></span> The lustre is mounted with the attribute. So, I assume it saved the checksum. But the checksum might not be stored, I am not sure. I will have to investigate.<br/>
<span style="color: #a72f79"><span style="font-size: small">(09:16:15)</span> <b>andrew.melo:</b></span> Yeah, you definitely don't want a gfal-sum to trigger a computationally expensive operation<br/>
<span style="color: #de5f24"><span style="font-size: small">(09:22:53)</span> <b>justas.balcas:</b></span> Curious, for lustre - what plugin you use for xrootd (ofs.osslib) or for gridftp (dsi)? Or Gridftp is on top of XRootd and all redirected to xrootd?<br/>
<span style="color: #a72f79"><span style="font-size: small">(10:00:23)</span> <b>andrew.melo:</b></span> This is my least favorite SAM message:<br/><pre>	<br/>open(<a href="root://xrootd.accre.vanderbilt.edu:1094//store/test/xrootd/T2_US_Vanderbilt/store/mc/SAM/GenericTTbar/AODSIM/CMSSW_9_2_6_91X_mcRun1_realistic_v2-v1/00000/A64CCCF2-5C76-E711-B359-0CC47A78A3F8.root">root://xrootd.accre.vanderbilt.edu:1094//store/test/xrootd/T2_US_Vanderbilt/store/mc/SAM/GenericTTbar/AODSIM/CMSSW_9_2_6_91X_mcRun1_realistic_v2-v1/00000/A64CCCF2-5C76-E711-B359-0CC47A78A3F8.root</a>, flags=OpenFlags.READ, timeout=90)<br/>XRootDStatus.code=400 "[ERROR] Server responded with an error: [3010] Unable to open /store/test/xrootd/T2_US_Vanderbilt/store/mc/SAM/GenericTTbar/AODSIM/CMSSW_9_2_6_91X_mcRun1_realistic_v2-v1/00000/A64CCCF2-5C76-E711-B359-0CC47A78A3F8.root; permission denied"</pre><br/><br/>
<span style="color: #7d414c"><span style="font-size: small">(10:12:12)</span> <b>bockjoo:</b></span> It turns out the checksum is stored. The file that I checked owned by cmsprod, but the gfal-sum was authorized with bockjoo, so the checksum was never set.<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:12:53)</span> <b>bockjoo:</b></span> <tt>[bockjoo@cmsio6 ~]$ getfattr --only-values --absolute-names -n user.adler32  /cmsuf/data/store/mc/test.root</tt><br/>/cmsuf/data/store/mc/test.root: user.adler32: No such attribute<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:13:53)</span> <b>bockjoo:</b></span> But the file with adler32:<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:14:02)</span> <b>bockjoo:</b></span> <tt>getfattr --only-values --absolute-names -n user.adler32  /cmsuf/data/store/user/t2/users/bockjoo/pps-protons-tutorial.tar.gz</tt> <br/>16aed1df<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:15:28)</span> <b>bockjoo:</b></span> The problem with gfal-copy stagein could be due to the performance of the local disk, then because I could not reproduce the 2(UFConn) issue.<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:16:13)</span> <b>bockjoo:</b></span> Jobs must have been landed on the worker nodes where WNTMP is very slow/sluggish.<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:16:41)</span> <b>bockjoo:</b></span> Just guessing.<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:17:15)</span> <b>bockjoo:</b></span> @justas.balcas there is no ofs.osslib directive:<br/>
<span style="color: #de5f24"><span style="font-size: small">(10:17:34)</span> <b>justas.balcas:</b></span> multiuser?<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:18:09)</span> <b>bockjoo:</b></span> yes<br/>
<span style="color: #de5f24"><span style="font-size: small">(10:19:28)</span> <b>justas.balcas:</b></span> Can you share full xrootd config with me? Just want to understand why you are not affected by this: <a href="https://github.com/opensciencegrid/xrootd-multiuser/issues/14#issuecomment-720509941">https://github.com/opensciencegrid/xrootd-multiuser/issues/14#issuecomment-720509941</a><br/>
<blockquote>
<span style="color: #7d414c"><span style="font-size: small">(18:42:42)</span> <b>bockjoo:</b></span> I think Florida is affected too.<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:02:44)</span> <b>justas.balcas:</b></span> So davs stageout is bad for you :slightly_smiling_face: While for gridftp I guess you have something like this:<br/>export GRIDFTP_CKSUM_EXT_ADLER32=“/usr/local/bin/xrdadler32”<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:03:20)</span> <b>justas.balcas:</b></span> while xrootd - we did hacks inside xrootd code (so we run hacked xrootd server)<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:08:11)</span> <b>justas.balcas:</b></span> While xrootd:<br/><pre>Unable to fchmod /storage/cms/store/temp/jbalcas/test-xrootd; operation not permitted</pre><br/>
<span style="color: #7d414c"><span style="font-size: small">(19:11:47)</span> <b>bockjoo:</b></span> I just heard GRIDFTP_CKSUM_EXT_ADLER32 from you.<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:15:28)</span> <b>justas.balcas:</b></span> So how gridftp does checksum at Florida?<br/>
<span style="color: #7d414c"><span style="font-size: small">(19:16:33)</span> <b>bockjoo:</b></span> I think we never did since the bestman era.<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:16:38)</span> <b>justas.balcas:</b></span> <pre>Can you try this? Replace host and path to UFL<br/>echo foo &gt;&gt; test<br/>gfal-copy -p -K adler32 test gsi<a href="ftp://transfer-10.ultralight.org//storage/cms/store/temp/jbalcas/test-gridftp">ftp://transfer-10.ultralight.org//storage/cms/store/temp/jbalcas/test-gridftp</a><br/>gfal-copy -p -K adler32 test <a href="root://transfer-10.ultralight.org//storage/cms/store/temp/jbalcas/test-xrootd">root://transfer-10.ultralight.org//storage/cms/store/temp/jbalcas/test-xrootd</a></pre><br/>
<span style="color: #de5f24"><span style="font-size: small">(19:17:02)</span> <b>justas.balcas:</b></span> and after that:<br/><pre>getfattr -d -m - /storage/cms/store/temp/jbalcas/test-gridftp<br/>getfattr -d -m - /storage/cms/store/temp/jbalcas/test-xrootd</pre><br/>
<span style="color: #7d414c"><span style="font-size: small">(19:24:16)</span> <b>bockjoo:</b></span> <pre>[root@cmsio3 ~]# getfattr -d -m - /cmsuf/data//store/temp/user/bockjoo/test-gridftp<br/>getfattr: Removing leading '/' from absolute path names<br/># file: cmsuf/data//store/temp/user/bockjoo/test-gridftp<br/>lustre.lov=0s0AvRCwEAAABu2QAAAAAAAH9oAAACAAAAAAAQAAEAAAA1uxQAAAAAAAAAAAAAAAAAAAAAAAgAAAA=<br/>trusted.link=0s3/HqEQEAAAA2AAAAAAAAAAAAAAAAAAAAAB4AAAACAABofwAA2W0AAAAAdGVzdC1ncmlkZnRw<br/>trusted.lma=0sAAAAAAAAAAB/aAAAAgAAAG7ZAAAAAAAA<br/>trusted.lov=0s0AvRCwEAAABu2QAAAAAAAH9oAAACAAAAAAAQAAEAAAA1uxQAAAAAAAAAAAAAAAAAAAAAAAgAAAA=<br/>trusted.som=0sBAAAAAAAAAAEAAAAAAAAAAEAAAAAAAAA</pre><br/>
<span style="color: #7d414c"><span style="font-size: small">(19:25:31)</span> <b>bockjoo:</b></span> test-xrootd file shows a similar output<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:26:44)</span> <b>justas.balcas:</b></span> so there is no checksum at all.<br/>
<span style="color: #7d414c"><span style="font-size: small">(19:26:55)</span> <b>bockjoo:</b></span> no<br/>
<span style="color: #7d414c"><span style="font-size: small">(19:27:43)</span> <b>bockjoo:</b></span> log shows the setting is failing.<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:29:01)</span> <b>justas.balcas:</b></span> gridftp should work with: export GRIDFTP_CKSUM_EXT_ADLER32=“/usr/local/bin/xrdadler32”; while root/davs - there is no way yet<br/>
<span style="color: #7d414c"><span style="font-size: small">(19:30:14)</span> <b>bockjoo:</b></span> Yeah. I forgot about this with root/davs.<br/>
<span style="color: #7d414c"><span style="font-size: small">(19:30:39)</span> <b>bockjoo:</b></span> As I said, I never heard of GRIDFTP_CKSUM_EXT_ADLER32<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:31:14)</span> <b>justas.balcas:</b></span> so yea, I was just curious how it was setting checksum before, that is what I use for gridftp<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:31:44)</span> <b>justas.balcas:</b></span> because it uses same attr for xrootd/gridftp<br/>
<span style="color: #7d414c"><span style="font-size: small">(19:32:31)</span> <b>bockjoo:</b></span> I think we never worried about storing the checksum. Last time, we did was with srm.<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:33:52)</span> <b>justas.balcas:</b></span> try to take out one gridftp/xrootd server from the pool and do big file copy and check what happens whenever copy finishes (using -k adler32)<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:34:05)</span> <b>justas.balcas:</b></span> it should read file twice - so not the most efficient way<br/>
<span style="color: #7d414c"><span style="font-size: small">(19:39:40)</span> <b>bockjoo:</b></span> Why do you mean by taking out one server and how big the file should be?<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:42:33)</span> <b>justas.balcas:</b></span> This is without GRIDFTP_CKSUM_EXT_ADLER32: (there are no xattr set)<br/>-bash-4.2$ time gfal-sum gsi<a href="ftp://transfer-10.ultralight.org//storage/cms/store/temp/jbalcas/test-big">ftp://transfer-10.ultralight.org//storage/cms/store/temp/jbalcas/test-big</a> adler32<br/>gsi<a href="ftp://transfer-10.ultralight.org//storage/cms/store/temp/jbalcas/test-big">ftp://transfer-10.ultralight.org//storage/cms/store/temp/jbalcas/test-big</a> 71f31e95<br/><br/>real	0m2.048s<br/>user	0m0.070s<br/>sys	0m0.029s<br/>This is with GRIDFTP_CKSUM_EXT_ADLER32 (xattr is set)<br/>-bash-4.2$ time gfal-sum gsi<a href="ftp://transfer-10.ultralight.org//storage/cms/store/temp/jbalcas/test-big">ftp://transfer-10.ultralight.org//storage/cms/store/temp/jbalcas/test-big</a> adler32<br/>gsi<a href="ftp://transfer-10.ultralight.org//storage/cms/store/temp/jbalcas/test-big">ftp://transfer-10.ultralight.org//storage/cms/store/temp/jbalcas/test-big</a> 71f31e95<br/><br/>real	0m0.383s<br/>user	0m0.097s<br/>sys	0m0.037s<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:43:21)</span> <b>justas.balcas:</b></span> there is no load on this server, nor on storage (all is test)<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:46:57)</span> <b>justas.balcas:</b></span> repeated several times - without cksum_ext and without attr - ~2.03 sec; with cksum_ext and with xattr - ~0.4sec<br/>
<span style="color: #de5f24"><span style="font-size: small">(19:47:35)</span> <b>justas.balcas:</b></span> File is 3gb size<br/>
<span style="color: #7d414c"><span style="font-size: small">(19:50:48)</span> <b>bockjoo:</b></span> So, with GRIDFTP_CKSUM_EXT_ADLER32, the checksum is stored and nex time the file is read, it takes no time.<br/>
<span style="color: #7d414c"><span style="font-size: small">(19:51:31)</span> <b>bockjoo:</b></span> Isn't that expected?<br/>
<span style="color: #7d414c"><span style="font-size: small">(19:52:11)</span> <b>bockjoo:</b></span> Or do you want me to test if it works with Lustre?<br/>
<span style="color: #7d414c"><span style="font-size: small">(20:15:31)</span> <b>bockjoo:</b></span> Where do I put<br/>
<span style="color: #7d414c"><span style="font-size: small">(20:15:35)</span> <b>bockjoo:</b></span> export GRIDFTP_CKSUM_EXT_ADLER32=/usr/bin/xrdadler32<br/>
<span style="color: #7d414c"><span style="font-size: small">(20:15:35)</span> <b>bockjoo:</b></span> ?<br/>
<span style="color: #7d414c"><span style="font-size: small">(20:17:08)</span> <b>bockjoo:</b></span> In the gridftp server config, /etc/sysconfig/globus-gridftp-server?<br/>
<span style="color: #de5f24"><span style="font-size: small">(21:36:11)</span> <b>justas.balcas:</b></span> yes, next time it reads checksum from xattr, without calculating it; and yes, it has to go to /etc/sysconfig/globus-gridftp-server<br/>
<span style="color: #7d414c"><span style="font-size: small">(21:45:51)</span> <b>bockjoo:</b></span> This does not work for me. Two gfal-sum coomands takes 3 seconds each.  getfattr command shows no checksum is stored.<br/>
</blockquote>
<span style="color: #7d414c"><span style="font-size: small">(10:19:30)</span> <b>bockjoo:</b></span> <tt>xrd.port 1094</tt><br/>all.role server<br/>all.manager <a href="http://cmsio5.rc.ufl.edu:1213">cmsio5.rc.ufl.edu:1213</a><br/>all.export /store nostage<br/>xrootd.fslib throttle default<br/>throttle.throttle concurrency 20<br/>xrootd.async off<br/>all.sitename T2_US_Florida<br/>cms.allow host *<br/>ofs.trace none<br/>ofs.authlib libXrdMacaroons.so libXrdAccSciTokens.so<br/>xrootd.fslib libXrdMultiuser.so default<br/>multiuser.umask 0002<br/>macaroons.secretkey /etc/xrootd/macaroon-secret<br/>oss.namelib /usr/lib64/libXrdCmsTfc.so file:/cvmfs/cms.cern.ch/SITECONF/local/PhEDEx/storage.xml?protocol=direct<br/>ofs.authorize 1<br/>acc.authdb /etc/xrootd/Authfile<br/>acc.audit deny grant<br/>sec.protocol /usr/lib64 gsi -certdir:/etc/grid-security/certificates -cert:/etc/grid-security/xrd/xrdcert.pem -key:/etc/grid-security/xrd/xrdkey.pem -crl:3 -authzfun:libXrdLcmaps.so -authzfunparms:--lcmapscfg,/etc/xrootd/lcmaps.cfg,--loglevel,3 -gmapopt:10 -gmapto:0<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:19:54)</span> <b>bockjoo:</b></span> <tt>xrootd.seclib /usr/lib64/libXrdSec.so</tt><br/>all.adminpath /var/run/xrootd<br/>all.pidpath /var/run/xrootd<br/>if exec xrootd<br/>   xrd.protocol http:1094 /usr/lib64/libXrdHttp.so<br/>   http.cadir /etc/grid-security/certificates<br/>   http.cert /etc/grid-security/xrd/xrdcert.pem<br/>   http.key /etc/grid-security/xrd/xrdkey.pem<br/>   http.secxtractor /usr/lib64/libXrdLcmaps.so<br/>   http.listingdeny yes<br/>   http.staticpreload <a href="http://static/robots.txt">http://static/robots.txt</a> /etc/xrootd/robots.txt<br/>   http.desthttps yes<br/>   http.exthandler xrdtpc libXrdHttpTPC.so<br/>   http.exthandler xrdmacaroons libXrdMacaroons.so<br/>   http.header2cgi Authorization authz<br/>fi<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:20:00)</span> <b>bockjoo:</b></span> <tt>cms.delay startup 10 servers 1</tt><br/>cms.fxhold 60s<br/>cms.dfs lookup central mdhold 20m redirect verify<br/>xrootd.chksum max 2 md5 adler32 crc32<br/>xrd.report 169.228.130.91:9931 every 60s all sync<br/>xrootd.monitor all auth flush 30s window 5s fstat 60 lfn ops xfr 5 dest files io info user <a href="http://xrd-mon.osgstorage.org:9930">xrd-mon.osgstorage.org:9930</a> dest files io info user 169.228.130.91:9930<br/>
<span style="color: #de5f24"><span style="font-size: small">(10:21:38)</span> <b>justas.balcas:</b></span> No big diff. So in lustre, if file /store/foo is owned by user bockjoo, user xrootd can create/remove xattr of /store/foo?<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:28:39)</span> <b>bockjoo:</b></span> It depends on the file ownership.<br/>
</body>
</html>
