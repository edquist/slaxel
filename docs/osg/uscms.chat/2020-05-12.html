<!DOCTYPE html>
<html>
<head>
<title>Tue May 12, 2020 : #uscms (osg)</title>
</head>
<body>
<h3>Tue May 12, 2020 : #uscms (osg)</h3>
<span style="color: #a72f79"><span style="font-size: small">(08:05:57)</span> <b>andrew.melo:</b></span> Hey all, is there a way to tell gridftp to use a different host cert/key?<br/>
<span style="color: #a72f79"><span style="font-size: small">(08:12:09)</span> <b>andrew.melo:</b></span> I basically need to migrate hostnames and am looking for a way to do a graceful move<br/>
<span style="color: #d1707d"><span style="font-size: small">(10:07:18)</span> <b>gattebury:</b></span> There’s a config file knob or ENV variable … let me see if I can’t dig up what they are.<br/>
<span style="color: #d1707d"><span style="font-size: small">(10:08:02)</span> <b>gattebury:</b></span> Mmm, from an old 2012 presentation I gave at the OSG AHM meeting:<br/><pre>In /etc/sysconfig/globus-gridftp-server:<br/><br/> export X509_USER_CERT=/etc/grid-security/red-gridftp-hostcert.pem<br/> export X509_USER_KEY=/etc/grid-security/red-gridftp-hostkey.pem</pre><br/>
<span style="color: #d1707d"><span style="font-size: small">(10:09:09)</span> <b>gattebury:</b></span> Looks like we actually still have that in place so I’d guess it does still work ¯\_(ツ)_/¯<br/>
<span style="color: #a72f79"><span style="font-size: small">(10:46:44)</span> <b>andrew.melo:</b></span> sweet. I'm gonna try (?) to migrate it live by adding a 2nd LB VIP with the new hostname. it might detonate badly, we'll see :slightly_smiling_face:<br/>
<span style="color: #df3dc0"><span style="font-size: small">(11:41:21)</span> <b>burt:</b></span> do things ever detonate well?<br/>
<span style="color: #a72f79"><span style="font-size: small">(11:42:55)</span> <b>andrew.melo:</b></span> Hmmm<br/>
<span style="color: #a72f79"><span style="font-size: small">(11:42:59)</span> <b>andrew.melo:</b></span> Fireworks, I suppose<br/>
<span style="color: #a72f79"><span style="font-size: small">(13:11:34)</span> <b>andrew.melo:</b></span> ugh, bringing up a replacement CE and getting some heiroglyphics I don't understand:<br/><pre>05/12/20 13:10:17 The SCHEDD (pid 28250) exited with status 4<br/>05/12/20 13:10:17 restarting /usr/sbin/condor_schedd in 265 seconds<br/>05/12/20 13:10:17 SECMAN: FAILED: Received "DENIED" from server for user gsi@unmapped using method GSI.<br/>05/12/20 13:10:17 ERROR: SECMAN:2010:Received "DENIED" from server for user gsi@unmapped using method GSI.<br/>05/12/20 13:10:17 Failed to start non-blocking update to &lt;129.59.197.77:9619&gt;.</pre><br/><br/>
<span style="color: #a72f79"><span style="font-size: small">(13:12:09)</span> <b>andrew.melo:</b></span> (that IP is the external interface of this machine)<br/>
<span style="color: #e06b56"><span style="font-size: small">(13:12:53)</span> <b>jthiltges:</b></span> Does the system hostname match the DNS entry, by chance?<br/>
<span style="color: #e06b56"><span style="font-size: small">(13:13:25)</span> <b>jthiltges:</b></span> I've had occasional grief when the hostname, DNS, and certificate aren't all aligned.<br/>
<span style="color: #a72f79"><span style="font-size: small">(13:13:38)</span> <b>andrew.melo:</b></span> I'm pretty sure I got that lined up, I get the following:<br/><pre>[root@vm-cms-ce5 condor-ce]# condor_ce_host_network_check <br/>Starting analysis of host networking for HTCondor-CE<br/>System hostname: <a href="http://ce5.accre.vanderbilt.edu">ce5.accre.vanderbilt.edu</a><br/>FQDN matches hostname<br/>Forward resolution of hostname <a href="http://ce5.accre.vanderbilt.edu">ce5.accre.vanderbilt.edu</a> is 129.59.197.77.<br/>Backward resolution of IPv4 129.59.197.77 is <a href="http://ce5.accre.vanderbilt.edu">ce5.accre.vanderbilt.edu</a>.<br/>Forward and backward resolution match!<br/>HTCondor is considering all network interfaces and addresses.<br/>HTCondor would pick address of 129.59.197.77 as primary address.<br/>HTCondor primary address 129.59.197.77 matches system preferred address.<br/>Host network configuration should work with HTCondor-CE</pre><br/>
<span style="color: #a72f79"><span style="font-size: small">(13:14:22)</span> <b>andrew.melo:</b></span> and then<br/><pre>[root@vm-cms-ce5 condor-ce]# openssl x509 -in /etc/grid-security/hostcert.pem -noout -subject<br/>subject= /DC=com/DC=DigiCert-Grid/C=US/ST=TN/L=Nashville/O=Vanderbilt University/CN=<a href="http://ce5.accre.vanderbilt.edu">ce5.accre.vanderbilt.edu</a></pre><br/>
<span style="color: #a72f79"><span style="font-size: small">(13:19:09)</span> <b>andrew.melo:</b></span> OK, false alarm .. I got the logic wrong and config-management didn't make the spool directory<br/>
<span style="color: #a72f79"><span style="font-size: small">(13:19:40)</span> <b>andrew.melo:</b></span> reading the full log (and not just the tail) might help....<br/>
<span style="color: #e06b56"><span style="font-size: small">(13:20:22)</span> <b>jthiltges:</b></span> Great! That's certainly an underwhelming error message though. :stuck_out_tongue_closed_eyes:<br/>
<span style="color: #a72f79"><span style="font-size: small">(13:21:30)</span> <b>andrew.melo:</b></span> lol yeah, I think w/o an existent SPOOL path, things get bad early:<br/><pre>05/12/20 13:14:43    /etc/condor-ce/config.d/99-local.conf<br/>05/12/20 13:14:43    /usr/share/condor-ce/condor_ce_router_defaults|<br/>05/12/20 13:14:43 config Macros = 165, Sorted = 165, StringBytes = 14227, TablesBytes = 6132<br/>05/12/20 13:14:43 CLASSAD_CACHING is ENABLED<br/>05/12/20 13:14:43 Daemon Log is logging: D_ALWAYS D_ERROR D_AUDIT<br/>05/12/20 13:14:43 SharedPortEndpoint: waiting for connections to named socket 27812_cf51_13<br/>05/12/20 13:14:43 DaemonCore: ERROR: Can't open address file /mnt/ce-spool/ce5.vampire/.schedd_address.new<br/>05/12/20 13:14:43 DaemonCore: ERROR: Can't open address file /mnt/ce-spool/ce5.vampire/.schedd_address.super.new<br/>05/12/20 13:14:43 DaemonCore: command socket at &lt;129.59.197.77:9619?addrs=129.59.197.77-9619+[--1]-9619&amp;noUDP&amp;sock=27812_cf51_13&gt;<br/>05/12/20 13:14:43 DaemonCore: private command socket at &lt;129.59.197.77:9619?addrs=129.59.197.77-9619+[--1]-9619&amp;noUDP&amp;sock=27812_cf51_13&gt;<br/>05/12/20 13:14:43 DaemonCore: ERROR: Can't open address file /mnt/ce-spool/ce5.vampire/.schedd_address.new<br/>05/12/20 13:14:43 DaemonCore: ERROR: Can't open address file /mnt/ce-spool/ce5.vampire/.schedd_address.super.new<br/>05/12/20 13:14:43 DaemonCore: ERROR: Can't open address file /mnt/ce-spool/ce5.vampire/.schedd_address.new<br/>05/12/20 13:14:43 DaemonCore: ERROR: Can't open address file /mnt/ce-spool/ce5.vampire/.schedd_address.super.new<br/>05/12/20 13:14:43 History file rotation is enabled.<br/>05/12/20 13:14:43   Maximum history file size is: 20971520 bytes<br/>05/12/20 13:14:43   Number of rotated history files is: 2<br/>05/12/20 13:14:43 Logging per-job history files to: /var/lib/gratia/condorce_data<br/>05/12/20 13:14:43 initLocalStarterDir(): mkdir(/mnt/ce-spool/ce5.vampire/local_univ_execute) failed: No such file or directory (errno 2)<br/>05/12/20 13:14:43 my_popenv: Failed to exec in child, errno=2 (No such file or directory)<br/>05/12/20 13:14:43 Failed to execute /usr/sbin/condor_shadow.std, ignoring<br/>05/12/20 13:14:43 CronJobList: Adding job 'GRATIA_CLEANUP'<br/>05/12/20 13:14:43 CronJob: Initializing job 'GRATIA_CLEANUP' (/usr/share/condor-ce/gratia_cleanup.py)<br/>05/12/20 13:14:43 ERROR "failed to open log /mnt/ce-spool/ce5.vampire/job_queue.log, errno =</pre><br/><br/>
<span style="color: #a72f79"><span style="font-size: small">(15:36:59)</span> <b>andrew.melo:</b></span> ugh, I lied. the schedd came up, but the rest is struggling now:<br/>
<span style="color: #a72f79"><span style="font-size: small">(15:37:00)</span> <b>andrew.melo:</b></span> <pre>==&gt; /var/log/condor-ce/CollectorLog &lt;==<br/>05/12/20 15:36:36 PERMISSION DENIED to gsi@unmapped from host 129.59.197.77 for command 58 (UPDATE_AD_GENERIC), access level DAEMON: reason: DAEMON authorization policy contains no matching ALLOW entry for this request; identifiers used for this host: 129.59.197.77,<a href="http://ce5.accre.vanderbilt.edu">ce5.accre.vanderbilt.edu</a>, hostname size = 1, original ip address = 129.59.197.77<br/>05/12/20 15:36:36 DC_AUTHENTICATE: Command not authorized, done!<br/><br/>==&gt; /var/log/condor-ce/JobRouterLog &lt;==<br/>05/12/20 15:36:36 SECMAN: FAILED: Received "DENIED" from server for user gsi@unmapped using method GSI.<br/>05/12/20 15:36:36 ERROR: SECMAN:2010:Received "DENIED" from server for user gsi@unmapped using method GSI.<br/>05/12/20 15:36:36 Failed to send update to collector ce5.accre.vanderbilt.edu:9619.<br/><br/>==&gt; /var/log/condor-ce/CollectorLog &lt;==<br/>05/12/20 15:36:39 PERMISSION DENIED to gsi@unmapped from host 129.59.197.77 for command 2 (UPDATE_MASTER_AD), access level ADVERTISE_MASTER: reason: ADVERTISE_MASTER authorization policy contains no matching ALLOW entry for this request; identifiers used for this host: 129.59.197.77,<a href="http://ce5.accre.vanderbilt.edu">ce5.accre.vanderbilt.edu</a>, hostname size = 1, original ip address = 129.59.197.77<br/>05/12/20 15:36:39 DC_AUTHENTICATE: Command not authorized, done!<br/><br/>==&gt; /var/log/condor-ce/MasterLog &lt;==<br/>05/12/20 15:36:39 SECMAN: FAILED: Received "DENIED" from server for user gsi@unmapped using method GSI.<br/>05/12/20 15:36:39 ERROR: SECMAN:2010:Received "DENIED" from server for user gsi@unmapped using method GSI.<br/>05/12/20 15:36:39 Failed to start non-blocking update to &lt;129.59.197.77:9619&gt;.</pre><br/>
<span style="color: #9e3997"><span style="font-size: small">(21:26:09)</span> <b>bbockelm:</b></span> <tt>gsi@unmapped</tt> -&gt; mapfile problem.  Either LCMAPS isn't firing as expected or there's still a problematic regex.<br/>
</body>
</html>
