<!DOCTYPE html>
<html>
<head>
<title>Tue Jan 26, 2021 : #uscms (osg)</title>
</head>
<body>
<h3>Tue Jan 26, 2021 : #uscms (osg)</h3>
<span style="color: #73769d"><span style="font-size: small">(17:44:18)</span> <b>smithnp:</b></span> I think I've got the the new gpu's we added to one of our (slurm) clusters ready to go.  I've poked through some documentation, has anyone here configured a CE for GPU support? I think I heard someone mention @justas.balcas has done this before.  Or do I simply just need to get a factory entry set up for GPU work and route those jobs on the CE to the slurm nodes that have GPU's?<br/>
<span style="color: #de5f24"><span style="font-size: small">(17:52:12)</span> <b>justas.balcas:</b></span> Yes, we did this. I am unaware of documentation in CMS about this. I sent this at some point to mailing list:<br/><pre>Here are my notes for GPU resources from a Site's point of view:<br/><br/>1. StartD Changes (I put everything inside the /etc/condor/config.d/99-local.conf for test):<br/>   a. Slot Type - include gpus=100%; [1]<br/>   b. Start Expression match only jobs which have RequestGPUs classad. [2]<br/>   c. Have GPU Discovery parameters set.  [3]<br/>   d. For GPU Nodes, add --nv flag [4]<br/>2. CE Changes (routes):<br/>   a. Latest HTCondor CE does not support RequestGPUs, so you need to write your own router rules. For reference, OSG ticket: <a href="https://opensciencegrid.atlassian.net/browse/HTCONDOR-103">https://opensciencegrid.atlassian.net/browse/HTCONDOR-103</a> and also the latest code part I use [5].<br/>3. CMS Implementation: (ticket for Caltech: <a href="https://ggus.eu/index.php?mode=ticket_info&amp;ticket_id=148603">https://ggus.eu/index.php?mode=ticket_info&amp;ticket_id=148603</a>). Mainly create ticket to SI Team and follow up with them to get this implemented (new factory entry and how you want it mapped - auto or single GPU, etc - that might need your StartD changes). <br/><br/>4. Some other notes - do not use "use feature:..." [6]. It broke htcondor cron feature and so far this bug is present in 8.8.9 release<br/><br/>5. Also I have seen this floating around in CMS, FYI: <a href="https://docs.google.com/document/d/150k_VBbja1EK9HlxhXs544T0uhenbad8dnMadyNKlpg/edit#">https://docs.google.com/document/d/150k_VBbja1EK9HlxhXs544T0uhenbad8dnMadyNKlpg/edit#</a> <br/><a href="https://indico.cern.ch/event/978590/">https://indico.cern.ch/event/978590/</a><br/><br/>6. Testing - Once done with SI Team and you have factory entry - the easiest way is using CRAB and adding extraJDL, you can find documentation here: <a href="https://twiki.cern.ch/twiki/bin/view/CMSPublic/CRAB3FAQ#How_can_I_tell_CRAB_to_run_jobs">https://twiki.cern.ch/twiki/bin/view/CMSPublic/CRAB3FAQ#How_can_I_tell_CRAB_to_run_jobs</a> <br/><br/><br/>[1]<br/>SLOT_TYPE_1 = cpus=$(NUM_REAL_CPUS), memory=$(DETECTED_MEMORY), gpus=100%, 95%<br/>[2]<br/>($(START)) &amp;&amp; RequestGPUs &gt;= 1<br/><br/>[3]<br/>GPU_DISCOVERY_EXTRA = -extra -dynamic<br/>MACHINE_RESOURCE_INVENTORY_GPUs=$(LIBEXEC)/condor_gpu_discovery -properties $(GPU_DISCOVERY_EXTRA)<br/>MACHINE_RESOURCE_GPUs = $(LIBEXEC)/condor_gpu_discovery -properties $(GPU_DISCOVERY_EXTRA)<br/>ENVIRONMENT_FOR_AssignedGPUs=GPU_DEVICE_ORDINAL=/(CUDA|OCL)// CUDA_VISIBLE_DEVICES<br/>ENVIRONMENT_VALUE_FOR_UnAssignedGPUs=10000<br/><br/>[4]<br/>SINGULARITY_EXTRA_ARGUMENTS=--nv<br/><br/>[5]<br/>/* HTCondor uses RequestGPUs. Allow also to use WantWholeNode with GPU Resources */<br/>copy_RequestGPUs = "orig_RequestGPUs";<br/>eval_set_OriginalGPUs = ifThenElse(orig_RequestGPUs isnt undefined, orig_RequestGPUs, undefined);<br/>set_GlideinGPUsIsGood = !isUndefined(MATCH_EXP_JOB_GLIDEIN_GPUs) &amp;&amp; (int(MATCH_EXP_JOB_GLIDEIN_GPUs) isnt error);<br/>set_JOB_GLIDEIN_GPUs = "$$(ifThenElse(WantWholeNode is true, !isUndefined(TotalGPUs) ? TotalGPUs : JobGPUs, OriginalGPUs))";<br/>set_JobGPUs = JobIsRunning ? int(MATCH_EXP_JOB_GLIDEIN_GPUs) : OriginalGPUs;<br/>set_RequestGPUs = ifThenElse((WantWholeNode is true &amp;&amp; OriginalGPUs isnt undefined),<br/>(!isUndefined(TotalGPUs) &amp;&amp; TotalGPUs &gt; 0) ? TotalGPUs : JobGPUs,<br/>OriginalGPUs);<br/><br/><br/><br/>[6]<br/>use feature: GPUs<br/>use feature : GPUsMonitor</pre><br/>
<span style="color: #de5f24"><span style="font-size: small">(17:52:21)</span> <b>justas.balcas:</b></span> feel free to ping me on this :wink:<br/>
<span style="color: #de5f24"><span style="font-size: small">(17:53:27)</span> <b>justas.balcas:</b></span> We find out with Max that every site runs CE/Condor differently - so what works for me - does not mean same will work for you :slightly_smiling_face:<br/>
<span style="color: #73769d"><span style="font-size: small">(18:03:26)</span> <b>smithnp:</b></span> I think that could be said about just about any scheduler :joy:<br/>
<span style="color: #a72f79"><span style="font-size: small">(23:02:58)</span> <b>andrew.melo:</b></span> IT's late here, but bockjoo and I have the SLURM bits you need in slurm_local_submit_attributes.sh<br/>
<span style="color: #7d414c"><span style="font-size: small">(23:53:26)</span> <b>bockjoo:</b></span> More specifically, I had to modify:<br/>
<span style="color: #7d414c"><span style="font-size: small">(23:53:43)</span> <b>bockjoo:</b></span> /etc/condor-ce/config.d/02-ce-slurm.conf<br/> /etc/condor-ce/config.d/99-local.conf<br/> /etc/blahp/slurm_local_submit_attributes.sh<br/>
<span style="color: #7d414c"><span style="font-size: small">(23:54:09)</span> <b>bockjoo:</b></span> You can see my config by executing:<br/>
<span style="color: #7d414c"><span style="font-size: small">(23:54:48)</span> <b>bockjoo:</b></span> <tt>files="/etc/condor-ce/config.d/02-ce-slurm.conf</tt><br/> <tt>/etc/condor-ce/config.d/99-local.conf</tt><br/> <tt>/etc/blahp/slurm_local_submit_attributes.sh"</tt><br/>
<span style="color: #7d414c"><span style="font-size: small">(23:56:02)</span> <b>bockjoo:</b></span> <tt>for f in $files ; do condor_ce_run -lr <a href="http://cms.rc.ufl.edu:9619">cms.rc.ufl.edu:9619</a> /bin/sh -c "cat$f" ; done</tt><br/>
<span style="color: #7d414c"><span style="font-size: small">(23:59:19)</span> <b>bockjoo:</b></span> Test with condor-g submission:<br/>
<span style="color: #7d414c"><span style="font-size: small">(23:59:23)</span> <b>bockjoo:</b></span> Submission file:<br/>
</body>
</html>
