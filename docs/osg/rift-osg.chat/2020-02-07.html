<!DOCTYPE html>
<html>
<head>
<title>Fri Feb 7, 2020 : #rift-osg (osg)</title>
</head>
<body>
<h3>Fri Feb 7, 2020 : #rift-osg (osg)</h3>
<span style="color: #a2a5dc"><span style="font-size: small">(09:58:45)</span> <b>james.clark:</b></span> hey <b>@here</b>, so yesterday we got:<br/>• cvmfs container working ok at the command line by adding <tt>/.singularity.d/libs</tt> to the <tt>LD_LIBRARY_PATH</tt> via the environment script (and noted that this happpens automatically when the image is created by a <tt>singularity pull docker://</tt>)<br/>• cvmfs container jobs working ok @ Omaha but nowhere else<br/>• discovered that <tt>/.singularity.d/libs</tt> does not exist in the failing jobs (i.e., the error @efajardo mentions above)<br/>It also looks like the failing jobs are looking in (what i assume is) the "old" location that the OSG containers set up:<br/><pre>WARNING: underlay of /etc/OpenCL/vendors required more than 50 (111) bind mounts</pre><br/>so i just added all the "old" <tt>/host-libs</tt> stuff to the dockerfile, in addition to the <tt>.singularity.d/libs</tt> part and submitted some tests :crossed_fingers:<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(10:03:51)</span> <b>james.clark:</b></span> so.. i don't want to get anyone's hopes up but this just happened for some jobs @ LIGO-CIT:<br/><pre>+-----------------------------------------------------------------------------+<br/>| NVIDIA-SMI 418.87.00    Driver Version: 418.87.00    CUDA Version: 10.1     |<br/>|-------------------------------+----------------------+----------------------+<br/>| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |<br/>| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |<br/>|===============================+======================+======================|<br/>|   0  Tesla K10.G2.8GB    Off  | 00000000:04:00.0 Off |                  N/A |<br/>| N/A   20C    P8    17W / 117W |     11MiB /  3527MiB |      0%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/>|   1  Tesla K10.G2.8GB    Off  | 00000000:05:00.0 Off |                  N/A |<br/>| N/A   17C    P8    17W / 117W |     11MiB /  3527MiB |      0%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/>|   2  Tesla K10.G1.8GB    Off  | 00000000:08:00.0 Off |                  N/A |<br/>| N/A   38C    P0    58W / 117W |    269MiB /  3527MiB |     33%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/>|   3  Tesla K10.G1.8GB    Off  | 00000000:09:00.0 Off |                  N/A |<br/>| N/A   20C    P8    17W / 117W |     11MiB /  3527MiB |      0%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/>|   4  GeForce GTX 750 Ti  Off  | 00000000:83:00.0 Off |                  N/A |<br/>| 30%   19C    P8     1W /  38W |     11MiB /  2002MiB |      0%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/>|   5  GeForce GTX 750 Ti  Off  | 00000000:84:00.0 Off |                  N/A |<br/>| 30%   19C    P8     1W /  38W |     11MiB /  2002MiB |      0%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/>                                                                               <br/>+-----------------------------------------------------------------------------+<br/>| Processes:                                                       GPU Memory |<br/>|  GPU       PID   Type   Process name                             Usage      |<br/>|=============================================================================|<br/>+-----------------------------------------------------------------------------+<br/>Cupy config:<br/>CuPy Version          : 6.7.0<br/>CUDA Root             : /usr/local/cuda<br/>CUDA Build Version    : 10000<br/>CUDA Driver Version   : 10010<br/>CUDA Runtime Version  : 10000<br/>cuDNN Build Version   : 7605<br/>cuDNN Version         : 7605<br/>NCCL Build Version    : 2402<br/>NCCL Runtime Version  : 2402<br/>=== SUCCESS ===</pre><br/><br/>
<span style="color: #a2a5dc"><span style="font-size: small">(10:15:51)</span> <b>james.clark:</b></span> that said, i don't think any of yesterday's tests were actuallly landing at LIGO-CIT so this might not be news<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(10:54:42)</span> <b>james.clark:</b></span> PRP is also functioning now...<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:58:57)</span> <b>rynge:</b></span> I'm trying to catch up - where does it _not_ work?<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:02:04)</span> <b>james.clark:</b></span> so:<br/>• before adding the <tt>host-libs</tt> special sauce, it did *not* work @ PRP, QB2 and (i think) LIGO-CIT<br/>• after adding the <tt>host-libs</tt> i think... it might work everywhere.. i haven't had anything land on QB2 to be sure yet, though<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:02:26)</span> <b>rynge:</b></span> Hmm, ok, I will work on switching from host-libs to --nv<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:02:47)</span> <b>rynge:</b></span> I made the change - just need to test<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:04:30)</span> <b>james.clark:</b></span> so, to be clear, when i did not have host-libs, <tt>singularity.d/libs</tt> alone did the trick @ Omaha.  i now have *both* <tt>host-libs</tt> and <tt>singularity.d/libs</tt> set up and that seems to make it work at everywhere i've landed so far<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:05:41)</span> <b>rynge:</b></span> Ok, well I want to fix this up for the long term<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:42:42)</span> <b>rynge:</b></span> @james.clark Do you have other GPU images, which do not have /.singularity.d/libs directories?<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:50:28)</span> <b>james.clark:</b></span> there's another version of the same image which i'm just experimenting with to check exactly which lines are doing the work - i can modify that for any required testing (i  don't really want to touch the image that just started working, obviously)<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:55:21)</span> <b>james.clark:</b></span> here's the currently successful one: <a href="https://git.ligo.org/james-clark/research-projects-RIT/blob/containers-latest/Dockerfile#L8">https://git.ligo.org/james-clark/research-projects-RIT/blob/containers-latest/Dockerfile#L8</a>.  i was just starting to tinker around with a copy to check how much of that is actually needed<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(13:53:24)</span> <b>james.clark:</b></span> ok, so i just determined that, for RIFT at least, we only need to create the <tt>/.singularity.d/libs</tt> and <tt>/host-libs</tt> dirs and add them to the <tt>LD_LIBRARY_PATH</tt>.  Any idea if the OpenCL part is likely to be needed?  <a href="https://sylabs.io/guides/3.5/user-guide/gpu.html#opencl-applications">https://sylabs.io/guides/3.5/user-guide/gpu.html#opencl-applications</a> .<br/>
<span style="color: #674b1b"><span style="font-size: small">(13:54:58)</span> <b>rynge:</b></span> I just pushed a changed to switch to --nv for the OSG jobs. My tests are working fine, but we will wait an hour or so, and then do some real job tests<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(13:57:07)</span> <b>james.clark:</b></span> should i expect this to mean i don't need to create the binding dirs in the container?<br/>
<span style="color: #674b1b"><span style="font-size: small">(14:02:04)</span> <b>rynge:</b></span> /.singularity.d/libs is still required<br/>
<span style="color: #674b1b"><span style="font-size: small">(14:02:12)</span> <b>rynge:</b></span> but I added a good error message about it<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(14:03:58)</span> <b>james.clark:</b></span> and host-libs?  or just .singularity.d/libs ?<br/>
<span style="color: #674b1b"><span style="font-size: small">(14:26:59)</span> <b>rynge:</b></span> Just <tt>/.singularity.d/libs</tt><br/>
</body>
</html>
