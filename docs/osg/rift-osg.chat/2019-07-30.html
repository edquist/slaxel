<!DOCTYPE html>
<html>
<head>
<title>Tue Jul 30, 2019 : #rift-osg (osg)</title>
</head>
<body>
<h3>Tue Jul 30, 2019 : #rift-osg (osg)</h3>
<span style="color: #53b759"><span style="font-size: small">(10:47:11)</span> <b>isfiligoi:</b></span> Slightly more urgent:<br/>How can we get better GPU utilization by ligo jobs?<br/>Looks like you hardly ever hit even 25%<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(10:47:13)</span> <b>james.clark:</b></span> fyi, looking at this now (/var filled up on the submit host yesterday)<br/>
<span style="color: #53b759"><span style="font-size: small">(10:47:20)</span> <b>isfiligoi:</b></span> ok<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(10:48:12)</span> <b>james.clark:</b></span> Hmm, let me check<br/>
<span style="color: #53b759"><span style="font-size: small">(10:48:33)</span> <b>isfiligoi:</b></span> FYI, here is the ps:<br/><pre><br/>condor   14347    88  0 13:18 ?        00:00:00       condor_starter -f 10.244.32.1<br/>ligo     14351 14347  0 13:18 ?        00:00:00         /bin/bash /var/lib/condor/execute/dir_14347/condor_exec.exe -v std -name gfactory_instance -entry Glow_US_UCSD_xcache_gpu -clientname osg-ligo-1-t2-ucsd-edu_OSG_gWMSFrontend.main-gpu<br/>ligo     22781 14351  0 13:19 ?        00:00:00           /bin/bash /var/lib/condor/execute/dir_14347/glide_CO2GO9/main/condor_startup.sh glidein_config<br/>ligo     24299 22781  0 13:19 ?        00:00:01             /var/lib/condor/execute/dir_14347/glide_CO2GO9/main/condor/sbin/condor_master -f -pidfile /var/lib/condor/execute/dir_14347/glide_CO2GO9/condor_master2.pid<br/>ligo     24301 24299  0 13:19 ?        00:00:00               condor_procd -A /var/lib/condor/execute/dir_14347/glide_CO2GO9/log/procd_address -L /var/lib/condor/execute/dir_14347/glide_CO2GO9/log/ProcLog -R 1000000 -S 60 -C 3004<br/>ligo     24302 24299  0 13:19 ?        00:00:07               condor_startd -f<br/>ligo     27710 24302  0 14:56 ?        00:00:00                 condor_starter -f -a slot1_1 <a href="http://ldas-osg.ligo.caltech.edu">ldas-osg.ligo.caltech.edu</a><br/>ligo     28979 27710  0 14:59 ?        00:00:00                   /bin/bash /var/lib/condor/execute/dir_14347/glide_CO2GO9/execute/dir_27710/condor_exec.exe --output-file CME_out-5300-14652186-1.xml --event 5300 --n-chunk 10000 --time-mar<br/>ligo     29282 28979 99 14:59 ?        00:42:57                     python ./research-projects-RIT/MonteCarloMarginalizeCode/Code/integrate_likelihood_extrinsic_batchmode --output-file CME_out-5300-14652186-1.xml --event 5300 --n-chunk 10<br/></pre><br/>
<span style="color: #a2a5dc"><span style="font-size: small">(10:50:36)</span> <b>james.clark:</b></span> i'm pretty sure <tt>integrate_likelihood_extrinsic_batchmode</tt> is the GPU code, so at least the correct type of job is landing there<br/>
<span style="color: #53b759"><span style="font-size: small">(10:51:08)</span> <b>isfiligoi:</b></span> it is using some GPU, but not much<br/>
<span style="color: #53b759"><span style="font-size: small">(10:51:34)</span> <b>isfiligoi:</b></span> <pre><br/>[root@osg-wn-gpu-opt-6d7b6f574-pnmqp /]# nvidia-smi <br/>Tue Jul 30 15:51:23 2019       <br/>+-----------------------------------------------------------------------------+<br/>| NVIDIA-SMI 430.14       Driver Version: 430.14       CUDA Version: 10.2     |<br/>|-------------------------------+----------------------+----------------------+<br/>| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |<br/>| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |<br/>|===============================+======================+======================|<br/>|   0  GeForce GTX 1080    Off  | 00000000:0B:00.0  On |                  N/A |<br/>| 37%   55C    P2    59W / 180W |    375MiB /  8119MiB |      0%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/></pre><br/>
<span style="color: #53b759"><span style="font-size: small">(10:51:46)</span> <b>isfiligoi:</b></span> <pre><br/>[root@osg-wn-gpu-opt-6d7b6f574-pnmqp /]# nvidia-smi <br/>Tue Jul 30 15:51:22 2019       <br/>+-----------------------------------------------------------------------------+<br/>| NVIDIA-SMI 430.14       Driver Version: 430.14       CUDA Version: 10.2     |<br/>|-------------------------------+----------------------+----------------------+<br/>| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |<br/>| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |<br/>|===============================+======================+======================|<br/>|   0  GeForce GTX 1080    Off  | 00000000:0B:00.0  On |                  N/A |<br/>| 37%   55C    P2    41W / 180W |    375MiB /  8119MiB |     10%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/></pre><br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:15:29)</span> <b>james.clark:</b></span> hm, my test job just error-ed out with:<br/><pre><br/>CUDARuntimeError: cudaErrorNoDevice: no CUDA-capable device is detected<br/></pre><br/>It's just a simple script which attempts to create a cupy array.<br/>
<span style="color: #53b759"><span style="font-size: small">(11:17:29)</span> <b>isfiligoi:</b></span> ok, so I need to test more<br/>
<span style="color: #53b759"><span style="font-size: small">(11:17:35)</span> <b>isfiligoi:</b></span> can you tell me how to reproduce?<br/>
<span style="color: #53b759"><span style="font-size: small">(11:17:42)</span> <b>isfiligoi:</b></span> image used and the script executed<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:29:01)</span> <b>james.clark:</b></span> my usual first test before trying RIFT itself<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:34:02)</span> <b>james.clark:</b></span> Re the GPU usage:  does the plot just report the <tt>Volatile GPU-Util</tt> field from nvidia-smi ?<br/>
<span style="color: #53b759"><span style="font-size: small">(11:35:33)</span> <b>isfiligoi:</b></span> the problem is that you are pointing to your won NVIDIA libraries in the image; if I force it to use the singularity-provided ones, it works<br/><pre><br/>+ exec singularity exec --bind /tmp/igor/.host-libs:/host-libs --bind /etc/OpenCL/vendors:/etc/OpenCL/vendors --bind /tmp/igor:/srv --bind /usr/bin:/mybin --no-home --ipc --pid /cvmfs/ligo-containers.opensciencegrid.org/james-clark/research-projects-rit/rift/latest /bin/bash<br/>bash: /root/.bashrc: Permission denied<br/>Singularity&gt; nvidia-smi<br/>Failed to initialize NVML: Driver/library version mismatch<br/>Singularity&gt; export LD_LIBRARY_PATH=/host-libs/:${LD_LIBRARY_PATH}<br/>Singularity&gt; nvidia-smi<br/>Tue Jul 30 16:34:09 2019       <br/>+-----------------------------------------------------------------------------+<br/>| NVIDIA-SMI 418.67       Driver Version: 430.14       CUDA Version: 10.2     |<br/>|-------------------------------+----------------------+----------------------+<br/>| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |<br/>| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |<br/>|===============================+======================+======================|<br/>|   0  GeForce GTX 108...  Off  | 00000000:B1:00.0 Off |                  N/A |<br/>| 25%   26C    P8     9W / 250W |      0MiB / 11178MiB |      0%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/></pre><br/>
<span style="color: #53b759"><span style="font-size: small">(11:35:48)</span> <b>isfiligoi:</b></span> Does this same image work on other OSG sites???<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:37:03)</span> <b>james.clark:</b></span> i believe so but let me double check<br/>
<span style="color: #53b759"><span style="font-size: small">(11:41:45)</span> <b>isfiligoi:</b></span> Can you run a test job from condor) and print out the complete env?<br/>Also output of nvidia-smi?<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:42:14)</span> <b>james.clark:</b></span> actually, this may be the first singularity+GPU OSG resource we've actually landed on.  and now that submit node has filled up again..  there are others i can use in the meantime<br/>
<span style="color: #53b759"><span style="font-size: small">(11:42:49)</span> <b>isfiligoi:</b></span> ok… so maybe it is not completely a surprise :stuck_out_tongue:<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:48:57)</span> <b>james.clark:</b></span> this image is basically identical to the docker one we're already using at PRP, by the way.  should we avoid installing the nvidia libs then?<br/>
<span style="color: #53b759"><span style="font-size: small">(11:50:21)</span> <b>isfiligoi:</b></span> you should put /host-libs as the first thing in the LD_LIBRARY_PATH… that’s where OSG singularity injects them from the host<br/>
<span style="color: #53b759"><span style="font-size: small">(11:50:38)</span> <b>isfiligoi:</b></span> Here is an example of how OSG tensorflow does it:<br/><a href="https://github.com/opensciencegrid/osgvo-tensorflow-gpu/blob/master/environment">https://github.com/opensciencegrid/osgvo-tensorflow-gpu/blob/master/environment</a><br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:55:46)</span> <b>james.clark:</b></span> ah, got it, thanks<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(12:12:19)</span> <b>james.clark:</b></span> Actually, can you remind me where the dockerfile is that you're already using on PRP?  I just need to check something unrelated to singularity<br/>
<span style="color: #53b759"><span style="font-size: small">(12:16:45)</span> <b>isfiligoi:</b></span> the “non-singularity one”?<br/>Anyway, both here:<br/><a href="https://github.com/sfiligoi/prp-osg-pool/tree/master/wn">https://github.com/sfiligoi/prp-osg-pool/tree/master/wn</a><br/>
<span style="color: #a2a5dc"><span style="font-size: small">(12:23:42)</span> <b>james.clark:</b></span> perfect, thanks.   apparently they had some problems with <tt>numba</tt> import failures.  they've resolved that by just pip installing it with the jobs themselves as a workaround but i see it's in the dockerfile<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(14:25:58)</span> <b>james.clark:</b></span> Great news: my test job ran fine with /host-libs<br/>
<span style="color: #53b759"><span style="font-size: small">(14:31:45)</span> <b>isfiligoi:</b></span> great!<br/>
<span style="color: #53b759"><span style="font-size: small">(14:33:04)</span> <b>isfiligoi:</b></span> Can you add the new image to all future jobs, as an optional feature?<br/>This way I can start adding more singularity enabled nodes<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(14:33:15)</span> <b>james.clark:</b></span> testing RIFT itself now then i'll confirm the additional attributes we normally expect<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(14:34:37)</span> <b>james.clark:</b></span> well, the pipeline is already set up to send singularity-based jobs to the OSG with or without GPUs so it should be ready<br/>
<span style="color: #53b759"><span style="font-size: small">(14:36:22)</span> <b>isfiligoi:</b></span> but the rift jobs did not start on the test node… I did not blacklist them there<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(14:39:04)</span> <b>james.clark:</b></span> hm, i just sent some with the same image as my test job, the same <tt>+DESIRED_Sites</tt> and no special requirements but yes, they're not doing much<br/>
<span style="color: #53b759"><span style="font-size: small">(14:40:05)</span> <b>isfiligoi:</b></span> @efajardo? ^^^<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(14:46:11)</span> <b>james.clark:</b></span> ah, i was missing a <tt>+OpenScienceGrid</tt> (was adapting the wrong workflow options).   Looks like there may be an error with an install path internal to the image but it certainly starts ok<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(14:49:40)</span> <b>james.clark:</b></span> no, my mistake - those must be landing on non-singularity nodes?   there is indeed a single job which is now running!<br/>
<span style="color: #53b759"><span style="font-size: small">(14:54:28)</span> <b>isfiligoi:</b></span> Make sure you land on osg-wn-gpu-sing-ligo-795dfbc46d-tw8hf<br/>
<span style="color: #53b759"><span style="font-size: small">(14:54:38)</span> <b>isfiligoi:</b></span> Only one with singularity enabled<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(14:56:17)</span> <b>james.clark:</b></span> yep, i just resubmitted with the usual requirements (i wasn't sure things like HAS_SINGULARITY were defined but i see it now)<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(14:57:03)</span> <b>james.clark:</b></span> and indeed, 1 job running with 11 idle (instead of held).<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(14:58:38)</span> <b>james.clark:</b></span> can you remind me what the status and plan (if any) is to mount the x509-authenticated ligo data in cvmfs?  iirc, that wasn't possible.<br/>
<span style="color: #53b759"><span style="font-size: small">(14:59:23)</span> <b>isfiligoi:</b></span> not in the short-time plane for PRP<br/>
<span style="color: #53b759"><span style="font-size: small">(15:00:10)</span> <b>isfiligoi:</b></span> currently CVMFS is mounted outside the container so not obvious how x509 credentials would even be communicated there<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(15:01:19)</span> <b>james.clark:</b></span> got it<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(15:18:17)</span> <b>james.clark:</b></span> that job completed successfully btw.  when can we expect general deployment? :slightly_smiling_face:<br/>
<span style="color: #53b759"><span style="font-size: small">(15:28:16)</span> <b>isfiligoi:</b></span> still troubleshooting icecube jobs… the other  large user of PRP GPUs…<br/>we have a lead, so hopefully by the end of today we are ready to move on<br/>
<span style="color: #53b759"><span style="font-size: small">(15:30:05)</span> <b>isfiligoi:</b></span> but I can add a few more nodes for ligo, if you are able to work in mixed mode (some with and some without singularity)<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(15:37:18)</span> <b>james.clark:</b></span> it's ok - it's probably easier all round to stick with the current setup and then completely transition when ready.  The main advantage of singularity is that we'll be able to just submit to the whole OSG without any special configuration but the only other site i'm landing at seems to be giving nvidia library problems with that image (<tt>CUDARuntimeError: cudaErrorInsufficientDriver: CUDA driver version is insufficient for CUDA runtime version</tt>)<br/>
<span style="color: #53b759"><span style="font-size: small">(15:39:06)</span> <b>isfiligoi:</b></span> cuda 9 vs cuda 10 , I suppose<br/>
<span style="color: #53b759"><span style="font-size: small">(15:39:19)</span> <b>isfiligoi:</b></span> are you using cuda10 in yours?<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(15:51:17)</span> <b>james.clark:</b></span> i am, yes.  10.1.   i thought it was possible to completely contain all the required nvidia libraries, though<br/>
<span style="color: #a63024"><span style="font-size: small">(15:51:30)</span> <b>efajardo:</b></span> which is the other site<br/>
<span style="color: #a63024"><span style="font-size: small">(15:51:32)</span> <b>efajardo:</b></span> QB2?<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(15:51:39)</span> <b>james.clark:</b></span> yep<br/>
<span style="color: #53b759"><span style="font-size: small">(15:59:19)</span> <b>isfiligoi:</b></span> no, the libraries and the driver must be compatible<br/>
<span style="color: #53b759"><span style="font-size: small">(15:59:36)</span> <b>isfiligoi:</b></span> you can run CUDA9 binaries on CUDA 10 kernels, but not the way around<br/>
<span style="color: #53b759"><span style="font-size: small">(16:00:36)</span> <b>isfiligoi:</b></span> bottom line, if you want to run on all possible setups, keep the container cuda version as low as feasible<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(16:04:30)</span> <b>james.clark:</b></span> seems reasonable<br/>
</body>
</html>
