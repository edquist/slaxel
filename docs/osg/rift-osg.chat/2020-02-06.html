<!DOCTYPE html>
<html>
<head>
<title>Thu Feb 6, 2020 : #rift-osg (osg)</title>
</head>
<body>
<h3>Thu Feb 6, 2020 : #rift-osg (osg)</h3>
<span style="color: #a2a5dc"><span style="font-size: small">(10:14:20)</span> <b>james.clark:</b></span> @efajardo @rynge @dweitzel just a heads-up that I also have high-availability on here and this is probably a reasonable channel<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:18:51)</span> <b>***rynge:</b></span> waves<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(10:19:03)</span> <b>james.clark:</b></span> :slightly_smiling_face:<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:19:09)</span> <b>rynge:</b></span> Just replied to the email - I have access<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(10:19:40)</span> <b>james.clark:</b></span> perfect<br/>
<span style="color: #235e5b"><span style="font-size: small">(11:00:56)</span> <b>dweitzel:</b></span> Hi @james.clark and @efajardo.  I played around with that image.<br/>
<span style="color: #235e5b"><span style="font-size: small">(11:01:08)</span> <b>dweitzel:</b></span> I see why it seems "stuck", there is no prompt.<br/>
<span style="color: #235e5b"><span style="font-size: small">(11:01:41)</span> <b>dweitzel:</b></span> But.... it responds to bash commands.  If you run:<br/><pre>singularity shell --nv /cvmfs/singularity.opensciencegrid.org/james-clark/research-projects-rit/rift:latest</pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(11:01:47)</span> <b>dweitzel:</b></span> it just is blank.<br/>
<span style="color: #235e5b"><span style="font-size: small">(11:01:53)</span> <b>dweitzel:</b></span> type <tt>env</tt> then enter.<br/>
<span style="color: #235e5b"><span style="font-size: small">(11:02:28)</span> <b>dweitzel:</b></span> it's bash under there, and it's responding.  It appears that bash is just not configured at all to show the normal prompt?<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:02:36)</span> <b>james.clark:</b></span> lol, you're right<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:02:58)</span> <b>james.clark:</b></span> any idea what's happening differently with the docker uri?<br/>
<span style="color: #235e5b"><span style="font-size: small">(11:03:34)</span> <b>dweitzel:</b></span> I suspect that it is the custom .singularity stuff in the container.<br/>
<span style="color: #235e5b"><span style="font-size: small">(11:03:53)</span> <b>dweitzel:</b></span> I think singularity uses a slightly different engine when it runs something from a docker uri vs. a normal filesystem.<br/>
<span style="color: #235e5b"><span style="font-size: small">(11:04:22)</span> <b>dweitzel:</b></span> _I think_<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:04:56)</span> <b>james.clark:</b></span> note that if you do a <tt>singularity pull</tt> first and run the <tt>sif</tt> file, it does the same thing<br/>
<span style="color: #235e5b"><span style="font-size: small">(11:05:12)</span> <b>dweitzel:</b></span> ok, that feeds more into my theory.<br/>
<span style="color: #235e5b"><span style="font-size: small">(11:05:30)</span> <b>dweitzel:</b></span> the .singularity directory stuff just does odd things with the shell.<br/>
<span style="color: #235e5b"><span style="font-size: small">(11:05:35)</span> <b>dweitzel:</b></span> in this case.<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:06:12)</span> <b>james.clark:</b></span> ok, cool - so, apparently we need to set LD_LIBRARY_PATH as well as use <tt>--nv</tt> to find cuda; sounds like i should try just doing that directly in the dockerfile<br/>
<span style="color: #235e5b"><span style="font-size: small">(11:08:34)</span> <b>dweitzel:</b></span> sounds like a plan.<br/>
<span style="color: #a63024"><span style="font-size: small">(11:10:09)</span> <b>efajardo:</b></span> hmm what do you have to do to the <tt>LD_LIBRARY_PATH</tt><br/>
<span style="color: #a63024"><span style="font-size: small">(11:10:50)</span> <b>efajardo:</b></span> I am toally lost regarding what broke<br/>
<span style="color: #a63024"><span style="font-size: small">(11:11:48)</span> <b>efajardo:</b></span> But I am trying to understand<br/>
<span style="color: #a63024"><span style="font-size: small">(11:11:49)</span> <b>efajardo:</b></span> why this<br/>
<span style="color: #a63024"><span style="font-size: small">(11:11:51)</span> <b>efajardo:</b></span> <pre>singularity exec --nv --nv <a href="docker://containers.ligo.org/james-clark/research-projects-rit/rift:latest">docker://containers.ligo.org/james-clark/research-projects-rit/rift:latest</a> nvidia-smi<br/>Thu Feb  6 09:11:19 2020       <br/>+-----------------------------------------------------------------------------+<br/>| NVIDIA-SMI 440.33.01    Driver Version: 440.33.01    CUDA Version: 10.2     |<br/>|-------------------------------+----------------------+----------------------+<br/>| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |<br/>| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |<br/>|===============================+======================+======================|<br/>|   0  GeForce GTX 1650    Off  | 00000000:02:00.0 Off |                  N/A |<br/>| 30%   25C    P0    14W /  75W |      0MiB /  3911MiB |      0%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/>|   1  Tesla P40           Off  | 00000000:03:00.0 Off |                    0 |<br/>| N/A   22C    P0    50W / 250W |      0MiB / 22919MiB |      0%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/>|   2  Tesla P100-PCIE...  Off  | 00000000:84:00.0 Off |                    0 |<br/>| N/A   15C    P0    27W / 250W |      0MiB / 16280MiB |      4%      Default |<br/>+-------------------------------+----------------------+----------------------+<br/>                                                                               <br/>+-----------------------------------------------------------------------------+<br/>| Processes:                                                       GPU Memory |<br/>|  GPU       PID   Type   Process name                             Usage      |<br/>|=============================================================================|<br/>|  No running processes found                                                 |<br/>+-----------------------------------------------------------------------------+</pre><br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:11:51)</span> <b>james.clark:</b></span> <pre>LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda/lib64<br/>export LD_LIBRARY_PATH<br/>PATH=/usr/local/cuda/bin:/usr/local/bin:/usr/bin:/bin<br/>export PATH</pre><br/>*is* what i'm doing in that environment file the actions scripts source -- i found that i needed the environment file to get the  <tt>nvidia/cuda:9.0-runtime-centos7</tt>  image to even work with the docker uri<br/>
<span style="color: #a63024"><span style="font-size: small">(11:11:52)</span> <b>efajardo:</b></span> Works<br/>
<span style="color: #a63024"><span style="font-size: small">(11:11:54)</span> <b>efajardo:</b></span> and this one<br/>
<span style="color: #a63024"><span style="font-size: small">(11:12:01)</span> <b>efajardo:</b></span> doesnt<br/>
<span style="color: #a63024"><span style="font-size: small">(11:12:02)</span> <b>efajardo:</b></span> <pre>singularity exec --nv --nv /cvmfs/singularity.opensciencegrid.org/james-clark/research-projects-rit/rift:latest nvidia-smi<br/>NVIDIA-SMI couldn't find libnvidia-ml.so library in your system. Please make sure that the NVIDIA Display Driver is properly installed and present in your system.<br/>Please also try adding directory that contains libnvidia-ml.so to your system PATH.</pre><br/>
<span style="color: #674b1b"><span style="font-size: small">(11:13:36)</span> <b>rynge:</b></span> Note that Docker ENV are ignore when we put the image into CVMFS - you need to drop files into /.singularity if you want it to work on OSG<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:13:47)</span> <b>rynge:</b></span> <a href="https://github.com/opensciencegrid/osgvo-el7">https://github.com/opensciencegrid/osgvo-el7</a><br/>
<span style="color: #674b1b"><span style="font-size: small">(11:14:11)</span> <b>rynge:</b></span> See 90-environment.sh in the .singularity.d dir<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:14:34)</span> <b>rynge:</b></span> Also need to copy it in there <a href="https://github.com/opensciencegrid/osgvo-el7/blob/master/Dockerfile#L136">https://github.com/opensciencegrid/osgvo-el7/blob/master/Dockerfile#L136</a><br/>
<span style="color: #a63024"><span style="font-size: small">(11:14:56)</span> <b>efajardo:</b></span> Well but what if we do <tt>--nv</tt><br/>
<span style="color: #a63024"><span style="font-size: small">(11:15:06)</span> <b>efajardo:</b></span> cause that makes sense when you are binding by hand<br/>
<span style="color: #a63024"><span style="font-size: small">(11:15:20)</span> <b>efajardo:</b></span> I do not understand what is the relationip between binding and the env variables<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:17:55)</span> <b>rynge:</b></span> The env stuff is more general<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:17:58)</span> <b>rynge:</b></span> Not only GPU<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:18:19)</span> <b>james.clark:</b></span> ok, trying again with the .singularity directory, as described in that dockerfile.  i thought i was effectively doing that, though i don't currently have symlinks to <tt>.exec</tt> etc<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:18:37)</span> <b>rynge:</b></span> All I'm saying is that if we figure out this is a problem setting LD_LIBRARY_PATH, we have a hook where we can set it<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:18:50)</span> <b>rynge:</b></span> Those symlinks might be old<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:19:06)</span> <b>rynge:</b></span> I mean for older versions of Singularity<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:19:27)</span> <b>rynge:</b></span> I don't think you need it<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:21:22)</span> <b>james.clark:</b></span> so, just to be clear, this is what we're currently doing:<br/><a href="https://git.ligo.org/james-clark/research-projects-RIT/blob/containers-latest/Dockerfile#L10">https://git.ligo.org/james-clark/research-projects-RIT/blob/containers-latest/Dockerfile#L10</a><br/>where environment is:<br/><a href="https://git.ligo.org/james-clark/research-projects-RIT/blob/containers-latest/environment">https://git.ligo.org/james-clark/research-projects-RIT/blob/containers-latest/environment</a><br/><br/>(but we do also set an algorithm-specific variable, unrelated to any GPU stuff, in the dockerfile and i just noticed that is indeed ignored in cvmfs, so i need to change that anyway)<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:21:44)</span> <b>james.clark:</b></span> If i do *not* use that environment, even the docker uri fails<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:27:07)</span> <b>rynge:</b></span> That might be the the wrong location<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:28:02)</span> <b>rynge:</b></span> I have never tried that, but you could try to stick it into /.singularity.d/env/<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:28:06)</span> <b>rynge:</b></span> With a .sh extension<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:30:19)</span> <b>james.clark:</b></span> yeah, i'm just trying with the osgvo-el7-cuda10 dockerfile as an example now.. (with that extra variable)<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:35:22)</span> <b>rynge:</b></span> I haven't worked on that one for a while<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:36:34)</span> <b>rynge:</b></span> Anyways, I think this is a good path to explore - the env setup is definitely something that varies slightly between Docker / Singularity+Docker file/ Singularity+CVMFS<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:36:48)</span> <b>rynge:</b></span> Sorry I don't have time to jump in right now<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:43:48)</span> <b>james.clark:</b></span> np, i have some good leads now<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(12:54:50)</span> <b>james.clark:</b></span> ok, major finding:  the CVMFS image only has whatever we explicitly put in <tt>LD_LIBRARY_PATH</tt> in the environment script when we build the container.  the docker-pulled image automatically adds <tt>/.singularity.d/libs</tt> .   In *both* versions, that <tt>/.singularity.d/libs</tt> has the required libraries.   So if you shell into the CVMFS image and add <tt>/.singularity.d/libs</tt>  to the LD_LIBRARY_PATH, nvidia-smi actually works.    I also notice that the <tt>singularity.d</tt> directory contains quite a few extra things that get magically added in the docker conversion such that it has everything listed here: <a href="https://singularity.lbl.gov/docs-environment-metadata">https://singularity.lbl.gov/docs-environment-metadata</a><br/>
<span style="color: #a2a5dc"><span style="font-size: small">(12:55:14)</span> <b>james.clark:</b></span> rebuilding this now to confirm<br/>
<span style="color: #a63024"><span style="font-size: small">(13:25:42)</span> <b>efajardo:</b></span> @james.clark I am lost so for Rift do we need to clean the ENv<br/>
<span style="color: #a63024"><span style="font-size: small">(13:26:02)</span> <b>efajardo:</b></span> or if we put it in //singilairt/env when singularity is launched<br/>
<span style="color: #a63024"><span style="font-size: small">(13:26:05)</span> <b>efajardo:</b></span> it will contain it?<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(13:26:36)</span> <b>james.clark:</b></span> right now i'm just trying to get the container to function properly on its own tbh<br/>
<span style="color: #a63024"><span style="font-size: small">(13:31:50)</span> <b>efajardo:</b></span> ok<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(13:31:55)</span> <b>james.clark:</b></span> ok, it just showed up in cvmfs:<br/><pre>singularity exec --nv /cvmfs/singularity.opensciencegrid.org/james-clark/research-projects-rit/rift:latest nvidia-smi</pre><br/>is now functional!   I'll commit the changes so you can see what's involved.   It's basically just a case of making sure <tt>/.singularity.d/libs</tt> is in LD_LIBRARY_PATH since that appears to be where <tt>--nv</tt> binds the host drivers (as far as i can tell).<br/><br/>I'm not sure what this requires on the OSG side but i'm testing on CIT and IGWN now<br/><br/>... except i'm now running into a cupy problem<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(13:34:19)</span> <b>james.clark:</b></span> Here's the relevant line in the dockerfile:<br/><a href="https://git.ligo.org/james-clark/research-projects-RIT/blob/containers-latest/Dockerfile#L9">https://git.ligo.org/james-clark/research-projects-RIT/blob/containers-latest/Dockerfile#L9</a><br/><br/>and that directory is:<br/><a href="https://git.ligo.org/james-clark/research-projects-RIT/tree/containers-latest/.singularity.d">https://git.ligo.org/james-clark/research-projects-RIT/tree/containers-latest/.singularity.d</a><br/><br/>In particular, this is what's needed to make it work in the CVMFS version:<br/><a href="https://git.ligo.org/james-clark/research-projects-RIT/blob/containers-latest/.singularity.d/env/90-environment.sh">https://git.ligo.org/james-clark/research-projects-RIT/blob/containers-latest/.singularity.d/env/90-environment.sh</a><br/><br/>(but when you run from <tt>docker://</tt> that happens automatically)<br/>
<span style="color: #674b1b"><span style="font-size: small">(14:01:08)</span> <b>rynge:</b></span> :thumbsup:<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(14:23:01)</span> <b>james.clark:</b></span> and it looks like the cupy error has just gone away by bumping up to cuda 10 (i noticed nvcc was a requirement but unavailable for cuda 9.0) :slightly_smiling_face:<br/>
<span style="color: #a63024"><span style="font-size: small">(15:18:14)</span> <b>efajardo:</b></span> @rynge where does this error come from<br/><pre>ERROR  : Failed creating directory /var/singularity/mnt/final/.singularity.d/libs :No such file or directory</pre><br/>
<span style="color: #a63024"><span style="font-size: small">(15:18:16)</span> <b>efajardo:</b></span> the wrapper?<br/>
</body>
</html>
