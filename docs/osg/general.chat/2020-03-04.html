<!DOCTYPE html>
<html>
<head>
<title>Wed Mar 4, 2020 : #general (osg)</title>
</head>
<body>
<h3>Wed Mar 4, 2020 : #general (osg)</h3>
<span style="color: #bb86b7"><span style="font-size: small">(09:09:41)</span> <b>kwangs:</b></span> Can someone here help be troubleshoot a CVMFS problem with getting LIGO data from OSG storage?<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:10:10)</span> <b>kwangs:</b></span> The filepath is <tt>/cvmfs/oasis.opensciencegrid.org/ligo/frames/O3/hoft_C01_clean_sub60Hz/H1/H-H1_HOFT_CLEAN_SUB60HZ_C01-12424/H-H1_HOFT_CLEAN_SUB60HZ_C01-1242439680-4096.gwf</tt><br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:10:25)</span> <b>kwangs:</b></span> (All files are equally inaccessible.)<br/>
<span style="color: #235e5b"><span style="font-size: small">(09:13:36)</span> <b>dweitzel:</b></span> Yup, I can help.  Just to confirm the basics, you have your certificate in your path?  What's the DN?<br/>
<span style="color: #235e5b"><span style="font-size: small">(09:13:44)</span> <b>dweitzel:</b></span> in your *environment<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:14:14)</span> <b>kwangs:</b></span> Hi Derek<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:14:36)</span> <b>kwangs:</b></span> Here is the output of <tt>grid-proxy-info</tt><br/><pre>$ grid-proxy-info <br/>subject  : /DC=org/DC=cilogon/C=US/O=LIGO/CN=Shawn Kwang <a href="mailto:shawn.kwang@ligo.org">shawn.kwang@ligo.org</a><br/>issuer   : /DC=org/DC=cilogon/C=US/O=CILogon/CN=CILogon Basic CA 1<br/>identity : /DC=org/DC=cilogon/C=US/O=LIGO/CN=Shawn Kwang <a href="mailto:shawn.kwang@ligo.org">shawn.kwang@ligo.org</a><br/>type     : end entity credential<br/>strength : 2048 bits<br/>path     : /tmp/x509up_u44001<br/>timeleft : 259:14:41  (10.8 days)</pre><br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:15:22)</span> <b>kwangs:</b></span> Is there something else that would help with answering your question?<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:16:35)</span> <b>kwangs:</b></span> *something* (sorry!)<br/>
<span style="color: #235e5b"><span style="font-size: small">(09:17:48)</span> <b>dweitzel:</b></span> ok, I can confirm that your DN is being picked up and you are on the whitelist.<br/>
<span style="color: #235e5b"><span style="font-size: small">(09:18:34)</span> <b>dweitzel:</b></span> do you have root on the machine you are trying to access that file?  I'm curious about any CVMFS log lines in /var/log/messages<br/>
<span style="color: #235e5b"><span style="font-size: small">(09:19:02)</span> <b>dweitzel:</b></span> Also, I apologize if this debugging might get long, lots of moving pieces, caches, origins, the clients...<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:19:14)</span> <b>kwangs:</b></span> I'll copy and paste the messages. But right before, I'll say I this is a NEMO cluster compute node. It has an 'internal' IP address (172.20.1.117)<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:19:37)</span> <b>kwangs:</b></span> I can successfully access the file from another computer, the submit node which as an external IP address (129.89.61.20).<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:20:03)</span> <b>kwangs:</b></span> I suspect (speculate) the problem may be in our UWM networking. But I'd like a way to check if that is the case.<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:20:07)</span> <b>kwangs:</b></span> Anyway, here is the log message<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:20:16)</span> <b>kwangs:</b></span> <pre>Mar  4 09:05:21 execute3074 cvmfs2: (<a href="http://ligo.osgstorage.org">ligo.osgstorage.org</a>) unexpected curl error (35) while trying to fetch /frames/O3/hoft_C01_clean_sub60Hz/H1/H-H1_HOFT_CLEAN_SUB60HZ_C01-12424/H-H1_HOFT_CLEAN_SUB60HZ_C01-1242439680-4096.gwf<br/>Mar  4 09:05:21 execute3074 cvmfs2: (<a href="http://ligo.osgstorage.org">ligo.osgstorage.org</a>) failed to fetch Part of /frames/O3/hoft_C01_clean_sub60Hz/H1/H-H1_HOFT_CLEAN_SUB60HZ_C01-12424/H-H1_HOFT_CLEAN_SUB60HZ_C01-1242439680-4096.gwf (hash: ef1d139a02503d76e025f147f4a6ef1c630470ff, error 12 [unknown network error])<br/>Mar  4 09:05:21 execute3074 cvmfs2: (<a href="http://ligo.osgstorage.org">ligo.osgstorage.org</a>) unexpected curl error (35) while trying to fetch /frames/O3/hoft_C01_clean_sub60Hz/H1/H-H1_HOFT_CLEAN_SUB60HZ_C01-12424/H-H1_HOFT_CLEAN_SUB60HZ_C01-1242439680-4096.gwf<br/>Mar  4 09:05:21 execute3074 cvmfs2: (<a href="http://ligo.osgstorage.org">ligo.osgstorage.org</a>) failed to fetch Part of /frames/O3/hoft_C01_clean_sub60Hz/H1/H-H1_HOFT_CLEAN_SUB60HZ_C01-12424/H-H1_HOFT_CLEAN_SUB60HZ_C01-1242439680-4096.gwf (hash: ef1d139a02503d76e025f147f4a6ef1c630470ff, error 12 [unknown network error])</pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(09:21:24)</span> <b>dweitzel:</b></span> ok, curl error 35 is an SSL handshake error.<br/>
<span style="color: #235e5b"><span style="font-size: small">(09:21:53)</span> <b>dweitzel:</b></span> which doesn't narrow it down much since authentication and authorization is done at the SSL level.<br/>
<span style="color: #235e5b"><span style="font-size: small">(09:22:24)</span> <b>dweitzel:</b></span> since it's only 1 node, is it possible that the CRL's are out of date on that node?<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:23:11)</span> <b>kwangs:</b></span> Maybe, it's actually all NEMO cluster nodes that have this problem, and only the submit host can access the files.<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:23:31)</span> <b>kwangs:</b></span> But is there a way to check the certs? Maybe I need to update an osg-ca-certs package?<br/>
<span style="color: #235e5b"><span style="font-size: small">(09:23:36)</span> <b>dweitzel:</b></span> that's interesting.<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:24:01)</span> <b>kwangs:</b></span> BTW - yum reports <tt>osg-ca-certs.noarch  1.84-1.osg35.el7</tt><br/>
<span style="color: #235e5b"><span style="font-size: small">(09:24:04)</span> <b>dweitzel:</b></span> you can try updating the osg-ca-certs, but I don't think there has been any relevant changes for a while.<br/>
<span style="color: #235e5b"><span style="font-size: small">(09:25:18)</span> <b>dweitzel:</b></span> those ca certs are a little old, last sept., but that isn't too bad.<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:26:00)</span> <b>kwangs:</b></span> I'll still give it an update with yum.<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:27:02)</span> <b>kwangs:</b></span> After updating, I still get the same error message<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:27:51)</span> <b>kwangs:</b></span> I had the impression (correct me if I'm wrong) that CVMFS is using curl to download the file stored at UNL. Is it possible to give me a URL I can try manually with <tt>curl URL-of-file</tt>?<br/>
<span style="color: #235e5b"><span style="font-size: small">(09:36:10)</span> <b>dweitzel:</b></span> hopefully it is attempting to pull the files from a nearby cache.  Chicago or Madison in your case.<br/>
<span style="color: #235e5b"><span style="font-size: small">(09:36:29)</span> <b>dweitzel:</b></span> The difficult part of the curl'ing is getting the command line arguments right.  All the client cert auth required.<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:37:48)</span> <b>kwangs:</b></span> Good point.<br/>
<span style="color: #235e5b"><span style="font-size: small">(09:40:20)</span> <b>dweitzel:</b></span> the URL will be something like:<br/><pre><a href="https://osg-chicago-stashcache.nrp.internet2.edu:8444//user/ligo/frames/O3/hoft_C01_clean_sub60Hz/H1/H-H1_HOFT_CLEAN_SUB60HZ_C01-12424/H-H1_HOFT_CLEAN_SUB60HZ_C01-1242439680-4096.gwf">https://osg-chicago-stashcache.nrp.internet2.edu:8444//user/ligo/frames/O3/hoft_C01_clean_sub60Hz/H1/H-H1_HOFT_CLEAN_SUB60HZ_C01-12424/H-H1_HOFT_CLEAN_SUB60HZ_C01-1242439680-4096.gwf</a></pre><br/>
<span style="color: #235e5b"><span style="font-size: small">(09:40:27)</span> <b>dweitzel:</b></span> Still working on the curl command line options.<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:43:00)</span> <b>kwangs:</b></span> I just heard from our networking engineers, I think there is a UWM firewall policy that blocked the connection.<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:43:43)</span> <b>kwangs:</b></span> Thus if you have something better to do, I would wait until they try change our firewall, before you spend more time troubleshooting this.<br/>
<span style="color: #e06b56"><span style="font-size: small">(09:44:25)</span> <b>jthiltges:</b></span> To confirm that the InCommon IGTF CRL is valid:<br/><pre>$ openssl crl -in /etc/grid-security/certificates/ba240aa8.r0 -noout -lastupdate -nextupdate<br/>lastUpdate=Mar  3 15:03:19 2020 GMT<br/>nextUpdate=Mar  7 15:03:19 2020 GMT</pre><br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:45:42)</span> <b>kwangs:</b></span> I don't have file <tt>/etc/grid-security/certificates/ba240aa8.r0</tt>  on this node. I do have file <tt>/etc/grid-security/certificates/ba240aa8.0</tt>, but that's an x509 cert.<br/>
<span style="color: #e06b56"><span style="font-size: small">(09:46:46)</span> <b>jthiltges:</b></span> Hmm. How about <tt>f5f0dfc2.r0</tt> ?  (That's from -subject_hash_old, rather than -subject_hash).<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:47:32)</span> <b>kwangs:</b></span> This file does not exist either <tt>/etc/grid-security/certificates/f5f0dfc2.r0</tt><br/>
<span style="color: #e06b56"><span style="font-size: small">(09:50:06)</span> <b>jthiltges:</b></span> Hmm. If the CRL files exist on the submit host (which works?) and are missing from the worker nodes (which don't work), try running fetch-crl to update the CRL files.<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:50:58)</span> <b>kwangs:</b></span> I checkd, these two files do not exist on the submit host either.<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:51:09)</span> <b>kwangs:</b></span> Is there a osg repo package they belong inside?<br/>
<span style="color: #e06b56"><span style="font-size: small">(09:54:36)</span> <b>jthiltges:</b></span> CRL files have such a short lifetime (often just a couple days) that they're updated separately by the fetch-crl utility.<br/>Notes here: https://opensciencegrid.org/docs/common/ca/#managing-certificate-revocation-lists<br/>In general, it's a good idea to keep them updated for security reasons. If transfers are working on the submit host without CRL files, it may be a separate issue. ¯\_(ツ)_/¯<br/>
<span style="color: #43761b"><span style="font-size: small">(09:55:02)</span> <b>blin:</b></span> you should enable the <tt>fetch-crl-cron</tt> service just to make sure the CRLs are consistently up-to-date<br/>
<span style="color: #bb86b7"><span style="font-size: small">(09:55:03)</span> <b>kwangs:</b></span> Thanks, I'll certainly read the docs you sent me<br/>
<span style="color: #43761b"><span style="font-size: small">(09:56:03)</span> <b>blin:</b></span> ah, it's in the flocking doc but it's not rendered properly :disappointed: <a href="https://opensciencegrid.org/docs/submit/osg-flock/#managing-services">https://opensciencegrid.org/docs/submit/osg-flock/#managing-services</a><br/>
<span style="color: #43761b"><span style="font-size: small">(09:56:07)</span> <b>blin:</b></span> we'll fix that up<br/>
</body>
</html>
