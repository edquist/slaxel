<!DOCTYPE html>
<html>
<head>
<title>Thu Nov 12, 2020 : #software (osg)</title>
</head>
<body>
<h3>Thu Nov 12, 2020 : #software (osg)</h3>
<span style="color: #e06b56"><span style="font-size: small">(12:12:38)</span> <b>jthiltges:</b></span> Regarding xrootd v5 with HDFS at CMS sites:<br/>After we upgraded Nebraska SEs to xrootd v5, we started seeing SAM test issues. The <tt>org.cms.WN-mc-/cms/Role=lcgadmin</tt> test (occasionally?) gets an unknown status due to a timeout.<br/><br/>Example command that was timing out:<br/><pre>/usr/bin/python2.6 /cvmfs/oasis.opensciencegrid.org/mis/osg-wn-client/3.4/3.4.56/el6-x86_64/usr/bin/gfal-copy -t 2400 -T 2400 -p -K adler32 file:///srv/cms-MC-test/TEST-FILE <a href="davs://xrootd-local.unl.edu:1094/store/unmerged/SAM/StageOutTest-IB-69-Tue-Nov-10-22_20_49-2020">davs://xrootd-local.unl.edu:1094/store/unmerged/SAM/StageOutTest-IB-69-Tue-Nov-10-22_20_49-2020</a></pre><br/>xrootd.log shows errors where it's trying to access the checksum file by the LFN, rather than the PFN, and it's unable to find the checksum file.<br/><br/><pre>RemoteException: File does not exist: /cksums/store/unmerged/SAM/StageOutTest-B9-69-Wed-Nov--4-09_51_23-2020</pre><br/>:warning: Guesswork from here on!<br/><br/>I think this was the xrootd commit that changed behavior: <a href="https://github.com/xrootd/xrootd/commit/b3625f9d67">https://github.com/xrootd/xrootd/commit/b3625f9d67</a><br/><br/>In v4, <tt>XrdOfs::chksum</tt> converted LFN to PFN before handing over to <tt>XrdHdfs::ChecksumManager::Get</tt><br/>In v5, the default changed and conversion is no longer done. Seems previous behavior can be restored with an undocumented flag:<br/><br/><pre>-ofs.osslib /usr/lib64/libXrdHdfs.so<br/>+ofs.osslib +mmapio /usr/lib64/libXrdHdfs.so</pre><br/>This might be something best solved with changes to xrootd-hdfs. Not yet sure. I'm testing the config change now. :crossed_fingers:<br/>
<blockquote>
<span style="color: #e06b56"><span style="font-size: small">(14:00:19)</span> <b>jthiltges:</b></span> Doh. The config change above causes cmsd to fail.<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(19:46:59)</span> <b>didavila:</b></span> Hey John sorry to jump on this train until now but I just execute (not exactly the same) but a very similar command and it worked just fine<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(19:47:41)</span> <b>didavila:</b></span> <pre>[1747] ddavila@uaf-1 ~$ gfal-copy  -t 2400 -T 2400 -p -K adler32 file:///tmp/hello-v5 <a href="davs://gftp-1.t2.ucsd.edu:1094/store/user/ddavila/new_dir-004/hello-v5">davs://gftp-1.t2.ucsd.edu:1094/store/user/ddavila/new_dir-004/hello-v5</a><br/>Copying file:///tmp/hello-v5   [DONE]  after 1s    </pre><br/>
<span style="color: #a2a5dc"><span style="font-size: small">(19:49:33)</span> <b>didavila:</b></span> this is what I see in the logs wrt the checksum:<br/><pre>File we will access: /cksums//store/user/ddavila/new_dir-004/hello-v5<br/>Readahead buffer stats for /cksums//store/user/ddavila/new_dir-004/hello-v5 : 0 misses, 0 hits, 0 partial hits, 0 unbuffered, 0 buffered bytes used of 0 read (0.00%)</pre><br/>
<span style="color: #e06b56"><span style="font-size: small">(20:51:14)</span> <b>jthiltges:</b></span> If you look at your HDFS by chance, do you see the checksum for that file in<br/><pre>/cksums/store/user/ddavila/new_dir-004/hello-v5</pre><br/>rather than<br/><pre>/cksums/hadoop/cms/store/user/ddavila/new_dir-004/hello-v5</pre><br/>(guessing from the storage.xml)<br/>
<span style="color: #e06b56"><span style="font-size: small">(20:53:13)</span> <b>jthiltges:</b></span> The SAM failures have been intermittent, and I'm not yet sure why. :disappointed:<br/>
<span style="color: #e06b56"><span style="font-size: small">(21:04:55)</span> <b>jthiltges:</b></span> I'd be curious if you see errors like this in your xrootd.log<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(2020-11-13 13:48:00)</span> <b>didavila:</b></span> Actually the checksum gets written here: /hadoop/cksums/cms/store/user/ddavila/new_dir-004/hello-v5<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(2020-11-13 13:48:05)</span> <b>didavila:</b></span> as expected<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(2020-11-13 13:48:24)</span> <b>didavila:</b></span> I do see the error that you mentioned:<br/><pre>No lfn2pfn mapping for /cksums//store/unmerged/RunIISummer20UL16RECO/WplusJetsToTauNu_TauToMu_TuneCP5_13TeV-powhegMiNNLO-pythia8-photos/AODSIM/106X_mcRun2_asymptotic_v13-v2/00021/D9F23DC6-187B-CB45-8C2F-E10C3D4AE332.root<br/>File we will access: /cksums//store/unmerged/RunIISummer20UL16RECO/WplusJetsToTauNu_TauToMu_TuneCP5_13TeV-powhegMiNNLO-pythia8-photos/AODSIM/106X_mcRun2_asymptotic_v13-v2/00021/D9F23DC6-187B-CB45-8C2F-E10C3D4AE332.root</pre><br/>
<span style="color: #a2a5dc"><span style="font-size: small">(2020-11-13 13:49:01)</span> <b>didavila:</b></span> but I remember seeing this before. I think that’s normal. I believe there is a HEAD operation to see if the file exists before creating it<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(2020-11-13 14:07:44)</span> <b>didavila:</b></span> wait what I said before makes no sense I was thinking of a different issue<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(2020-11-13 14:09:41)</span> <b>didavila:</b></span> and I do see an issue like the one you mentioned. In the node where we have xrootd-5 I see the checksums being written to 2 different places:<br/>1. No lfn2pfn mapping for /cksums//cms/phedex/store/unmerged/logs/prod<br/>2. No lfn2pfn mapping for /cksums//store/unmerged/logs/prod/<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(2020-11-13 14:10:02)</span> <b>didavila:</b></span> looks like randomly I get one path or the other<br/>
<span style="color: #e06b56"><span style="font-size: small">(2020-11-16 10:11:59)</span> <b>jthiltges:</b></span> I'm trying out an xrootd-hdfs patch at Nebraska, converting LFN to PFN before generating the checksum file path: <a href="https://github.com/opensciencegrid/xrootd-hdfs/compare/master...jthiltges:xrd5pfn">https://github.com/opensciencegrid/xrootd-hdfs/compare/master...jthiltges:xrd5pfn</a><br/>
<span style="color: #e06b56"><span style="font-size: small">(2020-11-16 12:24:48)</span> <b>jthiltges:</b></span> Opened a software ticket to track things: <a href="https://opensciencegrid.atlassian.net/browse/SOFTWARE-4363">https://opensciencegrid.atlassian.net/browse/SOFTWARE-4363</a><br/>
<span style="color: #a2a5dc"><span style="font-size: small">(2020-11-16 12:31:47)</span> <b>didavila:</b></span> ok, let’s continue the discussion over there<br/>
<span style="color: #e06b56"><span style="font-size: small">(2020-11-17 11:24:50)</span> <b>jthiltges:</b></span> I gave up on untangling the spaghetti and emailed the xrootd list. My patch seems to _work_, but it's not the right direction.<br/>
</blockquote>
<span style="color: #a63024"><span style="font-size: small">(12:24:53)</span> <b>paschos:</b></span> @dwd cvmfs crashed again on scott (spt) despite adjusting CVMFS_NFILES… we will generate a cvmfs bugreport<br/>
</body>
</html>
