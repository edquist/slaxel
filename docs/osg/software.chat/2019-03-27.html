<!DOCTYPE html>
<html>
<head>
<title>Wed Mar 27, 2019 : #software (osg)</title>
</head>
<body>
<h3>Wed Mar 27, 2019 : #software (osg)</h3>
<span style="color: #9e3997"><span style="font-size: small">(09:23:17)</span> <b>bbockelm:</b></span> anyone <b>@here</b> who wants to build RC2?<br/>
<span style="color: #c386df"><span style="font-size: small">(09:29:41)</span> <b>matyas:</b></span> yoink<br/>
<span style="color: #c386df"><span style="font-size: small">(11:47:47)</span> <b>matyas:</b></span> built; tests kicked off<br/>
<span style="color: #c386df"><span style="font-size: small">(15:42:29)</span> <b>matyas:</b></span> I can't test this by hand right now (can't log in to Fermicloud VMs for some reason) but the VMU StashCache tests detected an error on RC2: fetching from the cache via HTTP now prepends a newline (<tt>\r\n</tt>) to the result.<br/>
<span style="color: #53b759"><span style="font-size: small">(15:44:43)</span> <b>marian:</b></span> note: soon enough RC3! (<a href="https://github.com/xrootd/xrootd/issues/937#issuecomment-477331296">https://github.com/xrootd/xrootd/issues/937#issuecomment-477331296</a>)<br/>
<span style="color: #43761b"><span style="font-size: small">(15:47:30)</span> <b>blin:</b></span> yeah @matyas let's submit an issue<br/>
<span style="color: #e06b56"><span style="font-size: small">(16:54:30)</span> <b>jthiltges:</b></span> @matyas I was able to reproduce that issue: 0x0d 0x0a prepended to the expected HTTP contents. I'd fortunately only upgraded one server. :slightly_smiling_face:  Thanks for mentioning it here.<br/>
<span style="color: #c386df"><span style="font-size: small">(16:55:04)</span> <b>matyas:</b></span> great! it also chopped off the ending newline for me<br/>
<span style="color: #9e3997"><span style="font-size: small">(16:55:17)</span> <b>bbockelm:</b></span> :confused: ok, I can reproduce that too.  Working on it.<br/>
<span style="color: #9e3997"><span style="font-size: small">(16:56:22)</span> <b>bbockelm:</b></span> OTOH, it does work better than the wireless in this building....<br/>
<span style="color: #e06b56"><span style="font-size: small">(16:56:34)</span> <b>jthiltges:</b></span> Ah, you're right!<br/><br/>xrootd-4.9.1-0.2.rc2.osg34.el7.x86_64<br/><pre>$ curl -s -k -E /tmp/cert.pem '<a href="https://red-gridftp7.unl.edu:1094/store/hello_world.txt">https://red-gridftp7.unl.edu:1094/store/hello_world.txt</a>' | hexdump -C<br/>00000000  0d 0a 68 65 6c 6c 6f 20  77 6f 72 6c 64           |..hello world|<br/>0000000d</pre><br/><br/>xrootd-4.9.1-0.1.rc1.osg34.el7.x86_64<br/><pre>$ curl -s -k -E /tmp/cert.pem '<a href="https://red-gridftp7.unl.edu:1094/store/hello_world.txt">https://red-gridftp7.unl.edu:1094/store/hello_world.txt</a>' | hexdump -C<br/>00000000  68 65 6c 6c 6f 20 77 6f  72 6c 64 21 0a           |hello world!.|<br/>0000000d</pre><br/>
<span style="color: #c386df"><span style="font-size: small">(16:57:05)</span> <b>matyas:</b></span> we'll rename WID IT the "wireless facilitation team" :stuck_out_tongue:<br/>
<span style="color: #c386df"><span style="font-size: small">(16:57:57)</span> <b>matyas:</b></span> last character, not ending newline<br/>
<span style="color: #9e3997"><span style="font-size: small">(16:57:58)</span> <b>bbockelm:</b></span> bisecting...<br/>
<span style="color: #43761b"><span style="font-size: small">(16:58:54)</span> <b>blin:</b></span> @ivukotic ^^ just in case you were thinking about bravely updating to 4.9.1 rc2<br/>
<span style="color: #9e3997"><span style="font-size: small">(16:59:15)</span> <b>bbockelm:</b></span> <tt>recvfrom(3, "HTTP/1.1 200 OK\r\nConnection: Keep-Alive\r\nContent-Length: 12\r\n\r\n\r\n", 16384, 0, NULL, NULL) = 65</tt><br/>
<span style="color: #9e3997"><span style="font-size: small">(17:00:25)</span> <b>bbockelm:</b></span> <tt>curl -v -H 'Want-Digest: adler32' <a href="http://hcc-briantest7.unl.edu:8000/tmp/xrootd/foo">http://hcc-briantest7.unl.edu:8000/tmp/xrootd/foo</a></tt> works.<br/>
<span style="color: #e06b56"><span style="font-size: small">(17:03:37)</span> <b>jthiltges:</b></span> <pre>-                prot-&gt;SendSimpleResp(200, NULL, NULL, NULL, filesize, keepalive);<br/>+                prot-&gt;SendSimpleResp(200, NULL, m_digest_header.c_str(), NULL, filesize, keepalive);</pre><br/>?<br/>The change prints the blank m_digest_header?<br/>
<span style="color: #9e3997"><span style="font-size: small">(17:04:43)</span> <b>bbockelm:</b></span> yeah, I was arriving at a similar conclusion.<br/>
<span style="color: #9e3997"><span style="font-size: small">(17:05:01)</span> <b>bbockelm:</b></span> <pre><br/>diff --git a/src/XrdHttp/XrdHttpReq.cc b/src/XrdHttp/XrdHttpReq.cc<br/>index 3aafc29..6c527fc 100644<br/>--- a/src/XrdHttp/XrdHttpReq.cc<br/>+++ b/src/XrdHttp/XrdHttpReq.cc<br/>@@ -2098,7 +2098,7 @@ int XrdHttpReq::PostProcessHTTPReq(bool final_) {<br/>               if (rwOps.size() == 0) {<br/>                 // Full file.<br/>                 <br/>-                prot-&gt;SendSimpleResp(200, NULL, m_digest_header.c_str(), NULL, filesize, keepalive);<br/>+                prot-&gt;SendSimpleResp(200, NULL, m_digest_header.empty() ? NULL : m_digest_header.c_str(), NULL, filesize, keepalive);<br/>                 return 0;<br/>               } else<br/>                 if (rwOps.size() == 1) {<br/></pre><br/>
<span style="color: #9e3997"><span style="font-size: small">(17:05:42)</span> <b>bbockelm:</b></span> Ok, I've gotta run home - @jthiltges, can you submit the above as a PR?<br/>
<span style="color: #e06b56"><span style="font-size: small">(17:05:59)</span> <b>jthiltges:</b></span> Sure.<br/>
<span style="color: #9e3997"><span style="font-size: small">(17:06:12)</span> <b>bbockelm:</b></span> with that, Matyas' reproducer appears to work.<br/>
<span style="color: #9e3997"><span style="font-size: small">(17:06:32)</span> <b>bbockelm:</b></span> :slightly_smiling_face: and if we get the PR in now and beat Matevz, we at least won't be the last people to cause a new RC!<br/>
<span style="color: #e06b56"><span style="font-size: small">(17:09:17)</span> <b>jthiltges:</b></span> Would something like this be a better option?<br/><pre>diff --git a/src/XrdHttp/XrdHttpProtocol.cc b/src/XrdHttp/XrdHttpProtocol.cc<br/>index 0445f99a..26b0f78b 100644<br/>--- a/src/XrdHttp/XrdHttpProtocol.cc<br/>+++ b/src/XrdHttp/XrdHttpProtocol.cc<br/>@@ -1428,7 +1428,7 @@ int XrdHttpProtocol::StartSimpleResp(int code, const char *desc, const char *hea<br/> <br/>   if (bodylen &gt;= 0) ss &lt;&lt; "Content-Length: " &lt;&lt; bodylen &lt;&lt; crlf;<br/> <br/>-  if (header_to_add)<br/>+  if (header_to_add &amp;&amp; strlen(header_to_add))<br/>     ss &lt;&lt; header_to_add &lt;&lt; crlf;<br/> <br/>   ss &lt;&lt; crlf;<br/>@@ -1445,7 +1445,7 @@ int XrdHttpProtocol::StartChunkedResp(int code, const char *desc, const char *he<br/>   const std::string crlf = "\r\n";<br/> <br/>   std::stringstream ss;<br/>-  if (header_to_add) {<br/>+  if (header_to_add &amp;&amp; strlen(header_to_add)) {<br/>     ss &lt;&lt; header_to_add &lt;&lt; crlf;<br/>   }<br/>   ss &lt;&lt; "Transfer-Encoding: chunked";</pre><br/>
<span style="color: #9e3997"><span style="font-size: small">(17:10:16)</span> <b>bbockelm:</b></span> Letâ€™s do the simpler fix now.<br/>
<span style="color: #e06b56"><span style="font-size: small">(17:10:22)</span> <b>jthiltges:</b></span> :+1:<br/>
<span style="color: #9e3997"><span style="font-size: small">(17:11:50)</span> <b>bbockelm:</b></span> (The strlen call could be costly - you really just need to check if it is empty.)<br/>
<span style="color: #e06b56"><span style="font-size: small">(17:28:10)</span> <b>jthiltges:</b></span> <a href="https://github.com/xrootd/xrootd/pull/949">https://github.com/xrootd/xrootd/pull/949</a><br/>
</body>
</html>
