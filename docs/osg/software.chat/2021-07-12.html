<!DOCTYPE html>
<html>
<head>
<title>Mon Jul 12, 2021 : #software (osg)</title>
</head>
<body>
<h3>Mon Jul 12, 2021 : #software (osg)</h3>
<span style="color: #9f69e7"><span style="font-size: small">(08:20:52)</span> <b>mtwest2718:</b></span> Do the OSG's Hosted-CEs support 2FA with ssh login? I found <a href="https://indico.cern.ch/event/651349/contributions/2830254/attachments/1580439/2497221/XSEDE2FA.pdf">this</a> OSG talk by Edgar Fajardo from 2018 but nothing else in later documents.<br/>
<span style="color: #43761b"><span style="font-size: small">(08:26:33)</span> <b>blin:</b></span> it depends on the flexibility of the site's 2FA policy: pilot submission through a CE is automated based on user job pressure so putting a human in the middle to click approve doesn't really work<br/>
<span style="color: #43761b"><span style="font-size: small">(08:27:12)</span> <b>blin:</b></span> However, we have some 2FA sites that consider private key SSH from a known IP/IP range sufficient for their 2FA policy<br/>
<span style="color: #9f69e7"><span style="font-size: small">(08:56:55)</span> <b>mtwest2718:</b></span> Given that more sites are including 2FA in their login, is there a standard protocol or software suite that would make things easier in connecting a new cluster up to the OSG?<br/>
<span style="color: #43761b"><span style="font-size: small">(09:01:23)</span> <b>blin:</b></span> i think it's called the Simpsons protocol <a href="https://media.giphy.com/media/l41lUJ1YoZB1lHVPG/giphy.gif">https://media.giphy.com/media/l41lUJ1YoZB1lHVPG/giphy.gif</a><br/>
<span style="color: #43761b"><span style="font-size: small">(09:02:20)</span> <b>blin:</b></span> but seriously, a key part to 2FA is the human interaction, at least to most policies, and I think that's a fundamental issue for Hosted CEs<br/>
<span style="color: #9f69e7"><span style="font-size: small">(09:10:38)</span> <b>mtwest2718:</b></span> What I take away from that is that when setting up a new HTC cluster, one must keep in mind the potential issues with connecting it to the OSG/EGI and work with those orgs to mitigate any impedance mismatches.<br/>
<span style="color: #43761b"><span style="font-size: small">(09:14:30)</span> <b>blin:</b></span> Yeah, particularly if they're counting on an OSG Hosted CE (I don't think EGI has an equivalent?) since that will submit jobs to the site's access point over SSH<br/>
<span style="color: #43761b"><span style="font-size: small">(09:14:56)</span> <b>blin:</b></span> it's possible to work around 2FA altogether if the site runs their own CE since SSH wouldn't be involved<br/>
<span style="color: #99a949"><span style="font-size: small">(13:08:29)</span> <b>dwd:</b></span> @blin Isn’t there supposed to be a CE-Token hackathon now?  I am the only one connected<br/>
<span style="color: #99a949"><span style="font-size: small">(13:10:16)</span> <b>dwd:</b></span> No I clicked the Google meet link but there’s also a zoom link, with no passcode?<br/>
<blockquote>
<span style="color: #43761b"><span style="font-size: small">(13:19:05)</span> <b>blin:</b></span> ah, i think the calendar's public so i didn't want to include the connection details<br/>
</blockquote>
<span style="color: #99a949"><span style="font-size: small">(13:13:15)</span> <b>dwd:</b></span> Oh the problems were only in the calendar invite.  Now I found the original email invite with full zoom url<br/>
<span style="color: #674b1b"><span style="font-size: small">(13:18:41)</span> <b>rynge:</b></span> <pre>07/12/21 10:42:41 (cid:75) (D_AUDIT) Examining SciToken with payload {"sub":"vofrontend-IIT","iss":"<a href="https://chtc.cs.wisc.edu">https://chtc.cs.wisc.edu</a>","wlcg.ver":"1.0","jti":"02816b85-4526-4685-a8f6-c057d42f0efa","exp":1626112900,"iat":1626109300,"scope":"compute.read compute.modify compute.create","nbf":1626109300,"aud":"<a href="http://iitce1.iit.edu:9619">iitce1.iit.edu:9619</a>"}.</pre><br/><br/>
<span style="color: #e96699"><span style="font-size: small">(13:36:00)</span> <b>lincoln:</b></span> @blin I _think_ my CE is up at <a href="http://osg-gk.mwt2.org">osg-gk.mwt2.org</a>:9619<br/>
<blockquote>
<span style="color: #43761b"><span style="font-size: small">(13:40:49)</span> <b>blin:</b></span> one sec, generating the token<br/>
<span style="color: #43761b"><span style="font-size: small">(13:41:09)</span> <b>blin:</b></span> did you do this from the zoom chat?<br/><pre>add this line to /etc/condor-ce/mapfiles.d/10-scitokens.conf, replacing &lt;LOCAL USER&gt;:<br/><br/>SCITOKENS /^https:\/\/wlcg\.cloud\.cnaf\.infn\.it\/,/ &lt;LOCAL USER&gt; </pre><br/>
<span style="color: #e96699"><span style="font-size: small">(13:46:46)</span> <b>lincoln:</b></span> No, I will<br/>
<span style="color: #e96699"><span style="font-size: small">(13:47:29)</span> <b>lincoln:</b></span> can i map you to the <tt>osg</tt>  user ?<br/>
<span style="color: #e96699"><span style="font-size: small">(13:48:27)</span> <b>lincoln:</b></span> if so, then done.<br/>
<span style="color: #43761b"><span style="font-size: small">(13:53:58)</span> <b>blin:</b></span> <tt>/etc/pki/tls/certs/localhost.crt</tt><br/>
<span style="color: #43761b"><span style="font-size: small">(13:54:23)</span> <b>blin:</b></span> also<br/><pre>/etc/pki/tls/private/localhost.key</pre><br/>
</blockquote>
<span style="color: #674b1b"><span style="font-size: small">(13:40:00)</span> <b>rynge:</b></span> <pre>07/12/21 10:42:05 (cid:28) (D_AUDIT) Examining SciToken with payload {"scope":"condor:/WRITE condor:/READ","sub":"Token","aud":"ANY","ver":"scitokens:2.0","iss":"<a href="https://scitokens.org/osg-connect">https://scitokens.org/osg-connect</a>","exp":1626114002,"iat":1626110402,"nbf":1626110402,"jti":"e0637e27-d11a-45b7-b5a9-80e61b71f745"}.</pre><br/><br/>
<span style="color: #9e3997"><span style="font-size: small">(14:07:09)</span> <b>bbockelm:</b></span> @blin - if you get the chance, what's the token auth fallback ticket?<br/>
<span style="color: #674b1b"><span style="font-size: small">(14:29:15)</span> <b>rynge:</b></span> @bbockelm sub looks correct now, but auth still fails<br/>
<span style="color: #674b1b"><span style="font-size: small">(14:29:19)</span> <b>rynge:</b></span> <pre>07/12/21 12:28:17 (cid:3011) (D_AUDIT) Examining SciToken with payload {"sub":"vofrontend-OSG_US_ISI_osg","iss":"<a href="https://chtc.cs.wisc.edu">https://chtc.cs.wisc.edu</a>","wlcg.ver":"1.0","jti":"2b5c300e-aa5a-4a91-a3a8-5d57cd60ce18","exp":1626120106,"iat":1626116506,"scope":"compute.read compute.modify compute.create","nbf":1626116506,"aud":"<a href="http://osg.isi.edu:9619">osg.isi.edu:9619</a>"}.<br/>07/12/21 12:28:17 (cid:3011) (D_AUDIT) Command=QMGMT_WRITE_CMD, peer=&lt;169.228.38.36:26738&gt;<br/>07/12/21 12:28:17 (cid:3011) (D_AUDIT) AuthMethod=SCITOKENS, AuthId=<a href="https://chtc.cs.wisc.edu">https://chtc.cs.wisc.edu</a>,vofrontend-OSG_US_ISI_osg, CondorId=glow@users.htcondor.org<br/>07/12/21 12:28:17 (cid:3011) (D_AUDIT) Authorization Denied</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(14:29:59)</span> <b>rynge:</b></span> <pre><br/>SCITOKENS /^https:\/\/scitokens.org\/osg-connect,.*/ osg<br/>SCITOKENS /^https:\/\/chtc.cs.wisc.edu,.*/ glow<br/>SSL /\/CN=([-.A-Za-z0-9\/= ]+)/ \1@unmapped.htcondor.org<br/>CLAIMTOBE /.*/ anonymous@claimtobe<br/>FS /^(root|condor)$/ \1@daemon.htcondor.org<br/>FS /(.*)/ \1</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(14:34:18)</span> <b>rynge:</b></span> Hmm, getting some mixed signals from the logs:<br/>
<span style="color: #674b1b"><span style="font-size: small">(14:34:21)</span> <b>rynge:</b></span> <pre>07/12/21 12:32:18 (D_SECURITY:2) AUTHENTICATION: name to map is '<a href="https://chtc.cs.wisc.edu">https://chtc.cs.wisc.edu</a>,vofrontend-OSG_US_ISI_osg'<br/>07/12/21 12:32:18 (D_SECURITY:2) AUTHENTICATION: pre-map: current user is 'scitokens'<br/>07/12/21 12:32:18 (D_SECURITY:2) AUTHENTICATION: pre-map: current domain is 'unmapped'<br/>07/12/21 12:32:18 (D_SECURITY:2) AUTHENTICATION: map file already loaded.<br/>07/12/21 12:32:18 (D_SECURITY:2) AUTHENTICATION: attempting to map '<a href="https://chtc.cs.wisc.edu">https://chtc.cs.wisc.edu</a>,vofrontend-OSG_US_ISI_osg'<br/>07/12/21 12:32:18 (D_SECURITY:2) AUTHENTICATION: 1: attempting to map '<a href="https://chtc.cs.wisc.edu">https://chtc.cs.wisc.edu</a>,vofrontend-OSG_US_ISI_osg'<br/>07/12/21 12:32:18 (D_SECURITY:2) AUTHENTICATION: 2: mapret: 0 included_voms: 0 canonical_user: glow<br/>07/12/21 12:32:18 (D_ALWAYS:2) AUTHENTICATION: successful mapping to glow<br/>07/12/21 12:32:18 (D_SECURITY:2) AUTHENTICATION: found user glow, splitting.<br/>07/12/21 12:32:18 (D_SECURITY:2) AUTHENTICATION: post-map: current user is 'glow'<br/>07/12/21 12:32:18 (D_SECURITY:2) AUTHENTICATION: post-map: current domain is '<a href="http://users.htcondor.org">users.htcondor.org</a>'<br/>07/12/21 12:32:18 (D_SECURITY) AUTHENTICATION: post-map: current FQU is '<a href="mailto:glow@users.htcondor.org">glow@users.htcondor.org</a>'<br/>07/12/21 12:32:18 (D_SECURITY) AUTHENTICATE: Exchanging keys with remote side.<br/>07/12/21 12:32:18 (D_SECURITY:2) CRYPTO: simple reset m_ivec(len 8) and m_num<br/>07/12/21 12:32:18 (D_SECURITY) AUTHENTICATE: Result of end of authenticate is 1.<br/>07/12/21 12:32:18 (D_SECURITY) DC_AUTHENTICATE: authentication of 169.228.38.36 complete.<br/>07/12/21 12:32:18 (D_SECURITY:2) CRYPTO: protocol(AES), not clearing StreamCryptoState.<br/>07/12/21 12:32:18 (D_SECURITY) DC_AUTHENTICATE: encryption enabled for session osg:1340855:1626118338:1404<br/>07/12/21 12:32:18 (D_SECURITY:2) SECMAN: because protocal is AES, not using other MAC.<br/>07/12/21 12:32:18 (D_SECURITY) DC_AUTHENTICATE: message authenticator enabled with key id osg:1340855:1626118338:1404.<br/>07/12/21 12:32:18 (D_SECURITY) DC_AUTHENTICATE: Success.</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(14:35:33)</span> <b>rynge:</b></span> Ah, here is the problem:<br/>
<span style="color: #674b1b"><span style="font-size: small">(14:35:37)</span> <b>rynge:</b></span> <pre>07/12/21 12:34:44 (D_ALWAYS) DC_AUTHENTICATE: authentication of &lt;169.228.38.36:15552&gt; was successful but resulted in a limited authorization which did not include this command (1112 QMGMT_WRITE_CMD), so aborting.<br/>07/12/21 12:34:44 (D_SECURITY) DC_AUTHENTICATE: sending session ad:<br/>ReturnCode = "DENIED"<br/>Sid = "osg:1340855:1626118484:1425"<br/>TriedAuthentication = true<br/>User = "<a href="mailto:glow@users.htcondor.org">glow@users.htcondor.org</a>"<br/>ValidCommands = "60004,60012,60021,60052,421,478,480,486,488,489,487,499,502,464,1112,481,509,511,521,74000,507,60007,457,60020,443,441,6,12,5,515,516,519,1111,471"</pre><br/><br/>
<span style="color: #9e3997"><span style="font-size: small">(14:38:18)</span> <b>bbockelm:</b></span> ah, interesting.<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:39:16)</span> <b>bbockelm:</b></span> What version of <tt>scitokens-cpp</tt> are you using?<br/>
<span style="color: #674b1b"><span style="font-size: small">(14:41:15)</span> <b>rynge:</b></span> *scitoken*s-cpp-0.6.2-1.osg35.el7.x86_64<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:41:37)</span> <b>bbockelm:</b></span> Hm, that looks recent enough.<br/>
<span style="color: #674b1b"><span style="font-size: small">(14:42:01)</span> <b>rynge:</b></span> it is fully updated osg 3.5<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:43:14)</span> <b>bbockelm:</b></span> Unfortunately, it appears the log line says you don't have the right authorization but doesn't mention which authorization it does think you have!<br/>
<span style="color: #674b1b"><span style="font-size: small">(14:43:33)</span> <b>rynge:</b></span> <tt>1112 QMGMT_WRITE_CMD</tt><br/>
<span style="color: #674b1b"><span style="font-size: small">(14:43:37)</span> <b>rynge:</b></span> No?<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:43:52)</span> <b>bbockelm:</b></span> Ah!  I need <tt>compute.cancel</tt>.<br/>
<span style="color: #235e5b"><span style="font-size: small">(14:45:31)</span> <b>dweitzel:</b></span> are you looking at this line: <a href="https://github.com/scitokens/scitokens-cpp/blob/7d9c77bd0fd238a8db000acd8229616e786ba273/src/scitokens_internal.cpp#L625">https://github.com/scitokens/scitokens-cpp/blob/7d9c77bd0fd238a8db000acd8229616e786ba273/src/scitokens_internal.cpp#L625</a> ?<br/>
<span style="color: #235e5b"><span style="font-size: small">(14:46:15)</span> <b>dweitzel:</b></span> You need to have all 3 to get a "condor:/WRITE" ?<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:46:24)</span> <b>bbockelm:</b></span> Correct<br/>
<span style="color: #235e5b"><span style="font-size: small">(14:46:45)</span> <b>dweitzel:</b></span> I happen to know the maintainer of that library, if there needs to be changes.<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:47:06)</span> <b>bbockelm:</b></span> No, the library is correct and the token is wrong.  Otherwise you can accidentally give a token too many permissions.<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:47:14)</span> <b>bbockelm:</b></span> <a href="https://github.com/opensciencegrid/tiger-osg-config/commit/095851aa4b8c63dd725e98e4c2a128655c526c80">https://github.com/opensciencegrid/tiger-osg-config/commit/095851aa4b8c63dd725e98e4c2a128655c526c80</a><br/>
<span style="color: #9e3997"><span style="font-size: small">(14:47:42)</span> <b>bbockelm:</b></span> (waiting for flux to redeploy<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:56:39)</span> <b>bbockelm:</b></span> The problem is the condor permission system is much more coarse-grained than the WLCG permissions.  Thus, you need all the fine-grained permissions to translate it safely to the coarse permission.<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:20:58)</span> <b>rynge:</b></span> Maybe too late in the hackathon, and we need somebody from the factory side for this, but I re-enabled scitokens for my production entries and auth against my scitoken-only CE is not working<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:21:18)</span> <b>rynge:</b></span> <pre>012 (4504488.004.000) 07/12 14:08:32 Job was held.<br/>    Error connecting to schedd <a href="http://osg.isi.edu">osg.isi.edu</a>: AUTHENTICATE:1003:Failed to authenticate with any method|AUTHENTICATE:1004:Failed to authenticate using FS<br/>    Code 0 Subcode 0</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(16:21:38)</span> <b>rynge:</b></span> It works from ITB, but not production<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:21:58)</span> <b>rynge:</b></span> <tt>entry_OSG_US_ISI_osg</tt><br/>
<span style="color: #43761b"><span style="font-size: small">(16:24:04)</span> <b>blin:</b></span> the prod factory doesn't support token submission, AFAIK<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:26:38)</span> <b>rynge:</b></span> Ok, that makes sense<br/>
<span style="color: #de5f24"><span style="font-size: small">(17:03:28)</span> <b>justas.balcas:</b></span> Hi, do you know if gridftp stores deletion info in the logs?<br/><pre>[root@transfer-9 ~]# cat /var/log/gridftp.log-20210710 | awk '{print $6 " " $15}' | sort | uniq -c<br/>   1318 USER=cmantill TYPE=STOR<br/>    107 USER=cmsprod TYPE=NLST<br/>    830 USER=cmsprod TYPE=RETR<br/>   4320 USER=cmsprod TYPE=STOR<br/>   5756 USER=cmsuser TYPE=RETR<br/>   6067 USER=cmsuser TYPE=STOR</pre><br/>Or is there a knob to enable that?<br/>
<span style="color: #43761b"><span style="font-size: small">(17:12:29)</span> <b>blin:</b></span> unfortunately i don't believe it does<br/>
<blockquote>
<span style="color: #de5f24"><span style="font-size: small">(17:47:01)</span> <b>justas.balcas:</b></span> It is fun how we run it like that for such a long time … :smile:<br/>
</blockquote>
<span style="color: #a72f79"><span style="font-size: small">(17:46:12)</span> <b>andrew.melo:</b></span> Is there a way to take the divisor in a condor submit script? I'd like to have an output file have an output remap with something like output.root -&gt; /1000/output_1234.root<br/>
<span style="color: #a72f79"><span style="font-size: small">(17:46:28)</span> <b>andrew.melo:</b></span> So seomthing like $(ITEM // 1000)?<br/>
<span style="color: #9e3997"><span style="font-size: small">(18:08:18)</span> <b>bbockelm:</b></span> I think you want to take a look at the <tt>quantize</tt> function <br/>
<span style="color: #9e3997"><span style="font-size: small">(18:09:12)</span> <b>bbockelm:</b></span> <tt>quantize(ITEM, 100)</tt> will round up to the nearest multiple of 100.<br/>
<span style="color: #9e3997"><span style="font-size: small">(18:12:21)</span> <b>bbockelm:</b></span> Something like this might do it:<br/><pre>ITEM % 1000 ? quantize(ITEM - 1000, 1000) : ITEM</pre><br/>
<span style="color: #9e3997"><span style="font-size: small">(18:12:36)</span> <b>bbockelm:</b></span> Exercise for user to figure out if it handles values less than 1000 correctly<br/>
<span style="color: #a72f79"><span style="font-size: small">(18:15:58)</span> <b>andrew.melo:</b></span> I basically want to shove something into the output_remap to split all the files in a pleasing way<br/>
</body>
</html>
