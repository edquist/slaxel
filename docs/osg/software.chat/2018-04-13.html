<!DOCTYPE html>
<html>
<head>
<title>Fri Apr 13, 2018 : #software (osg)</title>
</head>
<body>
<h3>Fri Apr 13, 2018 : #software (osg)</h3>
<span style="color: #a72f79"><span style="font-size: small">(11:54:03)</span> <b>andrew.melo:</b></span> I've added a bunch of new drives to existing datanodes, then ran the balancer. It appears, though, that the balancing is going the wrong direction:<br/><pre><br/> grep 'TB' /tmp/hadoop-balance.log <br/>18/04/13 10:47:33 INFO balancer.Balancer: Need to move 2.06 TB to make the cluster balanced.<br/>Apr 13, 2018 11:08:02 AM          0              2.80 GB             2.06 TB              50 GB<br/>18/04/13 11:08:11 INFO balancer.Balancer: Need to move 2.08 TB to make the cluster balanced.<br/>Apr 13, 2018 11:28:38 AM          1              3.96 GB             2.08 TB              50 GB<br/>18/04/13 11:28:47 INFO balancer.Balancer: Need to move 2.08 TB to make the cluster balanced.<br/>Apr 13, 2018 11:49:17 AM          2              6.37 GB             2.08 TB              50 GB<br/>18/04/13 11:49:26 INFO balancer.Balancer: Need to move 2.08 TB to make the cluster balanced.<br/></pre><br/>
<span style="color: #a72f79"><span style="font-size: small">(11:54:23)</span> <b>andrew.melo:</b></span> Is there a way to speed up the migrations?<br/>
<span style="color: #43761b"><span style="font-size: small">(11:55:38)</span> <b>blin:</b></span> @sthapa @gattebury @jthiltges ^^<br/>
<span style="color: #a72f79"><span style="font-size: small">(11:55:47)</span> <b>andrew.melo:</b></span> I guess also, it's not balancing intra-node:<br/><pre><br/>/dev/mapper/vghdfs-disk0       7.3T  3.1T  3.8T  46% /mnt/hdfs-disk0<br/>/dev/mapper/vghdfs-disk2       7.3T  3.2T  3.8T  46% /mnt/hdfs-disk2<br/>/dev/mapper/vghdfs-disk1       7.3T  3.2T  3.8T  46% /mnt/hdfs-disk1<br/>/dev/mapper/vghdfs-disk3       7.3T  329M  6.9T   1% /mnt/hdfs-disk3<br/>/dev/mapper/vghdfs-disk4       7.3T  335M  6.9T   1% /mnt/hdfs-disk4<br/></pre><br/>
<span style="color: #a72f79"><span style="font-size: small">(11:55:52)</span> <b>andrew.melo:</b></span> 3/4 are new disks, but the i/o rate is basically zero for this machine<br/>
<span style="color: #e06b56"><span style="font-size: small">(12:18:04)</span> <b>jthiltges:</b></span> @andrew.melo. We didn't make any changes to our HDFS config with the upgrade to 2.6.<br/>The only tweak related to balancing speed that I see is this: dfs.balance.bandwidthPerSec = 2000000000<br/>There's a new <tt>hdfs diskbalancer</tt> command, but I haven't tried it yet.<br/>
<span style="color: #a72f79"><span style="font-size: small">(13:09:29)</span> <b>andrew.melo:</b></span> Right, but simply cranking that gives: <tt>18/04/13 12:16:38 WARN balancer.Dispatcher: Failed to move blk_1074219632_485619 with size=134217728 from 10.0.14.16:1800:DISK to 10.0.11.56:1800:DISK through 10.0.11.51:1800: Got error, status message Not able to receive block 1074219632 from /10.0.32.126:38478 because threads quota is exceeded., block move is failed</tt><br/>
<span style="color: #a72f79"><span style="font-size: small">(13:09:43)</span> <b>andrew.melo:</b></span> So I figured there was datanode changes you needed make as well<br/>
<span style="color: #43761b"><span style="font-size: small">(13:10:25)</span> <b>blin:</b></span> @andrew.melo i'm curious, what'd you have to change?<br/>
<span style="color: #a72f79"><span style="font-size: small">(13:11:59)</span> <b>andrew.melo:</b></span> My unknowledgeable reading says that there are corresponding changes to the datanodes' <tt>dfs.datanode.balance.max.concurrent.moves</tt><br/>
<span style="color: #a72f79"><span style="font-size: small">(13:12:31)</span> <b>andrew.melo:</b></span> I didn't change it yet, I'm just trying to read docs for the first time, but it appears that you have to both increase the balancing rate, and then also give the datanodes more headroom<br/>
<span style="color: #e06b56"><span style="font-size: small">(13:22:12)</span> <b>jthiltges:</b></span> The dfs.balance.bandwidthPerSec is a datanode (hdfs-site.xml) setting, I think. Or maybe I'm misunderstanding.<br/>I vaguely remember seeing thread errors like that when increasing moverThreads. The changes didn't seem to help balancing speed, and I didn't pursue it further.<br/>
</body>
</html>
