<!DOCTYPE html>
<html>
<head>
<title>Thu Jan 14, 2021 : #software (osg)</title>
</head>
<body>
<h3>Thu Jan 14, 2021 : #software (osg)</h3>
<span style="color: #7d414c"><span style="font-size: small">(10:36:32)</span> <b>bockjoo:</b></span> Requirements = TARGET.RequestGPUs &gt;= 1;<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:36:39)</span> <b>bockjoo:</b></span> Does that mean<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:36:59)</span> <b>bockjoo:</b></span> RequestGPUs = 1 in the condor submission file?<br/>
<span style="color: #a72f79"><span style="font-size: small">(10:38:53)</span> <b>andrew.melo:</b></span> well, &gt;= 1 :slightly_smiling_face:<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:39:56)</span> <b>bockjoo:</b></span> I mean the submission file where it should be a definitive number, 1,2,3,4,... or n.<br/>
<span style="color: #a72f79"><span style="font-size: small">(10:40:16)</span> <b>andrew.melo:</b></span> I think we're saying the same thing<br/>
<span style="color: #a72f79"><span style="font-size: small">(10:40:32)</span> <b>andrew.melo:</b></span> But it's the submission of the pilots that matches there, not the payload jobs inside<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:42:30)</span> <b>bockjoo:</b></span> I am trying to submit a condor-g job. In the condor-g job submit file, RequestGPUs = 1 gives error:<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:42:42)</span> <b>bockjoo:</b></span> WARNING: the line 'RequestGPUs = 1' was unused by condor_submit. Is it a typo?<br/>
<span style="color: #a72f79"><span style="font-size: small">(10:43:36)</span> <b>andrew.melo:</b></span> maybe you need a <tt>+</tt> in the front<br/>
<span style="color: #7d414c"><span style="font-size: small">(10:45:17)</span> <b>bockjoo:</b></span> + works. Thanks!<br/>
<span style="color: #7d414c"><span style="font-size: small">(11:07:18)</span> <b>bockjoo:</b></span> Submission works but RequestGPUs does not appear on /etc/blahp/slurm_local_submit_attributes.sh<br/>
<span style="color: #7d414c"><span style="font-size: small">(11:07:37)</span> <b>bockjoo:</b></span> This is the router for GPUs:<br/>
<span style="color: #7d414c"><span style="font-size: small">(11:07:46)</span> <b>bockjoo:</b></span> [<br/>     GridResource = "batch slurm";<br/>     name = "Slurm_GPU";<br/>     Requirements = TARGET.RequestGPUs &gt;= 1;<br/>     MaxIdleJobs = 120;<br/>     # 48 hrs max walltime<br/>     set_default_maxWallTime = 2880;<br/>   ]<br/>
<span style="color: #43761b"><span style="font-size: small">(11:17:04)</span> <b>blin:</b></span> ah, i forgot one thing. You'll need to add this to your route:<br/><tt>set_default_CERequirements = "RequestGPUs";</tt><br/>
<span style="color: #7d414c"><span style="font-size: small">(11:34:33)</span> <b>bockjoo:</b></span> Hmm, I added that and Slurm_GPU to JOB_ROUTER_ROUTE_NAMES, but it still does not appear on the submit attributes script. I will check more.<br/>
<span style="color: #7d414c"><span style="font-size: small">(12:06:38)</span> <b>bockjoo:</b></span> condor_ce_job_router_info -config does not show the router name Slurm_GPU.<br/>
<span style="color: #43761b"><span style="font-size: small">(12:12:15)</span> <b>blin:</b></span> that likely means a syntax error<br/>
<span style="color: #43761b"><span style="font-size: small">(12:15:18)</span> <b>blin:</b></span> (or maybe somehow it's not in <tt>JOB_ROUTER_ROUTE_NAMES</tt> )<br/>
<span style="color: #7d414c"><span style="font-size: small">(12:21:46)</span> <b>bockjoo:</b></span> [root@cms ~]# condor_ce_config_val JOB_ROUTER_ROUTE_NAMES<br/>SAM_tests Local_Slurm Slurm_GPU<br/>
<span style="color: #7d414c"><span style="font-size: small">(12:33:27)</span> <b>bockjoo:</b></span> Found an offending file /etc/condor-ce/config.d/02-ce-slurm.conf.original<br/>
<span style="color: #7d414c"><span style="font-size: small">(13:01:29)</span> <b>bockjoo:</b></span> After removing the file, I can see all the routes.<br/>
<span style="color: #7d414c"><span style="font-size: small">(13:02:20)</span> <b>bockjoo:</b></span> Also I had to restart the condor-ce to see the new route in /var/log/condor-ce/JobRouterLog<br/>
<span style="color: #7d414c"><span style="font-size: small">(13:06:09)</span> <b>bockjoo:</b></span> But still I do not see RequestGPUs in the submit attributes script. Hmm...<br/>
<span style="color: #43761b"><span style="font-size: small">(13:09:11)</span> <b>blin:</b></span> could you dump the GPU route here?<br/>
<span style="color: #7d414c"><span style="font-size: small">(13:10:10)</span> <b>bockjoo:</b></span> Route 3<br/>Name         : "Slurm_GPU"<br/>Source       : entries:2<br/>Universe     : 9<br/>MaxJobs      : 10000<br/>MaxIdleJobs  : 120<br/>GridResource : batch slurm<br/>Requirements : TARGET.RequestGPUs &gt;= 1<br/>ClassAd      :<br/>    [<br/>        name = "Slurm_GPU";<br/>        set_default_maxWallTime = 2880;<br/>        set_default_CERequirements = "RequestGPUs";<br/>        copy_RequestCpus = "orig_RequestCpus";<br/>        eval_set_remote_queue = ifThenElse(batch_queue isnt undefined,batch_queue,ifThenElse(queue isnt undefined,queue,ifThenElse(default_queue isnt undefined,default_queue,"")));<br/>        set_JobMemory = JobIsRunning ? int(MATCH_EXP_JOB_GLIDEIN_Memory) * 95 / 100 : OriginalMemory;<br/>        set_RequestMemory = ifThenElse(WantWholeNode is true, !isUndefined(TotalMemory) ? TotalMemory * 95 / 100 : JobMemory,OriginalMemory);<br/>        set_JOB_GLIDEIN_Memory = "$$(TotalMemory:0)";<br/>        eval_set_remote_OriginalMemory = ifThenElse(maxMemory isnt undefined,maxMemory,ifThenElse(default_maxMemory isnt undefined,default_maxMemory,2000));<br/>        eval_set_OriginalMemory = ifThenElse(maxMemory isnt undefined,maxMemory,ifThenElse(default_maxMemory isnt undefined,default_maxMemory,2000));<br/>        Requirements = TARGET.RequestGPUs &gt;= 1;<br/>        set_osg_environment = "OSG_GRID='/cvmfs/cms.cern.ch/grid/cvmfs/oasis.opensciencegrid.org/osg-software/osg-wn-client/current/el7-x86_64' OSG_SQUID_LOCATION='squid1-data.ufhpc:3128' OSG_SITE_READ='/osg/data/tmp' OSG_APP='/cmsuf/data/app' OSG_HOSTNAME='<a href="http://cms.rc.ufl.edu">cms.rc.ufl.edu</a>' OSG_DATA='/osg/data' OSG_STORAGE_ELEMENT='True' OSG_SITE_NAME='UFlorida-HPC' OSG_DEFAULT_SE='<a href="http://cmsio.rc.ufl.edu">cmsio.rc.ufl.edu</a>' OSG_SITE_WRITE='/osg/data/tmp' SINGULARITY_BIN='/usr/bin' PATH='/cmsuf/bin:$PATH' X509_CERT_DIR='/cvmfs/cms.cern.ch/grid/etc/grid-security/certificates' SINGULARITY_BINDPATH='/cmsuf'";<br/>        set_requirements = true;<br/>        MaxIdleJobs = 120;<br/>        set_JOB_GLIDEIN_Cpus = "$$(ifThenElse(WantWholeNode is true, !isUndefined(TotalCpus) ? TotalCpus : JobCpus, OriginalCpus))";<br/>        delete_PeriodicRemove = true;<br/>        copy_environment = "orig_environment";<br/>        GridResource = "batch slurm";<br/>        eval_set_remote_SMPGranularity = ifThenElse(xcount isnt undefined,xcount,ifThenElse(default_xcount isnt undefined,default_xcount,1));<br/>        copy_OnExitHoldSubCode = "orig_OnExitHoldSubCode";<br/>        eval_set_remote_NodeNumber = ifThenElse(xcount isnt undefined,xcount,ifThenElse(default_xcount isnt undefined,default_xcount,1));<br/>        set_GlideinCpusIsGood =  !isUndefined(MATCH_EXP_JOB_GLIDEIN_Cpus) &amp;&amp; (int(MATCH_EXP_JOB_GLIDEIN_Cpus) isnt error);<br/>        copy_OnExitHold = "orig_OnExitHold";<br/>        set_CondorCE = 1;<br/>        set_OnExitHoldReason = ifThenElse((orig_OnExitHold isnt undefined) &amp;&amp; orig_OnExitHold,ifThenElse(orig_OnExitHoldReason isnt undefined,orig_OnExitHoldReason,strcat("The on_exit_hold expression (",unparse(orig_OnExitHold),") evaluated to TRUE.")),ifThenElse(minWalltime isnt undefined &amp;&amp; RemoteWallClockTime isnt undefined &amp;&amp; (RemoteWallClockTime &lt; 60 * minWallTime),strcat("The job's wall clock time, ",int(RemoteWallClockTime / 60),"min, is less than the minimum specified by the job (",minWalltime,")"),"Job held for unknown reason."));<br/>        eval_set_CERequirements = ifThenElse(default_CERequirements isnt undefined,strcat(default_CERequirements,",Walltime,CondorCE"),"Walltime,CondorCE");<br/>        copy_OnExitHoldReason = "orig_OnExitHoldReason";<br/>        set_OnExitHold = ifThenElse(orig_OnExitHold isnt undefined,orig_OnExitHold,false) || ifThenElse(minWalltime isnt undefined &amp;&amp; RemoteWallClockTime isnt undefined,RemoteWallClockTime &lt; 60 * minWallTime,false);<br/>        delete_TotalSubmitProcs = true;<br/>        set_JobIsRunning = (JobStatus isnt 1) &amp;&amp; (JobStatus isnt 5) &amp;&amp; GlideinCpusIsGood;<br/>        set_RoutedJob = true;<br/>        set_OnExitHoldSubCode = ifThenElse((orig_OnExitHold isnt undefined) &amp;&amp; orig_OnExitHold,ifThenElse(orig_OnExitHoldSubCode isnt undefined,orig_OnExitHoldSubCode,1),42);<br/>        set_RequestCpus = ifThenElse(WantWholeNode is true, !isUndefined(TotalCpus) ? TotalCpus : JobCpus,OriginalCpus);<br/>        set_JobCpus = JobIsRunning ? int(MATCH_EXP_JOB_GLIDEIN_Cpus) : OriginalCpus;<br/>        eval_set_environment = mergeEnvironment(join(" ",strcat("HOME=",userHome(Owner,"/")),ifThenElse(false is true,"",strcat("CONDORCE_COLLECTOR_HOST=","cms.ufhpc:9619"))),osg_environment,orig_environment,"",default_pilot_job_env);<br/>        set_WallTime = ifThenElse(maxWallTime isnt undefined,60 * maxWallTime,ifThenElse(default_maxWallTime isnt undefined,60 * default_maxWallTime,60 * 2880));<br/>        delete_CondorCE = true;<br/>        MaxJobs = 10000;<br/>        eval_set_OriginalCpus = ifThenElse(xcount isnt undefined,xcount,ifThenElse(orig_RequestCpus isnt undefined,ifThenElse(orig_RequestCpus &gt; 1,orig_RequestCpus,ifThenElse(default_xcount isnt undefined,default_xcount,1)),ifThenElse(default_xcount isnt undefined,default_xcount,1)))<br/>    ]<br/>
<span style="color: #7d414c"><span style="font-size: small">(13:20:00)</span> <b>bockjoo:</b></span> Don't I need to put copy_RequestGPUs = "orig_RequestGPUs"; .... somewhere?<br/>
<span style="color: #43761b"><span style="font-size: small">(13:33:22)</span> <b>blin:</b></span> well it doesn't look like you're using the whole node GPU logic in that route<br/>
<span style="color: #43761b"><span style="font-size: small">(13:33:50)</span> <b>blin:</b></span> (this stuff)<br/><pre> set_RequestGPUs = ifThenElse((WantWholeNode is true &amp;&amp; OriginalGPUs isnt undefined),<br/> (!isUndefined(TotalGPUs) &amp;&amp; TotalGPUs &gt; 0) ? TotalGPUs : JobGPUs,<br/> OriginalGPUs);</pre><br/>
<span style="color: #7d414c"><span style="font-size: small">(14:18:17)</span> <b>bockjoo:</b></span> Do you mean I should add set_RequestGPUs .... to the Slurm_GPU route?<br/>
<span style="color: #43761b"><span style="font-size: small">(14:23:43)</span> <b>blin:</b></span> hrm actually nevermind, the CE doesn't support whole node job requests outside of condor in that manner<br/>
<span style="color: #43761b"><span style="font-size: small">(14:24:35)</span> <b>blin:</b></span> for the pre-routed and routed jobs, do they have <tt>RequestGPUs</tt> set in their job ad?<br/>
<span style="color: #43761b"><span style="font-size: small">(14:25:12)</span> <b>blin:</b></span> something like <tt>condor_ce_q -const 'RouteName == "Slurm_GPU"' -af:jh RequestGPUs</tt> should give you the routed jobs<br/>
<span style="color: #7d414c"><span style="font-size: small">(14:27:25)</span> <b>bockjoo:</b></span> No RequestGPUs is found from the command:<br/>
<span style="color: #7d414c"><span style="font-size: small">(14:27:29)</span> <b>bockjoo:</b></span> [root@cms ~]# condor_ce_q -const 'RouteName == "Slurm_GPU"' -af:jh RequestGPUs<br/> ID      RequestGPUs<br/>
<span style="color: #7d414c"><span style="font-size: small">(14:27:45)</span> <b>bockjoo:</b></span> But [root@cms ~]# condor_ce_q -l 454791.0 | grep GPU<br/>RequestGPUs = 1<br/>
<span style="color: #7d414c"><span style="font-size: small">(14:40:54)</span> <b>bockjoo:</b></span> 454791.0 is intended to be Slurm_GPU but is Local_Slurm (non-GPU route).<br/>
<span style="color: #43761b"><span style="font-size: small">(16:24:55)</span> <b>blin:</b></span> @bockjoo is <tt>Local_Slurm</tt> your catchall route? if so, you should have that after <tt>Slurm_GPU</tt> in your <tt>JOB_ROUTER_ROUTE_NAMES</tt><br/>
<span style="color: #7d414c"><span style="font-size: small">(16:27:36)</span> <b>bockjoo:</b></span> I forgot to add ( isUndefined(TARGET.RequestGPUs) || (TARGET.RequestGPUs =?= 0) ) for Local_Slurm and everything was routed to Local_Slurm, i.e., The two routes were not exclusive. My bad.<br/>
<span style="color: #43761b"><span style="font-size: small">(16:29:41)</span> <b>blin:</b></span> they don't necessarily have to be exclusive with newer versions of HTCondor-CE<br/>
<span style="color: #43761b"><span style="font-size: small">(16:29:55)</span> <b>blin:</b></span> (and htcondor)<br/>
<span style="color: #43761b"><span style="font-size: small">(16:30:11)</span> <b>blin:</b></span> see <a href="https://opensciencegrid.org/docs/compute-element/job-router-recipes/#how-jobs-match-to-job-routes">https://opensciencegrid.org/docs/compute-element/job-router-recipes/#how-jobs-match-to-job-routes</a> for job to route matching behavior<br/>
<span style="color: #7d414c"><span style="font-size: small">(16:51:13)</span> <b>bockjoo:</b></span> Now, I can submit condor-g jobs to the slurm gpu partion so it works.<br/>
</body>
</html>
