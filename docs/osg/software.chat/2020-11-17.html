<!DOCTYPE html>
<html>
<head>
<title>Tue Nov 17, 2020 : #software (osg)</title>
</head>
<body>
<h3>Tue Nov 17, 2020 : #software (osg)</h3>
<span style="color: #674b1b"><span style="font-size: small">(08:35:14)</span> <b>rynge:</b></span> Good morning - I need some help with the negotiator on <a href="http://flock.opensciencegrid.org">flock.opensciencegrid.org</a> negotiator after an upgrade to HTCondor 8.9.9 and GWMS 3.7.1 (osg-upcoming)<br/>
<span style="color: #674b1b"><span style="font-size: small">(08:35:59)</span> <b>rynge:</b></span> The negotiator runs fine for a little bit, but then gets into a state where it stops scheduling<br/>
<span style="color: #674b1b"><span style="font-size: small">(08:36:28)</span> <b>rynge:</b></span> Once cycle:<br/>
<span style="color: #674b1b"><span style="font-size: small">(08:36:33)</span> <b>rynge:</b></span> <pre>11/17/20 08:31:18 group quotas: assigning 39 submitters to accounting groups<br/>11/17/20 08:31:18 group quotas: assigning group quotas from 17300 available weighted slots<br/>11/17/20 08:31:18 group quotas: subtree &lt;none&gt; receiving quota= 17300<br/>11/17/20 08:31:18 group quotas: group &lt;none&gt;, allocated 0 for static children, 17300 for dynamic children<br/>11/17/20 08:31:18 group quotas: subtree group_xsedehigh receiving quota= 3460<br/>11/17/20 08:31:18 group quotas: group group_xsedehigh, allocated 0 for static children, 3460 for dynamic children<br/>11/17/20 08:31:18 group quotas: group group_xsedehigh assigned quota= 3460<br/>11/17/20 08:31:18 group quotas: group &lt;none&gt; assigned quota= 13840<br/>11/17/20 08:31:18 group quotas: group= &lt;none&gt;  cquota= 0  static= 0  accept= 1  quota= 13840  req= 139252  usage= 20302<br/>11/17/20 08:31:18 group quotas: group= group_xsedehigh  cquota= 0.2  static= 0  accept= 1  quota= 3460  req= 0  usage= 1<br/>11/17/20 08:31:18 group quotas: allocation round 1<br/>11/17/20 08:31:18 group quotas: fairshare (1): group= &lt;none&gt;  quota= 13840  requested= 139252<br/>11/17/20 08:31:18 group quotas: fairshare (2): group= &lt;none&gt;  quota= 13840  allocated= 13840  requested= 125412<br/>11/17/20 08:31:18 group quotas: fairshare (1): group= group_xsedehigh  quota= 3460  requested= 0<br/>11/17/20 08:31:18 group quotas: fairshare (2): group= group_xsedehigh  quota= 3460  allocated= 0  requested= 0<br/>11/17/20 08:31:18 group quotas: allocate-surplus (1): group= &lt;none&gt;  surplus= 3460  subtree-requested= 125412<br/>11/17/20 08:31:18 group quotas: allocate-surplus (2b): quota-based allocation, group= &lt;none&gt;  requested= 125412  surplus= 3460<br/>11/17/20 08:31:18 group quotas: allocate-surplus-loop: by_quota= 1  iteration= 1  requested= 125412  surplus= 3460<br/>11/17/20 08:31:18 group quotas: allocate-surplus (4): group &lt;none&gt; allocated surplus= 3460  allocated= 17300  requested= 121952<br/>11/17/20 08:31:18 group quotas: fairshare (3): group= &lt;none&gt;  surplus= 0  subtree_requested= 121952<br/>11/17/20 08:31:18 group quotas: group= &lt;none&gt;  quota= 13840  requested= 139252  allocated= 17300  unallocated= 121952<br/>11/17/20 08:31:18 group quotas: group= group_xsedehigh  quota= 3460  requested= 0  allocated= 0  unallocated= 0<br/>11/17/20 08:31:18 group quotas: groups= 2  requesting= 1  served= 1  unserved= 0  slots= 17181  requested= 139252  allocated= 17300  surplus= 0  maxdelta= 0<br/>11/17/20 08:31:18 group quotas: entering RR iteration n= 0<br/>11/17/20 08:31:18 Group group_xsedehigh - sortkey= 0.000289017<br/>11/17/20 08:31:18 Group group_xsedehigh - skipping, zero slots allocated<br/>11/17/20 08:31:18 Group &lt;none&gt; - sortkey= 3.4e+38<br/>11/17/20 08:31:18 Group &lt;none&gt; - BEGIN NEGOTIATION<br/>11/17/20 08:31:18 NEGOTIATOR_STRICT_ENFORCE_QUOTA is true, current proposed allocation for &lt;none&gt; is 17300<br/>11/17/20 08:31:18 subtree_usage at group_xsedehigh is 1<br/>11/17/20 08:31:18 subtree_usage at &lt;none&gt; is 20303<br/>11/17/20 08:31:18 group quotas: Group &lt;none&gt;  allocated= 17300  usage= 20302<br/>11/17/20 08:31:18 group quotas: Group group_xsedehigh  allocated= 0  usage= 1<br/>11/17/20 08:31:18 Round 1 totals: allocated= 17300  usage= 17300<br/>11/17/20 08:31:18 ---------- Finished Negotiation Cycle ----------</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(08:37:03)</span> <b>rynge:</b></span> But the actual state of the pool is:<br/>
<span style="color: #674b1b"><span style="font-size: small">(08:37:06)</span> <b>rynge:</b></span> <pre>               Machines Owner Claimed Unclaimed Matched Preempting  Drain<br/><br/>  X86_64/LINUX    11804     0    6645      5159       0          0      0<br/><br/>         Total    11804     0    6645      5159       0          0      0</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(08:37:42)</span> <b>rynge:</b></span> If I restart the negotiator, it will work fine for a while again<br/>
<span style="color: #674b1b"><span style="font-size: small">(08:41:26)</span> <b>rynge:</b></span> Here is how it looks from gwms monitoring:<br/>
<span style="color: #674b1b"><span style="font-size: small">(08:41:28)</span> <b>rynge:</b></span> <br/>
<span style="color: #9e3997"><span style="font-size: small">(08:41:53)</span> <b>bbockelm:</b></span> @rynge - I don't know of anything that woudl cause that.<br/>
<span style="color: #674b1b"><span style="font-size: small">(08:42:39)</span> <b>rynge:</b></span> <tt>Round 1 totals: allocated= 17300  usage= 17300</tt> This one is confusing to me. We only have like 12k ads in the system<br/>
<span style="color: #9e3997"><span style="font-size: small">(08:42:40)</span> <b>bbockelm:</b></span> <tt>11/17/20 08:31:18 group quotas: Group &lt;none&gt;  allocated= 17300  usage= 20302</tt><br/>
<span style="color: #9e3997"><span style="font-size: small">(08:43:03)</span> <b>bbockelm:</b></span> That's the problematic statement.  Maybe something with <tt>SLOT_WEIGHT</tt> gone wrong?<br/>
<span style="color: #9e3997"><span style="font-size: small">(08:43:20)</span> <b>bbockelm:</b></span> Basically it thinks the pool size is smaller than the actual usage of the pool.<br/>
<span style="color: #674b1b"><span style="font-size: small">(08:44:08)</span> <b>rynge:</b></span> Right - ok, so that would be the slot weight as set by the glideins?<br/>
<span style="color: #9e3997"><span style="font-size: small">(08:44:16)</span> <b>bbockelm:</b></span> Is there a slot constraint or inconsistent value of <tt>SLOT_WEIGHT</tt> somewhere (startd has it set to one thing, negotiator has it set to another)?<br/>
<span style="color: #674b1b"><span style="font-size: small">(08:44:59)</span> <b>rynge:</b></span> <pre>NEGOTIATOR_SLOT_CONSTRAINT = (isundefined(OSG_GLIDEIN_VERSION) || (OSG_GLIDEIN_VERSION &gt;= 512)) &amp;&amp; isUndefined(IsOsgVoContainer)</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(08:46:41)</span> <b>rynge:</b></span> The glideins have:<br/>
<span style="color: #674b1b"><span style="font-size: small">(08:46:45)</span> <b>rynge:</b></span> <pre>SlotWeight = Cpus</pre><br/><br/>
<span style="color: #9e3997"><span style="font-size: small">(08:50:16)</span> <b>bbockelm:</b></span> <pre># condor_status -const '(isundefined(OSG_GLIDEIN_VERSION) || (OSG_GLIDEIN_VERSION &gt;= 512)) &amp;&amp; isUndefined(IsOsgVoContainer)' -af Cpus | awk '{sum += $1} END {print sum}'<br/>17852</pre><br/>So that looks about right.<br/>
<span style="color: #9e3997"><span style="font-size: small">(08:51:55)</span> <b>bbockelm:</b></span> <pre># condor_status -submitter -af WeightedRunningJobs | awk '{sum += $1} END {print sum}'<br/>9906</pre><br/>and that's definitely less than 23k.<br/>
<span style="color: #43761b"><span style="font-size: small">(09:08:15)</span> <b>blin:</b></span> @gthain ^^<br/>
<span style="color: #e0a729"><span style="font-size: small">(09:12:36)</span> <b>gthain:</b></span> What's the summary?<br/>
<span style="color: #674b1b"><span style="font-size: small">(09:13:39)</span> <b>rynge:</b></span> See above from today<br/>
<span style="color: #674b1b"><span style="font-size: small">(09:14:05)</span> <b>rynge:</b></span> I have now downgraded to 8.9.8 (the version we ran before)<br/>
<span style="color: #674b1b"><span style="font-size: small">(09:16:38)</span> <b>rynge:</b></span> Here is the log: <a href="http://flock.opensciencegrid.org/NegotiatorLog-8.9.9">http://flock.opensciencegrid.org/NegotiatorLog-8.9.9</a><br/>
<span style="color: #e0a729"><span style="font-size: small">(09:20:35)</span> <b>gthain:</b></span> What's the unit for the png? slots?  or cores?<br/>
<span style="color: #674b1b"><span style="font-size: small">(09:22:16)</span> <b>rynge:</b></span> Cores<br/>
<span style="color: #674b1b"><span style="font-size: small">(09:22:36)</span> <b>rynge:</b></span> But glideinwms is sometimes confused about that<br/>
<span style="color: #674b1b"><span style="font-size: small">(09:22:54)</span> <b>rynge:</b></span> Full graph here <a href="http://flock.opensciencegrid.org/vofrontend/monitor/frontendStatus.html">http://flock.opensciencegrid.org/vofrontend/monitor/frontendStatus.html</a><br/>
<span style="color: #73769d"><span style="font-size: small">(09:25:41)</span> <b>tim.theisen:</b></span> @gthain This smells like the problem that LIGO had with group quotas. There are lots of warnings where it maps undefined groups to none. Could that be the problem?<br/>
<span style="color: #e0a729"><span style="font-size: small">(09:30:56)</span> <b>gthain:</b></span> I don't think so.  I think case, the negotiator thinks there are many more running jobs than there actually are<br/>
<span style="color: #674b1b"><span style="font-size: small">(09:35:06)</span> <b>rynge:</b></span> We did upgrade a bunch of schedds at the same time to 8.9.9<br/>
<span style="color: #902d59"><span style="font-size: small">(09:38:31)</span> <b>zmiller:</b></span> @gthain @tim.theisen We decided that these messages in the negotiator log were "scary sounding but actually benign", right?<br/><pre>11/16/20 22:41:41 SECMAN: failed to create session &lt;192.170.227.146:9618?addrs=192.170.227.146-9618&amp;alias=login05.osgconnect.net&amp;noUDP&amp;sock=schedd_1639162_5eee&gt;#1605574692#279 (key already exists).<br/>11/16/20 22:41:41 SECMAN: existing session &lt;192.170.227.146:9618?addrs=192.170.227.146-9618&amp;alias=login05.osgconnect.net&amp;noUDP&amp;sock=schedd_1639162_5eee&gt;#1605574692#279:</pre><br/>
<span style="color: #902d59"><span style="font-size: small">(09:38:58)</span> <b>zmiller:</b></span> (Because we see them in the CHTC NegotiatorLog and things seem to be working fine there...)<br/>
<span style="color: #e0a729"><span style="font-size: small">(09:39:35)</span> <b>gthain:</b></span> Right.  Scary but benign<br/>
<span style="color: #e0a729"><span style="font-size: small">(09:39:41)</span> <b>gthain:</b></span> We should still remove them<br/>
<span style="color: #902d59"><span style="font-size: small">(09:40:33)</span> <b>zmiller:</b></span> Yep.  Just double-checking.<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:56:36)</span> <b>rynge:</b></span> Somewhat anecdotally, but 8.9.8 seems to be behave better<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:56:39)</span> <b>rynge:</b></span> <a href="http://flock.opensciencegrid.org/vofrontend/monitor/frontendStatus.html">http://flock.opensciencegrid.org/vofrontend/monitor/frontendStatus.html</a><br/>
<span style="color: #674b1b"><span style="font-size: small">(10:57:48)</span> <b>rynge:</b></span> We also set <tt>NEGOTIATOR_USE_SLOT_WEIGHTS = False</tt><br/>
<span style="color: #674b1b"><span style="font-size: small">(10:58:10)</span> <b>rynge:</b></span> But we tried that with 8.9.9 as well, and it did not seem to make a difference<br/>
<span style="color: #e0a729"><span style="font-size: small">(11:01:37)</span> <b>gthain:</b></span> And the 8.9.8 negotiator gets the correct total number of running jobs?<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:12:27)</span> <b>rynge:</b></span> We will have to leave it a for a while to be sure, but so far it seems fine<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:13:00)</span> <b>rynge:</b></span> <tt>11/17/20 11:12:16 Round 2 totals: allocated= 24322 usage= 24322</tt><br/>
<span style="color: #674b1b"><span style="font-size: small">(11:13:11)</span> <b>rynge:</b></span> <pre>               Machines Owner Claimed Unclaimed Matched Preempting  Drain<br/><br/>  X86_64/LINUX    25868     0   24067      1801       0          0      0<br/><br/>         Total    25868     0   24067      1801       0          0      0</pre><br/><br/>
<span style="color: #73769d"><span style="font-size: small">(14:51:05)</span> <b>tim.theisen:</b></span> I built the release candidate for HTCondor 8.9.10 and I realize that I need to rebuild the blahp against it. What's the easiest way to make a new build off the current tag? If that isn't easy. Perhaps we should tag a new version since there is GPU stuff in the blahp. In the past the OSG decided when to cut a new version. Is that my decision now that it is in HTCondor's wheelhouse?<br/>
<span style="color: #16569E"><span style="font-size: small">(14:52:34)</span> <b>edquist:</b></span> &gt;What's the easiest way to make a new build off the current tag<br/>
<span style="color: #16569E"><span style="font-size: small">(14:52:39)</span> <b>edquist:</b></span> you mean of condor?<br/>
<span style="color: #73769d"><span style="font-size: small">(14:53:14)</span> <b>tim.theisen:</b></span> No, I need the build the blahp against the latest condor in upcoming-development.<br/>
<span style="color: #16569E"><span style="font-size: small">(14:53:17)</span> <b>edquist:</b></span> ah<br/>
<span style="color: #73769d"><span style="font-size: small">(14:53:48)</span> <b>tim.theisen:</b></span> Can I do that easily without dropping a new tag? I don't know what the procedure is.<br/>
<span style="color: #16569E"><span style="font-size: small">(14:54:23)</span> <b>edquist:</b></span> if you just want a rebuild you can bump the Release field in the osg/blahp.spec<br/>
<span style="color: #16569E"><span style="font-size: small">(14:54:44)</span> <b>edquist:</b></span> you do not need a new tag<br/>
<span style="color: #16569E"><span style="font-size: small">(14:55:10)</span> <b>edquist:</b></span> or any new commits<br/>
<span style="color: #16569E"><span style="font-size: small">(14:55:19)</span> <b>edquist:</b></span> (in the BLAH repo)<br/>
<span style="color: #16569E"><span style="font-size: small">(14:55:25)</span> <b>edquist:</b></span> ..<br/>
<span style="color: #73769d"><span style="font-size: small">(14:55:27)</span> <b>tim.theisen:</b></span> There is no blahp.spec in svn/native/redhat/branches/upcoming/blahp/osg<br/>
<span style="color: #16569E"><span style="font-size: small">(14:57:28)</span> <b>edquist:</b></span> in that case i usually bust open the blahp.spec, move it under osg/, commit that as-is, and then bump the release so the change can be seen.  you can get at the source there with <tt>fetch-dot-source -s upstream/github.source</tt><br/>
<span style="color: #16569E"><span style="font-size: small">(14:57:38)</span> <b>edquist:</b></span> or i can do this for you quickly and kick off a build<br/>
<span style="color: #43761b"><span style="font-size: small">(14:58:06)</span> <b>blin:</b></span> &gt; In the past the OSG decided when to cut a new version. Is that my decision now that it is in HTCondor's wheelhouse?<br/>i'd say yes<br/>
<span style="color: #73769d"><span style="font-size: small">(14:59:04)</span> <b>tim.theisen:</b></span> OK, thanks for the input, I come back if I need more info.<br/>
<span style="color: #16569E"><span style="font-size: small">(14:59:49)</span> <b>edquist:</b></span> if we ever do cut a new tag though, we usually do it with a <tt>-2</tt> tag (<tt>v1.2.3-2</tt>), to emphasize that it is a packaging-only change<br/>
<span style="color: #16569E"><span style="font-size: small">(15:01:07)</span> <b>edquist:</b></span> (<tt>fetch-dot-source</tt> is from the osg-build repo; the <tt>-s</tt> option tells it to grab the rpm/*.spec file, along with the tarball)<br/>
<span style="color: #16569E"><span style="font-size: small">(15:01:26)</span> <b>edquist:</b></span> ...<br/>
<span style="color: #16569E"><span style="font-size: small">(15:01:41)</span> <b>edquist:</b></span> gl;hf<br/>
</body>
</html>
