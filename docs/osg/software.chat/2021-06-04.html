<!DOCTYPE html>
<html>
<head>
<title>Fri Jun 4, 2021 : #software (osg)</title>
</head>
<body>
<h3>Fri Jun 4, 2021 : #software (osg)</h3>
<span style="color: #43761b"><span style="font-size: small">(08:22:43)</span> <b>blin:</b></span> hey @dschultz, i was talking to @miwalls who noticed some IceCube jobs failing because it's setting <tt>GLOBUS_LOCATION="/cvmfs/icecube.opensciencegrid.org/iceprod/master/Ubuntu_20.04_x86_64"</tt> (they've got an Ubuntu 20.04 cluster), which doesn't seem to exist. What would it take to build everything in iceprod for Ubuntu 20?<br/>
<blockquote>
<span style="color: #50a0cf"><span style="font-size: small">(10:05:10)</span> <b>dschultz:</b></span> It takes reminding me that I haven't done that yet.  Though we usually run inside a centos7 container.<br/>
<span style="color: #43761b"><span style="font-size: small">(10:06:35)</span> <b>blin:</b></span> ah so the stuff in iceprod usually gets picked up after a Singularity container start?<br/>
<span style="color: #50a0cf"><span style="font-size: small">(10:09:04)</span> <b>dschultz:</b></span> generally yes.  the glidein usually takes care of the container start<br/>
<span style="color: #50a0cf"><span style="font-size: small">(10:09:12)</span> <b>dschultz:</b></span> that is, if we remember to configure it<br/>
<span style="color: #a63024"><span style="font-size: small">(10:10:05)</span> <b>miwalls:</b></span> Is there a way to check if singularity is starting?<br/>
<span style="color: #50a0cf"><span style="font-size: small">(10:11:25)</span> <b>dschultz:</b></span> remind me what site this is and how it gets connected?<br/>
<span style="color: #43761b"><span style="font-size: small">(10:14:37)</span> <b>blin:</b></span> this is SIUE <a href="https://github.com/opensciencegrid/topology/blob/master/topology/Southern%20Illinois%20University%20Edwardsville/SIUE%20-%20CC/SIUE-CC-production.yaml#L25">https://github.com/opensciencegrid/topology/blob/master/topology/Southern%20Illino[…]University%20Edwardsville/SIUE%20-%20CC/SIUE-CC-production.yaml</a><br/>
<span style="color: #43761b"><span style="font-size: small">(10:14:49)</span> <b>blin:</b></span> so @miwalls you do have Singularity installed?<br/>
<span style="color: #a63024"><span style="font-size: small">(10:18:02)</span> <b>miwalls:</b></span> Yes<br/>
<span style="color: #50a0cf"><span style="font-size: small">(10:18:18)</span> <b>dschultz:</b></span> @blin so this is through OSGConnect then.  the jobs do have <tt>HAS_SINGULARITY =?= true</tt> in the Requirements, and specify <tt>SingularityImage</tt><br/>
<span style="color: #43761b"><span style="font-size: small">(10:18:56)</span> <b>blin:</b></span> gotcha, thanks. maybe this is an issue with the pilot starting up Singularity then. thanks!<br/>
<span style="color: #a63024"><span style="font-size: small">(10:18:59)</span> <b>miwalls:</b></span> Singularity is installed cluster wide at<br/>root@cc-gpu-02:/# which singularity<br/>/usr/local/bin/singularity<br/>
<span style="color: #a63024"><span style="font-size: small">(10:22:46)</span> <b>miwalls:</b></span> Here are all of the mentions of singularity in glidein_config.<br/><tt>root@cc-gpu-02:/scratch/glide_AUEk4Y# cat glidein_config | grep -i singu</tt><br/><tt>GLIDEIN_Singularity_Use PREFERRED</tt><br/><tt>GLIDEIN_SINGULARITY_BINARY_OVERRIDE /usr/local/software/Singularity/singularity-3.7.0/bin:/usr/local/software/Singularity/singularity-3.5.3/bin</tt><br/><tt>GLIDEIN_SINGULARITY_REQUIRE OPTIONAL</tt><br/><tt>SINGULARITY_IMAGES_DICT default:/cvmfs/singularity.opensciencegrid.org/opensciencegrid/osgvo-el7:latest</tt><br/><tt>GWMS_SINGULARITY_STATUS PREFERRED</tt><br/><tt>SINGULARITY_PATH /cvmfs/oasis.opensciencegrid.org/mis/singularity/bin/singularity</tt><br/><tt>GWMS_SINGULARITY_PATH /cvmfs/oasis.opensciencegrid.org/mis/singularity/bin/singularity</tt><br/><tt>SINGULARITY_VERSION 3.7.4</tt><br/><tt>GWMS_SINGULARITY_VERSION 3.7.4</tt><br/><tt>SINGULARITY_MODE unprivileged</tt><br/><tt>GWMS_SINGULARITY_MODE unprivileged</tt><br/><tt>GLIDEIN_PROVIDES singularity/unprivileged</tt><br/><tt>HAS_CVMFS_IGWN_PRIVATE_DATA_SINGULARITY False</tt><br/><tt>CVMFS_singularity_opensciencegrid_org_NIOERR 0</tt><br/><tt>OpSysLongName Singularity Container - CentOS 7</tt><br/><tt>CVMFS_singularity_opensciencegrid_org_REVISION 133931</tt><br/><tt>HAS_CVMFS_singularity_opensciencegrid_org False</tt><br/><tt>HAS_SINGULARITY False</tt><br/><tt>SINGULARITY_COMMENT Disabled due to CVMFS being on NFS or CVMFS errors</tt><br/>
<span style="color: #a63024"><span style="font-size: small">(10:24:19)</span> <b>miwalls:</b></span> I don't see any CVMFS errors and it isn't on NFS so who knows.<br/>
</blockquote>
<span style="color: #a63024"><span style="font-size: small">(09:05:49)</span> <b>miwalls:</b></span> Was this line <tt>CVMFS_REPOSITORIES="</tt>echo $((echo <a href="http://oasis.opensciencegrid.org">oasis.opensciencegrid.org</a>;echo <a href="http://cms.cern.ch">cms.cern.ch</a>;ls /cvmfs)|sort -u)|tr ' ' ,<tt>"</tt> specifically made to work with the <tt>osg-oasis</tt> install? It doesn't seem to work with cvmfs installed for Ubuntu 20.04.<br/>
<span style="color: #43761b"><span style="font-size: small">(09:19:55)</span> <b>blin:</b></span> oh! there is an osg-oasis deb if you haven't installed that already<br/>
<span style="color: #43761b"><span style="font-size: small">(09:20:02)</span> <b>blin:</b></span> i learned about it recently, let me dig up a link<br/>
<span style="color: #43761b"><span style="font-size: small">(09:20:28)</span> <b>blin:</b></span> <a href="https://cvmfs-contrib.github.io/">https://cvmfs-contrib.github.io/</a><br/>
<span style="color: #a63024"><span style="font-size: small">(09:22:40)</span> <b>miwalls:</b></span> Should I install that alongside of the cvmfs install?<br/>
<span style="color: #a63024"><span style="font-size: small">(09:32:12)</span> <b>miwalls:</b></span> After installing that I am given the option to install <tt>cvmfs-config-osg</tt> is this correct? It seems that it will replace <tt>cvmfs-config-default</tt>. My experience with CVMFS has been met with lots of issues :smile:<br/>
<span style="color: #43761b"><span style="font-size: small">(09:32:24)</span> <b>blin:</b></span> yup, it should provide all the configs you need. you made custom config changes, though, right?<br/>
<span style="color: #43761b"><span style="font-size: small">(09:32:29)</span> <b>blin:</b></span> yeah <tt>cmvfs-config-osg</tt> is what you want<br/>
<span style="color: #a63024"><span style="font-size: small">(09:33:16)</span> <b>miwalls:</b></span> Only changes I made was this:<br/><tt>root@cc-head-01:/scratch# cat /etc/cvmfs/default.local</tt> <br/><tt>CVMFS_REPOSITORIES="<a href="http://oasis.opensciencegrid.org">oasis.opensciencegrid.org</a>,<a href="http://cms.cern.ch">cms.cern.ch</a>"</tt><br/><tt>CVMFS_QUOTA_LIMIT=20000</tt><br/><tt>CVMFS_CACHE_BASE="/scratch/cvmfs"</tt><br/><tt>CVMFS_HTTP_PROXY="<a href="http://cc-condor-01.hpc.siue.edu:3128">http://cc-condor-01.hpc.siue.edu:3128</a>"</tt><br/>
<span style="color: #43761b"><span style="font-size: small">(09:35:12)</span> <b>blin:</b></span> yeah, i'd restore the <tt>CVMFS_REPOSITORIES</tt> config from above and use the <tt>cvmfs-config-osg</tt> package. I think that should be sufficient<br/>
<span style="color: #a63024"><span style="font-size: small">(09:35:50)</span> <b>miwalls:</b></span> The echo line?<br/>
<span style="color: #43761b"><span style="font-size: small">(09:36:35)</span> <b>blin:</b></span> yup! let me double check on one of our nodes first, though<br/>
<span style="color: #43761b"><span style="font-size: small">(09:40:21)</span> <b>blin:</b></span> yeah, go with the <tt>echo</tt> line<br/>
<span style="color: #a63024"><span style="font-size: small">(09:42:02)</span> <b>miwalls:</b></span> Thanks! I hope this fixes some issues. I randomly see transport errors then jobs just never start. I'll keep an eye on it.<br/>
<span style="color: #50a0cf"><span style="font-size: small">(10:05:10)</span> <b>dschultz:</b></span> It takes reminding me that I haven't done that yet.  Though we usually run inside a centos7 container.<br/>
<blockquote>
<span style="color: #50a0cf"><span style="font-size: small">(10:05:10)</span> <b>dschultz:</b></span> It takes reminding me that I haven't done that yet.  Though we usually run inside a centos7 container.<br/>
<span style="color: #43761b"><span style="font-size: small">(10:06:35)</span> <b>blin:</b></span> ah so the stuff in iceprod usually gets picked up after a Singularity container start?<br/>
<span style="color: #50a0cf"><span style="font-size: small">(10:09:04)</span> <b>dschultz:</b></span> generally yes.  the glidein usually takes care of the container start<br/>
<span style="color: #50a0cf"><span style="font-size: small">(10:09:12)</span> <b>dschultz:</b></span> that is, if we remember to configure it<br/>
<span style="color: #a63024"><span style="font-size: small">(10:10:05)</span> <b>miwalls:</b></span> Is there a way to check if singularity is starting?<br/>
<span style="color: #50a0cf"><span style="font-size: small">(10:11:25)</span> <b>dschultz:</b></span> remind me what site this is and how it gets connected?<br/>
<span style="color: #43761b"><span style="font-size: small">(10:14:37)</span> <b>blin:</b></span> this is SIUE <a href="https://github.com/opensciencegrid/topology/blob/master/topology/Southern%20Illinois%20University%20Edwardsville/SIUE%20-%20CC/SIUE-CC-production.yaml#L25">https://github.com/opensciencegrid/topology/blob/master/topology/Southern%20Illino[…]University%20Edwardsville/SIUE%20-%20CC/SIUE-CC-production.yaml</a><br/>
<span style="color: #43761b"><span style="font-size: small">(10:14:49)</span> <b>blin:</b></span> so @miwalls you do have Singularity installed?<br/>
<span style="color: #a63024"><span style="font-size: small">(10:18:02)</span> <b>miwalls:</b></span> Yes<br/>
<span style="color: #50a0cf"><span style="font-size: small">(10:18:18)</span> <b>dschultz:</b></span> @blin so this is through OSGConnect then.  the jobs do have <tt>HAS_SINGULARITY =?= true</tt> in the Requirements, and specify <tt>SingularityImage</tt><br/>
<span style="color: #43761b"><span style="font-size: small">(10:18:56)</span> <b>blin:</b></span> gotcha, thanks. maybe this is an issue with the pilot starting up Singularity then. thanks!<br/>
<span style="color: #a63024"><span style="font-size: small">(10:18:59)</span> <b>miwalls:</b></span> Singularity is installed cluster wide at<br/>root@cc-gpu-02:/# which singularity<br/>/usr/local/bin/singularity<br/>
<span style="color: #a63024"><span style="font-size: small">(10:22:46)</span> <b>miwalls:</b></span> Here are all of the mentions of singularity in glidein_config.<br/><tt>root@cc-gpu-02:/scratch/glide_AUEk4Y# cat glidein_config | grep -i singu</tt><br/><tt>GLIDEIN_Singularity_Use PREFERRED</tt><br/><tt>GLIDEIN_SINGULARITY_BINARY_OVERRIDE /usr/local/software/Singularity/singularity-3.7.0/bin:/usr/local/software/Singularity/singularity-3.5.3/bin</tt><br/><tt>GLIDEIN_SINGULARITY_REQUIRE OPTIONAL</tt><br/><tt>SINGULARITY_IMAGES_DICT default:/cvmfs/singularity.opensciencegrid.org/opensciencegrid/osgvo-el7:latest</tt><br/><tt>GWMS_SINGULARITY_STATUS PREFERRED</tt><br/><tt>SINGULARITY_PATH /cvmfs/oasis.opensciencegrid.org/mis/singularity/bin/singularity</tt><br/><tt>GWMS_SINGULARITY_PATH /cvmfs/oasis.opensciencegrid.org/mis/singularity/bin/singularity</tt><br/><tt>SINGULARITY_VERSION 3.7.4</tt><br/><tt>GWMS_SINGULARITY_VERSION 3.7.4</tt><br/><tt>SINGULARITY_MODE unprivileged</tt><br/><tt>GWMS_SINGULARITY_MODE unprivileged</tt><br/><tt>GLIDEIN_PROVIDES singularity/unprivileged</tt><br/><tt>HAS_CVMFS_IGWN_PRIVATE_DATA_SINGULARITY False</tt><br/><tt>CVMFS_singularity_opensciencegrid_org_NIOERR 0</tt><br/><tt>OpSysLongName Singularity Container - CentOS 7</tt><br/><tt>CVMFS_singularity_opensciencegrid_org_REVISION 133931</tt><br/><tt>HAS_CVMFS_singularity_opensciencegrid_org False</tt><br/><tt>HAS_SINGULARITY False</tt><br/><tt>SINGULARITY_COMMENT Disabled due to CVMFS being on NFS or CVMFS errors</tt><br/>
<span style="color: #a63024"><span style="font-size: small">(10:24:19)</span> <b>miwalls:</b></span> I don't see any CVMFS errors and it isn't on NFS so who knows.<br/>
</blockquote>
<span style="color: #43761b"><span style="font-size: small">(10:43:11)</span> <b>blin:</b></span> @miwalls poking around the pilot logs it looks like we're not detecting singularity properly. @rynge @marcom what paths does gwms look at for singularity?<br/>
<span style="color: #a63024"><span style="font-size: small">(10:44:10)</span> <b>miwalls:</b></span> Curious on that as well at the moment it is here /usr/local/bin/singularity worst case I can symlink it?<br/>
<span style="color: #43761b"><span style="font-size: small">(10:45:07)</span> <b>blin:</b></span> there are also CE config workarounds that we can give, depending on which is easier for you to deploy<br/>
<span style="color: #a63024"><span style="font-size: small">(10:45:55)</span> <b>miwalls:</b></span> Doesn't matter to me I prefer configs though<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:46:06)</span> <b>rynge:</b></span> I think it should be fine as long as it is in the path - what site is this on?<br/>
<span style="color: #43761b"><span style="font-size: small">(10:47:10)</span> <b>blin:</b></span> SIUE<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:47:28)</span> <b>rynge:</b></span> Ah, now it is coming back to me :slightly_smiling_face:<br/>
<span style="color: #dd8527"><span style="font-size: small">(10:48:13)</span> <b>marcom:</b></span> These are the paths looked, in order:<br/><pre>    # 1. Optional: Look first in the override path (GLIDEIN_SINGULARITY_BINARY_OVERRIDE)<br/>    # 2. Look in the path suggested via $1 (SINGULARITY_BIN) <br/>    #      (keywords: PATH -&gt; go to step 3 - ie start w/ $PATH; <br/>    #           OSG -&gt; OSG location, and continue from step 3 if failed, this is the default)<br/>    # 3. Look in $PATH<br/>    # 4. Invoke module singularitypro<br/>    # 5. Invoke module singularity<br/>    # 6. Look in the default OSG location</pre><br/>
<span style="color: #674b1b"><span style="font-size: small">(10:48:14)</span> <b>rynge:</b></span> <pre>SINGULARITY_COMMENT = "Disabled due to CVMFS being on NFS or CVMFS errors"</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(10:48:19)</span> <b>rynge:</b></span> How is CVMFS mounted?<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:49:50)</span> <b>rynge:</b></span> Singularity itself is found and the unpriv one is working (<tt>/cvmfs/oasis.opensciencegrid.org/mis/singularity/bin/singularity</tt>), but our validation scripts do not like the CVMFS mounts<br/>
<span style="color: #43761b"><span style="font-size: small">(10:50:21)</span> <b>blin:</b></span> i also see <tt>Fri Jun  4 09:11:38 CDT 2021 ERROR: /cvmfs/singularity.opensciencegrid.org/opensciencegrid/osgvo-el7:latest file not found</tt><br/>
<span style="color: #674b1b"><span style="font-size: small">(10:50:47)</span> <b>rynge:</b></span> Looks like it is getting disabled because of CVMFS errors<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:50:51)</span> <b>rynge:</b></span> <pre>CVMFS_singularity_opensciencegrid_org_REVISION 133877<br/>CVMFS_singularity_opensciencegrid_org_NIOERR 4</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(10:52:53)</span> <b>rynge:</b></span> Singularity is working on most nodes, but there are a few problematic ones<br/>
<span style="color: #43761b"><span style="font-size: small">(10:53:21)</span> <b>blin:</b></span> ah gotcha<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:53:28)</span> <b>rynge:</b></span> <pre>$ condor_status -const 'GLIDEIN_ResourceName == "SIUE-CC-production" &amp;&amp; CVMFS_singularity_opensciencegrid_org_NIOERR &gt; 0' -af Machine | sort | uniq -c<br/>      6 <a href="http://cc-cpu-04.hpc.siue.edu">cc-cpu-04.hpc.siue.edu</a><br/>      4 <a href="http://cc-cpu-07.hpc.siue.edu">cc-cpu-07.hpc.siue.edu</a><br/>      3 <a href="http://cc-cpu-08.hpc.siue.edu">cc-cpu-08.hpc.siue.edu</a></pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(10:53:47)</span> <b>rynge:</b></span> Might worth taking a look at the cvmfs logs on those<br/>
<span style="color: #a63024"><span style="font-size: small">(10:58:45)</span> <b>miwalls:</b></span> Where would the errors be since this is ubuntu 20.04?<br/>
<span style="color: #a63024"><span style="font-size: small">(11:01:09)</span> <b>miwalls:</b></span> I was fixing CVMFS issues. I haven't had good luck with it in Ubuntu 20.04 with a pretty much default config. I get transport errors quite often in directories. Brian and I did some work to help with that.<br/>
<span style="color: #a63024"><span style="font-size: small">(11:01:21)</span> <b>miwalls:</b></span> At this point I see no errors mentioned in the last hour about cvmfs in journalctl<br/>
<span style="color: #a63024"><span style="font-size: small">(11:02:27)</span> <b>miwalls:</b></span> Are the jobs looking further back in the logs or how does it determine if there are errors. Also I don't have NFS at all on the cluster.<br/>
<span style="color: #a63024"><span style="font-size: small">(11:31:38)</span> <b>miwalls:</b></span> I cancelled a job that was stuck on cc-gpu-01 and now the new one is detecting singularity.<br/><pre>GLIDEIN_Singularity_Use PREFERRED<br/>GLIDEIN_SINGULARITY_BINARY_OVERRIDE /usr/local/software/Singularity/singularity-3.7.0/bin:/usr/local/software/Singularity/singularity-3.5.3/bin<br/>GLIDEIN_SINGULARITY_REQUIRE OPTIONAL<br/>VOS_USING_SE_BASEPATH <br/>VOS_USING_SE_OTHER_SUBDIR <br/>VOS_USING_SE_VONAME_LOWERCASE <br/>GLIDECLIENT_Start (isUndefined(MY.OSG_NODE_VALIDATED) || MY.OSG_NODE_VALIDATED) &amp;&amp;                                         (isUndefined(MY.RecentJobStarts) || RecentJobStarts &lt; 256) &amp;&amp;                                         (isUndefined(TARGET.ProjectName) != True &amp;&amp; TARGET.ProjectName != "") &amp;&amp;                                         (GLIDEIN_Site =!= "AMNH" || (regexp("jlab.org", User) != True &amp;&amp; User =!= "cgomes02@services.ci-connect.net")) &amp;&amp;                                         (regexp("CancerComputer", GLIDEIN_ResourceName) =!= True || stringListMember(TARGET.ProjectName, "SBGrid,SPLINTER,TG-MCB130135,BioGraph,swipnanobio,SINGE,SSGAforCSP,sweeps,TG-MCB190026,PNGtemplate,PainDrugs", ",") || regexp("^COVID19", TARGET.ProjectName)) &amp;&amp;                                         (isUndefined(WantsStashCvmfs) ||                                            !WantsStashCvmfs ||                                            isUndefined(CVMFS_stash_osgstorage_org_REVISION) ||                                            isUndefined(SUBMITTER_stash_osgstorage_org_REVISION) ||                                            CVMFS_stash_osgstorage_org_REVISION &gt;= SUBMITTER_stash_osgstorage_org_REVISION)<br/>SINGULARITY_IMAGES_DICT default:/cvmfs/singularity.opensciencegrid.org/opensciencegrid/osgvo-el7:latest<br/>HAS_SINGULARITY True<br/>GWMS_SINGULARITY_STATUS PREFERRED<br/>SINGULARITY_PATH /cvmfs/oasis.opensciencegrid.org/mis/singularity/bin/singularity<br/>GWMS_SINGULARITY_PATH /cvmfs/oasis.opensciencegrid.org/mis/singularity/bin/singularity<br/>SINGULARITY_VERSION 3.7.4<br/>GWMS_SINGULARITY_VERSION 3.7.4<br/>SINGULARITY_MODE unprivileged<br/>GWMS_SINGULARITY_MODE unprivileged<br/>GLIDEIN_PROVIDES singularity/unprivileged<br/>HAS_CVMFS_IGWN_PRIVATE_DATA_SINGULARITY False<br/>HAS_CVMFS_singularity_opensciencegrid_org True<br/>CVMFS_singularity_opensciencegrid_org_REVISION 133941<br/>CVMFS_singularity_opensciencegrid_org_NIOERR 0<br/>OpSysLongName Singularity Container - CentOS 7</pre><br/>
<span style="color: #a63024"><span style="font-size: small">(11:33:23)</span> <b>miwalls:</b></span> Nevermind it doesn't seem to be using the local singularity hmm<br/>
<span style="color: #a63024"><span style="font-size: small">(12:03:20)</span> <b>miwalls:</b></span> Awesome we are further along now. The last bit seems to be this error in the container.<br/>RuntimeError: You have to provide at least one OpenCL device using the "OpenCLDeviceList" parameter. (in void I3CLSimModule&lt;OutputMapType&gt;::Configure() [with OutputMapType = I3Map&lt;ModuleKey, I3Vector&lt;I3CompressedPhoton&gt; &gt;])<br/>
<span style="color: #50a0cf"><span style="font-size: small">(12:09:47)</span> <b>dschultz:</b></span> if you're running GPU slots, do you have <tt>/etc/OpenCL/vendors/nvidia.icd</tt>, and is it properly mapped into the container?<br/>
<span style="color: #a63024"><span style="font-size: small">(12:13:06)</span> <b>miwalls:</b></span> Unfamiliar territory for me but that file contains this.<br/>cat /etc/OpenCL/vendors/nvidia.icd<br/>libnvidia-opencl.so.1<br/>
<span style="color: #50a0cf"><span style="font-size: small">(12:14:07)</span> <b>dschultz:</b></span> that seems right<br/>
<span style="color: #a63024"><span style="font-size: small">(12:17:51)</span> <b>miwalls:</b></span> This is still the iceprod job that is giving that error. I'm unsure how to check if it properly mapping opencl.<br/>
<span style="color: #a63024"><span style="font-size: small">(13:42:21)</span> <b>miwalls:</b></span> Is it possible to add /usr/local/bin to the PATH for the jobs?<br/>
<span style="color: #43761b"><span style="font-size: small">(13:53:37)</span> <b>blin:</b></span> @miwalls i believe that should be in the PATH by default<br/>
<span style="color: #a63024"><span style="font-size: small">(13:54:05)</span> <b>miwalls:</b></span> Oh okay, I guess it is just preferring cvmfs instead.<br/>
<span style="color: #43761b"><span style="font-size: small">(13:55:23)</span> <b>blin:</b></span> maybe? i'd be surprised if it preferred the unpriv singularity out of CVMFS<br/>
<span style="color: #43761b"><span style="font-size: small">(13:55:53)</span> <b>blin:</b></span> oh wait, i see what you're saying from the logs above<br/>
<span style="color: #43761b"><span style="font-size: small">(13:56:34)</span> <b>blin:</b></span> that should be fine, then. is it just the OpenCL error now?<br/>
<span style="color: #a63024"><span style="font-size: small">(13:58:44)</span> <b>miwalls:</b></span> Yes, I tested OpenCL in my own singularity container and it worked. I'm unsure how to tell what flags/mappings the Iceprod is using. Using 'singularity exec --nv --bind /etc/OpenCL' worked.<br/>
<span style="color: #43761b"><span style="font-size: small">(13:59:44)</span> <b>blin:</b></span> have you tried it using the singularity out of cvmfs?<br/>
<span style="color: #a63024"><span style="font-size: small">(14:17:04)</span> <b>miwalls:</b></span> Yes looks like it. I am trying to run the task.cfg myself within the job.<br/>
<span style="color: #a63024"><span style="font-size: small">(14:25:53)</span> <b>miwalls:</b></span> That won't let me do it. Overall I see opencl working though.<br/>
<span style="color: #43761b"><span style="font-size: small">(14:29:58)</span> <b>blin:</b></span> do you see opencl working within the container?<br/>
<span style="color: #50a0cf"><span style="font-size: small">(14:31:11)</span> <b>dschultz:</b></span> there's also the possibility a new version of singularity did something strange with the env, and the iceprod framework isn't happy with that<br/>
<span style="color: #50a0cf"><span style="font-size: small">(14:31:43)</span> <b>dschultz:</b></span> was busy for a while, but I'll take a more in-depth look now<br/>
<span style="color: #a63024"><span style="font-size: small">(14:38:33)</span> <b>miwalls:</b></span> I can't figure out a way to test opencl within the osgvo-el7:latest image<br/>
<span style="color: #50a0cf"><span style="font-size: small">(14:44:22)</span> <b>dschultz:</b></span> one error I'm seeing from iceprod jobs is failing to download src files:<br/><pre>error: globus_xio: Unable to connect to <a href="http://gridftp-scratch.icecube.wisc.edu:2811">gridftp-scratch.icecube.wisc.edu:2811</a></pre><br/>
<span style="color: #a63024"><span style="font-size: small">(14:44:49)</span> <b>miwalls:</b></span> that might've been me. depending on the time<br/>
<span style="color: #50a0cf"><span style="font-size: small">(14:45:01)</span> <b>dschultz:</b></span> we also have black hole protection in there, where after a failure the job will just sleep for 10 minutes, so it doesn't chew jobs up<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:45:03)</span> <b>bbockelm:</b></span> :wink: @dschultz - your WebDAV server sure has a funny name.<br/>
<span style="color: #50a0cf"><span style="font-size: small">(14:45:14)</span> <b>dschultz:</b></span> yeah, I know.  still on the list<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:45:23)</span> <b>bbockelm:</b></span> :troll shrinks back under the bridge:<br/>
<span style="color: #a63024"><span style="font-size: small">(14:47:35)</span> <b>miwalls:</b></span> Here is my unhelpful way of testing :smile:<br/>root@cc-gpu-04:/scratch# /cvmfs/oasis.opensciencegrid.org/mis/singularity/bin/singularity exec --nv --bind /etc/OpenCL <a href="docker://tensorflow/tensorflow:latest-gpu">docker://tensorflow/tensorflow:latest-gpu</a> python -c 'import pyopencl; print(pyopencl.get_platforms()[0].get_devices())'<br/>INFO:    Using cached SIF image<br/>[&lt;pyopencl.Device 'NVIDIA A100-PCIE-40GB' on 'NVIDIA CUDA' at 0x100afa0&gt;, &lt;pyopencl.Device 'NVIDIA A100-PCIE-40GB' on 'NVIDIA CUDA' at 0x100b030&gt;]<br/>
<span style="color: #50a0cf"><span style="font-size: small">(14:52:57)</span> <b>dschultz:</b></span> yeah, I think the container itself is probably fine.  a bare test job finished fine<br/>
<span style="color: #50a0cf"><span style="font-size: small">(15:02:47)</span> <b>dschultz:</b></span> I think the issue is that LD_LIBRARY_PATH doesn't have <tt>/.singularity.d/libs/</tt> in it, which is where all the nvidia libraries from the host are mounted<br/>
<span style="color: #50a0cf"><span style="font-size: small">(15:04:08)</span> <b>dschultz:</b></span> an example from another site (from a while ago) had this:<br/><pre>LD_LIBRARY_PATH=/srv/condor/lib:/host-libs:/.singularity.d/libs:</pre><br/>
<span style="color: #50a0cf"><span style="font-size: small">(15:05:20)</span> <b>dschultz:</b></span> not sure where that would get configured.  @blin?<br/>
<span style="color: #50a0cf"><span style="font-size: small">(15:06:13)</span> <b>dschultz:</b></span> there are also a lot of layers here, so it could be my fault somewhere<br/>
<span style="color: #43761b"><span style="font-size: small">(15:06:47)</span> <b>blin:</b></span> i don't think we touch <tt>LD_LIBRARY_PATH</tt> in the CE setup, so my guess is something in the pilot would set it?<br/>
<span style="color: #50a0cf"><span style="font-size: small">(15:07:43)</span> <b>dschultz:</b></span> that would be my guess.  probably after the job starts, if it detects it's running in singularity<br/>
<span style="color: #9e3997"><span style="font-size: small">(15:08:20)</span> <b>bbockelm:</b></span> @rynge is well-versed in <tt>LD_LIBRARY_PATH</tt>, GPUs, and Singularity.<br/>
<span style="color: #50a0cf"><span style="font-size: small">(15:41:48)</span> <b>dschultz:</b></span> fun fact: our more recent cvmfs environments automatically add <tt>/.singularity.d/libs/</tt> to LD_LIBRARY_PATH to get around this problem.  but of course someone wanted to run a really old environment the last few days (shakes fist at users)<br/>
<span style="color: #674b1b"><span style="font-size: small">(15:42:46)</span> <b>rynge:</b></span> Huh, that should be set from the --nv flag<br/>
<span style="color: #674b1b"><span style="font-size: small">(15:43:16)</span> <b>rynge:</b></span> I will have to check to see if something changed in Singularity or GWMS<br/>
<span style="color: #50a0cf"><span style="font-size: small">(15:43:49)</span> <b>dschultz:</b></span> it could be that we're running pyglidein inside the OSG glidein, and it's removing it there<br/>
<span style="color: #674b1b"><span style="font-size: small">(15:43:56)</span> <b>rynge:</b></span> Which image is this? I want to be able to test with the same one<br/>
<span style="color: #50a0cf"><span style="font-size: small">(15:45:14)</span> <b>dschultz:</b></span> <tt>/cvmfs/singularity.opensciencegrid.org/opensciencegrid/osgvo-el7:latest</tt><br/>
<span style="color: #50a0cf"><span style="font-size: small">(15:47:32)</span> <b>dschultz:</b></span> I did make a change, which may have fixed it<br/>
<span style="color: #674b1b"><span style="font-size: small">(15:47:55)</span> <b>rynge:</b></span> Yeah, looks ok on my machine<br/>
<span style="color: #674b1b"><span style="font-size: small">(15:48:16)</span> <b>rynge:</b></span> What value did you see for <tt>LD_LIBRARY_PATH</tt> ?<br/>
<span style="color: #50a0cf"><span style="font-size: small">(15:49:05)</span> <b>dschultz:</b></span> previously a payload job saw<br/><pre>LD_LIBRARY_PATH=/srv/glidein/glideinExec/lib:/srv/glidein/glideinExec/lib/condor::/usr/local/lib64:/usr/local/lib:/usr/lib64:/usr/lib:/usr/lib/x86_64-linux-gnu:/lib64:/lib:/lib/x86_64-linux-gnu</pre><br/>
<span style="color: #50a0cf"><span style="font-size: small">(15:49:37)</span> <b>dschultz:</b></span> I'm hopeful I've added the singularity dir to the pyglidein config, and it will now see that as well<br/>
<span style="color: #674b1b"><span style="font-size: small">(15:52:44)</span> <b>rynge:</b></span> Yeah, that is odd - looks like we always add <tt>/.singularity.d/libs</tt> in that image<br/>
<span style="color: #674b1b"><span style="font-size: small">(15:53:07)</span> <b>rynge:</b></span> It could been overridden with a SINGULARITYENV variable<br/>
<span style="color: #674b1b"><span style="font-size: small">(15:55:43)</span> <b>rynge:</b></span> I wonder if the image was loaded at all<br/>
<span style="color: #674b1b"><span style="font-size: small">(15:56:05)</span> <b>rynge:</b></span> @dschultz Do you have the full env for that job?<br/>
<span style="color: #50a0cf"><span style="font-size: small">(15:57:01)</span> <b>dschultz:</b></span> maybe that was from before we got all the cvmfs errors out.  I'm running another test job, just need to wait for condor to pick it up<br/>
<span style="color: #674b1b"><span style="font-size: small">(15:57:15)</span> <b>rynge:</b></span> Ok, thanks<br/>
<span style="color: #50a0cf"><span style="font-size: small">(16:03:45)</span> <b>dschultz:</b></span> jobs now see<br/><pre>/srv/glidein/execute.146.163.142.21-313/dir_570/resource_libs:/srv/glidein/glideinExec/lib:/srv/glidein/glideinExec/lib/condor:/.singularity.d/libs:/host-libs:/.singularity.d/libs:/usr/local/lib64:/usr/local/lib:/usr/lib64:/usr/lib:/usr/lib/x86_64-linux-gnu:/lib64:/lib:/lib/x86_64-linux-gnu</pre><br/>and I got a successful completion<br/>
<span style="color: #50a0cf"><span style="font-size: small">(16:03:49)</span> <b>dschultz:</b></span> so, I think it's good now<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:30:22)</span> <b>rynge:</b></span> Ok, but what changed?<br/>
</body>
</html>
