<!DOCTYPE html>
<html>
<head>
<title>Wed Jan 8, 2020 : #software (osg)</title>
</head>
<body>
<h3>Wed Jan 8, 2020 : #software (osg)</h3>
<span style="color: #c386df"><span style="font-size: small">(09:54:52)</span> <b>matyas:</b></span> @blin looks like my osg-test run for osg-xrootd-standalone failed because libXrdMacaroons.so wasn't installed<br/>
<span style="color: #c386df"><span style="font-size: small">(09:55:23)</span> <b>matyas:</b></span> (on EL6)<br/>
<span style="color: #c386df"><span style="font-size: small">(09:56:24)</span> <b>matyas:</b></span> do we need to make the macaroons plugin a requirement for osg-xrootd-standalone?<br/>
<span style="color: #43761b"><span style="font-size: small">(09:56:41)</span> <b>blin:</b></span> hrm, that should be part of xrootd now<br/>
<span style="color: #43761b"><span style="font-size: small">(09:56:50)</span> <b>blin:</b></span> but perhaps it's only part of xrootd on EL7<br/>
<span style="color: #c386df"><span style="font-size: small">(10:02:37)</span> <b>matyas:</b></span> yep, macaroons are only included in EL7<br/>
<span style="color: #c386df"><span style="font-size: small">(10:03:19)</span> <b>matyas:</b></span> so we have to change the EL6 xrootd config back so that it doesn't use macaroons<br/>
<span style="color: #c386df"><span style="font-size: small">(10:10:33)</span> <b>matyas:</b></span> "osg-xrootd" doesn't get installed in osg-tested-internal which is why we didn't see it in the nightlies<br/>
<span style="color: #a63024"><span style="font-size: small">(12:31:07)</span> <b>efajardo:</b></span> <b>@here</b>, @didavila and I found something odd while testing lcmaps and osg-xrootd-standalone. The policy gets looked over. So we have<br/><br/><tt>                       -authzfunparms:lcmapscfg=/etc/lcmaps.db,loglevel=5,policy=authorize_only \</tt><br/><br/>But in the log of xrootd it shows it is always using <tt>xrootd_policy</tt><br/><br/><pre>lcmaps[6667]   LOG_DEBUG: 2020-01-08.18:14:59Z: lcmaps.mod-lcmaps_runPluginManager(): Do lcmaps_runEvaluationManager with the following policies:<br/>lcmaps[6667]   LOG_DEBUG: 2020-01-08.18:14:59Z: lcmaps.mod-lcmaps_runPluginManager():     xrootd_policy</pre><br/>
<span style="color: #a63024"><span style="font-size: small">(12:31:11)</span> <b>efajardo:</b></span> any idea?<br/>
<span style="color: #43761b"><span style="font-size: small">(12:32:34)</span> <b>blin:</b></span> what version of xrootd-lcmaps? could you dump the whole sec.protocol line?<br/>
<span style="color: #a63024"><span style="font-size: small">(12:34:39)</span> <b>efajardo:</b></span> it is what comes by default<br/>
<span style="color: #a63024"><span style="font-size: small">(12:34:57)</span> <b>efajardo:</b></span> <pre>if defined ?EnableLcmaps<br/>   xrootd.seclib /usr/lib64/libXrdSec-4.so<br/>   sec.protocol /usr/lib64 gsi -certdir:/etc/grid-security/certificates \<br/>                       -cert:/etc/grid-security/xrd/xrdcert.pem \<br/>                       -key:/etc/grid-security/xrd/xrdkey.pem \<br/>                       -crl:1 \<br/>                       -authzfun:libXrdLcmaps.so \<br/>                       -authzfunparms:lcmapscfg=/etc/lcmaps.db,loglevel=5,policy=authorize_only \<br/>                       -gmapopt:10 -gmapto:0<br/><br/>   acc.authdb /etc/xrootd/auth_file<br/>   ofs.authorize 1<br/>fi</pre><br/>
<span style="color: #a72f79"><span style="font-size: small">(12:36:51)</span> <b>andrew.melo:</b></span> arghhhhhh, this is triggering something I'm failing to remember all the way. I seem to remember it having to do with how the args were split up<br/>
<span style="color: #43761b"><span style="font-size: small">(12:37:12)</span> <b>blin:</b></span> yeah, the format looks right, though<br/>
<span style="color: #43761b"><span style="font-size: small">(12:37:24)</span> <b>blin:</b></span> but there were bugs in older versions of xrootd-lcmaps where the policy wasn't respected<br/>
<span style="color: #a72f79"><span style="font-size: small">(12:37:24)</span> <b>andrew.melo:</b></span> something like you needed to separate the params with semicolons instead of commas. let me try to find it in my config management<br/>
<span style="color: #43761b"><span style="font-size: small">(12:38:13)</span> <b>blin:</b></span> so @efajardo i take it that you're using the latest xrootd-lcmaps?<br/>
<span style="color: #a63024"><span style="font-size: small">(12:38:24)</span> <b>efajardo:</b></span> <pre>rpm -qv xrootd-lcmaps<br/>xrootd-lcmaps-1.7.4-4.osg34.el7.x86_64</pre><br/><br/>
<span style="color: #a63024"><span style="font-size: small">(12:41:00)</span> <b>efajardo:</b></span> @andrew.melo did you see something in your config?<br/>
<span style="color: #43761b"><span style="font-size: small">(12:43:58)</span> <b>blin:</b></span> and presumably you set <tt>set EnableLcmaps = 1</tt> ?<br/>
<span style="color: #a63024"><span style="font-size: small">(12:44:04)</span> <b>efajardo:</b></span> yes<br/>
<span style="color: #a63024"><span style="font-size: small">(12:44:34)</span> <b>efajardo:</b></span> <pre>cconfig -c /etc/xrootd/xrootd-standalone.cfg<br/>all.export /tmp <br/>all.adminpath /var/spool/xrootd <br/>all.pidpath /var/run/xrootd <br/>continue /etc/xrootd/config.d/<br/>Config continuing with file /etc/xrootd/config.d/10-common-site-local.cfg ...<br/>Config continuing with file /etc/xrootd/config.d/10-xrootd-lcmaps.cfg ...<br/>Config continuing with file /etc/xrootd/config.d/40-osg-standalone.cfg ...<br/>xrd.port 1094<br/>all.role server<br/>cms.allow host * <br/>xrootd.trace emsg login stall redirect <br/>ofs.trace -all <br/>xrd.trace conn <br/>cms.trace all <br/>xrd.network keepalive kaparms 10m,1m,5 <br/>xrd.timeout idle 60m <br/>Config continuing with file /etc/xrootd/config.d/40-xrootd-hdfs.cfg ...<br/>ofs.ckslib * /usr/lib64/libXrdHdfs.so <br/>ofs.osslib /usr/lib64/libXrdHdfs.so <br/>Config continuing with file /etc/xrootd/config.d/40-xrootd-lcmaps.cfg ...<br/>xrootd.seclib /usr/lib64/libXrdSec-4.so <br/>sec.protocol /usr/lib64 gsi -certdir:/etc/grid-security/certificates -cert:/etc/grid-security/xrd/xrdcert.pem -key:/etc/grid-security/xrd/xrdkey.pem -crl:1 -authzfun:libXrdLcmaps.so -authzfunparms:policy=authorize_only -gmapopt:10 -gmapto:0 <br/>acc.authdb /etc/xrootd/auth_file <br/>ofs.authorize 1 <br/>Config continuing with file /etc/xrootd/config.d/50-osg-http.cfg ...<br/>xrd.protocol http:1094 libXrdHttp.so <br/>http.cadir /etc/grid-security/certificates <br/>http.cert /etc/grid-security/xrd/xrdcert.pem <br/>http.key /etc/grid-security/xrd/xrdkey.pem <br/>http.secxtractor /usr/lib64/libXrdLcmaps.so <br/>http.exthandler xrdmacaroons libXrdMacaroons.so <br/>macaroons.secretkey /etc/xrootd/macaroon-secret <br/>ofs.authlib libXrdMacaroons.so <br/>http.header2cgi Authorization authz <br/>http.listingdeny yes <br/>http.staticpreload <a href="http://static/robots.txt">http://static/robots.txt</a> /etc/xrootd/ban-robots.txt <br/>Config continuing with file /etc/xrootd/config.d/50-osg-monitoring.cfg ...<br/>all.sitename T2_US_UCSD <br/>xrd.report <a href="http://xrd-report.osgstorage.org:9931">xrd-report.osgstorage.org:9931</a> <br/>xrootd.monitor all auth flush 30s window 5s fstat 60 lfn ops xfr 5 dest redir fstat info user <a href="http://xrd-report.osgstorage.org:9930">xrd-report.osgstorage.org:9930</a> dest fstat info user <a href="http://xrd-mon.osgstorage.org:9930">xrd-mon.osgstorage.org:9930</a> <br/>Config continuing with file /etc/xrootd/config.d/50-osg-paths.cfg ...<br/>all.adminpath /var/spool/xrootd <br/>all.pidpath /run/xrootd <br/>oss.localroot /hadoop <br/>Config continuing with file /etc/xrootd/config.d/50-osg-tpc.cfg ...<br/>http.exthandler xrdtpc libXrdHttpTPC.so <br/>Config continuing with file /etc/xrootd/config.d/90-osg-standalone-paths.cfg ...<br/>Config continuing with file /etc/xrootd/config.d/95-UCSD-local.cfg ...<br/>all.manager <a href="http://redirector.t2.ucsd.edu:1313">redirector.t2.ucsd.edu:1313</a><br/>all.export / nostage <br/>xrd.report <a href="http://xrootd.t2.ucsd.edu:9931">xrootd.t2.ucsd.edu:9931</a> every 30s all sync <br/>xrootd.chksum max 2 md5 adler32 crc32 <br/>oss.namelib /usr/lib64/libXrdCmsTfc.so file:/etc/xrootd/storage.xml?protocol=hadoop </pre><br/>
<span style="color: #a72f79"><span style="font-size: small">(12:45:44)</span> <b>andrew.melo:</b></span> No, but I think I didn't commit that interim change. My issue was I needed to change the log level to debug an lcmaps problem but nothing was increasing the logging<br/>
<span style="color: #a72f79"><span style="font-size: small">(12:51:09)</span> <b>andrew.melo:</b></span> @efajardo <tt>-authzfunparms:--lcmapscfg=/etc/lcmaps.db,--loglevel=5</tt><br/>
<span style="color: #a72f79"><span style="font-size: small">(12:51:24)</span> <b>andrew.melo:</b></span> try the double-dashes<br/>
<span style="color: #43761b"><span style="font-size: small">(12:52:39)</span> <b>blin:</b></span> nope, that's not right<br/>
<span style="color: #43761b"><span style="font-size: small">(12:53:11)</span> <b>blin:</b></span> you want either<br/><tt>-authzfunparms:--lcmapscfg,/etc/lcmaps.db</tt><br/>or<br/><tt>-authzfunparms:lcmapscfg=/etc/lcmaps.db</tt><br/>
<span style="color: #43761b"><span style="font-size: small">(12:54:27)</span> <b>blin:</b></span> i just setup a standalone server and the config is working fine for me :disappointed:<br/><pre>[root@fermicloud178 standalone]# grep authzfunparms /etc/xrootd/config.d/40-xrootd-lcmaps.cfg <br/>                       -authzfunparms:lcmapscfg=/etc/lcmaps.db,loglevel=5,policy=authorize_only \<br/>[root@fermicloud178 standalone]# grep 'processing policy' xrootd.log <br/>lcmaps[5567]   LOG_DEBUG: 2020-01-08.18:44:40Z: processing policy: authorize_only<br/>lcmaps[5781]   LOG_DEBUG: 2020-01-08.18:46:48Z: processing policy: authorize_only<br/>lcmaps[5959]   LOG_DEBUG: 2020-01-08.18:48:54Z: processing policy: authorize_only<br/>lcmaps[5982]   LOG_DEBUG: 2020-01-08.18:48:55Z: processing policy: authorize_only<br/>lcmaps[6003]   LOG_DEBUG: 2020-01-08.18:48:55Z: processing policy: authorize_only<br/>lcmaps[6024]   LOG_DEBUG: 2020-01-08.18:48:55Z: processing policy: authorize_only<br/>lcmaps[6045]   LOG_DEBUG: 2020-01-08.18:48:55Z: processing policy: authorize_only<br/>lcmaps[6152]   LOG_DEBUG: 2020-01-08.18:49:48Z: processing policy: authorize_only</pre><br/>
<span style="color: #43761b"><span style="font-size: small">(12:56:32)</span> <b>blin:</b></span> dumb question: have you tried restarting the xrootd server?<br/>
<span style="color: #a63024"><span style="font-size: small">(14:20:49)</span> <b>efajardo:</b></span> yep plenty of times<br/>
<span style="color: #43761b"><span style="font-size: small">(14:23:20)</span> <b>blin:</b></span> so in the cconfig output you sent, i only see:<br/><tt>-authzfunparms:policy=authorize_only</tt> that's a little different from the authzfunparms you mentioned earlier<br/>
<span style="color: #a63024"><span style="font-size: small">(15:33:16)</span> <b>efajardo:</b></span> yea we tried to reduce it to see if we can nail it<br/>
<span style="color: #a63024"><span style="font-size: small">(15:33:28)</span> <b>efajardo:</b></span> but same problem<br/>
<span style="color: #a63024"><span style="font-size: small">(15:33:33)</span> <b>efajardo:</b></span> the policy says one thing<br/>
<span style="color: #a63024"><span style="font-size: small">(15:33:35)</span> <b>efajardo:</b></span> but the log another<br/>
<span style="color: #a63024"><span style="font-size: small">(15:34:08)</span> <b>efajardo:</b></span> @didavila tried reproducing the error in the osg-xrootd-standalone container and there was no problem<br/>
<span style="color: #a63024"><span style="font-size: small">(15:34:19)</span> <b>efajardo:</b></span> so I suggest to call it a local problem and fix it at UCSD<br/>
<span style="color: #a63024"><span style="font-size: small">(15:34:23)</span> <b>efajardo:</b></span> there is an easy fix<br/>
<span style="color: #a63024"><span style="font-size: small">(15:34:33)</span> <b>efajardo:</b></span> that is to add a <tt>xrootd_policy</tt><br/>
<span style="color: #a63024"><span style="font-size: small">(15:34:44)</span> <b>efajardo:</b></span> entry to <tt>/etc/lcmaps.db</tt><br/>
<span style="color: #a63024"><span style="font-size: small">(15:35:13)</span> <b>efajardo:</b></span> <pre>gridmapfile = "lcmaps_localaccount.mod"<br/>              "-gridmap /etc/grid-security/grid-mapfile"<br/><br/>banfile = "lcmaps_ban_dn.mod"<br/>          "-banmapfile /etc/grid-security/ban-mapfile"<br/><br/>banvomsfile = "lcmaps_ban_fqan.mod"<br/>              "-banmapfile /etc/grid-security/ban-voms-mapfile"<br/><br/>vomsmapfile = "lcmaps_voms_localaccount.mod"<br/>              "-gridmap /etc/grid-security/voms-mapfile"<br/><br/>defaultmapfile = "lcmaps_voms_localaccount2.mod"<br/>                 "-gridmap /usr/share/osg/voms-mapfile-default"<br/><br/>verifyproxynokey = "lcmaps_verify_proxy2.mod"<br/>                   "--allow-limited-proxy"<br/>                   "--discard_private_key_absence"<br/>                   " -certdir /etc/grid-security/certificates"<br/><br/>good        = "lcmaps_dummy_good.mod"<br/>bad         = "lcmaps_dummy_bad.mod"<br/><br/><br/>authorize_only:<br/>verifyproxynokey -&gt; banfile<br/>banfile -&gt; banvomsfile | bad<br/>banvomsfile -&gt; gridmapfile | bad<br/>gridmapfile -&gt; good | vomsmapfile<br/>vomsmapfile -&gt; good | defaultmapfile<br/>defaultmapfile -&gt; good | bad<br/><br/>xrootd_policy:<br/>verifyproxynokey -&gt; banfile<br/>banfile -&gt; banvomsfile | bad<br/>banvomsfile -&gt; gridmapfile | bad<br/>gridmapfile -&gt; good | vomsmapfile<br/>vomsmapfile -&gt; good | defaultmapfile<br/>defaultmapfile -&gt; good | bad</pre><br/>
<span style="color: #a63024"><span style="font-size: small">(15:35:20)</span> <b>efajardo:</b></span> And then xrootd finds it<br/>
<span style="color: #43761b"><span style="font-size: small">(16:20:30)</span> <b>blin:</b></span> hrm, i don't love that solution but i'm out of ideas for what the cause is at this point<br/>
</body>
</html>
