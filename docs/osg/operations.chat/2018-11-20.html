<!DOCTYPE html>
<html>
<head>
<title>Tue Nov 20, 2018 : #operations (osg)</title>
</head>
<body>
<h3>Tue Nov 20, 2018 : #operations (osg)</h3>
<span style="color: #16569E"><span style="font-size: small">(11:33:30)</span> <b>edquist:</b></span> Hi @dweitzel, @jthiltges, @matyas - for the topology webhook stuff on topology-itb, John made a <tt>topomerge</tt> user which will be running a separate instance of apache.  I've been exploring the various config files on topology-itb, including <tt>/etc/httpd/conf.d/topology-itb.conf</tt>, trying to make sense of what all we want to change or duplicate for this separate instance.  As far as i can tell, we at least want a separate copy of this httpd conf file, eg <tt>topology-itb-webhook.conf</tt>.  But I think a big part of the question is, do we need to make a separate copy/instance of the whole /opt/topology-itb area for the webhook stuff?  I'd like to get your thoughts on it<br/>
<span style="color: #c386df"><span style="font-size: small">(11:34:10)</span> <b>matyas:</b></span> <b>@edquist</b> I would like that, so we can update it separately<br/>
<span style="color: #16569E"><span style="font-size: small">(11:36:43)</span> <b>edquist:</b></span> Good, that's how it's seeming to me too \:)  Wanted to get feedback on it from the people who might care.<br/>
<span style="color: #c386df"><span style="font-size: small">(11:39:28)</span> <b>matyas:</b></span> you did :slightly_smiling_face:<br/>
<span style="color: #16569E"><span style="font-size: small">(11:47:56)</span> <b>edquist:</b></span> @jthiltges - if you have any specific thoughts about it let me know, otherwise yeah i'm thinking to make a separate everything for the webhook stuff (including a new httpd conf file and a new <tt>/opt/topology-itb-webhook</tt> area)<br/>
<span style="color: #e06b56"><span style="font-size: small">(11:49:05)</span> <b>jthiltges:</b></span> <b>@edquist</b> If that makes sense for your workflow, sounds good to me!<br/>
<span style="color: #16569E"><span style="font-size: small">(11:49:16)</span> <b>edquist:</b></span> ok, great, thanks!<br/>
<span style="color: #e06b56"><span style="font-size: small">(15:15:24)</span> <b>jthiltges:</b></span> Hardware issues affected a VM server at Lincoln. hcc-cvmfs-repo and hcc-oasis-itb were down for ~30min. Both hosts are back up. @dwd<br/>
<span style="color: #16569E"><span style="font-size: small">(16:29:21)</span> <b>edquist:</b></span> @jthiltges and/or @dweitzel, i've added a new httpd config on topology-itb, you can see the changes i've made compared to the old one below.  Is this enough to get apache to start up a new instance running as the topomerge user?  (I've put in place the various other webhook copies of directories and config stuff also)<br/><br/><pre><br/>--- /etc/httpd/conf.d/topology-itb.conf	2018-07-20 08:36:27.648371511 -0500<br/>+++ /etc/httpd/conf.d/topology-itb-webhook.conf	2018-11-20 16:24:06.091729561 -0600<br/>@@ -5,7 +5,7 @@<br/> &lt;IfModule mod_ssl.c&gt;<br/> <br/> <br/>-&lt;VirtualHost *:443&gt;<br/>+&lt;VirtualHost *:7443&gt;<br/> #    DocumentRoot "/var/www/html"<br/>     ServerName <a href="http://topology-itb.opensciencegrid.org">topology-itb.opensciencegrid.org</a><br/> <br/>@@ -13,6 +13,8 @@<br/> SSLVerifyDepth  10<br/> GridSiteEnvs on<br/> SSLEngine on<br/>+User topomerge<br/>+Group topomerge<br/> <br/> SSLCACertificatePath /etc/grid-security/certificates<br/> SSLCARevocationPath /etc/grid-security/certificates<br/>@@ -22,14 +24,14 @@<br/> <br/> #ProxyPass / <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a><br/> <br/>-WSGIDaemonProcess topology_itb python-home=/opt/topology-itb/venv home=/opt/topology-itb/src<br/>+WSGIDaemonProcess topology_itb python-home=/opt/topology-itb-webhook/venv home=/opt/topology-itb-webhook/src<br/> <br/> WSGIProcessGroup topology_itb<br/> WSGIApplicationGroup %{SERVER}<br/> <br/>-WSGIScriptAlias / /opt/topology-itb/src/topology-itb.wsgi<br/>+WSGIScriptAlias / /opt/topology-itb-webhook/src/topology-itb-webhook.wsgi<br/> <br/>-&lt;Directory /opt/topology-itb&gt;<br/>+&lt;Directory /opt/topology-itb-webhook&gt;<br/>     Require all granted<br/> &lt;/Directory&gt;<br/></pre><br/>
<span style="color: #e06b56"><span style="font-size: small">(16:31:14)</span> <b>jthiltges:</b></span> I'm a bit confused by the port change.<br/>
<span style="color: #e06b56"><span style="font-size: small">(16:32:28)</span> <b>jthiltges:</b></span> Can it be aliased under <tt>/webhook</tt> or <tt>/topomerge</tt> or such, but keep port 443?<br/>
<span style="color: #16569E"><span style="font-size: small">(16:37:31)</span> <b>edquist:</b></span> If there's a way to keep it on 443, that's fine with me<br/>
<span style="color: #16569E"><span style="font-size: small">(16:38:03)</span> <b>edquist:</b></span> for some reason i thought we'd have to run it on a separate port, since it was a separate instance of httpd running as a different user<br/>
<span style="color: #16569E"><span style="font-size: small">(16:38:28)</span> <b>edquist:</b></span> if it's possible to alias via some prefix that'd be fine with me<br/>
<span style="color: #16569E"><span style="font-size: small">(16:40:47)</span> <b>edquist:</b></span> @jthiltges or @dweitzel, do you know how to configure an alias like that?  Do we need to put something in place of the <tt>*</tt> in <tt>&lt;VirtualHost *:443&gt;</tt> ?<br/>
<span style="color: #16569E"><span style="font-size: small">(16:41:09)</span> <b>edquist:</b></span> (eg for a <tt>/webhook</tt> prefix)<br/>
<span style="color: #e06b56"><span style="font-size: small">(16:42:06)</span> <b>jthiltges:</b></span> Reading over the docs now. (I'm more familiar with uwsgi...) Give me a couple minutes.<br/>
<span style="color: #e06b56"><span style="font-size: small">(16:46:38)</span> <b>jthiltges:</b></span> Untested!<br/><pre>WSGIDaemonProcess topomerge user=topomerge group=topomerge<br/>WSGIScriptAlias process-group=topomerge /webhook /opt/topology-itb-webhook/src/topology-itb-webhook.wsgi</pre><br/>I'm guessing that adding that to <tt>/etc/httpd/conf.d/topology-itb.conf</tt> might be enough.<br/>
<span style="color: #16569E"><span style="font-size: small">(16:47:47)</span> <b>edquist:</b></span> ah, i see,<br/>
<span style="color: #16569E"><span style="font-size: small">(16:48:14)</span> <b>edquist:</b></span> hopefully it will take precedence over the other one that has<br/><pre><br/>WSGIScriptAlias / /opt/topology-itb-webhook/src/topology-itb-webhook.wsgi<br/></pre><br/>
<span style="color: #16569E"><span style="font-size: small">(16:48:20)</span> <b>edquist:</b></span> er,<br/>
<span style="color: #16569E"><span style="font-size: small">(16:48:25)</span> <b>edquist:</b></span> that has a <tt>/</tt><br/>
<span style="color: #e06b56"><span style="font-size: small">(16:49:36)</span> <b>jthiltges:</b></span> I think the alias of <tt>/webhook</tt> should take precedence over <tt>/</tt><br/><pre>WSGIScriptAlias / /opt/topology-itb/src/topology-itb.wsgi<br/>WSGIScriptAlias /webhook /opt/topology-itb-webhook/src/topology-itb-webhook.wsgi process-group=topomerge</pre><br/>
<span style="color: #16569E"><span style="font-size: small">(16:49:51)</span> <b>edquist:</b></span> ok<br/>
<span style="color: #16569E"><span style="font-size: small">(16:49:57)</span> <b>edquist:</b></span> that sounds good then<br/>
<span style="color: #e06b56"><span style="font-size: small">(16:51:14)</span> <b>jthiltges:</b></span> Please give it a try. Let me know if there's issues, and I'll be happy to dive into debugging tomorrow.<br/>
<span style="color: #16569E"><span style="font-size: small">(16:52:21)</span> <b>edquist:</b></span> great, thanks!<br/>
<span style="color: #16569E"><span style="font-size: small">(16:52:32)</span> <b>edquist:</b></span> the updated config diff is<br/><br/><pre><br/>--- /etc/httpd/conf.d/topology-itb.conf	2018-07-20 08:36:27.648371511 -0500<br/>+++ /etc/httpd/conf.d/topology-itb-webhook.conf	2018-11-20 16:51:45.566024838 -0600<br/>@@ -22,14 +22,14 @@<br/> <br/> #ProxyPass / <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a><br/> <br/>-WSGIDaemonProcess topology_itb python-home=/opt/topology-itb/venv home=/opt/topology-itb/src<br/>+WSGIDaemonProcess topomerge user=topomerge group=topomerge python-home=/opt/topology-itb-webhook/venv home=/opt/topology-itb-webhook/src<br/> <br/>-WSGIProcessGroup topology_itb<br/>+WSGIProcessGroup topomerge<br/> WSGIApplicationGroup %{SERVER}<br/> <br/>-WSGIScriptAlias / /opt/topology-itb/src/topology-itb.wsgi<br/>+WSGIScriptAlias process-group=topomerge /webhook /opt/topology-itb-webhook/src/topology-itb-webhook.wsgi<br/> <br/>-&lt;Directory /opt/topology-itb&gt;<br/>+&lt;Directory /opt/topology-itb-webhook&gt;<br/>     Require all granted<br/> &lt;/Directory&gt;<br/></pre><br/>
<span style="color: #16569E"><span style="font-size: small">(17:14:01)</span> <b>edquist:</b></span> We can look into this more tomorrow, but the httpd service failed to start with the new conf file in place.<br/><br/><pre><br/>Nov 20 16:55:44 <a href="http://hcc-osg-topology2.unl.edu">hcc-osg-topology2.unl.edu</a> httpd[14206]: AH00526: Syntax error on line 30 of /etc/httpd/conf.d/topology-itb-webhook.conf:<br/>Nov 20 16:55:44 <a href="http://hcc-osg-topology2.unl.edu">hcc-osg-topology2.unl.edu</a> httpd[14206]: Invalid option to WSGI script alias definition.<br/></pre><br/><br/>that line 30 it complained about was:<br/><br/><pre><br/>WSGIScriptAlias process-group=topomerge /webhook /opt/topology-itb-webhook/src/topology-itb-webhook.wsgi<br/></pre><br/>
<span style="color: #16569E"><span style="font-size: small">(17:24:55)</span> <b>edquist:</b></span> ah, <a href="https://modwsgi.readthedocs.io/en/develop/configuration-directives/WSGIScriptAlias.html">https://modwsgi.readthedocs.io/en/develop/configuration-directives/WSGIScriptAlias.html</a><br/>
<span style="color: #16569E"><span style="font-size: small">(17:25:14)</span> <b>edquist:</b></span> options (<tt>process-group=topomerge</tt>) have to go at the end of the line<br/>
<span style="color: #16569E"><span style="font-size: small">(17:25:21)</span> <b>edquist:</b></span> so<br/>
<span style="color: #16569E"><span style="font-size: small">(17:25:34)</span> <b>edquist:</b></span> <pre><br/>WSGIScriptAlias /webhook /opt/topology-itb-webhook/src/topology-itb-webhook.wsgi process-group=topomerge<br/></pre><br/>
<span style="color: #16569E"><span style="font-size: small">(17:25:41)</span> <b>edquist:</b></span> now it starts up<br/>
</body>
</html>
