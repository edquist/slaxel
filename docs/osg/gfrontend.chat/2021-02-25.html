<!DOCTYPE html>
<html>
<head>
<title>Thu Feb 25, 2021 : #gfrontend (osg)</title>
</head>
<body>
<h3>Thu Feb 25, 2021 : #gfrontend (osg)</h3>
<span style="color: #a63024"><span style="font-size: small">(09:21:23)</span> <b>efajardo:</b></span> @gthain another way to do it just for “ligo”<br/>
<span style="color: #a63024"><span style="font-size: small">(09:21:26)</span> <b>efajardo:</b></span> could be done<br/>
<span style="color: #a63024"><span style="font-size: small">(09:21:27)</span> <b>efajardo:</b></span> <a href="https://github.com/opensciencegrid/osg-flock/blob/master/node-check/advertise-singularity-vars#L21">https://github.com/opensciencegrid/osg-flock/blob/master/node-check/advertise-singularity-vars#L21</a><br/>
<span style="color: #a63024"><span style="font-size: small">(09:21:33)</span> <b>efajardo:</b></span> like this<br/>
<span style="color: #a63024"><span style="font-size: small">(09:21:36)</span> <b>efajardo:</b></span> with a line like<br/>
<span style="color: #a63024"><span style="font-size: small">(09:23:27)</span> <b>efajardo:</b></span> <tt>add_condor_vars_line BIN C '\\$F\\(CONDOR_DIR\\)\\/sbin' "+" "N"</tt><br/>
<span style="color: #a63024"><span style="font-size: small">(09:30:01)</span> <b>efajardo:</b></span> It cannot be done via the xml unfrotunately<br/>
<span style="color: #e0a729"><span style="font-size: small">(09:37:40)</span> <b>gthain:</b></span> This change belongs in the static condor_config for everyone<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(10:45:47)</span> <b>james.clark:</b></span> hi <b>@channel</b>, we (LIGO) are seeing some singularity problems @ PIC and Nikhef:  jobs are starting with an empty LD_LIBRARY_PATH - MKL and Nvidia libraries are missing.  Manually setting LD_LIBRARY_PATH=/.singularity.d/libs`  fixes this (at least for Nvidia).<br/><br/>Nikhef and PIC are running a newer singularity version (3.7.1).  We don't see this problem elsewhere.<br/><br/>Sound familiar to anyone?<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:47:02)</span> <b>bbockelm:</b></span> hm - doesn't sound familiar to me.  Maybe @dwd recognizes it?<br/>
<span style="color: #a63024"><span style="font-size: small">(10:48:13)</span> <b>efajardo:</b></span> @efajardo has left the channel<br/>
<span style="color: #99a949"><span style="font-size: small">(10:52:56)</span> <b>dwd:</b></span> I don’t think I do.  I just searched in the singularity github issues and didn’t find anybody else reporting problems with LD_LIBRARY_PATH recently either.  There was a major change to how environment variables were handled but that was back in 3.6.0<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(10:53:41)</span> <b>james.clark:</b></span> i believe the successful jobs are seeing 3.5.3-1.1.el7<br/>
<span style="color: #99a949"><span style="font-size: small">(11:00:04)</span> <b>dwd:</b></span> Then it could be that your job setup isn’t ready for 3.6.0+.  See <a href="https://github.com/hpcng/singularity/issues/5781">https://github.com/hpcng/singularity/issues/5781</a> for example.  A simple set of reproducer instructions would be most useful<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(11:32:16)</span> <b>james.clark:</b></span> ok, sorry, was in a call.  Just to be clear, our jobs expect <tt>LD_LIBRARY_PATH=/.singularity.d/libs</tt> to already by set when they start - my understanding was that this is something handled by either singularity itself (which seems to be the case if i start any version of singularity interactively) or possibly by condor.    If i set that variable, or any other actually, in the submit file, it is respected in the singularity job.  So it's not obvious to me that issue is the problem.<br/><br/>Basically, it's as if <tt>LD_LIBRARY_PATH</tt> is being *unset* at PIC and Nikhef, and the only difference we've noticed is their version of singularity.<br/>
<span style="color: #99a949"><span style="font-size: small">(11:57:07)</span> <b>dwd:</b></span> I understand, but there was a change to the strategy of importing variables from outside the container in 3.6.0 and its behavior depends on things in the outside environment.  They tried to make it more consistent.  I don’t recall all the details but they tried to make it mostly compatible but a few incompatible changes were made.  It’s possible that LIGO-specific settings affect it.  It’s also possible that GlideinWMS settings affect it although I’m quite sure that has been tested with other VOs and newer singularity versions.  I’m not sure about including GPUs.  Maybe @marcom can speak to that<br/>
<span style="color: #dd8527"><span style="font-size: small">(13:14:12)</span> <b>marcom:</b></span> There are VOs using GPUs (OSG a lot, and CMS is testing). I'm not sure about the singularity versions encountered by successful jobs, I'm expecting 3.6+ to be used, @rynge and @marco.mascheroni can comment here. We do use the -nv option and thought that was sufficient to enable GPUs w/o having to manually control the LD_LIBRARY_PATH content. VO can ask to preserve LD_LIBRARY_PATH, normally GWMS clears the outside value bedore invoking Singularity, I would need the Frontend and Factory config or a glidein log to know what happened here, e.g. if the VO asked for a specific value. @dwd If LD_LIBRARY_PATH and -nv cause conflicts that I think should be handled in Singularity or at least in the documentation<br/>
<span style="color: #99a949"><span style="font-size: small">(13:17:39)</span> <b>dwd:</b></span> The behavior is documented at <a href="https://sylabs.io/guides/3.7/user-guide/environment_and_metadata.html">https://sylabs.io/guides/3.7/user-guide/environment_and_metadata.html</a><br/>
<span style="color: #e0a729"><span style="font-size: small">(13:26:09)</span> <b>gthain:</b></span> Just to be clear, @james.clark, LIGO is using the configuration where the condor_starter is responsible for starting Singularity, no the USER_JOB_WRAPPER, correct?<br/>
<span style="color: #99a949"><span style="font-size: small">(13:26:10)</span> <b>dwd:</b></span> @marcom does GlideinWMS set <tt>SINGULARITYENV_LD_LIBRARY_PATH</tt>?  @james.clark does LIGO set it?  If so it is supposed to include <tt>"\$LD_LIBRARY_PATH"</tt><br/>
<span style="color: #dd8527"><span style="font-size: small">(13:43:40)</span> <b>marcom:</b></span> GWMS does not set SINGULARITYENV_LD_LIBRARY_PATH. @dwd Will the environment clear option also cause problems (-C)? I think an explicit warning, maybe also in the GPU section (<a href="https://sylabs.io/guides/3.7/user-guide/gpu.html">https://sylabs.io/guides/3.7/user-guide/gpu.html</a>) could help, otherwise people may not make the connection or think that the Singularity managed bits are added anyway. In my mind something controlled by a command line option is different from an image preset, probably I would not have made the connection, anyway GWMS is not setting SINGULARITYENV_LD_LIBRARY_PATH.<br/>
<span style="color: #99a949"><span style="font-size: small">(13:49:54)</span> <b>dwd:</b></span> The documentation gives an explicit example with --clearenv so I don’t think it will cause a problem.  What does GlideninWMS do if a VO asks to preserve LD_LIBRARY_PATH?<br/>
<blockquote>
<span style="color: #99a949"><span style="font-size: small">(15:12:30)</span> <b>dwd:</b></span> @marcom<br/>
<span style="color: #dd8527"><span style="font-size: small">(17:06:09)</span> <b>marcom:</b></span> We don't have a flag to preserve that, at the most we do not empty its content, it's up to the VO to add singularityenv_... to preserve it.<br/>We have a list of variables (gwms, aosg and condor variables) that we preserve if the user is OK with that. ld_library_path is not in there<br/>
</blockquote>
<span style="color: #a2a5dc"><span style="font-size: small">(15:28:12)</span> <b>james.clark:</b></span> re @gthain’s question: yes, LIGO has moved to using condor's own singularity invocation, not the OSG wrapper.  @dwd, I assume, given that it's never come up before, that LIGO does not set <tt>SINGULARITYENV_LD_LIBRARY_PATH</tt>, no - do you happen to know where this would be set if we are doing it?<br/>
<span style="color: #e0a729"><span style="font-size: small">(15:30:40)</span> <b>gthain:</b></span> @james.clark Note that when condor invokes singularity, it passes -C to clear the environment.  All the environment variables that condor knows about (e.g. that are set in the job ad) are passed via the SINGULARITYENV prefix<br/>
<span style="color: #99a949"><span style="font-size: small">(15:38:10)</span> <b>dwd:</b></span> Ah so it may be an issue in the condor singularity invocation.  It may need to include “:\$LD_LIBRARY_PATH” for &gt;= 3.6.0<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(15:39:15)</span> <b>james.clark:</b></span> ah ok - i think i'm finally making the connection between the <tt>-C</tt> and singularity version now<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(15:40:02)</span> <b>james.clark:</b></span> though i am still confused about where it's actually getting set to <tt>/.singularity.d/</tt> in the first place<br/>
<span style="color: #99a949"><span style="font-size: small">(15:40:43)</span> <b>dwd:</b></span> singularity sets it by default unless its overridden by SINGULARITYENV_LD_LIBRARY_PATH<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(15:47:34)</span> <b>james.clark:</b></span> but i don't think we are setting that ourselves.  do you mean the -C clears singularity's own default for &gt;=3.6 ?<br/>
<span style="color: #99a949"><span style="font-size: small">(16:03:35)</span> <b>dwd:</b></span> No, -C blocks passing in environment variables from outside the container to inside by default and it always has.  I think what changed is some things about the way variables are selectively passed in.<br/>
<span style="color: #99a949"><span style="font-size: small">(16:05:07)</span> <b>dwd:</b></span> If the condor singularity wrapper is touching LD_LIBRARY_PATH it could be seeing this difference in singularity versions<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(16:14:23)</span> <b>james.clark:</b></span> Got it, thank you.  so.. is this in condor's court now?<br/>
<span style="color: #99a949"><span style="font-size: small">(16:20:13)</span> <b>dwd:</b></span> If somebody tells them about it, yes I think so<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(16:20:25)</span> <b>james.clark:</b></span> :thumbsup:<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(16:20:51)</span> <b>james.clark:</b></span> i can do that, thanks again<br/>
<span style="color: #e0a729"><span style="font-size: small">(16:40:58)</span> <b>gthain:</b></span> Condor isn't doing anything special with LD_LIBRARY_PATH for singularity, unless it is told to via the config file or job clasad<br/>
<span style="color: #e0a729"><span style="font-size: small">(16:42:13)</span> <b>gthain:</b></span> Can we see the condor_config file in this case?<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(16:46:26)</span> <b>james.clark:</b></span> Presumably you want the one @ the problematic sites?   I'm not sure how to get at that<br/>
<span style="color: #e0a729"><span style="font-size: small">(16:53:38)</span> <b>gthain:</b></span> If you can tell me the GLIDEIN_Site name of one of the problem sites, I can probably go hunting<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(16:54:41)</span> <b>james.clark:</b></span> Sure: PIC is where i see Nvidia problems, Nikhef is where others have seen very similar MKL problems.  I have my finger on the trigger of a jira ticket if it's likely to help...<br/>
<span style="color: #99a949"><span style="font-size: small">(16:56:02)</span> <b>dwd:</b></span> Note that NIKHEF at least I know has enabled unprivileged user namespaces.  So different versions of singularity could be run there out of /cvmfs/oasis.opensciencegrid.org/mis/singularity for comparison.<br/>
<span style="color: #a2a5dc"><span style="font-size: small">(17:45:06)</span> <b>james.clark:</b></span> ok so is there a way for me to set that in the job?<br/>
</body>
</html>
