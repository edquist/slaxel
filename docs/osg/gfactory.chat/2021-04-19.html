<!DOCTYPE html>
<html>
<head>
<title>Mon Apr 19, 2021 : #gfactory (osg)</title>
</head>
<body>
<h3>Mon Apr 19, 2021 : #gfactory (osg)</h3>
<span style="color: #43761b"><span style="font-size: small">(09:08:25)</span> <b>blin:</b></span> @matyas @rynge Mitchell @ SIUE is a smart cookie. He installed CVMFS on his ubuntu workers along with the OSG configs without any documentation :eyes:<br/>
<span style="color: #c386df"><span style="font-size: small">(09:22:20)</span> <b>matyas:</b></span> Can we get him to tell us what he did?<br/>
<span style="color: #43761b"><span style="font-size: small">(09:23:19)</span> <b>blin:</b></span> sure, you own the ticket right now :slightly_smiling_face:<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:11:39)</span> <b>rynge:</b></span> Yay!<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:12:47)</span> <b>rynge:</b></span> @bbockelm What did you find in 3.7.3-rc1? We did upgrade flock with one driver being continued IDTOKEN testing<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:13:13)</span> <b>rynge:</b></span> Nevermind, I see the other thread<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:27:25)</span> <b>bbockelm:</b></span> @rynge - particularly, it is this: <a href="https://github.com/opensciencegrid/tiger-osg-config/blob/master/manifests/development/vo-frontend-glow/patch_frontend.sh#L29-L53">https://github.com/opensciencegrid/tiger-osg-config/blob/master/manifests/development/vo-frontend-glow/patch_frontend.sh#L29-L53</a><br/>
<span style="color: #674b1b"><span style="font-size: small">(10:34:12)</span> <b>rynge:</b></span> Interesting! That is different from the one in the other thread<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:38:27)</span> <b>rynge:</b></span> That patch is for 3.9?<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:39:05)</span> <b>bbockelm:</b></span> Yes, that frontend is on 3.9<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:39:18)</span> <b>bbockelm:</b></span> Let me check if it also affects 3.7<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:39:25)</span> <b>rynge:</b></span> Ok, I have patched osg-flock with the other patch<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:40:30)</span> <b>bbockelm:</b></span> <a href="https://github.com/glideinWMS/glideinwms/blob/branch_v3_7/frontend/glideinFrontendElement.py">https://github.com/glideinWMS/glideinwms/blob/branch_v3_7/frontend/glideinFrontendElement.py</a> yes, 3.7 is also affected.<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:41:00)</span> <b>rynge:</b></span> Yeah I applied that one<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:41:04)</span> <b>bbockelm:</b></span> And it looks like 3.7 has a separate set of patches for creating the token in-process but it's not the right set of privileges.<br/>
<span style="color: #674b1b"><span style="font-size: small">(10:41:16)</span> <b>rynge:</b></span> Fun<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:41:34)</span> <b>bbockelm:</b></span> <tt>condor:/ADVERTISE_SCHEDD</tt> I'm _pretty_ sure we don't want the glidein to be a schedd.<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:42:08)</span> <b>bbockelm:</b></span> It also sets the duration to 2 hours, which isn't going to be enough to survive even a modest queue time.<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:46:04)</span> <b>bbockelm:</b></span> and it has the wrong issuer.<br/>
<span style="color: #9e3997"><span style="font-size: small">(10:46:29)</span> <b>bbockelm:</b></span> and it signs the token incorrecty.<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:53:28)</span> <b>rynge:</b></span> Heh, so pretty much everything then...<br/>
<span style="color: #43761b"><span style="font-size: small">(11:54:55)</span> <b>blin:</b></span> @bbockelm is that 3.7.3 rc1 or rc2?<br/>
<span style="color: #9e3997"><span style="font-size: small">(11:57:01)</span> <b>bbockelm:</b></span> @blin - I just looked at the branch.  Not quite sure what's in the RC or not.<br/>
<span style="color: #43761b"><span style="font-size: small">(11:57:18)</span> <b>blin:</b></span> gotcha<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:59:01)</span> <b>rynge:</b></span> @bbockelm I think frontend issues we can iterate more quickly on than factory ones<br/>
<span style="color: #674b1b"><span style="font-size: small">(11:59:19)</span> <b>rynge:</b></span> Did you get to test end to end on itb?<br/>
<span style="color: #9e3997"><span style="font-size: small">(12:08:55)</span> <b>bbockelm:</b></span> yes, ignoring the factory issue.  Is the ITB factory on the RC?<br/>
<span style="color: #674b1b"><span style="font-size: small">(12:22:04)</span> <b>rynge:</b></span> it 3.7.3, but not sure which rc<br/>
<span style="color: #9e3997"><span style="font-size: small">(12:25:06)</span> <b>bbockelm:</b></span> Ok.  I _think_ it should work on the ITB factory then.  Both the patches I highlighted above as being needed on the factory are in RC1.<br/>
<span style="color: #9e3997"><span style="font-size: small">(12:26:31)</span> <b>bbockelm:</b></span> Right now, the CHTC frontend does not point to the ITB factory at all.  Think it's easier to patch the OSG Flock frontend or add the ITB factory to CHTC?<br/>
<span style="color: #674b1b"><span style="font-size: small">(12:29:16)</span> <b>rynge:</b></span> Yeah, I can work on that in a bit<br/>
<span style="color: #385a86"><span style="font-size: small">(14:06:38)</span> <b>jdost321:</b></span> sorry still playing catch up, Marco Mascheroni upgraded ITB factory to glideinwms-factory-3.7.3-0.02.rc2.osg35up.el7.noarch last week<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:22:01)</span> <b>bbockelm:</b></span> @rynge - anything you need help with from me on the OSG frontend?<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:22:23)</span> <b>bbockelm:</b></span> @jdost321 - what are your thoughts on some modest factory patches to fix IDTOKENS in the production factory?<br/>
<span style="color: #385a86"><span style="font-size: small">(14:23:26)</span> <b>jdost321:</b></span> we were planning to upgrade to whatever becomes the final 3.7.3 as soon as its ready in prod. Can it wait for that or is it more urgent?<br/>
<span style="color: #385a86"><span style="font-size: small">(14:24:04)</span> <b>jdost321:</b></span> i started getting bit by applying a bunch of earlier singlularity patches in prod, was hoping for a clean release before applying more patches<br/>
<span style="color: #9e3997"><span style="font-size: small">(14:25:28)</span> <b>bbockelm:</b></span> I guess it comes down to when we think the final 3.7.3 is released.  The two patches involved are this:<br/><pre>--- a/factory/glideFactoryEntry.py<br/>+++ b/factory/glideFactoryEntry.py<br/>@@ -1217,7 +1217,7 @@ def unit_work_v3(entry, work, client_name, client_int_name, client_int_req,<br/>     condortoken_file = os.path.join(submit_credentials.cred_dir, condortoken)<br/>     condortoken_data = decrypted_params.get(condortoken)<br/>     if condortoken_data:<br/>-        (fd, tmpnm) = tempfile.mkstemp()<br/>+        (fd, tmpnm) = tempfile.mkstemp(dir=submit_credentials.cred_dir)<br/>         try:<br/>             <a href="http://entry.log.info">entry.log.info</a>("frontend_token supplied, writing to %s" % condortoken_file)<br/>             os.chmod(tmpnm,0600)<br/>--- a/creation/lib/cgWCreate.py<br/>+++ b/creation/lib/cgWCreate.py<br/>@@ -168,18 +168,9 @@ def populate(self, exe_fname, entry_name, conf, entry):<br/>         submit_attrs = entry.get_child(u'config').get_child(u'submit').get_child_list(u'submit_attrs')<br/>         enc_input_files = []<br/> <br/>-        # if entry condor version supports tokens, add them to <br/>-        # the transfer/encrypt input file list<br/>-        param_c = cWDictFile.ReprDictFile(self.get_dir(), 'params.cfg')<br/>-        param_c.load()<br/>-        version = 'default'<br/>-        if 'CONDOR_VERSION' in param_c: <br/>-            version = param_c['CONDOR_VERSION']<br/>-<br/>-        if version &gt; '8.9.1' and version != 'default': <br/>-            enc_input_files.append('$ENV(IDTOKENS_FILE)')<br/>-            enc_input_files.append('$ENV(SCITOKENS_FILE)')<br/>-            self.add('+SciTokensFile', '"$ENV(SCITOKENS_FILE)"')<br/>+        enc_input_files.append('$ENV(IDTOKENS_FILE)')<br/>+<br/>+        self.add('+SciTokensFile', '"$ENV(SCITOKENS_FILE)"')<br/> <br/>         # Folders and files of tokens for glidein logging authentication<br/>         # leos token stuff, left it in for now</pre><br/>
<span style="color: #674b1b"><span style="font-size: small">(15:49:38)</span> <b>rynge:</b></span> <pre>04/19/21 13:48:50 DC_AUTHENTICATE: received DC_AUTHENTICATE from &lt;169.228.38.36:2030&gt;<br/>04/19/21 13:48:50 DC_AUTHENTICATE: generating BLOWFISH key for session osg:2973997:1618865330:17...<br/>04/19/21 13:48:50 SECMAN: new session, doing initial authentication.<br/>04/19/21 13:48:50 Returning to DC while we wait for socket to authenticate.<br/>04/19/21 13:48:50 AUTHENTICATE: setting timeout for (unknown) to 20.<br/>04/19/21 13:48:50 HANDSHAKE: in handshake(my_methods = 'SCITOKENS')<br/>04/19/21 13:48:50 HANDSHAKE: handshake() - i am the server<br/>04/19/21 13:48:50 HANDSHAKE: client sent (methods == 0)<br/>04/19/21 13:48:50 HANDSHAKE: i picked (method == 0)<br/>04/19/21 13:48:50 HANDSHAKE: client received (method == 0)<br/>04/19/21 13:48:50 DC_AUTHENTICATE: authentication of &lt;169.228.38.36:2030&gt; did not result in a valid mapped user name, which is required for this command (1112 QMGMT_WRITE_CMD), so aborting.</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(15:49:48)</span> <b>rynge:</b></span> How can I get some more verbose info than that?<br/>
<span style="color: #674b1b"><span style="font-size: small">(15:50:12)</span> <b>rynge:</b></span> I currently have: <tt>SCHEDD_DEBUG = D_SECURITY</tt><br/>
<span style="color: #c386df"><span style="font-size: small">(15:55:51)</span> <b>matyas:</b></span> <tt>D_SECURITY:2</tt><br/>
<span style="color: #43761b"><span style="font-size: small">(15:57:25)</span> <b>blin:</b></span> also, you should always enable <tt>D_CAT</tt> ! it makes it easier to find the security-related messages<br/>
<span style="color: #385a86"><span style="font-size: small">(16:07:38)</span> <b>jdost321:</b></span> @bbockelm @rynge i patched production<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:12:09)</span> <b>rynge:</b></span> @matyas @blin I still can't make it dump the mappings<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:12:19)</span> <b>rynge:</b></span> Any other tricks?<br/>
<span style="color: #43761b"><span style="font-size: small">(16:13:53)</span> <b>blin:</b></span> is this on the CE? do you mean you want to see what it mapped the token to, or what the configured scitokens mappings are?<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:14:24)</span> <b>rynge:</b></span> Yeah, CE<br/>
<span style="color: #43761b"><span style="font-size: small">(16:14:29)</span> <b>blin:</b></span> idk if scitokens mappings are cached so a restart of the condor-ce service may help<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:14:33)</span> <b>rynge:</b></span> Trying to disable GSI and force SCITOKEN<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:14:39)</span> <b>rynge:</b></span> I restart :slightly_smiling_face:<br/>
<span style="color: #43761b"><span style="font-size: small">(16:15:13)</span> <b>blin:</b></span> a restart should also show you what the auth mappings are, right after the daemon startup<br/>
<span style="color: #43761b"><span style="font-size: small">(16:15:21)</span> <b>blin:</b></span> (but maybe that's in <tt>D_ALWAYS:2</tt>)<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:48:27)</span> <b>rynge:</b></span> Still not getting anything. @jpeterson @jdost321 Can you guys look on itb, under the OSG_US_ISI_osg and see if you get any auth problems? Please also check the job to see if it has a scitoken added to it<br/>
<span style="color: #43761b"><span style="font-size: small">(16:49:28)</span> <b>blin:</b></span> do you have a log snippet with the <tt>D_SECURITY:2</tt>?<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:51:57)</span> <b>rynge:</b></span> <a href="http://osg.isi.edu/scitoken-schedlog.txt">http://osg.isi.edu/scitoken-schedlog.txt</a><br/>
<span style="color: #674b1b"><span style="font-size: small">(16:52:32)</span> <b>rynge:</b></span> 169.228.38.36 is the IP for the ITB factory<br/>
<span style="color: #385a86"><span style="font-size: small">(16:57:20)</span> <b>jdost321:</b></span> are we talking about tokens to submit from factory to CE for ISI?<br/>
<span style="color: #43761b"><span style="font-size: small">(16:57:27)</span> <b>blin:</b></span> hrm yeah, that's bizarre. it looks like the authn handshake succeeds and agrees on SCITOKENS<br/>
<span style="color: #43761b"><span style="font-size: small">(16:57:30)</span> <b>blin:</b></span> yup<br/>
<span style="color: #385a86"><span style="font-size: small">(16:57:47)</span> <b>jdost321:</b></span> i don't expect that to work anymore because we had to downgrade condor to 8.8.13 to test before upgrading prod condor<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:58:16)</span> <b>rynge:</b></span> Aha!<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:58:32)</span> <b>rynge:</b></span> Ok, please put it on the wishlist for that to go to 9.0.0<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:58:38)</span> <b>rynge:</b></span> On ITB I mean<br/>
<span style="color: #385a86"><span style="font-size: small">(16:59:05)</span> <b>jdost321:</b></span> we've had 8.8.13 in prod for a while now so should be no issue to re-upgrade ITB<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:59:17)</span> <b>rynge:</b></span> Great<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:59:46)</span> <b>rynge:</b></span> @blin Slightly related:<br/>
<span style="color: #674b1b"><span style="font-size: small">(16:59:50)</span> <b>rynge:</b></span> <pre># cat /usr/share/condor-ce/mapfiles.d/osg-scitokens-mapfile <br/># OSG<br/>SCITOKEN "<a href="https://scitokens.org/osg-connect">https://scitokens.org/osg-connect</a>" osg<br/># GLOW<br/>SCITOKEN "<a href="https://scitokens.org/chtc">https://scitokens.org/chtc</a>" glow</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(17:00:28)</span> <b>rynge:</b></span> That file is oddly named (does not have the .conf suffix), and is missing 'S' in <tt>SCITOKENS</tt><br/>
<blockquote>
<span style="color: #43761b"><span style="font-size: small">(17:05:03)</span> <b>blin:</b></span> @matyas this and the <tt>.conf</tt> suffix def needs to be addressed<br/>
<span style="color: #c386df"><span style="font-size: small">(17:05:41)</span> <b>matyas:</b></span> do mapfiles have the .conf extension?<br/>
<span style="color: #43761b"><span style="font-size: small">(17:05:49)</span> <b>blin:</b></span> yup<br/>
<span style="color: #c386df"><span style="font-size: small">(17:06:23)</span> <b>matyas:</b></span> <tt>/etc/condor-ce/condor_mapfile</tt><br/>
<span style="color: #c386df"><span style="font-size: small">(17:06:34)</span> <b>matyas:</b></span> that one doesn't<br/>
<span style="color: #43761b"><span style="font-size: small">(17:06:38)</span> <b>blin:</b></span> nope, it doesn't<br/>
<span style="color: #c386df"><span style="font-size: small">(17:06:47)</span> <b>matyas:</b></span> <tt>/etc/grid-security/grid-mapfile</tt><br/>
<span style="color: #43761b"><span style="font-size: small">(17:06:51)</span> <b>blin:</b></span> but anything in <tt>mapfiles.d</tt> dirs need it<br/>
<span style="color: #c386df"><span style="font-size: small">(17:06:57)</span> <b>matyas:</b></span> oh interesting<br/>
<span style="color: #c386df"><span style="font-size: small">(17:07:27)</span> <b>matyas:</b></span> should that go in <a href="https://opensciencegrid.atlassian.net/browse/SOFTWARE-4572">https://opensciencegrid.atlassian.net/browse/SOFTWARE-4572</a>?<br/>
<span style="color: #43761b"><span style="font-size: small">(17:07:29)</span> <b>blin:</b></span> <tt>/etc/grid-security/*-mapfile</tt> are loaded through lcmaps. HTCondor's the one forcing the <tt>.conf</tt> requirement on us<br/>
<span style="color: #43761b"><span style="font-size: small">(17:07:39)</span> <b>blin:</b></span> yeah, i'll update the description<br/>
<span style="color: #c386df"><span style="font-size: small">(17:07:44)</span> <b>matyas:</b></span> cool, thanks<br/>
</blockquote>
<span style="color: #674b1b"><span style="font-size: small">(17:01:20)</span> <b>rynge:</b></span> I also think we need to talk about the subject<br/>
<span style="color: #674b1b"><span style="font-size: small">(17:01:45)</span> <b>rynge:</b></span> Note that anybody submitting jobs under OSGConnect would have an OSGConnect scitoken<br/>
<span style="color: #674b1b"><span style="font-size: small">(17:01:59)</span> <b>rynge:</b></span> So we probably want to narrow that down a little bit :wink:<br/>
<blockquote>
<span style="color: #43761b"><span style="font-size: small">(17:05:18)</span> <b>blin:</b></span> really? why do the users have scitokens?<br/>
<span style="color: #674b1b"><span style="font-size: small">(17:33:48)</span> <b>rynge:</b></span> It goes with all the jobs so that users can use auth stashcp<br/>
<span style="color: #43761b"><span style="font-size: small">(17:39:56)</span> <b>blin:</b></span> oh interesting. how do their tokens get generated?<br/>
<span style="color: #43761b"><span style="font-size: small">(17:41:28)</span> <b>blin:</b></span> and can we just rely on issuing the correct scopes instead of the subjects?<br/>
<span style="color: #43761b"><span style="font-size: small">(17:42:16)</span> <b>blin:</b></span> <tt>condor:/WRITE condor:/READ</tt> for pilots, <tt>read:/ write:/</tt> (or whatever the scitokens equivalent is) for stashcp?<br/>
<span style="color: #674b1b"><span style="font-size: small">(17:49:38)</span> <b>rynge:</b></span> We need to check with Derek/BrianB,...<br/>
<span style="color: #674b1b"><span style="font-size: small">(17:50:23)</span> <b>rynge:</b></span> The tokens are generated by some HTCondor cred manager<br/>
<span style="color: #674b1b"><span style="font-size: small">(17:50:34)</span> <b>rynge:</b></span> And added to the jobs transparantly<br/>
</blockquote>
<span style="color: #385a86"><span style="font-size: small">(17:03:47)</span> <b>jdost321:</b></span> which OSG repo has condor 9.0.0?<br/>
<span style="color: #43761b"><span style="font-size: small">(17:04:23)</span> <b>blin:</b></span> @tim.theisen should have 9.0.0 built and available in 3.5 osg-upcoming-development by COB<br/>
<span style="color: #385a86"><span style="font-size: small">(17:05:52)</span> <b>jdost321:</b></span> @rynge is that ok for you for me to wait for the 9.0.0 rpms?<br/>
<span style="color: #385a86"><span style="font-size: small">(17:23:10)</span> <b>jdost321:</b></span> @blin is this the latest? 9.0.0-0.535950.osg35up.el7<br/>
<span style="color: #43761b"><span style="font-size: small">(17:23:44)</span> <b>blin:</b></span> nope, upstream released 9.0.0 proper so you should wait for <tt>9.0.0-1.osg35up.el7</tt><br/>
<span style="color: #385a86"><span style="font-size: small">(17:23:57)</span> <b>jdost321:</b></span> ok, thanks, will keep an eye out<br/>
<span style="color: #43761b"><span style="font-size: small">(17:24:20)</span> <b>blin:</b></span> when this is all green instead of orange <a href="https://koji.chtc.wisc.edu/koji/taskinfo?taskID=335904">https://koji.chtc.wisc.edu/koji/taskinfo?taskID=335904</a>, you should be able to grab it immediately from <tt>osg-upcoming-minefield</tt><br/>
<span style="color: #43761b"><span style="font-size: small">(17:24:38)</span> <b>blin:</b></span> (minefield is just development without waiting for Yum repos to update)<br/>
<span style="color: #73769d"><span style="font-size: small">(17:26:28)</span> <b>tim.theisen:</b></span> The task is this one: <a href="https://koji.opensciencegrid.org/koji/buildinfo?buildID=14538">https://koji.opensciencegrid.org/koji/buildinfo?buildID=14538</a><br/>
<span style="color: #73769d"><span style="font-size: small">(17:26:44)</span> <b>tim.theisen:</b></span> Brian pointed at the osg-3.6 one.<br/>
<span style="color: #73769d"><span style="font-size: small">(17:27:31)</span> <b>tim.theisen:</b></span> @jdost321 In any case, the build is finished and available in osg-upcoming-minefield.<br/>
<span style="color: #43761b"><span style="font-size: small">(17:27:39)</span> <b>blin:</b></span> ah right<br/>
<span style="color: #43761b"><span style="font-size: small">(17:27:50)</span> <b>blin:</b></span> upcoming minefield<br/>
<span style="color: #385a86"><span style="font-size: small">(17:29:30)</span> <b>jdost321:</b></span> i see it there, thanks!<br/>
<span style="color: #385a86"><span style="font-size: small">(17:39:23)</span> <b>jdost321:</b></span> @rynge ITB is running condor 9.0.0 I see running pilots again at ISI<br/>
<span style="color: #674b1b"><span style="font-size: small">(17:47:37)</span> <b>rynge:</b></span> Yay!<br/>
<span style="color: #674b1b"><span style="font-size: small">(17:47:40)</span> <b>rynge:</b></span> <pre>04/19/21 15:46:40 (D_SECURITY) DC_AUTHENTICATE: received following ClassAd:<br/>Command = 1111<br/>ConnectSinful = "&lt;128.9.35.239:9619?addrs=128.9.35.239-9619&amp;alias=osg.isi.edu&amp;noUDP&amp;sock=schedd_2989242_2792&gt;"<br/>CryptoMethods = "AES"<br/>ServerCommandSock = "&lt;169.228.38.36:13305?addrs=169.228.38.36-13305&amp;alias=gfactory-itb-1.opensciencegrid.org&gt;"<br/>Sid = "osg:2989296:1618871784:418"<br/>UseSession = "YES"<br/>04/19/21 15:46:40 (D_SECURITY) DC_AUTHENTICATE: resuming session id osg:2989296:1618871784:418 with return address &lt;169.228.38.36:13305?addrs=169.228.38.36-13305&amp;alias=gfactory-itb-1.opensciencegrid.org&gt;:<br/>04/19/21 15:46:40 (D_SECURITY) DC_AUTHENTICATE: Cached Session:<br/>AuthMethods = "SCITOKENS"<br/>AuthMethodsList = "SCITOKENS"<br/>AuthTokenId = "15496908-adf6-4e23-b401-c8d63346fb67"<br/>AuthTokenIssuer = "<a href="https://scitokens.org/osg-connect">https://scitokens.org/osg-connect</a>"<br/>AuthTokenScopes = "condor:/WRITE,condor:/READ"<br/>AuthTokenSubject = "Token"<br/>AuthenticatedName = "<a href="https://scitokens.org/osg-connect,Token">https://scitokens.org/osg-connect,Token</a>"<br/>Authentication = "YES"<br/>CryptoMethods = "AES"<br/>CryptoMethodsList = "AES,BLOWFISH,3DES"<br/>Enact = "YES"<br/>Encryption = "YES"<br/>Integrity = "YES"<br/>LimitAuthorization = "WRITE,READ,"<br/>ParentUniqueID = "gfactory-itb-1:2995742:1618871774"<br/>RemoteVersion = "$CondorVersion: 9.0.0 Apr 19 2021 PackageID: 9.0.0-1 RC $"<br/>ServerCommandSock = "&lt;169.228.38.36:13305?addrs=169.228.38.36-13305&amp;alias=gfactory-itb-1.opensciencegrid.org&gt;"<br/>ServerPid = 2995744<br/>SessionDuration = "1800"<br/>SessionLease = 3600<br/>Sid = "osg:2989296:1618871784:418"<br/>Subsystem = "C_GAHP_WORKER_THREAD"<br/>TriedAuthentication = true<br/>TrustDomain = "<a href="http://osg.isi.edu:9619">osg.isi.edu:9619</a>"<br/>User = "<a href="mailto:osg@users.htcondor.org">osg@users.htcondor.org</a>"<br/>ValidCommands = "60004,60012,60021,60052,421,478,480,486,488,489,487,499,502,464,1112,481,509,511,521,74000,507,60007,457,60020,443,441,6,12,5,515,516,519,1111,471"</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(17:47:48)</span> <b>rynge:</b></span> That looks great!<br/>
<span style="color: #674b1b"><span style="font-size: small">(17:51:48)</span> <b>rynge:</b></span> FYI, I have configured this CE to only accept scitokens for now - you might see some failures in the production stats<br/>
<span style="color: #9e3997"><span style="font-size: small">(18:09:22)</span> <b>bbockelm:</b></span> @rynge - note that the user would have to get the condor read and write scopes from the OSG-Connect issuer.<br/>
<span style="color: #674b1b"><span style="font-size: small">(18:17:28)</span> <b>rynge:</b></span> We are still talking about SciToken? Or IDTOKEN?<br/>
<span style="color: #674b1b"><span style="font-size: small">(18:17:58)</span> <b>rynge:</b></span> Ok, I see what you mean!<br/>
<span style="color: #674b1b"><span style="font-size: small">(18:17:59)</span> <b>rynge:</b></span> Cool!<br/>
<span style="color: #674b1b"><span style="font-size: small">(18:18:11)</span> <b>rynge:</b></span> <pre>scitokens-admin-create-token \<br/>    --keyfile /etc/condor/scitokens.pem \<br/>    --key_id 6804 \<br/>    --issuer <a href="https://scitokens.org/osg-connect">https://scitokens.org/osg-connect</a> \<br/>    --lifetime 3600 \<br/>    scope="condor:/WRITE condor:/READ" \<br/>    sub="Token" \<br/>    aud="ANY" \<br/>    ver="scitokens:2.0"</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(18:18:33)</span> <b>rynge:</b></span> So no need to limit it further then<br/>
<span style="color: #9e3997"><span style="font-size: small">(18:27:44)</span> <b>bbockelm:</b></span> Switching back to IDTOKEN for a second, it looks like the changes @jdost321 made result in a happy frontend:<br/><pre>$ condor_status -pool '<a href="http://glidein-cm.chtc.wisc.edu?sock=collector4">glidein-cm.chtc.wisc.edu?sock=collector4</a>' -af AuthenticatedIdentity AuthenticationMethod | sort | uniq -c<br/>      1 <a href="mailto:gwms-IIT@chtc.wisc.edu">gwms-IIT@chtc.wisc.edu</a> IDTOKENS<br/>      4 <a href="mailto:gwms-SU-ITS@chtc.wisc.edu">gwms-SU-ITS@chtc.wisc.edu</a> IDTOKENS<br/>   1104 vo-frontend-glow.chtc.wisc.edu@gsi_ocis GSI</pre><br/>
<span style="color: #674b1b"><span style="font-size: small">(18:31:21)</span> <b>rynge:</b></span> Mine are still using GSI by default<br/>
<span style="color: #674b1b"><span style="font-size: small">(18:31:27)</span> <b>rynge:</b></span> Trying to force them<br/>
<span style="color: #674b1b"><span style="font-size: small">(18:32:58)</span> <b>rynge:</b></span> <pre>Header: {"alg":"HS256","typ":"JWT","kid":"FRONTEND"} Payload: {"sub":"<a href="mailto:vofrontend_service@flock.opensciencegrid.org">vofrontend_service@flock.opensciencegrid.org</a>","iss":"<a href="http://flock.opensciencegrid.org:9618">flock.opensciencegrid.org:9618</a>","jti":"9574ad6a94c54f3e998021f524f5a699","exp":1618878927,"scope":"condor:/READ condor:/WRITE condor:/ADVERTISE_STARTD condor:/ADVERTISE_SCHEDD condor:/ADVERTISE_MASTER","iat":1618871727,"nbf":1618871727} File: /etc/condor/tokens.d/foo.test</pre><br/><br/>
<span style="color: #674b1b"><span style="font-size: small">(18:33:11)</span> <b>rynge:</b></span> So those are the issues you mentioned above, right?<br/>
<span style="color: #9e3997"><span style="font-size: small">(18:33:47)</span> <b>bbockelm:</b></span> I see the tokens at the factory.  What's the value of TRUST_DOMAIN on <a href="http://flock.osg.org">flock.osg.org</a>?  Does it include the 9618?<br/>
<span style="color: #674b1b"><span style="font-size: small">(18:34:17)</span> <b>rynge:</b></span> <pre># condor_config_val TRUST_DOMAIN<br/><a href="http://flock.opensciencegrid.org">flock.opensciencegrid.org</a></pre><br/><br/>
<span style="color: #9e3997"><span style="font-size: small">(18:35:07)</span> <b>bbockelm:</b></span> yup, that issuer will be a problem then.<br/>
<span style="color: #9e3997"><span style="font-size: small">(18:35:44)</span> <b>bbockelm:</b></span> If you're patching the frontend, reduce the scopes (need read, advertise staratd + master), and increase the lifetime to ~1 day<br/>
<span style="color: #674b1b"><span style="font-size: small">(18:36:09)</span> <b>rynge:</b></span> Got it<br/>
<span style="color: #9e3997"><span style="font-size: small">(19:00:14)</span> <b>bbockelm:</b></span> Mats - does 3.7.3 have the patches to the pilot to not require a X.509 credential on the worker node<br/>
<span style="color: #9e3997"><span style="font-size: small">(19:00:45)</span> <b>bbockelm:</b></span> (3.7.2 would fail to start if a valid GSI proxy wasnâ€™t around)<br/>
<span style="color: #674b1b"><span style="font-size: small">(19:09:47)</span> <b>rynge:</b></span> It is still not happy about<br/>
<span style="color: #674b1b"><span style="font-size: small">(19:10:27)</span> <b>rynge:</b></span> Frontend does some extra checks which seems to indicate that we still need a gsi credentials to pass through<br/>
<span style="color: #674b1b"><span style="font-size: small">(19:11:11)</span> <b>rynge:</b></span> <pre>         &lt;security&gt;<br/>            &lt;credentials&gt;<br/>               &lt;credential absfname="/etc/grid-security/gwms-frontend/osg-pilot.proxy" security_class="frontend" trust_domain="grid" type="grid_proxy"/&gt;<br/>               &lt;credential absfname="/etc/grid-security/gwms-frontend/osgconnect.scitoken" security_class="frontend" trust_domain="grid" type="scitoken"/&gt;<br/>            &lt;/credentials&gt;<br/>         &lt;/security&gt;</pre><br/>`<br/>
<span style="color: #674b1b"><span style="font-size: small">(19:11:26)</span> <b>rynge:</b></span> If I remove the proxy line:<br/>
<span style="color: #674b1b"><span style="font-size: small">(19:12:07)</span> <b>rynge:</b></span> [2021-04-19 19:05:13,184] WARNING: No security credentials match for factory pool <a href="http://gfactory-itb-1.opensciencegrid.org">gfactory-itb-1.opensciencegrid.org</a>, not advertising request; if this is not intentional, check for ty<br/>pos frontend's credential trust_domain and type, vs factory's pool trust_domain and auth_method<br/>
<span style="color: #674b1b"><span style="font-size: small">(19:18:22)</span> <b>rynge:</b></span> Will get back to this tomorrow...<br/>
<span style="color: #9e3997"><span style="font-size: small">(21:06:43)</span> <b>bbockelm:</b></span> That's for the factory&lt;-&gt;frontend communications, right?  No clue if that's supposed to work without GSI in 3.7.3.<br/>
</body>
</html>
